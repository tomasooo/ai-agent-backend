

<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Emailov√Ω Agent</title>
    <style>




/* === PRO EMAIL MODAL === */
.pro-modal { padding: 0; overflow: hidden; border-radius: 18px; box-shadow: 0 20px 60px rgba(0,0,0,.25); }
.pro-modal__header {
  display:flex; align-items:center; justify-content:space-between; gap:1rem;
  padding: 16px 18px;
  background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 60%, #6366f1 100%);
  color:#fff;
}
.pro-modal__id { display:flex; align-items:center; gap: 12px; min-width:0; }
.pro-headings { min-width:0; }
.pro-title { font-weight:700; font-size:1.1rem; line-height:1.25; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pro-subtitle { opacity:.95; font-size:.9rem; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; row-gap:.25rem; }
.pro-subtitle span { min-width:0; overflow-wrap:anywhere; }
.pro-dot { opacity:.75; flex-shrink:0; }

.pro-avatar {
  width:40px; height:40px; border-radius:50%;
  display:grid; place-items:center;
  background: rgba(255,255,255,.2);
  border: 1px solid rgba(255,255,255,.35);
  font-weight:700;
  backdrop-filter: blur(6px);
}

.pro-actions { display:flex; align-items:center; gap:.5rem; }
.pro-chip { background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.35); color:#fff; }
.pro-chip:hover { background: rgba(255,255,255,.28); }
.pro-close {
  margin-left:.25rem; width:36px; height:36px; border-radius:10px;
  background: rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.35);
  color:#fff; cursor:pointer;
}
.pro-close:hover { background: rgba(255,255,255,.28); }

.pro-modal__body { padding: 18px; display:grid; grid-template-columns: 280px minmax(0,1fr); gap: 16px; }
@media (max-width: 860px) { .pro-modal__body { grid-template-columns: 1fr; } }

.pro-meta {
  background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 14px; padding: 12px;
}
.pro-meta__row { display:grid; grid-template-columns: 90px 1fr; gap: 10px; padding: 8px 6px; align-items:start; }
.pro-meta__label { font-size:.8rem; color:#64748b; }
.pro-meta__value { font-size:.95rem; color:#0f172a; word-break:break-word; overflow-wrap:anywhere; }

.pro-body-card { background:#ffffff; border:1px solid #e5e7eb; border-radius: 14px; overflow:hidden; }
.pro-body-card__title { padding:10px 12px; font-weight:600; color:#0f172a; background:#f8fafc; border-bottom:1px solid #e5e7eb; }
.pro-body-card__content {
  padding: 14px 12px; min-height:220px;
  white-space: pre-wrap; line-height:1.55; color:#111827;
}
.pro-modal__footer { padding: 12px 18px; display:flex; justify-content:flex-end; gap: 10px; border-top:1px solid #e5e7eb; background:#fff; }

/* drobnosti */
#emailDetailModal .btn { border-radius:10px; padding:8px 12px; }
#emailDetailModal.show .modal { transform: translateY(0); opacity:1; transition:.28s ease; }
#emailDetailModal .modal { transform: translateY(8px); opacity:0; }








.toast .toast-action:hover { opacity: .9; }

          /* === STYLY PRO NOV√â MOD√ÅLN√ç OKNO === */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
    display: none; /* Skryt√© ve v√Ωchoz√≠m stavu */
    align-items: center; justify-content: center; z-index: 2000;
    opacity: 0; transition: opacity 0.3s ease;
}

.email-item { cursor: pointer; }
.email-item .analyze-btn { cursor: default; }
#emailDetailModal { z-index: 2050; }
#emailDetailModal .modal-body { max-height: calc(90vh - 160px); overflow: auto; }

#analysisModal { z-index: 2000; }
#templatePicker { z-index: 2100; }

.modal-overlay.show { opacity: 1; display: flex; }
.modal {
    background: white; border-radius: 20px; width: 90%; max-width: 900px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    transform: scale(0.95); transition: transform 0.3s ease;
    display: flex; flex-direction: column; max-height: 90vh;
}
.modal-overlay.show .modal { transform: scale(1); }
.modal-header {
    padding: 1.5rem 2rem; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid #e2e8f0; flex-shrink: 0;
}
.modal-title { font-size: 1.5rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.75rem; }
.modal-close { background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; transition: all 0.2s ease; }
.modal-close:hover { color: #1e293b; transform: rotate(90deg); }
.modal-body { padding: 2rem; overflow-y: auto; }
.modal-footer {
    padding: 1.5rem 2rem; display: flex; gap: 1rem; justify-content: flex-end;
    border-top: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0 0 20px 20px; flex-shrink: 0;
}
.analysis-section {
    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px;
    padding: 1.5rem; margin-bottom: 1.5rem;
}
.section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
.section-icon { font-size: 1.5rem; }
.section-title { font-size: 1.2rem; font-weight: 600; color: #1e293b; }
.section-content { color: #374151; line-height: 1.6; font-size: 0.95rem; }
.response-section { padding: 1.5rem 0; }
.response-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
.response-title { display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: 700; color: #0c4a6e; }
.response-content {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px;
    padding: 1.5rem; color: #374151; line-height: 1.7; font-size: 0.95rem;
    white-space: pre-wrap; /* Zachov√° form√°tov√°n√≠ odpovƒõdi od AI */
}
.btn-success { background: #22c55e; color: white; }
.loading {
    display: inline-block; width: 40px; height: 40px;
    border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
    border-radius: 50%; animation: spin 1s linear infinite;
}

.usage-panel { margin-top: 1rem; background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 1.25rem; }
.usage-title { margin: 0 0 1rem 0; color:#1e293b; font-weight: 600; }
.usage-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
.usage-card { border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem; transition: .2s ease; background:#f9fafb; }
.usage-card:hover { border-color:#667eea; box-shadow: 0 8px 25px rgba(102,126,234,.15); transform: translateY(-2px); }
.usage-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
.usage-name { font-weight:600; color:#1e293b; }
.usage-count { font-weight:700; color:#1e293b; }
.usage-bar { width:100%; height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
.usage-bar-fill { height:100%; background: linear-gradient(90deg,#667eea,#764ba2); width:0%; transition: width .4s ease; }
.usage-foot { margin-top:.5rem; color:#64748b; font-size:.9rem; }
.usage-period { margin-top: .75rem; color:#64748b; font-size:.9rem; }

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }




        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .tpl-help { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:1.25rem; margin-bottom: var(--section-gap);  }

.tpl-help h3 { margin:0 0 .75rem 0; font-size:1.15rem; color:#1e293b; }
.tpl-help .muted { color:#64748b; font-size:.92rem; }
.tpl-help .chip-grid { display:flex; flex-wrap:wrap; gap:.5rem; margin:.75rem 0 1rem 0; }
.tpl-help .chip { border:1px solid #e5e7eb; background:#f8fafc; border-radius:999px; padding:.35rem .65rem; font-size:.85rem; cursor:pointer; }
.tpl-help .chip:hover { background:#eef2ff; border-color:#c7d2fe; }
.tpl-help .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:.75rem; font-size:.9rem; }
.tpl-help .row { display:grid; grid-template-columns: 1.2fr .8fr; gap:1rem; }
@media (max-width: 900px){ .tpl-help .row{ grid-template-columns: 1fr; } }
.tpl-help .warn { margin-top:.6rem; color:#b45309; background:#fffbeb; border:1px solid #f59e0b33; padding:.6rem .75rem; border-radius:8px; font-size:.9rem; }
.tpl-help .ok { margin-top:.6rem; color:#065f46; background:#ecfdf5; border:1px solid #10b98133; padding:.6rem .75rem; border-radius:8px; font-size:.9rem; }
.tpl-help .btn-mini { display:inline-flex; align-items:center; gap:.4rem; border:none; border-radius:8px; padding:.5rem .7rem; background:#f1f5f9; cursor:pointer; }
.tpl-help .btn-mini:hover { background:#e2e8f0; }

        .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #94a3b8;
    height: 100%;
    /* P≈òID√ÅNO PRO VYCENTROV√ÅN√ç: */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 0 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: "ü§ñ";
            font-size: 1.8rem;
        }

        .collapse-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .collapse-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-menu {
            list-style: none;
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: white;
            border-radius: 2px;
        }

        .nav-icon {
            font-size: 1.2rem;
            min-width: 20px;
        }

        .nav-text {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
        }

        .sidebar.collapsed .logo span {
            display: none;
        }



        /* --- Oddƒõlen√≠ blok≈Ø a hlaviƒçka seznamu ≈°ablon --- */


.section-divider::before,
.section-divider::after {
  content: "";
  height: 1px;
  background: #e5e7eb;
  flex: 1;
}

:root { --section-gap: 1.5rem; } 



/* ‚Äûkarta‚Äú kolem seznamu ≈°ablon, aby byl vizu√°lnƒõ samostatnƒõ */
.templates-section {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  padding: 1rem 1rem 1.25rem ;
  margin-top: 0;
}

.templates-title{
  margin: 0 0 .75rem 0;
  font-weight: 700;
  color: #111827;
}

.templates-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: .75rem;
  margin-bottom: .75rem;
}
.templates-header .left {
 font-weight: 700;
  color: #111827;
}
.templates-header .left .sub {
  margin-left: .6rem;
  font-weight: 500;
  color: #6b7280;
  font-size: .95rem;
}
.templates-header .meta {
  color: #6b7280;
  font-size: .92rem;
}



.faq-generator-status {
    text-align: center;
    padding: 3rem 1.5rem;
    border: 2px dashed #e5e7eb;
    border-radius: 16px;
    background-color: #f9fafb;
    color: #4b5563;
  }
  .faq-spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #d1d5db;
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }
  .faq-status-text {
    font-weight: 500;
    font-size: 1.1rem;
  }
  .faq-status-subtext {
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #6b7280;
  }
  @keyframes spin { to { transform: rotate(360deg); } }


        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }

        .user-info {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
            background: #f1f5f9;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notifications:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Content Area */
        .content-area {
            padding: 2rem;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        #er-tags .tag {
  padding:.25rem .5rem;
  border:1px solid #e5e7eb;
  border-radius:999px;
  background:#f8fafc;
  font-size:.8rem;
  color:#475569;
}

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Overview */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.5rem;
            padding: 8px;
            border-radius: 10px;
            background: #f1f5f9;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: #16a34a;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        /* Email List */
        .email-list {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .email-list-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .email-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .email-item:hover {
            background: #f8fafc;
        }

        .email-item:last-child {
            border-bottom: none;
        }
        

        .email-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e2e8f0;
        }

        .email-status.unread {
            background: #3b82f6;
        }

        .email-status.processed {
            background: #16a34a;
        }

        .email-status.pending {
            background: #f59e0b;
        }

       .email-content {
            flex: 1;
            min-width: 0;
        }

        .email-sender {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
            overflow-wrap: anywhere;
        }

        .email-subject {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            overflow-wrap: anywhere;
        }

        .email-preview {
            color: #94a3b8;
            font-size: 0.8rem;
            overflow-wrap: anywhere;
        }

        .email-meta {
            text-align: right;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .email-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .email-item:hover .email-actions {
            opacity: 1;
        }

        .action-btn {
            background: #f1f5f9;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        /* === PLAN ‚Äì STYLING === */
.plan-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1.25rem;
  margin-top: .75rem;
}
.plan-card {
  position: relative;
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 16px;
  padding: 1.25rem;
  transition: all .25s ease;
  cursor: pointer;
  display: block;
}
.plan-card:has(.plan-input:checked) {
  outline: none;                 /* zru≈°√≠ p≈Øvodn√≠ outline */
  border-color: #667eea;         /* jemn√© zv√Ωraznƒõn√≠ r√°meƒçku karty */
  box-shadow: 0 10px 25px rgba(102,126,234,.15);
}
.plan-card:hover { border-color: #667eea; box-shadow: 0 10px 25px rgba(102,126,234,.15); transform: translateY(-2px); }
.plan-card.popular { border-color: #764ba2; }
.plan-input { display: none; }

.plan-inner { display: flex; flex-direction: column; gap: .75rem; }
.plan-badge {
  align-self: flex-start;
  background: linear-gradient(45deg,#667eea,#764ba2);
  color: #fff; font-size: .7rem; font-weight: 700;
  padding: .25rem .5rem; border-radius: 999px; letter-spacing: .5px;
}
.plan-head { display: flex; align-items: baseline; justify-content: space-between; gap: .75rem; }
.plan-name { font-weight: 700; color: #1e293b; }
.plan-price { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
.plan-price span { color:#64748b; font-weight:600; font-size:.9rem; }
.plan-features { list-style: none; color:#374151; display:flex; flex-direction:column; gap:.35rem; margin: .25rem 0 0 0; padding:0; font-size:.92rem; }
.plan-actions { margin-top: 1rem; display:flex; align-items:center; gap:.75rem; }

        .action-btn:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .action-btn.approve {
            background: #dcfce7;
            color: #16a34a;
        }

        .action-btn.reject {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Forms */
        .form-section {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .form-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-control {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control select {
            cursor: pointer;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Templates */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .template-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .template-name {
            font-weight: 600;
            color: #1e293b;
        }

        .template-actions {
            display: flex;
            gap: 0.5rem;
        }

        .template-preview {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .template-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Analytics */
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .chart-filters {
            display: flex;
            gap: 1rem;
        }

        .filter-btn {
            padding: 6px 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .chart-placeholder {
            height: 300px;
            background: #f8fafc;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 1.1rem;
        }

        /* Settings */
        .settings-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .settings-tab {
            padding: 1rem 0;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .settings-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
                background: #667eea;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
            }
             

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid #16a34a;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #dc2626;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        .page-container {
    width: 100%;
    max-width: 1500px; /* ZDE Mƒö≈áTE PO≈ΩADOVANOU ≈†√ç≈òKU */
    margin: 0 auto;    /* Toto vycentruje obsah na str√°nce */
}


.container {
    max-width: 900px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
}
.header {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    padding: 30px;
    text-align: center;
}
.header h1 {
    font-size: 28px;
    margin-bottom: 10px;
    font-weight: 600;
}
.header p {
    opacity: 0.9;
    font-size: 16px;
}
.content {
    padding: 30px;
}
.section-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.bulk-actions {
    display: flex;
    gap: 10px;
}
.bulk-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}
.bulk-btn.enable-all {
    background: #10b981;
    color: white;
}

.bulk-btn.disable-all {
    background: #ef4444;
    color: white;
}
.bulk-btn:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}
.email-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
}
.email-item {
    display: flex;
    align-items: center;
    padding: 20px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f9fafb;
}
.email-item:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}
.email-item.active {
    border-color: #10b981;
    background: linear-gradient(45deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
}
.checkbox-wrapper {
    position: relative;
    margin-right: 15px;
}
.checkbox-input {
    width: 20px;
    height: 20px;
    cursor: pointer;
    opacity: 0;
    position: absolute;
}
.checkbox-custom {
    width: 20px;
    height: 20px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
}
.checkbox-input:checked + .checkbox-custom {
    background: #10b981;
    border-color: #10b981;
}
.checkbox-custom::after {
    content: '‚úì';
    color: white;
    font-size: 12px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.checkbox-input:checked + .checkbox-custom::after {
    opacity: 1;
}
        
.email-info {
    flex: 1;
    min-width: 0;
}
.email-address {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    margin-bottom: 5px;
    overflow-wrap: anywhere;
}
.email-provider {
    font-size: 14px;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: wrap;
}
.provider-icon {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}



.modal.modal-full-width .response-section {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.modal.modal-full-width #response-editor {
    flex-grow: 1; /* Textov√© pole zabere v≈°echno voln√© m√≠sto */
    height: 100%;
}
.gmail-icon { background: #ea4335; }
.outlook-icon { background: #0078d4; }
.email-controls {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-left: 15px;
}
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    background: #f3f4f6;
    color: #6b7280;
}
.status-badge.active {
    background: #10b981;
    color: white;
}
.radio-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.3s ease;
}
.radio-wrapper:hover {
    background: rgba(102, 126, 234, 0.1);
}
.radio-wrapper.selected {
     background: transparent;   /* odstran√≠ ≈°ed√Ω obd√©ln√≠k uvnit≈ô */
    border: none;   
}
.radio-input {
    width: 16px;
    height: 16px;
    opacity: 0;
    position: absolute;
    cursor: pointer;
}
.radio-custom {
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
}
.radio-input:checked + .radio-custom {
    border-color: #667eea;
    background: #667eea;
}
.radio-custom::after {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: white;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.radio-input:checked + .radio-custom::after {
    opacity: 1;
}
.radio-label {
    font-size: 12px;
    font-weight: 500;
    color: #6b7280;
    user-select: none;
}
.disconnect-btn {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 50%;
    background: #ef4444;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    margin-left: 8px;
    opacity: 0.7;
}
.disconnect-btn:hover {
    opacity: 1;
    background: #dc2626;
    transform: scale(1.1);
}
.disconnect-icon {
    font-size: 16px;
    font-weight: bold;
    line-height: 1;
}
.add-account {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #6b7280;
    margin-top: 15px;
}
.add-account:hover {
    border-color: #667eea;
    color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

        
/* === MOD√ÅLN√ç OKNO === */
/* Overlay - p≈ôekryv cel√© obrazovky */
#modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    display: none; /* Skryt√© ve v√Ωchoz√≠m stavu */
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Kontejner mod√°ln√≠ho okna */
#modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 480px;
    transform: scale(0.9);
    animation: modalAppear 0.3s ease forwards;
}

@keyframes modalAppear { to { transform: scale(1); } }

/* Hlaviƒçka mod√°ln√≠ho okna */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid #e9ecef;
}
.modal-title {
    font-size: 1.4em;
    font-weight: 600;
    color: #2c3e50;
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
    transition: all 0.3s ease;
}
.modal-close:hover {
    color: #495057;
    transform: rotate(90deg);
}

/* Tƒõlo mod√°ln√≠ho okna */
.modal-body {
    padding: 24px;
}
.provider-buttons {
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.provider-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 16px 24px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    background: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #495057;
}
.provider-btn:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}
.provider-icon {
    width: 24px;
    height: 24px;
}


/* Styly pro nov√Ω header s filtry */
.emails-header { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
 .form-control { padding-left: 45px; }
.search-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.search-box {
    flex: 1;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 12px 16px 12px 45px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: white;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 1.1rem;
}

/* Hint pro v√Ωznam promƒõnn√Ωch */
.tpl-var-hint{
  display:none;
  margin-top:.5rem;
  font-size:.9rem;
  color:#334155;
  background:#eef2ff;
  border:1px solid #c7d2fe;
  padding:.5rem .75rem;
  border-radius:10px;
}
.tpl-var-hint strong{ color:#1f2937; }

/* schovej text ‚ÄûVa≈°e ≈°ablony‚Äú v headeru karty */
.templates-header .left { display: none; }
/* a≈• z≈Østane jen prav√° ƒç√°st s poƒçtem */
.templates-header { justify-content: flex-end; }



/* Styly pro Admin Dashboard */
       .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .admin-title { font-size: 2rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.75rem; }
    .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; }
    .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .stat-title { font-size: 0.9rem; color: #64748b; font-weight: 500; }
    .stat-icon { font-size: 1.5rem; padding: 8px; border-radius: 10px; background: #f1f5f9; }
    .stat-value { font-size: 2rem; font-weight: 700; color: #1e293b; }
    .users-section { background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; overflow: hidden; }
    .section-header { padding: 1.5rem 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; flex-wrap: wrap; gap: 1rem; }
    .section-title { font-size: 1.3rem; font-weight: 600; color: #1e293b; }
    .search-filters { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .search-box { position: relative; }
    .search-input { padding: 8px 12px 8px 35px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; width: 250px; }
    .search-input:focus { outline: none; border-color: #667eea; }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
    .filter-select { padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background: white; cursor: pointer; }
    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th, .users-table td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid #f1f5f9; }
    .users-table th { background: #f8fafc; font-weight: 600; color: #374151; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .users-table tbody tr:hover { background: #f8fafc; }
    .user-info-cell { display: flex; align-items: center; gap: 0.75rem; }
    .user-avatar-small { width: 32px; height: 32px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: 600; }
    .user-details { display: flex; flex-direction: column; }
    .user-name { font-weight: 600; color: #1e293b; }
    .user-email { font-size: 0.875rem; color: #64748b; }
    .role-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .role-admin { background: #fef3c7; color: #92400e; }
    .role-user { background: #dbeafe; color: #1e40af; }
    .action-buttons { display: flex; gap: 0.5rem; }
    .btn-sm { padding: 4px 8px; font-size: 0.75rem; } 


    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>AI Emailov√Ω Agent</span>
                </div>
                <button class="collapse-btn" id="collapseBtn">
                    <span>‚Üê</span>
                </button>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-page="dashboard">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="emails">
                            <span class="nav-icon">üìß</span>
                            <span class="nav-text">Emaily</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="templates">
                            <span class="nav-icon">üìù</span>
                            <span class="nav-text">≈†ablony</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="settings">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span class="nav-text">Nastaven√≠</span>
                        </a>
                    </li>
                    <li class="nav-item" id="admin-menu-item" style="display: none;">
                        <a href="#" class="nav-link" data-page="admin">
                            <span class="nav-icon">üëë</span>
                            <span class="nav-text">Admin</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="analytics">
                            <span class="nav-icon">üìà</span>
                            <span class="nav-text">Analytika</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="integrations">
                            <span class="nav-icon">üîó</span>
                            <span class="nav-text">Integrace</span>
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="user-info">
    <button class="notifications">
        <span>üîî</span>
        <span class="notification-badge">3</span>
    </button>
    <span id="user-name-display" style="font-weight: 500;"></span>
    <div class="user-avatar"></div>
    <button id="logout-button" style="border:none; background:#f1f5f9; padding:8px 12px; border-radius:8px; cursor:pointer;">Odhl√°sit se</button>
</div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Page -->
                <div class="page-content active" id="dashboard">
                    <div class="page-container"><div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">Zpracovan√© emaily</span>
                                <span class="stat-icon">üìß</span>
                            </div>
                            <div class="stat-value">1,247</div>
                            <div class="stat-change positive">
                                <span>‚Üó</span>
                                <span>+15% tento t√Ωden</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">U≈°et≈ôen√Ω ƒças</span>
                                <span class="stat-icon">‚è∞</span>
                            </div>
                            <div class="stat-value">24.5h</div>
                            <div class="stat-change positive">
                                <span>‚Üó</span>
                                <span>+8% tento mƒõs√≠c</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">√öspƒõ≈°nost AI</span>
                                <span class="stat-icon">üéØ</span>
                            </div>
                            <div class="stat-value">94.2%</div>
                            <div class="stat-change positive">
                                <span>‚Üó</span>
                                <span>+2.1% dnes</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">Aktivn√≠ ≈°ablony</span>
                                <span class="stat-icon">üìù</span>
                            </div>
                            <div class="stat-value">12</div>
                            <div class="stat-change">
                                <span>‚Üí</span>
                                <span>Beze zmƒõny</span>
                            </div>
                        </div>
                    </div>
                    </div>

                    <div class="email-list">
                        <div class="email-list-header">
                            <h3>Posledn√≠ emaily</h3>
                        </div>
                        
                        <div class="email-item">
                            <div class="email-status processed"></div>
                            <div class="email-content">
                                <div class="email-sender">Petr Svoboda</div>
                                <div class="email-subject">Re: Sch≈Øzka ohlednƒõ projektu</div>
                                <div class="email-preview">Dƒõkuji za rychlou odpovƒõƒè. Term√≠n mi vyhovuje...</div>
                            </div>
                            <div class="email-meta">
                                <div>15:42</div>
                                <div>Odpovƒõzeno AI</div>
                            </div>
                        </div>
                        
                        <div class="email-item">
                            <div class="email-status pending"></div>
                            <div class="email-content">
                                <div class="email-sender">Marie Nov√°kov√°</div>
                                <div class="email-subject">Dotaz na va≈°e slu≈æby</div>
                                <div class="email-preview">Dobr√Ω den, chtƒõla bych se zeptat na mo≈ænost...</div>
                            </div>
                            <div class="email-meta">
                                <div>14:28</div>
                                <div>ƒåek√° na schv√°len√≠</div>
                            </div>
                            <div class="email-actions">
                                <button class="action-btn approve">‚úì Schv√°lit</button>
                                <button class="action-btn reject">‚úó Zam√≠tnout</button>
                            </div>
                        </div>
                        
                        <div class="email-item">
                            <div class="email-status unread"></div>
                            <div class="email-content">
                                <div class="email-sender">Jan Proch√°zka</div>
                                <div class="email-subject">P≈ôipom√≠nky k n√°vrhu</div>
                                <div class="email-preview">Ahoj, m√°m nƒõkolik p≈ôipom√≠nek k tv√©mu n√°vrhu...</div>
                            </div>
                            <div class="email-meta">
                                <div>13:15</div>
                                <div>Nov√Ω</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emails Page -->



                <div class="page-content" id="emails">
                <div class="emails-header">
                    <h3>Spr√°va email≈Ø</h3>
                    <br>
    <div class="search-container">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="search" class="form-control" placeholder="Vyhledat emaily " id="search-bar">
        </div>
    </div>
    <div class="filter-row">
        <select class="form-control" id="status-filter">
            <option value="all">V≈°echny stavy</option>
                    <option value="unread">üìß Nep≈ôeƒçten√©</option>
                    <option value="processed">‚úÖ Zpracovan√©</option>
                    <option value="approval">‚è≥ ƒåekaj√≠c√≠</option>
                    <option value="spam">üö´ Spam</option>
        </select>
        <select class="form-control" id="period-filter">
            <option value="all">V≈°echna obdob√≠</option>
                    <option value="today">üìÖ Dnes</option>
                    <option value="week">üìÖ Tento t√Ωden</option>
                    <option value="month">üìÖ Tento mƒõs√≠c</option>
        </select>
       
    </div>
</div>


<div class="email-list">
    <div class="email-list-header">
        <h3 id="email-count-header">V≈°echny emaily</h3>
    </div>
    <div id="email-list-container">
        <div style="padding: 2rem; text-align: center; color: #94a3b8;">
            üìß Naƒç√≠t√°m emaily...
        </div>
    </div>
</div>
                    <div class="modal-overlay" id="templatePicker">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">üìö Vyberte ≈°ablonu</h2>
      <button class="modal-close" id="closeTemplatePicker">&times;</button>
    </div>

    <div class="modal-body">
      <div class="form-grid" style="margin-bottom:1rem;">
        <div class="form-group">
          <label class="form-label">Hledat</label>
          <input id="tplSearch" class="form-control" placeholder="N√°zev nebo text ≈°ablony...">
        </div>
        <div class="form-group">
          <label class="form-label">Kategorie</label>
          <select id="tplCategory" class="form-control">
            <option>V≈°e</option>
            <option>Obecn√©</option>
            <option>Obchodn√≠</option>
            <option>Podpora</option>
            <option>Sch≈Øzky</option>
          </select>
        </div>
      </div>

      <div id="tplPickerList" class="template-grid">
        <!-- sem se renderuj√≠ ≈°ablony (refreshPickerList) -->
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" id="cancelTplPicker">Zav≈ô√≠t</button>
    </div>
  </div>
</div>

<!-- Email Detail Modal -->
<div class="modal-overlay" id="emailDetailModal">
  <div class="modal pro-modal">
    <!-- Header -->
    <div class="pro-modal__header">
      <div class="pro-modal__id">
        <div class="pro-avatar" id="ed-avatar" aria-hidden="true">‚úâÔ∏è</div>
        <div class="pro-headings">
          <div class="pro-title" id="ed-subject">Bez p≈ôedmƒõtu</div>
          <div class="pro-subtitle">
            <span id="ed-from">‚Äî</span>
            <span class="pro-dot">‚Ä¢</span>
            <span id="ed-date">‚Äî</span>
          </div>
        </div>
      </div>
      <div class="pro-actions">
        <button class="btn btn-secondary pro-chip" id="ed-copy">
          <span>Copy</span>
        </button>
        <button class="btn btn-primary" id="ed-reply-open">Odpovƒõdƒõt</button>
        <button class="pro-close" id="closeEmailDetail" aria-label="Zav≈ô√≠t">‚úï</button>
      </div>
    </div>




    <!-- Body -->
    <div class="pro-modal__body">
      <div class="pro-meta">
        <div class="pro-meta__row">
          <div class="pro-meta__label">Odes√≠latel</div>
          <div class="pro-meta__value" id="ed-from-meta">‚Äî</div>
        </div>
        <div class="pro-meta__row">
          <div class="pro-meta__label">P≈ôedmƒõt</div>
          <div class="pro-meta__value" id="ed-subject-meta">‚Äî</div>
        </div>
        <div class="pro-meta__row">
          <div class="pro-meta__label">Datum</div>
          <div class="pro-meta__value" id="ed-date-meta">‚Äî</div>
        </div>
      </div>

      <div class="pro-body-card">
        <div class="pro-body-card__title">Obsah zpr√°vy</div>
        <div class="pro-body-card__content" id="ed-body">Naƒç√≠t√°m‚Ä¶</div>
      </div>

      <div class="pro-body-card" id="ed-ai-card" style="display: none;">
        <div class="pro-body-card__title">N√°vrh odpovƒõdi (AI)</div>
        <div class="pro-body-card__content">
          <div style="color:#0f172a; margin-bottom:12px; line-height:1.6;">
            <div><strong>Shrnut√≠:</strong> <span id="ed-ai-summary">‚Äî</span></div>
            <div><strong>Sentiment:</strong> <span id="ed-ai-sentiment">‚Äî</span></div>
          </div>
          <div id="ed-ai-reply" style="white-space: pre-wrap; line-height:1.55; color:#111827;"></div>
        </div>
      </div>
    </div>


      
    <!-- Footer -->
    <div class="pro-modal__footer">
      <button class="btn btn-secondary" id="closeEmailDetailBottom">Zav≈ô√≠t</button>
      <button class="btn btn-primary" id="ed-reply-bottom">Odpovƒõdƒõt</button>
    </div>
  </div>
</div>




                </div>

                <!-- Templates Page -->
                <div class="page-content" id="templates">
                    <div class="form-section">
                        <h3>Vytvo≈ôit novou ≈°ablonu</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">N√°zev ≈°ablony</label>
                                <input type="text" id="tpl-name" class="form-control" placeholder="nap≈ô. Odpovƒõƒè na dotaz">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kategorie</label>
                                <select id="tpl-category" class="form-control">
                                    <option>Obecn√©</option>
                                    <option>Obchodn√≠</option>
                                    <option>Podpora</option>
                                    <option>Sch≈Øzky</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Obsah ≈°ablony</label>
                            <textarea id="tpl-content" class="form-control" placeholder="Text ≈°ablony‚Ä¶"></textarea>
                        </div>
                        <button id="tpl-save-btn" class="btn btn-primary"><span>üíæ</span> Ulo≈æit ≈°ablonu</button>
                    </div>


<div class="tpl-help" id="tpl-help">
  <h3>üß© N√°povƒõda k ≈°ablon√°m</h3>
  <div class="muted">
    Do textu vkl√°dej promƒõnn√© ve tvaru <code>{{nazev}}</code>. P≈ôi vlo≈æen√≠ do emailu se pokus√≠me chybƒõj√≠c√≠ √∫daje doplnit z analyzovan√©ho emailu.
  </div>

  <div class="row" style="margin-top:.75rem;">
    <div>
      <div class="muted">Dostupn√© promƒõnn√© (kliknut√≠m vlo≈æ√≠≈° na kurzor do pole ‚ÄûObsah ≈°ablony‚Äú):</div>
      <div class="chip-grid" id="tpl-chip-grid"></div>

      <div class="muted" style="margin-top:.75rem;">AI slot (generativn√≠ √∫sek v hranat√Ωch z√°vork√°ch):</div>
      <div class="code">[[AI: Napi≈° struƒçn√Ω odstavec shrnuj√≠c√≠ d≈Øvod reklamace a dal≈°√≠ postup.]]</div>
      <div style="margin-top:.5rem;">
        <button class="btn-mini" id="btn-insert-ai">‚ûï Vlo≈æit AI slot</button>
        <button class="btn-mini" id="btn-insert-example">üìã Vlo≈æit uk√°zkovou ≈°ablonu</button>
      </div>
    </div>

    <div>
      <div class="muted">Kontrola ≈°ablony</div>
      <div id="tpl-validator" class="ok">≈Ω√°dn√© nezn√°m√© promƒõnn√©.</div>
      <div class="muted" style="margin-top:.75rem;">
        Tipy:
        <ul style="margin:.35rem 0 0 1rem;">
          <li>Pou≈æij <b>{{recipientName}}</b> pro zdvo≈ôil√© osloven√≠ (‚Äûpan√≠ Nov√°kov√°‚Äú / ‚Äûpane Dvo≈ô√°ku‚Äú).</li>
          <li>Nezn√°m√© hodnoty nech√°v√°me pr√°zdn√©; m≈Ø≈æe≈° je dopsat ruƒçnƒõ.</li>
          <li>AI sloty pi≈° ƒçesky a konkr√©tnƒõ, bez ‚Äûvypl≈à si s√°m‚Äú instrukc√≠.</li>
        </ul>
      </div>
    </div>
  </div>
</div>



<div class="templates-section">
  <h3 class="templates-title">üìÅ Va≈°e ≈°ablony</h3>
  <div class="template-grid" id="tpl-list"></div>
</div>
                    


                </div>

                <!-- Settings Page -->
   
<div class="page-content" id="settings">
    <div class="settings-tabs">
        <div class="settings-tab active" data-tab="ai">AI Nastaven√≠</div>
        <div class="settings-tab" data-tab="email">Email √∫ƒçty</div>
        <div class="settings-tab" data-tab="plan">Pl√°n</div>
        <div class="settings-tab" data-tab="notifications">Notifikace</div>
        <div class="settings-tab" data-tab="security">Zabezpeƒçen√≠</div>
        <div class="settings-tab" data-tab="faq">FAQ</div>
    </div>

    <div class="settings-content" id="ai-settings">
    <form id="settings-form">
        <div class="form-section">
            <h3>Styl odpovƒõd√≠</h3>

            <div class="form-group" style="display:flex;gap:.75rem;align-items:center;">
  <span id="learn-style-status" class="muted" style="color:#64748b;"></span>
</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">T√≥n komunikace</label>
                    <select class="form-control" id="tone-select">
                        <option>Form√°ln√≠</option>
                        <option>Neform√°ln√≠</option>
                        <option>P≈ô√°telsk√Ω</option>
                        <option>Profesion√°ln√≠</option>
                        <option>Struƒçn√Ω</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">D√©lka odpovƒõd√≠</label>
                    <select class="form-control" id="length-select">
                        <option>Kr√°tk√° (1-2 vƒõty)</option>
                        <option>St≈ôedn√≠ (1 odstavec)</option>
                        <option>Dlouh√° (v√≠ce odstavc≈Ø)</option>
                        <option>Adaptivn√≠</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Osobn√≠ podpis</label>
                <textarea class="form-control" id="signature-textarea" placeholder="S pozdravem,&#10;Jan Nov√°k..."></textarea>
            </div>
        </div>

        <div class="form-section">
            <h3>Automatizace</h3>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Automatick√© odpovƒõdi</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Povol√≠ AI automaticky odpov√≠dat na rutinn√≠ emaily</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="auto-reply-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Schvalov√°n√≠ d≈Øle≈æit√Ωch email≈Ø</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Vy≈æaduje va≈°e schv√°len√≠ pro d≈Øle≈æit√© zpr√°vy</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="approval-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Spam filtr</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Automaticky filtruje nevy≈æ√°dan√© zpr√°vy</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="spam-filter-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">
            <span>üíæ</span>
            Ulo≈æit nastaven√≠
        </button>
    </form>





                    </div>

                    <!-- Email Accounts Tab -->
    <div class="settings-content" id="email-settings" style="display: none;">               
<div class="container" style="max-width: 100%; box-shadow: none; border-radius: 0;">
    <div class="header" style="padding: 20px; text-align: left; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
        
    </div>
    <div class="content" style="padding: 20px;">
        <div class="section-title">
    <span>P≈ôipojen√© √∫ƒçty</span>
    <div style="display: flex; align-items: center; gap: 20px;">
        <div style="font-size: 14px; color: #667eea; font-weight: 500;">
            üìù Nastavuji: <span id="currentConfigEmail"></span>
        </div>
        <div class="bulk-actions">
            <button class="bulk-btn enable-all" onclick="enableAllAccounts()">Aktivovat v≈°e</button>
            <button class="bulk-btn disable-all" onclick="disableAllAccounts()">Deaktivovat v≈°e</button>
        </div>
    </div>
</div>
<div class="email-list">
    </div>
<div class="add-account" onclick="addAccount()">
    <span>+ P≈ôidat dal≈°√≠ emailov√Ω √∫ƒçet</span>
</div>


    </div>
    </div> 
</div>

<!-- === PLAN SETTINGS === -->
<div class="settings-content" id="plan-settings" style="display: none;">
  <div class="form-section">
    <h3>Vyberte tarif</h3>

    <div class="plan-grid">
      <!-- Starter -->
      <label class="plan-card">
        <input type="radio" name="plan" value="Starter" class="plan-input">
        <div class="plan-inner">
          <div class="plan-head">
            <div class="plan-name">Starter</div>
            <div class="plan-price">Zdarma</div>
          </div>
          <ul class="plan-features">
            <li>‚úì A≈æ 50 email≈Ø mƒõs√≠ƒçnƒõ</li>
            <li>‚úì 1 emailov√Ω √∫ƒçet</li>
            <li>‚úì Z√°kladn√≠ ≈°ablony</li>
            <li>‚úì Email podpora</li>
          </ul>
        </div>
      </label>

      <!-- Professional -->
      <label class="plan-card popular">
        <input type="radio" name="plan" value="Professional" class="plan-input">
        <div class="plan-inner">
          <div class="plan-badge">NEJPOPUL√ÅRNƒöJ≈†√ç</div>
          <div class="plan-head">
            <div class="plan-name">Professional</div>
            <div class="plan-price">490 Kƒç <span>/ mƒõs√≠c</span></div>
          </div>
          <ul class="plan-features">
            <li>‚úì Neomezen√© emaily</li>
            <li>‚úì 5 emailov√Ωch √∫ƒçt≈Ø</li>
            <li>‚úì Vlastn√≠ ≈°ablony</li>
            <li>‚úì Kalend√°≈ôov√° integrace</li>
            <li>‚úì Pokroƒçil√© analytics</li>
            <li>‚úì Priority podpora</li>
          </ul>
        </div>
      </label>

      <!-- Enterprise -->
      <label class="plan-card">
        <input type="radio" name="plan" value="Enterprise" class="plan-input">
        <div class="plan-inner">
          <div class="plan-head">
            <div class="plan-name">Enterprise</div>
            <div class="plan-price">1 490 Kƒç <span>/ mƒõs√≠c</span></div>
          </div>
          <ul class="plan-features">
            <li>‚úì Neomezen√© emaily</li>
            <li>‚úì Neomezen√© √∫ƒçty</li>
            <li>‚úì Team management</li>
            <li>‚úì API p≈ô√≠stup</li>
            <li>‚úì White-label ≈ôe≈°en√≠</li>
            <li>‚úì Dedikovan√° podpora</li>
            <li>‚úì SLA garance</li>
          </ul>
        </div>
      </label>
    </div>

    <div class="plan-actions">
      <button id="save-plan-btn" class="btn btn-primary">üíæ Ulo≈æit pl√°n</button>
      <span id="current-plan-badge" class="status-badge" style="margin-left:10px;">Aktu√°ln√≠: ‚Äî</span>
    </div>
  </div>
  <div class="usage-panel" id="usage-panel" style="display:none;">
  <h4 class="usage-title">Vyu≈æit√≠ tohoto mƒõs√≠ce</h4>

  <div class="usage-grid">
    <!-- AI akce -->
    <div class="usage-card">
      <div class="usage-head">
        <div class="usage-name">AI akce</div>
        <div class="usage-count"><span id="ai-used">0</span>/<span id="ai-limit">0</span></div>
      </div>
      <div class="usage-bar"><div class="usage-bar-fill" id="ai-bar" style="width:0%"></div></div>
      <div class="usage-foot"><span id="ai-left">0</span> zb√Ωv√°</div>
    </div>

    <!-- P≈ôipojen√© √∫ƒçty -->
    <div class="usage-card">
      <div class="usage-head">
        <div class="usage-name">P≈ôipojen√© √∫ƒçty</div>
        <div class="usage-count"><span id="acc-count">0</span>/<span id="acc-limit">0</span></div>
      </div>
      <div class="usage-bar"><div class="usage-bar-fill" id="acc-bar" style="width:0%"></div></div>
      <div class="usage-foot">Limit pro aktu√°ln√≠ tarif</div>
    </div>
  </div>

  <div class="usage-period" id="usage-period"></div>
</div>
</div>








                    <!-- Notifications Tab -->
                    <div class="settings-content" id="notifications-settings" style="display: none;">
                        <div class="form-section">
                            <h3>Notifikace</h3>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Email notifikace</strong>
                                    <div style="color: #64748b; font-size: 0.9rem;">Dost√°vat upozornƒõn√≠ na email</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Push notifikace</strong>
                                    <div style="color: #64748b; font-size: 0.9rem;">Zobrazovat notifikace v prohl√≠≈æeƒçi</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="settings-content" id="security-settings" style="display: none;">
                        <div class="form-section">
                            <h3>Zabezpeƒçen√≠</h3>
                            <div class="form-group">
                                <label class="form-label">Zmƒõna hesla</label>
                                <input type="password" id="cur-pass" class="form-control" placeholder="Souƒçasn√© heslo">
                            </div>
                            <div class="form-group">
                                <input type="password" id="new-pass" class="form-control" placeholder="Nov√© heslo">
                            </div>
                            <div class="form-group">
                                <input type="password" id="new-pass2" class="form-control" placeholder="Potvrzen√≠ nov√©ho hesla">
                            </div>
                            <button class="btn btn-primary" id="btn-change-pass">Zmƒõnit heslo</button>
                        </div>

                        <div class="form-section">
                            <h3>Dvoufaktorov√© ovƒõ≈ôen√≠</h3>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>2FA</strong>
                                    <div style="color: #64748b; font-size: 0.9rem;">Zv√Ω≈°te zabezpeƒçen√≠ sv√©ho √∫ƒçtu</div>
                                </div>
                                <button class="btn btn-primary">Povolit 2FA</button>
                            </div>
                        </div>
                    </div>

<!-- FAQ Tab -->
<div class="settings-content" id="faq-settings" style="display:none;">
  <div class="form-section">
    <h3>FAQ pro √∫ƒçet</h3>

    <div class="form-group">
      <label class="form-label">Aktivn√≠ √∫ƒçet</label>
      <!-- uk√°≈æe aktu√°ln√≠ primaryEmail jen pro informaci -->
      <div id="faq-current-account" class="muted" style="padding:.35rem .5rem;background:#f1f5f9;border-radius:.5rem;"></div>
    </div>

    <div class="form-group" style="display:flex; gap:.5rem; flex-wrap:wrap;">
      <button id="faq-add-btn" class="btn btn-primary"><span>‚ûï</span> P≈ôidat FAQ polo≈æku</button>
      <button id="faq-save-all-btn" class="btn"><span>üíæ</span> Ulo≈æit zmƒõny</button>
    </div>

    <div id="faq-list" style="display:grid; gap:.5rem;">
      <!-- dynamicky se sem vykresl√≠ jednotliv√© polo≈æky FAQ -->
    </div>

    <div class="muted" style="margin-top:.75rem;">
      Tip: FAQ se ukl√°d√° **per √∫ƒçet**. P≈ôepni prim√°rn√≠ √∫ƒçet vpravo naho≈ôe (pokud to u tebe m√°≈°), nebo dle toho, jak dnes vyb√≠r√°≈° aktivn√≠ schr√°nku.
    </div>
  </div>
</div>


                </div>

                </div>





                






                <!-- Analytics Page -->
                <div class="page-content" id="analytics">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Pr≈Ømƒõrn√° doba odpovƒõdi</h3>
            </div>
            <div class="chart-placeholder">
                <canvas id="responseTimeChart" style="height:300px"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Kvalita odpovƒõd√≠ AI</h3>
            </div>
            <div class="chart-placeholder">
                <canvas id="aiQualityChart" style="height:300px"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-header">
            <h3 class="chart-title">Nejƒçastƒõji pou≈æ√≠van√© ≈°ablony</h3>
            <div class="chart-filters">
                <button class="filter-btn active" data-days="7">7 dn√≠</button>
                <button class="filter-btn" data-days="30">30 dn√≠</button>
                <button class="filter-btn" data-days="90">3 mƒõs√≠ce</button>
            </div>
        </div>
        <div class="chart-placeholder">
            <canvas id="templateUsageChart" style="height:300px"></canvas>
        </div>
    </div>
</div>

                <!-- Integrations Page -->
                <div class="page-content" id="integrations">
                    <div class="form-section">
                        <h3>Dostupn√© integrace</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div style="border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <span style="font-size: 2rem;">üìÖ</span>
                                    <div>
                                        <h4 style="margin: 0; color: #1e293b;">Google Calendar</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Automatick√© pl√°nov√°n√≠ sch≈Øzek</p>
                                    </div>
                                </div>
                                <button class="btn btn-primary" style="width: 100%;">P≈ôipojit</button>
                            </div>

                            <div style="border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <span style="font-size: 2rem;">üíº</span>
                                    <div>
                                        <h4 style="margin: 0; color: #1e293b;">Slack</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Notifikace o d≈Øle≈æit√Ωch emailech</p>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" style="width: 100%;">P≈ôipravuje se</button>
                            </div>

                            <div style="border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <span style="font-size: 2rem;">üìä</span>
                                    <div>
                                        <h4 style="margin: 0; color: #1e293b;">CRM syst√©my</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Synchronizace s va≈°√≠m CRM</p>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" style="width: 100%;">P≈ôipravuje se</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
<!-- Admin Page -->
 <div class="page-content" id="admin">
<div class="admin-stats">
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">Celkem u≈æivatel≈Ø</span><span class="stat-icon">üë•</span></div><div class="stat-value" id="admin-total-users">-</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">Plat√≠c√≠ z√°kazn√≠ci</span><span class="stat-icon">‚≠ê</span></div><div class="stat-value" id="admin-paying-users">-</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">P≈ôipojen√© emaily</span><span class="stat-icon">üìß</span></div><div class="stat-value" id="admin-connected-emails">-</div></div>
                        <div class="stat-card"><div class="stat-header"><span class="stat-title">AI akce dnes</span><span class="stat-icon">ü§ñ</span></div><div class="stat-value" id="admin-ai-today">-</div></div>
                    </div>
                    <div class="users-section">
                        <div class="section-header">
                            <h2 class="section-title">Spr√°va u≈æivatel≈Ø</h2>
                            <div class="search-filters">
                                <div class="search-box"><span class="search-icon">üîç</span><input type="search" class="search-input" placeholder="Hledat u≈æivatele..." id="userSearch"></div>
                                <select class="filter-select" id="roleFilter"><option value="all">V≈°echny role</option><option value="admin">Admin</option><option value="user">U≈æivatel</option></select>
                            </div>
                        </div>
                        <table class="users-table">
                        <thead>
  <tr>
    <th>U≈æivatel</th>
    <th>Pl√°n</th>
    <th>Role</th>
    <th>Datum registrace</th>
    <th>AI akce (m)</th>
    <th>Tokeny (m)</th>
    <th>Akce</th>
  </tr>
</thead>
<tbody id="adminUsersTableBody"></tbody>
</table>
                    </div>
                    <div class="users-section" style="margin-top: 2rem;">
                        <div class="section-header">
                            <h2 class="section-title">Posledn√≠ aktivita</h2>
                            <button class="btn btn-primary btn-sm" id="refresh-log-btn">üîÑ Obnovit</button>
                        </div>
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>ƒåas</th>
                                    <th>U≈æivatel</th>
                                    <th>Akce</th>
                                    <th>Status</th>
                                    <th>Detaily</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogTableBody">
                                </tbody>
                        </table>
                    </div>
</div>

            </div>
              







        </main>


        <div class="modal-overlay" id="editUserModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title"><span>‚úèÔ∏è</span> Upravit u≈æivatele</h2>
                <button class="modal-close" data-close-modal>&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="form-group">
                        <label class="form-label">Jm√©no</label>
                        <input type="text" class="form-control" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email (pouze pro ƒçten√≠)</label>
                        <input type="email" class="form-control" id="editEmail" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-control" id="editRole">
                            <option value="user">U≈æivatel</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close-modal>Zru≈°it</button>
                <button class="btn btn-primary" id="saveUserBtn">üíæ Ulo≈æit zmƒõny</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div id="toastMessage">Nastaven√≠ bylo √∫spƒõ≈°nƒõ ulo≈æeno!</div>
    </div>
    <div id="modal-overlay">
    <div id="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">P≈ôipojit nov√Ω emailov√Ω √∫ƒçet</h2>
            <button class="modal-close" id="modal-close-btn" aria-label="Zav≈ô√≠t">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="provider-buttons">
                <button class="provider-btn google" id="connect-google-btn">
                    <svg class="provider-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    P≈ôipojit p≈ôes Google
                </button>
                 <button class="provider-btn custom" id="connect-custom-btn">
                    <svg class="provider-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="#28a745" stroke-width="2" fill="none"/>
                        <polyline points="22,6 12,13 2,6" stroke="#28a745" stroke-width="2" fill="none"/>
                    </svg>
                    P≈ôipojit p≈ôes Custom Email
                </button>
            </div>
        </div>
    </div>
</div>





<div class="modal-overlay" id="analysisModal">
    <div class="modal">
        <div class="modal-header">
    <h2 class="modal-title"><span>ü§ñ</span> AI Anal√Ωza emailu</h2>
    <button class="modal-close" id="closeAnalysisModal">&times;</button>
</div>

<div class="modal-body" id="analysisModalBody">
    
    <div id="analysis-summary-section"></div>

    <div class="response-section">
        <div class="response-header">
            <div class="response-title">
                <span>‚ú®</span> Doporuƒçen√° odpovƒõƒè
            </div>
        </div>
        <div class="response-content" id="response-display"></div>
        <textarea class="form-control" id="response-editor" style="display: none; width: 100%; min-height: 150px; margin-top: 1rem;"></textarea>
    </div>

</div>

<div class="modal-footer" id="analysis-footer">
  <button class="btn btn-secondary" id="edit-reply-btn"><span>üìù</span> Upravit odpovƒõƒè</button>
  <button class="btn btn-primary"  id="save-edit-btn"   style="display:none;"><span>üíæ</span> Ulo≈æit zmƒõny</button>
  <button class="btn btn-link"     id="cancel-edit-btn" style="display:none;">Zru≈°it √∫pravy</button>

  <button class="btn btn-success"  id="send-now-btn"><span>üì§</span> Odeslat nyn√≠</button>
  <button class="btn btn-secondary" id="pick-template-btn">üìö Vybrat ≈°ablonu</button>
</div>
    </div>
</div>




    <script>
// ===================================================================================
// === 1. DEKLARACE GLOB√ÅLN√çCH PROMƒöNN√ùCH ===========================================
// ===================================================================================
const sidebar = document.getElementById('sidebar');
const collapseBtn = document.getElementById('collapseBtn');
const navLinks = document.querySelectorAll('.nav-link');
const pageContents = document.querySelectorAll('.page-content');
const pageTitle = document.getElementById('pageTitle');
const settingsTabs = document.querySelectorAll('.settings-tab');
const settingsContents = document.querySelectorAll('.settings-content');
const emailListContainer = document.getElementById('email-list-container');
const emailCountHeader = document.getElementById('email-count-header');
const modal = document.getElementById('modal-overlay');
const closeModalBtn = document.getElementById('modal-close-btn');
const googleBtn = document.getElementById('connect-google-btn');
const settingsForm = document.getElementById('settings-form');
const toneSelect = document.getElementById('tone-select');
const lengthSelect = document.getElementById('length-select');
const signatureTextarea = document.getElementById('signature-textarea');
const autoReplySwitch = document.getElementById('auto-reply-switch');
const approvalSwitch = document.getElementById('approval-switch');
const spamFilterSwitch = document.getElementById('spam-filter-switch');
const statusFilter = document.getElementById('status-filter');
const periodFilter = document.getElementById('period-filter');
const analysisModal = document.getElementById('analysisModal');
const closeAnalysisModalBtn = document.getElementById('closeAnalysisModal');
const searchBar = document.getElementById('search-bar');


// === Modal helpers: ulo≈æit v√Ωchoz√≠ obsah a mo≈ænost ho vr√°tit ===
const modalBodyEl = document.querySelector('#modal-content .modal-body');
const DEFAULT_PROVIDER_HTML = modalBodyEl ? modalBodyEl.innerHTML : '';

function restoreProviderChooser() {
  if (!modalBodyEl || !DEFAULT_PROVIDER_HTML) return;
  modalBodyEl.innerHTML = DEFAULT_PROVIDER_HTML;

  // znovu nav√°zat kliky na tlaƒç√≠tka v chooseru
  document.getElementById('connect-google-btn')?.addEventListener('click', connectGoogleAccount);
  document.getElementById('connect-custom-btn')?.addEventListener('click', openCustomConnect);
}


let connectedAccounts = []; // [{ email: string, active: boolean }]
function getConnectedAccounts() { return connectedAccounts || []; }
function setConnectedAccounts(arr) { connectedAccounts = Array.isArray(arr) ? arr : []; }

let allEmails = [];
let currentMessageId = null;


window.__lastUsedTemplateId = null;




const dashboardUserEmail = localStorage.getItem('userEmail'); // majitel dashboardu (p≈ôihl√°≈°en√Ω)
let primaryEmail = localStorage.getItem('primaryEmail') || '';
// =============== SYNC P≈òIPOJEN√ùCH √öƒåT≈Æ S BACKENDEM (P≈òIDEJ) ===============
async function fetchConnectedEmailsFromServer() {
if (!dashboardUserEmail) return [];

  const urls = [
    `https://ai-email-server-stejdesign.onrender.com/api/accounts?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`,
    `https://ai-email-server-stejdesign.onrender.com/api/accounts/list?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`
  ];

  for (const u of urls) {
    try {
      const r = await fetch(u, { cache: 'no-store' });  // <<< d≈Øle≈æit√©
      const j = await r.json();
      if (j && j.success) {
        if (Array.isArray(j.accounts)) return j.accounts;                         // [{email, active}]
        if (Array.isArray(j.emails))   return j.emails.map(e => ({ email: e, active: true }));
      }
    } catch (_) {}
  }
  return [];
}

function getConnectedEmailsLS() {
  try { return JSON.parse(localStorage.getItem('connectedEmails')) || []; }
  catch { return []; }
}

function setConnectedEmailsLS(emails) {
  localStorage.setItem('connectedEmails', JSON.stringify(emails || []));
}


// ==== LEARNING FROM HISTORY (front-end) =====================================

// zmƒõ≈à, pokud m√°≈° jinou base URL backendu
// === BACKEND BASE (zmƒõ≈à pokud m√°≈° jinou URL) ===

// === BACKEND BASE ===
  window.BACKEND = 'https://ai-email-server-stejdesign.onrender.com';

  // === Helpery na window ===
  window.fetchSentReplies = async function(dashboardUserEmail, email, limit = 200) {
    const url = `${window.BACKEND}/api/gmail/sent-replies?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(email)}&limit=${limit}`;
    const r = await fetch(url, { cache: 'no-store' });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'fetchSentReplies: backend vr√°til chybu');
    return Array.isArray(j.items) ? j.items : [];
  };

  window.fetchInboxExamples = async function(dashboardUserEmail, email, limit = 200) {
    const url = `${window.BACKEND}/api/gmail/inbox-examples?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(email)}&limit=${limit}`;
    const r = await fetch(url, { cache: 'no-store' });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'fetchInboxExamples: backend vr√°til chybu');
    return Array.isArray(j.items) ? j.items : [];
  };

  window.saveStyleExamples = async function(dashboardUserEmail, email, items) {
    // 1) lehk√Ω limit na d√©lku tƒõla (kv≈Øli velikosti JSONu)
  const MAX_BODY = 4000; // znak≈Ø
  const cleaned = (items || []).map(it => ({
    ...it,
    body: String(it.body || '').slice(0, MAX_BODY)
  }));

  // 2) po≈°li to na server po men≈°√≠ch d√°vk√°ch
  const BATCH = 80;
  let savedTotal = 0;

  for (let i = 0; i < cleaned.length; i += BATCH) {
    const batch = cleaned.slice(i, i + BATCH);
    const r = await fetch(`${window.BACKEND}/api/style-examples/ingest`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email, items: batch })
    });
    const j = await r.json();
    if (!r.ok || !j?.success) {
      throw new Error(j?.message || 'saveStyleExamples: backend vr√°til chybu');
    }
    savedTotal += j.saved || 0;

    // kr√°tk√° pauza, a≈• netr√°p√≠me server
    await new Promise(res => setTimeout(res, 150));
  }

  return { saved: savedTotal };
  };

  window.fetchStyleProfile = async function(dashboardUserEmail, email) {
    const url = `${window.BACKEND}/api/style-profile?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(email)}`;
    const r = await fetch(url, { cache: 'no-store' });
    return await r.json();
  };



// ===== ANALYTICS =====
let __activityChart, __aiChart, __catChart;

async function loadAnalytics(days = 7) {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const account = (localStorage.getItem('primaryEmail') || '').trim();
  if (!dashboardUserEmail || !account) return;

  // Zniƒç√≠me star√© instance graf≈Ø, aby se mohly p≈ôekreslit
  if (window.__responseTimeChart) window.__responseTimeChart.destroy();
  if (window.__aiQualityChart) window.__aiQualityChart.destroy();
  if (window.__templateUsageChart) window.__templateUsageChart.destroy();

  // === 1. Graf: Pr≈Ømƒõrn√° doba odpovƒõdi (zat√≠m statick√° uk√°zka) ===
  const ctx1 = document.getElementById('responseTimeChart')?.getContext('2d');
  if (ctx1) {
    window.__responseTimeChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: ['Vy (manu√°lnƒõ)', 'AI Asistent'],
        datasets: [{
          label: 'Pr≈Ømƒõrn√° doba v hodin√°ch',
          data: [2.5, 0.1], // Statick√° uk√°zkov√° data
          backgroundColor: ['#9ca3af', '#6366f1'],
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
    });
  }

  // === 2. Graf: Kvalita odpovƒõd√≠ AI (zat√≠m statick√° uk√°zka) ===
  const ctx2 = document.getElementById('aiQualityChart')?.getContext('2d');
  if (ctx2) {
    window.__aiQualityChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Odesl√°no bez √∫prav', 'Upraveno a odesl√°no', 'Zahozeno'],
        datasets: [{
          data: [75, 20, 5], // Statick√° uk√°zkov√° data
          backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
  
  // === 3. Graf: Vyu≈æit√≠ ≈°ablon (data z API) ===
  try {
    const tplRes = await fetch(`${window.BACKEND}/api/analytics/templates?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
    const tplData = await tplRes.json();
    const topTemplates = (tplData.top || []).slice(0, 8);

    const ctx3 = document.getElementById('templateUsageChart')?.getContext('2d');
    if (ctx3) {
      window.__templateUsageChart = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: topTemplates.map(t => t.name),
          datasets: [{
            label: 'Poƒçet pou≈æit√≠',
            data: topTemplates.map(t => t.uses),
            backgroundColor: '#3b82f6',
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
  } catch (e) {
    console.error("Chyba p≈ôi naƒç√≠t√°n√≠ dat o ≈°ablon√°ch:", e);
    showToast("Nepoda≈ôilo se naƒç√≠st data o ≈°ablon√°ch.", "error");
  }

  // Zajist√≠me funkƒçnost tlaƒç√≠tek pro zmƒõnu ƒçasov√©ho obdob√≠
  document.querySelectorAll('#analytics .filter-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('#analytics .filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const days = parseInt(btn.dataset.days, 10);
      // Zde by v budoucnu volalo loadAnalytics(days), ale pro statick√° data to nen√≠ nutn√©
      // Prozat√≠m jen vizu√°lnƒõ p≈ôep√≠n√°me
    };
  });
}







  // === Klik handler ===
  window.learnFromHistory = async function() {
    const dashboardUserEmail = localStorage.getItem('userEmail') || 'tomas.lipuvka@gmail.com';
    const email = localStorage.getItem('primaryEmail') || 'tomas.lipuvka@gmail.com';

    const btn = document.getElementById('btn-learn-style');
    const old = btn?.textContent;
    try {
      if (btn) { btn.disabled = true; btn.textContent = 'Uƒç√≠m se z historie‚Ä¶'; }

      const sent  = await window.fetchSentReplies(dashboardUserEmail, email, 200);
      const inbox = await window.fetchInboxExamples(dashboardUserEmail, email, 200);
      const saved = await window.saveStyleExamples(dashboardUserEmail, email, [...sent, ...inbox]);

      (window.showToast || alert)(`Hotovo: ulo≈æeno ${saved.saved} p≈ô√≠klad≈Ø.`);
      const prof = await window.fetchStyleProfile(dashboardUserEmail, email);
      console.log('STYLE PROFILE', prof);
    } catch (e) {
      console.error(e);
      (window.showToast || alert)(e.message || 'Uƒçen√≠ z historie selhalo.');
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = old || 'Nauƒçit se z historie'; }
    }
  };

  // p≈ôipojit listener po naƒçten√≠ DOM
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btn-learn-style')
      ?.addEventListener('click', window.learnFromHistory);
  });





/**
 * St√°hne p≈ôipojen√© √∫ƒçty z backendu a ulo≈æ√≠ je do localStorage.
 * Vrac√≠ pole e-mail≈Ø. Pou≈æij v initializeDashboard().
 */
async function syncConnectedEmails() {
  const serverAccs = await fetchConnectedEmailsFromServer();
  setConnectedAccounts(serverAccs);
  return getConnectedAccounts();
}




function setPrimaryEmail(email) {
  primaryEmail = email;
  localStorage.setItem('primaryEmail', email);
}



window.CURRENT_EMAIL = { id:'', subject:'', from:'', date:'', bodyText:'', analysis:{}, account:'' };
window.CURRENT_SETTINGS = null;

// Pomocn√° funkce: aktu√°lnƒõ vybran√Ω p≈ôipojen√Ω √∫ƒçet (p≈ôepi≈°, pokud u≈æ nƒõco m√°≈°)
function getSelectedAccountEmail() {
  // zkus element select/input; pokud nem√°≈°, ulo≈æ si p≈ôi v√Ωbƒõru √∫ƒçtu do localStorage
  return document.querySelector('#accountSelect')?.value
      || localStorage.getItem('connectedEmail')
      || CURRENT_EMAIL.account
      || '';
}

// Naƒçti (jednou) nastaven√≠ pro dan√Ω √∫ƒçet
async function ensureSettingsLoaded() {
  if (CURRENT_SETTINGS && CURRENT_SETTINGS.connected_email === getSelectedAccountEmail()) return;
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const connectedEmail     = getSelectedAccountEmail();
  if (!dashboardUserEmail || !connectedEmail) return;

  const r = await fetch(`${API_BASE}/api/settings?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(connectedEmail)}`).then(x=>x.json());
  if (r.success) {
    CURRENT_SETTINGS = r.settings;
  }
}



// Po n√°vratu z OAuth: vezmeme new-email z URL a nastav√≠me jako primary
(function pickNewlyLinkedEmailFromUrl() {
  const params = new URLSearchParams(location.search);
  if (params.get('account-linked') === 'success' && params.get('new-email')) {
    setPrimaryEmail(decodeURIComponent(params.get('new-email')));
    // vyƒçisti URL
    const clean = new URL(location.href);
    clean.searchParams.delete('account-linked');
    clean.searchParams.delete('new-email');
    history.replaceState({}, '', clean.toString());
  }
})();


// === N√°povƒõda k ≈°ablon√°m ===
const TPL_VARS = [
  'recipientName','product','price','deliveryTime','senderName',
  'ourNextStep','ourDeadline','theirNextStep','theirDeadline','meetingDate',
  'orderNumber','issue','solutionOptionA','solutionOptionB','company',
  'painPoint','kpi','kpiValue','timeframe','slot1','slot2',
  'step1','step2','step3','deadline'
];

const TPL_DESCRIPTIONS = {
  recipientName: 'Jm√©no p≈ô√≠jemce (nap≈ô. ‚Äûpan√≠ Nov√°kov√°‚Äú).',
  product: 'Produkt/slu≈æba, kter√Ωch se email t√Ωk√°.',
  price: 'Cena (ide√°lnƒõ vƒçetnƒõ mƒõny).',
  deliveryTime: 'Term√≠n dod√°n√≠ / doruƒçen√≠.',
  senderName: 'Jm√©no a p≈ô√≠jmen√≠ odes√≠latele emailu (osoby, kter√° v√°m psala).',
  ourNextStep: 'N√°≈° dal≈°√≠ krok (co udƒõl√°me my).',
  ourDeadline: 'N√°≈° term√≠n/uz√°vƒõrka.',
  theirNextStep: 'Dal≈°√≠ krok protistrany (co m√° udƒõlat p≈ô√≠jemce).',
  theirDeadline: 'Term√≠n/uz√°vƒõrka pro p≈ô√≠jemce.',
  meetingDate: 'Datum/ƒças sch≈Øzky.',
  orderNumber: 'ƒå√≠slo objedn√°vky.',
  issue: 'Struƒçn√Ω popis probl√©mu/po≈æadavku.',
  solutionOptionA: 'Varianta ≈ôe≈°en√≠ A.',
  solutionOptionB: 'Varianta ≈ôe≈°en√≠ B.',
  company: 'N√°zev firmy p≈ô√≠jemce.',
  painPoint: 'Hlavn√≠ ‚Äûbolest‚Äú/probl√©m z√°kazn√≠ka.',
  kpi: 'C√≠l/KPI, kter√Ω sledujete.',
  kpiValue: 'Aktu√°ln√≠ hodnota KPI.',
  timeframe: 'Horizont/dobu plnƒõn√≠ (nap≈ô. ‚ÄûQ3 2025‚Äú).',
  slot1: 'Navr≈æen√Ω ƒçasov√Ω slot ƒç. 1 na call/sch≈Øzku.',
  slot2: 'Navr≈æen√Ω ƒçasov√Ω slot ƒç. 2 na call/sch≈Øzku.',
  step1: 'Krok postupu ƒç. 1.',
  step2: 'Krok postupu ƒç. 2.',
  step3: 'Krok postupu ƒç. 3.',
  deadline: 'Koneƒçn√Ω term√≠n/uz√°vƒõrka.'
};

function insertAtCursor(textarea, text) {
  const el = typeof textarea === 'string' ? document.getElementById(textarea) : textarea;
  if (!el) return;
  const start = el.selectionStart ?? el.value.length;
  const end   = el.selectionEnd   ?? el.value.length;
  const before = el.value.slice(0, start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const cursor = start + text.length;
  el.focus();
  el.setSelectionRange(cursor, cursor);
  // po ka≈æd√©m vlo≈æen√≠ rovnou validuj
  validateTemplateVariables();
}

async function learnStyleFromHistory() {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const primaryEmail = localStorage.getItem('primaryEmail');
  if (!dashboardUserEmail || !primaryEmail) {
    showToast('Vyber pros√≠m prim√°rn√≠ √∫ƒçet v Nastaven√≠ ‚Üí Email √∫ƒçty.', 'warning');
    return;
  }
  const statusEl = document.getElementById('learn-style-status');
  statusEl.textContent = 'Analyzuji odpovƒõdi‚Ä¶ m≈Ø≈æe to chv√≠li trvat.';
  try {
    const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/style/learn', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email: primaryEmail, limit: 200 })
    });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Uƒçen√≠ stylu selhalo.');
    // ulo≈æ styl do pamƒõti klientu, a≈• ho m√°me hned k dispozici
    window.CURRENT_SETTINGS = { ...(window.CURRENT_SETTINGS||{}), style_profile: j.style_profile };
    showToast('Styl nauƒçen. Budu ho pou≈æ√≠vat ve v≈°ech odpovƒõd√≠ch.', 'success');
    statusEl.textContent = 'Hotovo.';
  } catch (e) {
    showToast(e.message || 'Nepoda≈ôilo se nauƒçit styl.', 'error');
    statusEl.textContent = '';
  }
}

document.getElementById('learn-style-btn')?.addEventListener('click', learnStyleFromHistory);



function renderTplHelp() {
  const grid = document.getElementById('tpl-chip-grid');
  if (!grid) return;
  grid.innerHTML = '';

  // Hint box (vytvo≈ô√≠me jednou)
  let hintBox = document.getElementById('tpl-var-hint');
  if (!hintBox) {
    hintBox = document.createElement('div');
    hintBox.id = 'tpl-var-hint';
    hintBox.className = 'tpl-var-hint';
    // vlo≈æ hned pod grid s chipy
    grid.parentElement.insertBefore(hintBox, grid.nextSibling);
  }

  const showVarHint = (name) => {
    const desc = TPL_DESCRIPTIONS[name];
    if (!desc) { hintBox.style.display = 'none'; return; }
    hintBox.innerHTML = `<strong>{{${name}}}</strong> ‚Äî ${desc}`;
    hintBox.style.display = 'block';
  };
  const hideVarHint = () => { hintBox.style.display = 'none'; };

  // CHIPS s tooltippy
  TPL_VARS.forEach(v => {
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.type = 'button';
    btn.textContent = `{{${v}}}`;
    btn.title = TPL_DESCRIPTIONS[v] || ''; // nativn√≠ tooltip
    btn.setAttribute('aria-label', TPL_DESCRIPTIONS[v] || `{{${v}}}`);

    btn.addEventListener('click', () => insertAtCursor('tpl-content', `{{${v}}}`));
    btn.addEventListener('mouseenter', () => showVarHint(v));
    btn.addEventListener('focus', () => showVarHint(v));
    btn.addEventListener('mouseleave', hideVarHint);
    btn.addEventListener('blur', hideVarHint);

    grid.appendChild(btn);
  });

  // AI slot tlaƒç√≠tka
  document.getElementById('btn-insert-ai')?.addEventListener('click', () => {
    insertAtCursor('tpl-content', '[[AI: Napi≈° dvƒõ vƒõty empatick√©ho uzn√°n√≠ probl√©mu a navrhni dal≈°√≠ konkr√©tn√≠ krok.]]');
  });
  document.getElementById('btn-insert-example')?.addEventListener('click', (e) => {
  e.preventDefault();
  const nameEl = document.getElementById('tpl-name');
  const catEl = document.getElementById('tpl-category');
  const contentEl = document.getElementById('tpl-content');
  if (!contentEl) return;

  if (nameEl) nameEl.value = 'Odpovƒõƒè na reklamaci ‚Äî potvrzen√≠ p≈ôijet√≠';
  if (catEl)  catEl.value = 'Podpora';

  const example =
`Dobr√Ω den {{recipientName}},

dƒõkujeme za zpr√°vu ohlednƒõ objedn√°vky {{orderId}}. Mrz√≠ n√°s vznikl√© pot√≠≈æe.

[[AI: Struƒçnƒõ a empaticky shr≈à d≈Øvod reklamace podle emailu a p≈ôidej 1‚Äì2 vƒõty s uji≈°tƒõn√≠m.]]

Pro rychl√© vy≈ô√≠zen√≠ pros√≠m po≈°lete fotografie po≈°kozen√≠ a ƒç√≠slo √∫ƒçtu pro p≈ô√≠padn√© vr√°cen√≠ penƒõz.
ƒå√≠slo reklamace: {{caseId}}

Dƒõkujeme a brzy se ozveme s dal≈°√≠m postupem.
S pozdravem
{{senderName}}
{{senderSignature}}`;

  if ((contentEl.value || '').trim().length) {
    contentEl.value = contentEl.value.replace(/\s*$/, '') + '\n\n---\n' + example;
  } else {
    contentEl.value = example;
  }

  contentEl.focus();
  const pos = contentEl.value.length;
  contentEl.setSelectionRange(pos, pos);
  validateTemplateVariables?.();
  showToast?.('Uk√°zkov√° ≈°ablona vlo≈æena. Uprav ji a ulo≈æ.', 'success');
});

  // === Hint podle kurzoru v textarea ===
  const ta = document.getElementById('tpl-content');
  const checkCaretVar = () => {
    if (!ta) return hideVarHint();
    const i = ta.selectionStart ?? 0;
    const text = ta.value || '';
    const re = /{{\s*([a-zA-Z0-9_]+)\s*}}/g;
    let m, found = null;
    while ((m = re.exec(text))) {
      const start = m.index;
      const end = re.lastIndex;
      if (i >= start && i <= end) { found = m[1]; break; }
    }
    if (found && TPL_DESCRIPTIONS[found]) showVarHint(found);
    else hideVarHint();
  };
  ta?.addEventListener('keyup', checkCaretVar);
  ta?.addEventListener('click', checkCaretVar);
  ta?.addEventListener('focus', checkCaretVar);

  // validuj pr≈Øbƒõ≈ænƒõ
  document.getElementById('tpl-content')?.addEventListener('input', validateTemplateVariables);
  validateTemplateVariables();
}




function validateTemplateVariables() {
  const ta = document.getElementById('tpl-content');
  const box = document.getElementById('tpl-validator');
  if (!ta || !box) return;

  const txt = ta.value || '';
  const used = Array.from(txt.matchAll(/{{\s*([a-zA-Z0-9_]+)\s*}}/g)).map(m => m[1]);
  const aiSlots = Array.from(txt.matchAll(/\[\[\s*AI\s*:(.*?)\]\]/gs)).length;

  const unknown = [...new Set(used.filter(k => !TPL_VARS.includes(k)))];
  if (unknown.length) {
    box.className = 'warn';
    box.innerHTML = `Nezn√°m√© promƒõnn√©: <b>${unknown.join(', ')}</b>.<br>
      Pou≈æij nƒõkterou z dostupn√Ωch v√Ω≈°e nebo oprav p≈ôeklep.`;
  } else {
    box.className = 'ok';
    box.innerHTML = `≈Ω√°dn√© nezn√°m√© promƒõnn√©. AI slot≈Ø: <b>${aiSlots}</b>.`;
  }
}

// po naƒçten√≠ str√°nky/otev≈ôen√≠ z√°lo≈æky ≈†ablony
document.addEventListener('DOMContentLoaded', renderTplHelp);


// ZMƒöNA: Odebrali jsme promƒõnn√© pro spr√°vu √∫ƒçt≈Ø odsud, budeme je spravovat v r√°mci funkc√≠ a localStorage.

// ===================================================================================
// === 2. Z√ÅKLADN√ç FUNKCE APLIKACE (Dashboard, Mod√°ly, Toast...) ====================
// ===================================================================================

function showToast(message, type = 'success', opts = {}) {
  const { duration = 3000, actionText = null, onAction = null } = opts;

  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  if (!toast || !toastMessage) return;

  // text + typ
  toastMessage.textContent = message;
  toast.className = `toast ${type} show`;

  // zru≈° p≈ô√≠padn√Ω p≈ôedchoz√≠ timer
  if (window.__toastTimer) {
    clearTimeout(window.__toastTimer);
    window.__toastTimer = null;
  }

  // vytvo≈ô / sprav akƒçn√≠ tlaƒç√≠tko (pokud je)
  let actionBtn = toast.querySelector('.toast-action-btn');
  if (actionText) {
    if (!actionBtn) {
      actionBtn = document.createElement('button');
      actionBtn.className = 'toast-action-btn';
      actionBtn.style.marginLeft = '12px';
      actionBtn.style.border = 'none';
      actionBtn.style.background = '#f1f5f9';
      actionBtn.style.color = '#334155';
      actionBtn.style.padding = '6px 10px';
      actionBtn.style.borderRadius = '6px';
      actionBtn.style.cursor = 'pointer';
      toast.appendChild(actionBtn);
    }
    actionBtn.textContent = actionText;
    actionBtn.onclick = () => { if (onAction) onAction(); };
    actionBtn.style.display = 'inline-block';
  } else if (actionBtn) {
    actionBtn.style.display = 'none';
    actionBtn.onclick = null;
  }

  // auto-hide
  window.__toastTimer = setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

function checkMobile() {
    if (sidebar && window.innerWidth <= 768) {
        sidebar.classList.add('collapsed');
    }
}

function openModal() {
  // poka≈æd√© zaƒçni v√Ωbƒõrem poskytovatele
  restoreProviderChooser();
  if (modal) modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  if (modal) modal.style.display = 'none';
  document.body.style.overflow = '';
  // po zav≈ôen√≠ resetuj, aby p≈ô√≠≈°tƒõ nebyl ponechan√Ω formul√°≈ô
  restoreProviderChooser();
}

function hideAnalysisModal() {
    if (analysisModal) analysisModal.classList.remove('show');
    document.body.style.overflow = '';
}

function connectGoogleAccount() {
    const GOOGLE_CLIENT_ID = "990614891314-kugic255rq68tt1m7uqg4rdp9jdig5lb.apps.googleusercontent.com";
    const REDIRECT_URI = "https://ai-email-server-stejdesign.onrender.com/api/oauth/google/callback";
    const oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

    // P≈ôid√°me email p≈ôihl√°≈°en√©ho u≈æivatele do state
    const loggedUserEmail = localStorage.getItem('userEmail');
    const params = {
        client_id: GOOGLE_CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: 'code',
        scope: 'openid email profile https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.send',
        access_type: 'offline',
        prompt: 'consent',
        include_granted_scopes: 'true',
        state: encodeURIComponent(loggedUserEmail || '')
    };
    window.location.href = `${oauth2Endpoint}?${new URLSearchParams(params)}`;
}

// === CUSTOM EMAIL: otev≈ô√≠t modal s formul√°≈ôem a zavolat /api/custom-email/connect ===
function openCustomConnect() {
 const overlay = document.getElementById('modal-overlay');
  const box = document.getElementById('modal-content');
  const body = box?.querySelector('.modal-body');
  if (!overlay || !body) return;

  // ‚öôÔ∏è Z√°klad: jen e-mail + heslo. Ostatn√≠ je schovan√© v "Pokroƒçil√© nastaven√≠".
  body.innerHTML = `
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Email adresa</label>
        <input id="ce-emailAddress" class="form-control" type="email" placeholder="jan@firma.cz" required>
      </div>
      <div class="form-group">
        <label class="form-label">Heslo</label>
        <input id="ce-password" class="form-control" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
    </div>

    <button type="button" id="toggle-advanced" class="bulk-btn" style="margin:.75rem 0 0;">
      Pokroƒçil√© nastaven√≠
    </button>

    <div class="advanced-settings" style="display:none; margin-top: .75rem;">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">U≈æivatelsk√© jm√©no</label>
          <input id="ce-username" class="form-control" type="text" placeholder="(vƒõt≈°inou stejn√Ω jako email)">
        </div>
      </div>

      <div class="form-grid" style="margin-top:1rem;">
        <div class="form-group">
          <label class="form-label">IMAP host</label>
          <input id="ce-imapHost" class="form-control" placeholder="imap.firma.cz">
        </div>
        <div class="form-group">
          <label class="form-label">IMAP port</label>
          <input id="ce-imapPort" class="form-control" type="number" value="993">
        </div>
        <div class="form-group">
          <label class="form-label">IMAP zabezpeƒçen√≠</label>
          <select id="ce-imapSecure" class="form-control">
            <option value="1" selected>SSL/TLS</option>
            <option value="0">Nezabezpeƒçen√©</option>
          </select>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">SMTP host</label>
          <input id="ce-smtpHost" class="form-control" placeholder="smtp.firma.cz">
        </div>
        <div class="form-group">
          <label class="form-label">SMTP port</label>
          <input id="ce-smtpPort" class="form-control" type="number" value="465">
        </div>
        <div class="form-group">
          <label class="form-label">SMTP zabezpeƒçen√≠</label>
          <select id="ce-smtpSecure" class="form-control">
            <option value="1" selected>SSL/TLS</option>
            <option value="0">Nezabezpeƒçen√©</option>
          </select>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:.5rem; margin-top:1rem;">
      <button id="ce-connect-btn" class="btn btn-primary">Ovƒõ≈ôit & ulo≈æit</button>
      <button id="ce-cancel-btn" class="btn btn-secondary">Zru≈°it</button>
    </div>
    <div id="ce-connect-msg" style="margin-top:.5rem; color:#64748b;"></div>
  `;

  overlay.style.display = 'flex';

  // Toggle "Pokroƒçil√© nastaven√≠"
  document.getElementById('toggle-advanced')?.addEventListener('click', () => {
    const adv = document.querySelector('.advanced-settings');
    if (!adv) return;
    adv.style.display = adv.style.display === 'none' ? 'block' : 'none';
  });

  document.getElementById('ce-cancel-btn')?.addEventListener('click', () => { closeModal();   });

  // Ovƒõ≈ôit & ulo≈æit
  document.getElementById('ce-connect-btn')?.addEventListener('click', async () => {
    const dashboardUserEmail = localStorage.getItem('userEmail');
    const emailAddress = document.getElementById('ce-emailAddress').value.trim();
    const password     = document.getElementById('ce-password').value;

    const msgEl = document.getElementById('ce-connect-msg');
    const advVisible = document.querySelector('.advanced-settings')?.style.display !== 'none';
    const val = (id) => {
      const el = document.getElementById(id);
      return el && el.value ? el.value : undefined;
    };

    // üì¶ Minim√°ln√≠ payload (email+heslo). Pokud je otev≈ôen√© Pokroƒçil√© a nƒõco vyplnƒõn√©, p≈ôid√°me to.
    const payload = {
      dashboardUserEmail,
      emailAddress,
      password
    };
    if (advVisible) {
      payload.username   = val('ce-username') || emailAddress;
      payload.imapHost   = val('ce-imapHost');
      const ip = val('ce-imapPort'); if (ip) payload.imapPort = Number(ip);
      const isec = val('ce-imapSecure'); if (isec != null) payload.imapSecure = isec === '1';

      payload.smtpHost   = val('ce-smtpHost');
      const sp = val('ce-smtpPort'); if (sp) payload.smtpPort = Number(sp);
      const ssec = val('ce-smtpSecure'); if (ssec != null) payload.smtpSecure = ssec === '1';
    }

    msgEl.textContent = 'Ovƒõ≈ôuji p≈ôihl√°≈°en√≠‚Ä¶';
    try {
      const resp = await fetch(`${window.BACKEND}/api/custom-email/connect`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await resp.json();
      if (!resp.ok || !j.success) throw new Error(j.message || 'P≈ôipojen√≠ selhalo.');
      msgEl.textContent = '‚úÖ √öƒçet p≈ôipojen. Naƒç√≠t√°m‚Ä¶';

      // v√Ωchoz√≠ AI nastaven√≠ pro tento √∫ƒçet
      await fetch(`${window.BACKEND}/api/settings`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          dashboardUserEmail, email: emailAddress,
          tone:'Form√°ln√≠', length:'St≈ôedn√≠ (1 odstavec)', signature:'Spoleƒçnost Senzoor',
          auto_reply:false, approval_required:true, spam_filter:true
        })
      });

      await syncConnectedEmails();
      localStorage.setItem('primaryEmail', emailAddress);
      renderConnectedAccounts();
      await loadSettings();
      overlay.style.display = 'none';
      showToast('√öƒçet p≈ôid√°n a p≈ôipraven.', 'success');
    } catch (e) {
      msgEl.textContent = '‚ùå ' + (e.message || e);
    }
  });
}

// zapni tlaƒç√≠tko v modalu ‚ÄûP≈ôipojit p≈ôes Custom Email‚Äú
document.getElementById('connect-custom-btn')?.addEventListener('click', openCustomConnect);

function parseSenderName(s='') {
  const m = String(s).match(/<([^>]+)>/);
  const raw = m ? m[1] : String(s);
  return raw.trim().replace(/^mailto:/i, '');
}


async function tryGmailEmails(primaryEmail, status, period, searchQuery) {
  if (!primaryEmail) return null;

  if (status === 'approval') {
    try {
      const pendingUrl = new URL(`${window.BACKEND}/api/gmail/pending-replies`);
      pendingUrl.searchParams.set('dashboardUserEmail', dashboardUserEmail);
      pendingUrl.searchParams.set('email', primaryEmail);

      const r = await fetch(pendingUrl.toString(), { cache: 'no-store' });
      let j = null;
      try {
        j = await r.json();
      } catch (_) {
        j = null;
      }
      if (!r.ok || !j || !j.success) {
        return { src: 'gmail', total: Array.isArray(j?.pending) ? j.pending.length : 0, emails: [] };
      }

      const normalized = (j.pending || []).map((item) => {
        const createdAt = item.created_at || item.last_generated_at || item.sent_at;
        return {
          id: item.message_id,
          messageId: item.message_id,
          pendingId: item.id,
          sender: item.sender || '',
          subject: item.subject || 'Bez p≈ôedmƒõtu',
          snippet: item.summary || item.snippet || '',
          date: createdAt || new Date().toISOString(),
          _src: 'gmail',
          _pending: true,
          account: primaryEmail,
          replyBody: item.reply_body || '',
          originalBody: item.original_body || '',
          summary: item.summary || '',
          sentiment: item.sentiment || '',
          threadId: item.thread_id || '',
          status: item.status || 'pending'
        };
      });

      return { src: 'gmail', total: normalized.length, emails: normalized };
    } catch (error) {
      console.error('Nepoda≈ôilo se naƒç√≠st ƒçekaj√≠c√≠ odpovƒõdi:', error);
      return { src: 'gmail', total: 0, emails: [] };
    }
  }

  const url = `${window.BACKEND}/api/gmail/emails?email=${encodeURIComponent(primaryEmail)}&dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&status=${encodeURIComponent(status)}&period=${encodeURIComponent(period)}&searchQuery=${encodeURIComponent(searchQuery)}`;
  const r = await fetch(url, { cache: 'no-store' });
  let j = null;
  try {
    j = await r.json();
  } catch (_) {
    j = null;
  }
  if (!r.ok || !j || !j.success) return null;
  const normalized = (j.emails || []).map(e => ({
    id: e.id,                       // Gmail messageId
    uid: null,
    sender: e.sender,
    subject: e.subject,
    snippet: e.snippet || '',
    date: e.date,
    _src: 'gmail',
    _pending: false,
    account: primaryEmail
  }));
  return { src:'gmail', total:j.total || normalized.length, emails: normalized };
}

async function tryCustomPendingEmails(primaryEmail) {
  if (!primaryEmail) return null;
  const url = `${window.BACKEND}/api/custom-email/pending-replies?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(primaryEmail)}`;
  const r = await fetch(url, { cache: 'no-store' });
  let j = null;
  try {
    j = await r.json();
  } catch (_) {
    j = null;
  }
  if (!r.ok || !j || !j.success) {
    return { src: 'custom', total: Array.isArray(j?.pending) ? j.pending.length : 0, emails: [] };
  }

  const normalized = (j.pending || []).map((item) => {
    const createdAt = item.created_at || item.last_generated_at || item.sent_at;
    return {
      id: item.message_id || String(item.id),
      messageId: item.message_id || String(item.id),
      pendingId: item.id,
      sender: item.sender || '',
      subject: item.subject || 'Bez p≈ôedmƒõtu',
      snippet: item.summary || item.snippet || '',
      date: createdAt || new Date().toISOString(),
      _src: 'custom',
      _pending: true,
      account: primaryEmail,
      replyBody: item.reply_body || '',
      originalBody: item.original_body || '',
      summary: item.summary || '',
      sentiment: item.sentiment || '',
      status: item.status || 'pending'
    };
  });

  return { src: 'custom', total: normalized.length, emails: normalized };
}



        

async function tryCustomEmails(primaryEmail, status = 'all') {
  const url = `${window.BACKEND}/api/custom-email/emails?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(primaryEmail)}&limit=50&status=${encodeURIComponent(status)}`;
  const r = await fetch(url, { cache:'no-store' });
  let j = null;
  try {
    j = await r.json();
  } catch (_) {
    j = null;
  }
  if (!r.ok || !j || !j.success) return null;
  const normalized = (j.emails || []).map(e => {
    // backend vrac√≠ { id: "...", sender: "...", subject, date, ... }
    const uid = e.uid ?? e.id; // podpora obou variant
   return {
      id: String(uid),
      uid: Number(uid),
      sender: e.sender || e.from || '',
      subject: e.subject || '',
      snippet: e.snippet || '',
      date: e.date || e.internalDate || Date.now(),
      _src: 'custom',
      _pending: false,
      account: primaryEmail
    };
  });
  return { src:'custom', total: normalized.length, emails: normalized };
}


// ZMƒöNA: Funkce nyn√≠ naƒç√≠t√° emaily pro prim√°rn√≠ √∫ƒçet z localStorage
async function fetchEmails() {
    const primaryEmail = localStorage.getItem('primaryEmail');
  if (!primaryEmail) {
    if (emailListContainer) emailListContainer.innerHTML = `<div class="empty-state"><h3>Vyberte hlavn√≠ emailov√Ω √∫ƒçet</h3></div>`;
    if (emailCountHeader) emailCountHeader.textContent = 'Emaily';
    return;
  }

  const accs = getConnectedAccounts().length ? getConnectedAccounts() : await syncConnectedEmails();
  const prim = accs.find(a => a.email === primaryEmail);
  if (!prim || !prim.active) {
    if (emailListContainer) emailListContainer.innerHTML = `<div class="empty-state"><h3>Prim√°rn√≠ √∫ƒçet je neaktivn√≠</h3></div>`;
    if (emailCountHeader) emailCountHeader.textContent = `Emaily pro: ${primaryEmail} (neaktivn√≠)`;
    return;
  }

  const status = statusFilter ? statusFilter.value : 'all';
  const period = periodFilter ? periodFilter.value : 'all';
  const searchQuery = searchBar ? searchBar.value : '';

  emailListContainer.innerHTML = `<div class="empty-state"><span>üìß</span><p>Naƒç√≠t√°m emaily pro ${primaryEmail}‚Ä¶</p></div>`;

 try {
    const accountType = prim?.type || '';
    const isGmailAccount = !accountType || accountType === 'gmail';
    const isCustomAccount = !accountType || accountType === 'custom';

    let res = null;

    if (status === 'approval') {
      const [gmailPending, customPending] = await Promise.all([
        isGmailAccount ? tryGmailEmails(primaryEmail, status, period, searchQuery) : null,
        isCustomAccount ? tryCustomPendingEmails(primaryEmail) : null
      ]);

      const sources = [gmailPending, customPending].filter(src => src && Array.isArray(src.emails));
      const combinedEmails = sources.flatMap(src => src.emails);
      combinedEmails.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      const totalCount = sources.reduce((sum, src) => sum + (src?.total ?? (src?.emails?.length || 0)), 0);
      res = { src: 'approval', total: totalCount || combinedEmails.length, emails: combinedEmails };
    } else {
      const [gmailResult, customResult] = await Promise.all([
        isGmailAccount ? tryGmailEmails(primaryEmail, status, period, searchQuery) : null,
        isCustomAccount ? tryCustomEmails(primaryEmail, status) : null
      ]);

      if (gmailResult && Array.isArray(gmailResult.emails)) {
        res = gmailResult;
      }

      if ((!res || !Array.isArray(res.emails) || res.emails.length === 0) && customResult && Array.isArray(customResult.emails)) {
        res = customResult;
      }
    }

    if (!res || !Array.isArray(res.emails)) {
      throw new Error('Nepoda≈ôilo se naƒç√≠st emaily.');
    }

    allEmails = res.emails.map(email => ({
      ...email,
      account: email.account || primaryEmail
    }));

    if (emailCountHeader) {
      const total = Number(res.total ?? allEmails.length ?? 0);
      const countStr = total > 0 ? ` (${total})` : '';
      if (status === 'approval') {
        emailCountHeader.textContent = `ƒåekaj√≠c√≠ odpovƒõdi pro: ${primaryEmail}${countStr}`;
      } else {
        emailCountHeader.textContent = `Emaily pro: ${primaryEmail}${countStr}`;
      }
    }

    renderEmailList(allEmails, res.total ?? allEmails.length);
  } catch (e) {
    emailListContainer.innerHTML = `<div class="empty-state"><h3>${e.message || 'Chyba naƒç√≠t√°n√≠'}</h3></div>`;
  }
}





async function hydrateSecurityTab() {
  const email = localStorage.getItem('userEmail');
  if (!email) return;

  // Zjist√≠, jestli m√° u≈æivatel heslo
  try {
    const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/auth/has-password?email=${encodeURIComponent(email)}`);
    const j = await r.json();
    const hasPass = !!j?.hasPassword;

    const curEl = document.getElementById('cur-pass');
    if (curEl) {
      // Pokud heslo nem√° (Google-only), pole pro souƒçasn√© heslo skryj
      curEl.parentElement.style.display = hasPass ? '' : 'none';
    }
  } catch (e) {
    // Kdy≈æ se check nepovede, nic hrozn√©ho ‚Äì nech v≈°e viditeln√©
  }
}



async function loadTemplates() {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const list = document.getElementById('tpl-list');
  if (!list || !dashboardUserEmail) return;

  list.innerHTML = '<div style="color:#94a3b8;text-align:center;">Naƒç√≠t√°m ≈°ablony‚Ä¶</div>';

  try {
    const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Chyba naƒç√≠t√°n√≠');
    renderTemplateList(j.templates || []);
  } catch (e) {
    list.innerHTML = `<div style="color:#dc2626;text-align:center;">${e.message || 'Nepoda≈ôilo se naƒç√≠st ≈°ablony.'}</div>`;
  }
}





function renderTemplateList(templates = []) {
    const countEl = document.getElementById('tpl-count');
if (countEl) countEl.textContent = templates.length;
    const list = document.getElementById('tpl-list');
    if (!list) return;

    if (!templates.length) {
        list.innerHTML = '<div style="color:#94a3b8; text-align:center; padding: 2rem;">Zat√≠m nem√°te vytvo≈ôen√© ≈æ√°dn√© ≈°ablony.</div>';
        return;
    }

    list.innerHTML = ''; // Vyƒçist√≠me star√Ω obsah
    templates.forEach(tpl => {
        const uses = Number(tpl.uses ?? 0);
        const success = Number(tpl.success_rate ?? 0);
        const content = String(tpl.content ?? '');

        const card = document.createElement('div');
        card.className = 'template-card';
        card.innerHTML = `
            <div class="template-header">
                <div class="template-name">${escapeHtml(tpl.name || 'Bez n√°zvu')}</div>
                <div class="template-actions">
                    <button class="action-btn" data-act="edit">‚úèÔ∏è Upravit</button>
                    <button class="action-btn reject" data-act="delete" style="background: #fef2f2; color: #dc2626;">üóëÔ∏è Smazat</button>
                </div>
            </div>
            <div class="template-preview">${escapeHtml(content).slice(0, 150)}${content.length > 150 ? '‚Ä¶' : ''}</div>
            <div class="template-stats">
                <span>Pou≈æito: ${uses}√ó</span>
                <span>√öspƒõ≈°nost: ${success.toFixed(0)}%</span>
            </div>
        `;
        // P≈ôid√°me listener na celou kartu, kter√Ω bude delegovat kliknut√≠ na tlaƒç√≠tka
        card.addEventListener('click', (evt) => onTemplateCardClick(evt, tpl));
        list.appendChild(card);
    });
}

function extractEmailAddress(s = '') {
  // 1) odescapuj p≈ô√≠padn√© &lt; a &gt; apod.
  const txt = document.createElement('textarea');
  txt.innerHTML = String(s);
  const unescaped = txt.value;

  // 2) pokus o <email> tvar
  const m = unescaped.match(/<\s*([^>]+)\s*>/);
  if (m) return m[1].trim();

  // 3) fallback: najdi prvn√≠ v√Ωskyt nƒõco@nƒõco.tld ve stringu
  const m2 = unescaped.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
  if (m2) return m2[0].trim();

  // 4) posledn√≠ mo≈ænost ‚Äì vra≈• o≈ôezan√Ω text
  return unescaped.trim();
}




function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

let __analysisWasOpen = false;


// --- Template Picker modal (ponechat jen jednu verzi) ---
function openTemplatePicker() {
   const el = document.getElementById('templatePicker');
  if (!el) return;

  const a = document.getElementById('analysisModal');
  __analysisWasOpen = a?.classList.contains('show');
  if (__analysisWasOpen) a.classList.remove('show');  // doƒçasnƒõ schovej anal√Ωzu

  el.classList.add('show');
  document.body.style.overflow = 'hidden';
  refreshPickerList();
}

function closeTemplatePicker() {
  const el = document.getElementById('templatePicker');
  if (!el) return;

  el.classList.remove('show');
  document.body.style.overflow = '';

  if (__analysisWasOpen) {
    document.getElementById('analysisModal')?.classList.add('show'); // vra≈• anal√Ωzu
    __analysisWasOpen = false;
  }
}

async function refreshPickerList() {
  const list = document.getElementById('tplPickerList');
  const q = (document.getElementById('tplSearch')?.value || '').trim().toLowerCase();
  const cat = document.getElementById('tplCategory')?.value || 'V≈°e';
  list.innerHTML = 'Naƒç√≠t√°m‚Ä¶';

  try {
    const dashboardUserEmail = localStorage.getItem('userEmail');
    const url = new URL('https://ai-email-server-stejdesign.onrender.com/api/templates');
    url.searchParams.set('dashboardUserEmail', dashboardUserEmail);

    const r = await fetch(url.toString());
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Chyba p≈ôi naƒç√≠t√°n√≠.');

    let items = j.templates || [];
    if (cat && cat !== 'V≈°e') items = items.filter(t => (t.category || 'Obecn√©') === cat);
    if (q) items = items.filter(t =>
      String(t.name||'').toLowerCase().includes(q) ||
      String(t.content||'').toLowerCase().includes(q)
    );

    if (!items.length) { list.innerHTML = '<div style="color:#94a3b8;">≈Ω√°dn√© ≈°ablony</div>'; return; }

    list.innerHTML = '';
    for (const t of items) {
      const uses = Number(t.uses ?? 0);
      const success = Number(t.success_rate ?? 0);
      const content = String(t.content ?? '');
      const card = document.createElement('div');
      card.className = 'template-card';
      card.innerHTML = `
        <div class="template-header">
          <div class="template-name">${escapeHtml(String(t.name ?? 'Bez n√°zvu'))}</div>
          <div class="template-actions">
            <button class="action-btn" data-use="${t.id}">üìã Pou≈æ√≠t</button>
          </div>
        </div>
        <div class="template-preview">${escapeHtml(content).slice(0,220)}${content.length>220?'‚Ä¶':''}</div>
        <div class="template-stats">
          <span>Pou≈æito: ${Number.isFinite(uses)?uses:0}√ó</span>
          <span>√öspƒõ≈°nost: ${Number.isFinite(success)?success.toFixed(0):'0'}%</span>
        </div>`;
      card.addEventListener('click', (e) => {
        if (e.target.closest('[data-use]')) { useTemplate(t); closeTemplatePicker(); }
      });
      list.appendChild(card);
    }
  } catch (e) {
    list.innerHTML = `<div style="color:#dc2626;">${e.message || 'Nepoda≈ôilo se naƒç√≠st ≈°ablony.'}</div>`;
  }
}







function onTemplateCardClick(evt, tpl) {
  
  const btn = evt.target.closest('[data-act]');
  if (!btn) return;
  const act = btn.dataset.act;

  if (act === 'delete') return deleteTemplate(tpl.id);
  if (act === 'edit')   return startEditTemplate(tpl);
  if (act === 'use')    return useTemplate(tpl);
}

async function createTemplate() {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const name = document.getElementById('tpl-name').value.trim();
  const category = document.getElementById('tpl-category').value.trim();
  const content = document.getElementById('tpl-content').value.trim();
  if (!name || !content) { showToast('Vypl≈à jm√©no a obsah ≈°ablony.', 'warning'); return; }

  try {
    const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/templates', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ dashboardUserEmail, name, category, content })
    });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Nepoda≈ôilo se ulo≈æit');
    showToast('≈†ablona ulo≈æena.', 'success');
    document.getElementById('tpl-name').value = '';
    document.getElementById('tpl-content').value = '';
    loadTemplates();
  } catch (e) { showToast(e.message || 'Chyba p≈ôi ukl√°d√°n√≠', 'error'); }
}

function startEditTemplate(tpl) {
  document.getElementById('tpl-name').value = tpl.name;
  document.getElementById('tpl-category').value = tpl.category || 'Obecn√©';
  document.getElementById('tpl-content').value = tpl.content;

  const btn = document.getElementById('tpl-save-btn');
  btn.textContent = 'üíæ Ulo≈æit zmƒõny';
  btn.dataset.editingId = tpl.id;
}

async function saveEditedTemplate(id) {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const name = document.getElementById('tpl-name').value.trim();
  const category = document.getElementById('tpl-category').value.trim();
  const content = document.getElementById('tpl-content').value.trim();
  if (!name || !content) { showToast('Vypl≈à jm√©no a obsah ≈°ablony.', 'warning'); return; }

  try {
    const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${id}`, {
      method:'PUT', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ dashboardUserEmail, name, category, content })
    });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Nepoda≈ôilo se upravit');
    showToast('≈†ablona upravena.', 'success');
    const btn = document.getElementById('tpl-save-btn');
    btn.textContent = 'üíæ Ulo≈æit ≈°ablonu';
    delete btn.dataset.editingId;
    document.getElementById('tpl-name').value = '';
    document.getElementById('tpl-content').value = '';
    loadTemplates();
  } catch (e) { showToast(e.message || 'Chyba p≈ôi √∫pravƒõ', 'error'); }
}

async function deleteTemplate(id) {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  if (!confirm('Opravdu smazat ≈°ablonu?')) return;
  try {
    const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${id}?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`, { method:'DELETE' });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Nepoda≈ôilo se smazat');
    showToast('≈†ablona smaz√°na.', 'success');
    loadTemplates();
  } catch (e) { showToast(e.message || 'Chyba p≈ôi maz√°n√≠', 'error'); }
}




async function changePasswordSubmit() {
  const email = localStorage.getItem('userEmail');
  if (!email) { showToast('Nejste p≈ôihl√°≈°en.', 'error'); return; }

  const curPass = document.getElementById('cur-pass')?.value || '';
  const newPass = document.getElementById('new-pass')?.value || '';
  const newPass2 = document.getElementById('new-pass2')?.value || '';

  if (!newPass || !newPass2) {
    showToast('Vypl≈àte nov√© heslo a potvrzen√≠.', 'warning');
    return;
  }
  if (newPass !== newPass2) {
    showToast('Nov√° hesla se neshoduj√≠.', 'error');
    return;
  }

  try {
    const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/auth/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email,
        currentPassword: curPass,         // u Google-only bude pr√°zdn√Ω ‚Äì backend to zvl√°d√°
        newPassword: newPass,
        newPasswordConfirm: newPass2
      })
    });
    const j = await r.json();
    if (!j.success) {
      showToast(j.message || 'Zmƒõna hesla selhala.', 'error');
      return;
    }
    showToast(j.message || 'Heslo zmƒõnƒõno. P≈ôihlaste se znovu.', 'success');
    // pro jistotu odhl√°sit a nechat znovu p≈ôihl√°sit
    setTimeout(() => {
      localStorage.clear();
      window.location.href = 'login.html';
    }, 1200);
  } catch (e) {
    showToast('Nepoda≈ôilo se komunikovat se serverem.', 'error');
  }
}




// --- Helpers pro ≈°ablony ---
function escapeHtml(s=''){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}



// --- Grid ≈°ablon na str√°nce /Templates (pokud ho pou≈æ√≠v√°≈°) ---

function onTemplateCardClick(evt, tpl) {
  const btn = evt.target.closest('[data-act]');
  if (!btn) return;
  const act = btn.dataset.act;
  if (act === 'delete') return deleteTemplate(tpl.id);
  if (act === 'edit')   return startEditTemplate(tpl);
  if (act === 'use')    return useTemplate(tpl);
}





// napojen√≠ handler≈Ø (v tv√©m DOMContentLoaded):
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btn-change-pass');
  if (btn) btn.addEventListener('click', changePasswordSubmit);

  // Kdy≈æ u≈æivatel otev≈ôe z√°lo≈æku ‚ÄûZabezpeƒçen√≠‚Äú, naƒçti stav:
  const securityTab = document.querySelector('.settings-tab[data-tab="security"]');
  if (securityTab) {
    securityTab.addEventListener('click', () => {
      setTimeout(hydrateSecurityTab, 0);
    });
  }
  // Nebo rovnou p≈ôi loadu:
  hydrateSecurityTab();

const pickTplBtn = document.getElementById('pick-template-btn');
if (pickTplBtn) pickTplBtn.addEventListener('click', openTemplatePicker);

const tplPicker = document.getElementById('templatePicker');
tplPicker?.addEventListener('click', (e) => {
  if (e.target === tplPicker) closeTemplatePicker();
});
document.getElementById('closeTemplatePicker')?.addEventListener('click', closeTemplatePicker);
document.getElementById('cancelTplPicker')?.addEventListener('click', closeTemplatePicker);
document.getElementById('tplSearch')?.addEventListener('input', refreshPickerList);
document.getElementById('tplCategory')?.addEventListener('change', refreshPickerList);
});






function renderEmailList(emails, total) {
    if (!emailListContainer) return;
    emailListContainer.innerHTML = '';
    
    const currentStatusFilter = document.getElementById('status-filter')?.value;
    const isApprovalView = currentStatusFilter === 'approval';

    if (emails.length === 0) {
      emailListContainer.innerHTML = `<div class="empty-state"><h3>Nebyly nalezeny ≈æ√°dn√© emaily</h3><p>Zkuste zmƒõnit filtry nebo vyhled√°v√°n√≠.</p></div>`;
      return;
  }

  emails.forEach(email => {
      const sender = (email.sender || '').split('<')[0].trim().replace(/"/g, '') || email.sender;
      const pendingIdValue = email.pendingId ?? null;
      const pendingIdAttr = pendingIdValue !== null && pendingIdValue !== undefined ? escapeHtml(String(pendingIdValue)) : '';
      const srcAttr = escapeHtml(email._src || 'gmail');

      // Dynamick√© p≈ôid√°n√≠ schvalovac√≠ch tlaƒç√≠tek
      const actionButtons = isApprovalView
        ? `<div class="approval-actions" style="margin-top: 8px; display: flex; gap: 8px;">
                <button class="btn btn-success btn-sm approve-btn" data-pending-id="${pendingIdAttr}" data-src="${srcAttr}">‚úÖ Schv√°lit</button>
                <button class="btn btn-danger btn-sm reject-btn" data-pending-id="${pendingIdAttr}" data-src="${srcAttr}">‚ùå Zam√≠tnout</button>
              </div>`
        : `<button class="btn btn-primary analyze-btn" data-message-id="${email.id}" style="margin-top: 5px;">Analyzovat ü§ñ</button>`;

      const replyPreviewRaw = (email.replyBody || '').trim();
      const replyPreview = replyPreviewRaw ? replyPreviewRaw.slice(0, 180) + (replyPreviewRaw.length > 180 ? '‚Ä¶' : '') : '';
      const summaryText = (email.summary || email.snippet || '').trim();
      const badge = email._pending
        ? `<div class="status-badge" style="display:inline-flex; align-items:center; gap:6px; background:#fef3c7; color:#92400e; font-weight:600; padding:2px 8px; border-radius:999px; margin-bottom:6px; font-size:0.8rem;">‚è≥ ƒåek√° na schv√°len√≠</div>`
        : '';

      const preview = isApprovalView
        ? `
            <div class="email-preview">${escapeHtml(summaryText || '(bez shrnut√≠)')}</div>
            <div class="email-preview" style="margin-top:4px; color:#475569;">AI odpovƒõƒè: ${escapeHtml(replyPreview || '(bez n√°vrhu)')}</div>
          `
        : `<div class="email-preview">${escapeHtml(email.snippet || '')}</div>`;

      const datasetParts = [
        `data-id="${escapeHtml(email.id || '')}"`,
        `data-src="${srcAttr}"`,
        `data-from="${escapeHtml(email.sender || '')}"`
      ];‚êä
      if (email.account) datasetParts.push(`data-account="${escapeHtml(email.account)}"`);
      if (pendingIdValue !== null && pendingIdValue !== undefined) datasetParts.push(`data-pending-id="${pendingIdAttr}"`);
      if (email.messageId) datasetParts.push(`data-message-id="${escapeHtml(email.messageId)}"`);
      if (email._pending) datasetParts.push('data-pending="1"');

      const emailHTML = `
              <div class="email-item" ${datasetParts.join(' ')}>
                  <div class="email-content" style="flex-grow: 1;">
                      ${badge}
                      <div class="email-sender">${escapeHtml(sender)}</div>
                      <div class="email-subject">${escapeHtml(email.subject || '(bez p≈ôedmƒõtu)')}</div>
                      ${preview}
                  </div>
                  <div class="email-meta" style="text-align: right; flex-shrink: 0;">
                      <div>${new Date(email.date).toLocaleDateString('cs-CZ')}</div>
                      ${actionButtons}
                  </div>
              </div>`;
      emailListContainer.insertAdjacentHTML('beforeend', emailHTML);
  });
}

function renderPendingPreview(entry) {
  const card = document.getElementById('ed-ai-card');
  const summaryEl = document.getElementById('ed-ai-summary');
  const sentimentEl = document.getElementById('ed-ai-sentiment');
  const replyEl = document.getElementById('ed-ai-reply');

  if (!card || !summaryEl || !sentimentEl || !replyEl) return;

  if (!entry || !entry._pending) {
    card.style.display = 'none';
    summaryEl.textContent = '‚Äî';
    sentimentEl.textContent = '‚Äî';
    replyEl.textContent = '';
    return;
  }

  card.style.display = '';
  summaryEl.textContent = entry.summary || '(bez shrnut√≠)';
  sentimentEl.textContent = entry.sentiment || '(neuvedeno)';
  replyEl.textContent = entry.replyBody || '';
}




// --- Akce schv√°len√≠/odm√≠tnut√≠ pro maily v re≈æimu "ƒåekaj√≠c√≠" ---
document.getElementById('email-list-container')?.addEventListener('click', async (e) => {
  const approveBtn = e.target.closest('.approve-btn');
  const rejectBtn  = e.target.closest('.reject-btn');
  if (!approveBtn && !rejectBtn) return;

 const row = e.target.closest('.email-item');
    const pendingId = row?.dataset.pendingId;
    const src = row?.dataset.src || 'gmail';

    const dashboardUserEmail = localStorage.getItem('userEmail');
    const accountEmail       = localStorage.getItem('primaryEmail');

    const triggerBtn = approveBtn || rejectBtn;

    try {
      if (!pendingId) throw new Error('Chyb√≠ ID n√°vrhu.');
      if (!dashboardUserEmail || !accountEmail) throw new Error('Chyb√≠ kontext √∫ƒçtu.');
      if (!['gmail', 'custom'].includes(src)) throw new Error('Nepodporovan√Ω typ √∫ƒçtu.');

      if (triggerBtn) triggerBtn.disabled = true;

      const endpoint = approveBtn ? 'approve' : 'reject';
      const url = src === 'custom'
        ? `${window.BACKEND}/api/custom-email/pending-replies/${pendingId}/${endpoint}`
        : `${window.BACKEND}/api/gmail/pending-replies/${pendingId}/${endpoint}`;

      const payload = src === 'custom'
        ? { dashboardUserEmail, emailAddress: accountEmail }
        : { dashboardUserEmail, email: accountEmail };

      const r = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok || !j.success) throw new Error(j.message || 'Akce selhala.');

      showToast(j.message || (approveBtn ? 'Odpovƒõƒè byla odesl√°na.' : 'N√°vrh byl zam√≠tnut.'), 'success');
      await fetchEmails();
    } catch (err) {
      showToast(err.message || 'Chyba akce.', 'error');
    } finally {
      if (triggerBtn) triggerBtn.disabled = false;
    }
  });












// ZMƒöNA: Funkce nyn√≠ naƒç√≠t√° nastaven√≠ pro aktu√°lnƒõ vybran√Ω prim√°rn√≠ email
async function loadSettings() {
    const primaryEmail = localStorage.getItem('primaryEmail');
    if (!primaryEmail) {
        showToast('Nen√≠ vybr√°n ≈æ√°dn√Ω √∫ƒçet pro nastaven√≠.', 'warning');
        return;
    }

    console.log(`Naƒç√≠t√°m nastaven√≠ pro: ${primaryEmail}`);
    try {
        const response = await fetch(
  `https://ai-email-server-stejdesign.onrender.com/api/settings` +
  `?email=${encodeURIComponent(primaryEmail)}` +
  `&dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`
);
        const data = await response.json();
        if (data.success && data.settings) {
            const { tone, length, signature, auto_reply, approval_required, spam_filter } = data.settings;
            toneSelect.value = tone;
            lengthSelect.value = length;
            signatureTextarea.value = signature;
            autoReplySwitch.checked = auto_reply;
            approvalSwitch.checked = approval_required;
            spamFilterSwitch.checked = spam_filter;
            showToast(`Nastaven√≠ pro ${primaryEmail} bylo naƒçteno.`, 'success');
            window.CURRENT_SETTINGS = data.settings;
        } else {
             // Pokud pro dan√Ω email nastaven√≠ neexistuje, resetujeme formul√°≈ô do v√Ωchoz√≠ho stavu
            settingsForm.reset();
            showToast(`Pro ${primaryEmail} zat√≠m nebylo ulo≈æeno ≈æ√°dn√© nastaven√≠.`, 'info');
        }
    } catch (error) { showToast('Nepoda≈ôilo se naƒç√≠st nastaven√≠.', 'error'); }
}

// ZMƒöNA: Funkce ukl√°d√° nastaven√≠ pro aktu√°lnƒõ vybran√Ω prim√°rn√≠ email
async function saveSettings(event) {
    event.preventDefault();
    const primaryEmail = localStorage.getItem('primaryEmail');
    if (!primaryEmail) {
        showToast('Nen√≠ vybr√°n ≈æ√°dn√Ω √∫ƒçet, pro kter√Ω by se mƒõlo nastaven√≠ ulo≈æit.', 'error');
        return;
    }

    const settings = {
        dashboardUserEmail,                 
  email: primaryEmail,
  tone: toneSelect.value,
  length: lengthSelect.value,
  signature: signatureTextarea.value,
  auto_reply: autoReplySwitch.checked,
  approval_required: approvalSwitch.checked,
  spam_filter: spamFilterSwitch.checked
    };
    try {
        const response = await fetch('https://ai-email-server-stejdesign.onrender.com/api/settings', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(settings)
        });
        const data = await response.json();
        showToast(data.success ? data.message : `Chyba: ${data.message}`, data.success ? 'success' : 'error');
    } catch (error) { showToast('Nepoda≈ôilo se ulo≈æit nastaven√≠.', 'error'); }
}



async function loadPlan() {
  const userEmail = localStorage.getItem('userEmail');
  if (!userEmail) return;

  try {
    const res = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/user/plan?email=${encodeURIComponent(userEmail)}`);
    const data = await res.json();
    if (data.success && data.plan) {
      // za≈°krtnout spr√°vn√Ω radio
      const input = document.querySelector(`.plan-input[value="${data.plan}"]`);
      if (input) input.checked = true;
      // badge
      const badge = document.getElementById('current-plan-badge');
      if (badge) badge.textContent = `Aktu√°ln√≠: ${data.plan}`;
    }
  } catch (err) {
    console.error('Nepoda≈ôilo se naƒç√≠st pl√°n:', err);
  }
}

async function savePlan() {
  const userEmail = localStorage.getItem('userEmail');
  const selected = document.querySelector('.plan-input:checked');
  if (!userEmail || !selected) { showToast('Vyberte tarif.', 'warning'); return; }

  try {
    const res = await fetch('https://ai-email-server-stejdesign.onrender.com/api/user/plan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: userEmail, plan: selected.value })
    });
    const data = await res.json();
    showToast(data.message, data.success ? 'success' : 'error');
    if (data.success) {
      const badge = document.getElementById('current-plan-badge');
      if (badge) badge.textContent = `Aktu√°ln√≠: ${selected.value}`;
    }
  } catch (err) {
    showToast('Nepoda≈ôilo se ulo≈æit pl√°n.', 'error');
  }
}


async function loadLimits() {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  if (!dashboardUserEmail) return;

  const panel = document.getElementById('usage-panel');
  try {
    const res = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/limits?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
    const data = await res.json();
    if (!data.success) throw new Error('Nepoda≈ôilo se naƒç√≠st limity');

    // AI akce
    const used = data.ai_actions_used ?? 0;
    const limit = data.monthly_ai_actions ?? 0;
    const left = Math.max(0, limit - used);
    const pctAI = limit > 0 ? Math.min(100, Math.round((used / limit) * 100)) : 0;

    document.getElementById('ai-used').textContent = used;
    document.getElementById('ai-limit').textContent = limit;
    document.getElementById('ai-left').textContent = left;
    document.getElementById('ai-bar').style.width = pctAI + '%';

    // P≈ôipojen√© √∫ƒçty
    const accLimit = data.max_accounts ?? 0;
    const accCount = await getConnectedAccountsCount(dashboardUserEmail);
    const pctAcc = accLimit > 0 ? Math.min(100, Math.round((accCount / accLimit) * 100)) : 0;

    document.getElementById('acc-count').textContent = accCount;
    document.getElementById('acc-limit').textContent = accLimit;
    document.getElementById('acc-bar').style.width = pctAcc + '%';

    // Obdob√≠
    document.getElementById('usage-period').textContent =
      `Obdob√≠: od ${data.period_start} (UTC) | Tarif: ${data.plan}`;

    panel.style.display = 'block';
  } catch (e) {
    console.error(e);
    if (panel) panel.style.display = 'none';
  }
}

async function getConnectedAccountsCount(dashboardUserEmail) {
  try {
    const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/accounts?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
    const j = await r.json();
    if (j.success) {
      const arr = Array.isArray(j.accounts) ? j.accounts : (j.emails || []).map(e => ({email:e, active:true}));
      return Array.isArray(arr) ? arr.length : 0;
    }
  } catch (_) {}
  return 0;
}



function enterEditMode() {
    const view = document.getElementById('response-display');
  const edit = document.getElementById('response-editor');
  if (view && edit) {
    edit.value = (view.innerText || '').trim();
    view.style.display = 'none';
    edit.style.display = 'block';
    edit.focus();
  }
  document.getElementById('edit-reply-btn') ?.style.setProperty('display','none');
  document.getElementById('save-edit-btn') ?.style.setProperty('display','inline-flex');
  document.getElementById('cancel-edit-btn')?.style.setProperty('display','inline-flex');
}

function exitEditMode(saveChanges) {
    const view = document.getElementById('response-display');
  const edit = document.getElementById('response-editor');
  if (saveChanges && view && edit) {
    view.innerText = edit.value;
    showToast('Odpovƒõƒè byla upravena.', 'success');
  }
  if (view && edit) {
    view.style.display = 'block';
    edit.style.display = 'none';
  }
  document.getElementById('edit-reply-btn') ?.style.setProperty('display','inline-flex');
  document.getElementById('save-edit-btn') ?.style.setProperty('display','none');
  document.getElementById('cancel-edit-btn')?.style.setProperty('display','none');
}


// ===================================================================================
// === 3. FUNKCE PRO SPR√ÅVU EMAILOV√ùCH √öƒåT≈Æ ==========================================
// ===================================================================================

// ZMƒöNA: Funkce nyn√≠ zv√Ωrazn√≠ prim√°rn√≠ √∫ƒçet podle localStorage
function renderConnectedAccounts() {
    const listEl = document.querySelector('#email-settings .email-list');
  if (!listEl) return;

  const accs = getConnectedAccounts(); // [{email, active}]
  const primary = localStorage.getItem('primaryEmail'); // primary klidnƒõ nech√°me v LS

  listEl.innerHTML = '';

  if (accs.length === 0) {
    listEl.innerHTML = '<p style="text-align:center;color:#6b7280;padding:2rem;">Zat√≠m nem√°te p≈ôipojen√Ω ≈æ√°dn√Ω emailov√Ω √∫ƒçet.</p>';
    const span = document.getElementById('currentConfigEmail');
    if (span) span.textContent = '≈Ω√°dn√Ω';
    return;
  }

  accs.forEach(({ email, active, type }) => {
    let providerName = 'Vlastn√≠', providerIconClass = 'gmail-icon';
    const e = email.toLowerCase();
    if (e.includes('gmail')) providerName = 'Gmail';
    else if (e.includes('outlook') || e.includes('hotmail')) { providerName = 'Outlook'; providerIconClass = 'outlook-icon'; }
    else if (e.includes('seznam')) providerName = 'Seznam';

    const isSelectedForConfig = (email === primary);

    const html = `
      <div class="email-item ${active ? 'active' : ''}" data-email="${email}" data-type="${type || ''}">
        <div class="checkbox-wrapper" onclick="toggleAccount(this,'${email}',${!!active})">
          <input type="checkbox" class="checkbox-input" ${active ? 'checked' : ''}>
          <div class="checkbox-custom"></div>
        </div>
        <div class="email-info">
          <div class="email-address">${email}</div>
          <div class="email-provider">
            <div class="provider-icon ${providerIconClass}"></div>
            ${providerName} ‚Ä¢ P≈ôipojen
          </div>
        </div>
        <div class="email-controls">
          <div class="status-badge ${active ? 'active':''}">${active ? 'ü§ñ Aktivn√≠' : 'Neaktivn√≠'}</div>
          <div class="radio-wrapper ${isSelectedForConfig ? 'selected' : ''}" onclick="selectForConfig(this, '${email}')">
            <input type="radio" name="configEmail" value="${email}" class="radio-input" ${isSelectedForConfig ? 'checked' : ''}>
            <div class="radio-custom"></div>
            <span class="radio-label">Nastavit</span>
          </div>
          <button class="disconnect-btn" onclick="disconnectAccount('${email}', '${type || ''}' )" title="Odpojit √∫ƒçet">
            <span class="disconnect-icon">√ó</span>
          </button>
        </div>
      </div>`;
    listEl.insertAdjacentHTML('beforeend', html);
  });

  const span = document.getElementById('currentConfigEmail');
  if (span) span.textContent = primary || '≈Ω√°dn√Ω';
}

// ZMƒöNA: Funkce nyn√≠ ulo≈æ√≠ v√Ωbƒõr a znovu naƒçte nastaven√≠
function selectForConfig(radioWrapper, email) {
    // Ulo≈æ√≠me nov√Ω prim√°rn√≠ email do localStorage
    localStorage.setItem('primaryEmail', email);

    // Vizu√°ln√≠ aktualizace
    document.querySelectorAll('#email-settings .radio-wrapper').forEach(wrapper => wrapper.classList.remove('selected'));
    radioWrapper.classList.add('selected');
    radioWrapper.querySelector('.radio-input').checked = true;
    document.getElementById('currentConfigEmail').textContent = email;
    
    // NOV√â: Okam≈æitƒõ naƒçteme nastaven√≠ pro novƒõ vybran√Ω √∫ƒçet
    loadSettings();
    fetchEmails();
}

async function toggleAccount(wrapper, email, currentActive) {
  const checkbox = wrapper.querySelector('.checkbox-input');
  // optimisticky otoƒç√≠me hodnotu
  const newActive = !currentActive;
  checkbox.checked = newActive;

  try {
    const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/accounts/set-active', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email, active: newActive })
    });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Nepoda≈ôilo se ulo≈æit.');

    // refresh listu ze serveru (pravda je na serveru)
    const accs = await syncConnectedEmails();
    renderConnectedAccounts();

    // pokud jsi vypnul pr√°vƒõ prim√°rn√≠ √∫ƒçet ‚Üí zamez naƒç√≠t√°n√≠ email≈Ø
    const prim = localStorage.getItem('primaryEmail');
    const primObj = accs.find(a => a.email === prim);
    if (!primObj || !primObj.active) {
      if (emailListContainer) {
        emailListContainer.innerHTML = `<div class="empty-state"><h3>Prim√°rn√≠ √∫ƒçet je neaktivn√≠</h3><p>Pro naƒçten√≠ email≈Ø ho aktivujte v Nastaven√≠ ‚Üí Email √∫ƒçty.</p></div>`;
        if (emailCountHeader) emailCountHeader.textContent = 'Emaily';
      }
    } else {
      // pokud je str√°nka ‚ÄûEmaily‚Äú otev≈ôen√°, naƒçti je znovu
      const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
      if (emailsPageActive) fetchEmails();
    }

    showToast(`Stav √∫ƒçtu ${email} byl zmƒõnƒõn.`, 'success');
  } catch (e) {
    // revert UI p≈ôi chybƒõ
    checkbox.checked = currentActive;
    showToast(`Chyba: ${e.message || e}`, 'error');
  }
}





async function addAccount() {
     const dashboardUserEmail = localStorage.getItem('userEmail');
  if (!dashboardUserEmail) {
    showToast('Nejste p≈ôihl√°≈°en.', 'error');
    return;
  }

  try {
    // naƒçti limity i aktu√°ln√≠ poƒçet √∫ƒçt≈Ø najednou
    const [limitsRes, accCount] = await Promise.all([
      fetch(`https://ai-email-server-stejdesign.onrender.com/api/limits?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`)
        .then(r => r.json()),
      getConnectedAccountsCount(dashboardUserEmail)
    ]);

    // kdy≈æ API na limity sel≈æe, rad≈°i modal otev≈ôi (fallback)
    if (!limitsRes?.success) {
      openModal();
      return;
    }

    const plan = limitsRes.plan;                   // nap≈ô. "Starter"
    const maxAccounts = limitsRes.max_accounts ?? 0;
    const hasReachedLimit = accCount >= maxAccounts;

    if (hasReachedLimit) {
      const msg = plan === 'Starter'
        ? 'Na tarifu Starter lze p≈ôipojit maxim√°lnƒõ 1 emailov√Ω √∫ƒçet. Pro p≈ôid√°n√≠ dal≈°√≠ho √∫ƒçtu p≈ôejdƒõte na vy≈°≈°√≠ tarif v Nastaven√≠ ‚Üí Pl√°n.'
        : `Dos√°hli jste limitu p≈ôipojen√Ωch √∫ƒçt≈Ø pro tarif ${plan} (max ${maxAccounts}). Pro p≈ôid√°n√≠ dal≈°√≠ho √∫ƒçtu p≈ôejdƒõte v Nastaven√≠ na vy≈°≈°√≠ tarif.`;

      // uk√°≈æeme dlouhou notifikaci a nab√≠dneme rovnou p≈ôepnut√≠ na Pl√°n
      showToast(msg, 'warning', {
        duration: 9000,
        actionText: 'P≈ôej√≠t na Pl√°n',
        onAction: () => {
          // otev≈ôi str√°nku Nastaven√≠ ‚Üí z√°lo≈æku Pl√°n
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          const settingsLink = document.querySelector('.nav-link[data-page="settings"]');
          if (settingsLink) settingsLink.classList.add('active');

          document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
          const settingsPage = document.getElementById('settings');
          if (settingsPage) settingsPage.classList.add('active');

          document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.settings-content').forEach(c => c.style.display = 'none');

          const planTab = document.querySelector('.settings-tab[data-tab="plan"]');
          if (planTab) planTab.classList.add('active');

          const planContent = document.getElementById('plan-settings');
          if (planContent) planContent.style.display = 'block';

          // v≈ædy naƒçti ƒçerstv√° data
          loadPlan();
          loadLimits();
        }
      });

      // D≈ÆLE≈ΩIT√â: tady skonƒçit ‚Äì neotev√≠rat modal
      return;
    }

    // limit nen√≠ vyƒçerp√°n ‚Üí otev≈ôi modal pro p≈ôipojen√≠
    openModal();

  } catch (e) {
    console.error(e);
    // p≈ôi chybƒõ radƒõji modal otev≈ôi, a≈• m√° u≈æivatel ≈°anci to zkusit
    openModal();
  }
}

// ZMƒöNA: Funkce zkontroluje, zda nebyl odpojen prim√°rn√≠ √∫ƒçet
async function disconnectAccount(email, accType) {
  if (!confirm(`Opravdu chcete odpojit √∫ƒçet ${email}?`)) return;

  const dashboardUserEmail = localStorage.getItem('userEmail');
  if (!dashboardUserEmail) { showToast('Nejste p≈ôihl√°≈°en.', 'error'); return; }

  // 1) vyber endpoint podle typu
  //    - pokud accType nen√≠ k dispozici, zkus√≠me nejd≈ô√≠v custom, pak gmail (fallback)
  const tries = accType === 'custom' ? [
    { url: `${window.BACKEND}/api/custom-email/disconnect`, body: { dashboardUserEmail, emailAddress: email } }
  ] : accType === 'gmail' ? [
    { url: `${window.BACKEND}/api/oauth/google/revoke`, body: { dashboardUserEmail, email } }
  ] : [
    // nezn√°m√Ω typ -> zkus oba
    { url: `${window.BACKEND}/api/custom-email/disconnect`, body: { dashboardUserEmail, emailAddress: email } },
    { url: `${window.BACKEND}/api/oauth/google/revoke`, body: { dashboardUserEmail, email } }
  ];

  let ok = false, lastMsg = 'Nepoda≈ôilo se odpojit √∫ƒçet.';
  for (const t of tries) {
    try {
      const res = await fetch(t.url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(t.body)
      });
      const j = await res.json();
      if (j?.success) { ok = true; lastMsg = j.message || '√öƒçet odpojen.'; break; }
      lastMsg = j?.message || lastMsg;
    } catch (e) {
      lastMsg = e?.message || lastMsg;
    }
  }
  if (!ok) { showToast(lastMsg, 'error'); return; }

  // 2) refresh √∫ƒçt≈Ø a UI
  const serverAccs = await fetchConnectedEmailsFromServer();
  setConnectedAccounts(serverAccs);

  // pokud jsme odpojili prim√°rn√≠, nahraƒè ho jin√Ωm / sma≈æ
  const currentPrimary = localStorage.getItem('primaryEmail');
  if (currentPrimary === email) {
    const firstEmail = serverAccs[0]?.email;
    if (firstEmail) localStorage.setItem('primaryEmail', firstEmail);
    else localStorage.removeItem('primaryEmail');
  }

  renderConnectedAccounts();

  const newPrimaryAfter = localStorage.getItem('primaryEmail');
  if (newPrimaryAfter) {
    await loadSettings();
    const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
    if (emailsPageActive) fetchEmails();
  } else {
    if (emailListContainer)
      emailListContainer.innerHTML = `<div class="empty-state"><h3>Nem√°te p≈ôipojen√Ω ≈æ√°dn√Ω √∫ƒçet</h3><p>P≈ôidejte si √∫ƒçet v Nastaven√≠ ‚Üí Email √∫ƒçty.</p></div>`;
  }

  await loadLimits();
  showToast(lastMsg || '√öƒçet byl √∫spƒõ≈°nƒõ odpojen.', 'success');
}



// Pomocn√© regexy
const VAR_RE = /{{\s*([a-zA-Z0-9_.-]+)\s*}}/g;
const AI_RE  = /\[\[\s*AI\s*:(.*?)\]\]/gs;

window.__lastUsedTemplateId = null;


  async function useTemplate(tpl) {
  const modalEl         = document.getElementById('analysisModal');
  const responseDisplay = document.getElementById('response-display');
  const responseEditor  = document.getElementById('response-editor');

  if (!modalEl) { showToast('Nelze otev≈ô√≠t editor odpovƒõdi.', 'error'); return; }

  // otev≈ôi modal + p≈ôepni do editaƒçn√≠ho re≈æimu
  modalEl.classList.add('show');
  document.body.style.overflow = 'hidden';
  if (responseDisplay) responseDisplay.style.display = 'none';
  if (responseEditor)  {
    responseEditor.style.display = 'block';
    responseEditor.value = 'Naƒç√≠t√°m ≈°ablonu‚Ä¶';
  }
  document.getElementById('view-mode-buttons')?.style.setProperty('display', 'none');
  document.getElementById('edit-mode-buttons')?.style.setProperty('display', 'flex');

  window.__lastUsedTemplateId = tpl.id;

  try {
    const dashboardUserEmail = localStorage.getItem('userEmail');

    // volitelnƒõ: naƒçti nastaven√≠, pokud m√°te utilitu
    if (typeof ensureSettingsLoaded === 'function') {
      try { await ensureSettingsLoaded(); } catch(_) {}
    }

    // poskl√°dej context
    const context = {
      emailBody: (window.CURRENT_EMAIL?.bodyText) || '',
      analysis:  (window.CURRENT_EMAIL?.analysis) || {},
      settings:  (window.CURRENT_SETTINGS) || {},
      meta: {
        subject: window.CURRENT_EMAIL?.subject || '',
        from:    window.CURRENT_EMAIL?.from || '',
        date:    window.CURRENT_EMAIL?.date || ''
      }
    };

    // POZOR: ≈æ√°dn√© API_BASE, pou≈æijeme p≈ô√≠mo URL serveru
    const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/templates/render', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dashboardUserEmail, templateId: tpl.id, context })
    });
    const j = await r.json();

    if (j?.success && j?.rendered) {
      responseEditor.value = j.rendered;
      responseEditor.focus();
      showToast(`≈†ablona ‚Äû${tpl.name}‚Äú vlo≈æena do odpovƒõdi.`, 'success');
    } else {
      responseEditor.value = String(tpl.content || '');
      responseEditor.focus();
      showToast(j?.message || 'Render selhal, vlo≈æen p≈Øvodn√≠ obsah.', 'warning');
    }

    if (typeof closeTemplatePicker === 'function') closeTemplatePicker();
  } catch (e) {
    console.error(e);
    responseEditor.value = String(tpl.content || '');
    responseEditor.focus();
    showToast('Nepoda≈ôilo se vyrenderovat ≈°ablonu ‚Äì vlo≈æen p≈Øvodn√≠ obsah.', 'error');
  }
}

// inkrementace uses po √∫spƒõ≈°n√©m odesl√°n√≠ (m√°≈° event handler; jen dovnit≈ô p≈ôidej)
async function afterSuccessfulSend() {
  const tplId = window.__lastUsedTemplateId;
  const dashboardUserEmail = localStorage.getItem('userEmail');
  if (tplId) {
    fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${tplId}/increment-use`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ dashboardUserEmail })
    }).finally(() => {
      window.__lastUsedTemplateId = null;
      loadTemplates(); // aby se hned propsal poƒçet ‚ÄûPou≈æito‚Äú
    });
  }
}














// ZMƒöNA: Hlavn√≠ inicializaƒçn√≠ funkce, kter√° nastav√≠ v√Ωchoz√≠ prim√°rn√≠ √∫ƒçet
async function initializeDashboard() {
  // Kdy≈æ se vr√°time z OAuth, URL m≈Ø≈æe m√≠t ?account-linked=success...
  // Ne≈ôe≈° parametry ‚Äì stejnƒõ si v≈°e st√°hneme z DB a t√≠m je to nejspolehlivƒõj≈°√≠.
  if (new URLSearchParams(location.search).get('account-linked') === 'success') {
    showToast('√öƒçet byl √∫spƒõ≈°nƒõ propojen. Naƒç√≠t√°m √∫ƒçty...', 'success');
    // oƒçisti URL
    const clean = new URL(location.href);
    clean.searchParams.delete('account-linked');
    clean.searchParams.delete('new-email');
    history.replaceState({}, '', clean.toString());
  }

  // 1) st√°hni p≈ôipojen√© √∫ƒçty z backendu a ulo≈æ do localStorage
  let currentPrimary = localStorage.getItem('primaryEmail');
const connectedEmails = await syncConnectedEmails();

if (!currentPrimary || !connectedEmails.some(a => a.email === currentPrimary)) {
  const firstEmail = connectedEmails[0]?.email || null;
  if (firstEmail) localStorage.setItem('primaryEmail', firstEmail);
  else localStorage.removeItem('primaryEmail');
  currentPrimary = firstEmail;
}

  // 3) vykresli seznam √∫ƒçt≈Ø + stav ‚ÄûNastavuji: ...‚Äú
  renderConnectedAccounts();

  // 4) Kdy≈æ je prim√°rn√≠, rovnou naƒçti AI nastaven√≠ a e-maily
  if (currentPrimary) {
    await loadSettings();
    // jestli u≈æivatel stoj√≠ na z√°lo≈æce ‚ÄûEmaily‚Äú, naƒçti je
    const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
    if (emailsPageActive) fetchEmails();
  }
}

(function(){
  const modal = document.getElementById('emailDetailModal');
  const closeBtns = [
    document.getElementById('closeEmailDetail'),
    document.getElementById('closeEmailDetailBottom')
  ].filter(Boolean);

  closeBtns.forEach(btn => btn.addEventListener('click', () => {
    modal.classList.remove('show');
    document.body.style.overflow = '';
  }));

  // Klik mimo modal zav≈ôe
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
  });
})();



// ===================================================================================
// === 4. HLAVN√ç BLOK - SPU≈†TƒöN√ç PO NAƒåTEN√ç STR√ÅNKY ==================================
// ===================================================================================


document.addEventListener('DOMContentLoaded', () => {
    wireFaqButtons(); 
    console.log('AI Emailov√Ω Agent Dashboard loaded successfully');
    initAdminEventListeners();

 const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
        const adminMenuItem = document.getElementById('admin-menu-item');
        if (adminMenuItem) {
            adminMenuItem.style.display = 'block';
        }
    }

    const adminTabLink = document.querySelector('.nav-link[data-page="admin"]');
    if (adminTabLink) {
        adminTabLink.addEventListener('click', loadAdminUsers);
    }



    const planTab = document.querySelector('.settings-tab[data-tab="plan"]');
if (planTab) {
  planTab.addEventListener('click', () => {
    loadPlan();
    loadLimits(); // v≈ædy se naƒçtou ƒçerstv√° data p≈ôi kliknut√≠ na z√°lo≈æku "Pl√°n"
  });
}
    
    const userName = localStorage.getItem('userName');
    if (!userName) {
        alert("Nejste p≈ôihl√°≈°en.");
        window.location.href = 'login.html';
        return;
    }
    const avatarDiv = document.querySelector('.user-avatar');
    const userNameDisplay = document.getElementById('user-name-display');
    if (userNameDisplay) userNameDisplay.textContent = userName;
    if (avatarDiv) {
        const nameParts = userName.split(' ');
        let initials = nameParts.length > 1 ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : userName.substring(0, 2);
        avatarDiv.textContent = initials.toUpperCase();
    }
    const logoutButton = document.getElementById('logout-button');
    if (logoutButton) logoutButton.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'login.html';
    });
    
    initializeDashboard();

    if (collapseBtn) {
        collapseBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            collapseBtn.innerHTML = sidebar.classList.contains('collapsed') ? '<span>‚Üí</span>' : '<span>‚Üê</span>';
        });
    }

    navLinks.forEach(link => {
       link.addEventListener('click', (e) => {
            e.preventDefault();
            
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            
           
            pageContents.forEach(page => page.classList.remove('active'));
            
            const targetPageId = link.getAttribute('data-page');
            const targetElement = document.getElementById(targetPageId);
            if (targetElement) {
                targetElement.classList.add('active');
            }

            if (pageTitle) {
                const titles = { 'dashboard': 'Dashboard', 'emails': 'Spr√°va email≈Ø', 'templates': '≈†ablony', 'settings': 'Nastaven√≠', 'analytics': 'Analytika', 'integrations': 'Integrace', 'admin': 'Admin' };
                pageTitle.textContent = titles[targetPageId] || 'Dashboard';
            }

            // Naƒçten√≠ dat pro p≈ô√≠slu≈°nou str√°nku
            if (targetPageId === 'emails') fetchEmails();
            if (targetPageId === 'settings') loadSettings();
            if (targetPageId === 'analytics') loadAnalytics(7);
            if (targetPageId === 'admin') {
                loadAdminUsers();
                loadActivityLog();
            }
        });
    });



// ≈†ablony ‚Äì naƒçti, kdy≈æ u≈æivatel otev≈ôe z√°lo≈æku ‚Äû≈†ablony‚Äú
const templatesTabLink = document.querySelector('.nav-link[data-page="templates"]');
if (templatesTabLink) {
  templatesTabLink.addEventListener('click', () => loadTemplates());
}

// V AI/Nastaven√≠ tab panelu ‚Äì pokud chce≈° naƒç√≠tat i p≈ôi kliku na ‚Äû≈†ablony‚Äú p≈ôes postrann√≠ menu
document.getElementById('tpl-save-btn')?.addEventListener('click', (e) => {
  const editingId = e.currentTarget.dataset.editingId;
  if (editingId) return saveEditedTemplate(editingId);
  return createTemplate();
});


    if (settingsTabs) {
        settingsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            settingsTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Skryjeme v≈°echny obsahy z√°lo≈æek
            settingsContents.forEach(content => content.style.display = 'none');
            
            const targetContentId = tab.getAttribute('data-tab') + '-settings';
            const targetContent = document.getElementById(targetContentId);

            if (targetContent) {
                 targetContent.style.display = 'block';

                 // pokud je to FAQ tab, naƒçti FAQ
                 if (tab.getAttribute('data-tab') === 'faq') {
  loadFaqs();
  // wireFaqButtons() se nyn√≠ vol√° jen jednou v DOMContentLoaded, tak≈æe ho odsud odebereme
}

                 if (tab.getAttribute('data-tab') === 'email') {
                     renderConnectedAccounts();
                 }
                 if (tab.getAttribute('data-tab') === 'ai') {
                     loadSettings(); // Naƒçteme nastaven√≠, kdy≈æ se vr√°t√≠me na AI z√°lo≈æku
                 }
                 if (tab.getAttribute('data-tab') === 'plan') {
          loadPlan();
          loadLimits();
        }
            }
        });
    });
    }

    if (emailListContainer) {
        emailListContainer.addEventListener('click', async (event) => {
            const analyzeButton = event.target.closest('.analyze-btn');
            if (analyzeButton) {
                currentMessageId = analyzeButton.dataset.messageId;
                const primaryEmail = localStorage.getItem('primaryEmail'); // ZMƒöNA
                if (!primaryEmail) {
                    showToast('≈Ω√°dn√Ω propojen√Ω email pro anal√Ωzu.', 'error'); return;
                }
                const modalBody = document.getElementById('analysisModalBody');
                if (analysisModal && modalBody) {
                    modalBody.innerHTML = '<div class="loading" style="margin: 4rem auto;"></div>';
                    analysisModal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
                try {

const modalEl = modalBody.closest('.modal');
modalEl?.classList.add('analysis-modal');

modalBody.innerHTML = `
  <div class="analysis-loading">
    <div class="analysis-spinner"></div>
  </div>
`;

// jednor√°zovƒõ injektuj CSS pro loader
(function injectAnalysisLoaderStyles(){
  if (document.getElementById('analysis-loading-styles')) return;
  const style = document.createElement('style');
  style.id = 'analysis-loading-styles';
  style.textContent = `
    .analysis-modal .analysis-loading{
      min-height: 320px;
      display: grid;
      place-items: center;
    }
    .analysis-modal .analysis-spinner{
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 4px solid #e5e7eb;
      border-top-color: #667eea;
      animation: analysis-spin 1s linear infinite;
    }
    @keyframes analysis-spin { to { transform: rotate(360deg); } }
  `;
  document.head.appendChild(style);
})();
                    

                    // z karty zpr√°vy si vezmeme zdroj (gmail/custom)
const item = analyzeButton.closest('.email-item');
let src = item?.dataset?.src;
 // 1) pokud je n√°zev listu/hlaviƒçka "Custom IMAP", ber to jako custom
 const hdr = document.getElementById('email-count');
 const headerText = hdr?.textContent || '';
 if (/Custom IMAP/i.test(headerText)) src = 'custom';
 // 2) pokud m√°me ƒçistƒõ ƒç√≠seln√© ID (UID), je to custom
 if (src !== 'custom' && /^\d+$/.test(String(currentMessageId))) src = 'custom';
 // 3) posledn√≠ pojistka ‚Äì kdy≈æ m√°me payload pro custom (viz bodyCustom) a pr√°zdn√Ω messageId,
 //    tak urƒçitƒõ pou≈æij custom endpoint
 // (tuhle podm√≠nku m≈Ø≈æe≈° vynechat, pokud messageId v≈ædy m√°≈°)

// p≈ôiprav payloady pro oba p≈ô√≠pady
const bodyGmail = {
  dashboardUserEmail,
  email: primaryEmail,
  messageId: currentMessageId,
  styleProfile: (window.CURRENT_SETTINGS && window.CURRENT_SETTINGS.style_profile) || null
};
const bodyCustom = {
  dashboardUserEmail,
  emailAddress: primaryEmail,
  uid: Number(currentMessageId) // u customu pos√≠l√°me UID jako ƒç√≠slo
};

// zvol spr√°vn√Ω endpoint
const analyzeUrl = src === 'custom'
    ? `${window.BACKEND}/api/custom-email/analyze-email`
    : `${window.BACKEND}/api/gmail/analyze-email`;

// zavolej anal√Ωzu
const response = await fetch(analyzeUrl, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(src === 'custom' ? bodyCustom : bodyGmail)
});
const data = await response.json();
if (!response.ok || !data.success) throw new Error(data.message || 'Anal√Ωza selhala.');

// zapamatuj si zdroj, a≈• odes√≠l√°n√≠ v√≠, kam se m√° poslat reply
window.__currentEmailSource    = src;          // 'gmail' | 'custom'
window.__currentAccountAddress = primaryEmail;

if (data.success && modalBody) {
  modalBody.innerHTML = `
    <div class="analysis-section">
      <div class="section-header">
        <div class="section-icon">üìä</div>
        <div class="section-title">Shrnut√≠ a sentiment</div>
      </div>
      <div class="section-content">
        <strong>Shrnut√≠:</strong> ${data.analysis.summary}<br>
        <strong>Sentiment:</strong> ${data.analysis.sentiment}
      </div>
    </div>
    <div class="response-section">
      <div class="response-header">
        <div class="response-title"><span>‚ú®</span> Doporuƒçen√° odpovƒõƒè</div>
      </div>
      <div class="response-content" id="response-display">${data.analysis.suggested_reply.replace(/\n/g, '<br>')}</div>
      <textarea class="form-control" id="response-editor" style="display: none;"></textarea>
    </div>`;

  window.CURRENT_EMAIL = {
                        id: currentMessageId,
                        subject: item?.querySelector('.email-subject')?.textContent?.trim() || '',
                        from:    item?.dataset?.from || '',
                        date:    item?.querySelector('.email-meta > div')?.textContent?.trim() || '',
                        bodyText: data.emailBody || '',
                        analysis: data.analysis || {},
                        account:  primaryEmail,
                        headers: data.headers || {} // <-- P≈òID√ÅNO: Ulo≈æ√≠me hlaviƒçky
                      };


// 1) Roz≈°√≠≈ôit modal + p≈ôidat scope class
const modalEl = modalBody.closest('.modal');
modalEl?.classList.add('analysis-modal');
const modalEl2 = modalBody.closest('.modal');
modalEl2?.classList.add('analysis-modal');
// Pokud bys nƒõkdy mƒõl .modal-dialog, tak bezpeƒçnƒõ:
const dlg = modalEl2?.querySelector?.('.modal-dialog');
if (dlg) dlg.classList.add('modal-xl');

// 2) P≈ôiinjektovat CSS (jednou)
(function injectAnalysisStyles(){
  if (document.getElementById('analysis-modal-styles')) return;
  const css = `
    .analysis-modal .modal-body{ display:block; }
    .analysis-modal .response-section{ width:100%; }

    /* Zobrazen√° odpovƒõƒè (read-only) */
    .analysis-modal .response-content{
      display:block;
      width:100% !important;
      max-width:none !important;
      min-height:300px;
      padding:12px 14px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      overflow:auto;
      white-space:pre-wrap;       /* zachov√° od≈ô√°dkov√°n√≠ */
      word-break:break-word;
    }

    /* Editor */
    .analysis-modal #response-editor{
      display:none;
      width:100% !important;
      max-width:none !important;
      min-height:300px;
      padding:12px 14px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      resize:vertical;
      line-height:1.5;
    }
  `;
  const style = document.createElement('style');
  style.id = 'analysis-modal-styles';
  style.textContent = css;
  document.head.appendChild(style);
})();

                        // TENTO ≈ò√ÅDEK ZAJI≈†≈§UJE, ≈ΩE NOV√â TLAƒå√çTKO BUDE FUNGOVAT
                        document.getElementById('pick-template-btn')?.addEventListener('click', openTemplatePicker);

                    } else if (modalBody) {
                        modalBody.innerHTML = `<p style="text-align: center; color: red;">Chyba anal√Ωzy: ${data.message}</p>`;
                    }




                } catch (error) {
                    if(modalBody) modalBody.innerHTML = `<p style="text-align: center; color: red;">Nepoda≈ôilo se p≈ôipojit k serveru pro anal√Ωzu.</p>`;
                }
            }

 const item = event.target.closest('.email-item');
    if (item && !event.target.closest('.analyze-btn')) {
      const id  = item.dataset.id;
      const src = (item.dataset.src || '').toLowerCase(); // 'gmail' | 'custom'
      const from = item.dataset.from || '';
      const subject = item.querySelector('.email-subject')?.textContent?.trim() || '';
      const dateTxt = item.querySelector('.email-meta > div')?.textContent?.trim() || '';
      const pendingId = item.dataset.pendingId || '';

      const emailEntry = allEmails.find(entry => {
        if (pendingId) {
          return String(entry?.pendingId ?? '') === String(pendingId);
        }
        return String(entry?.id ?? '') === String(id);
      });

      window.__currentEmailCtx = {
        id,                                   // stejn√© "id" co u≈æ m√°≈° (messageId nebo UID)
        src,                                  // 'gmail' | 'custom'
        account: (item.dataset.account || localStorage.getItem('primaryEmail') || ''),
        from,
        subject,
        date: dateTxt,
        pendingId: pendingId || (emailEntry?.pendingId ? String(emailEntry.pendingId) : '')
      };

      // otev≈ôi modal + loading
      const modal = document.getElementById('emailDetailModal');
      const edFrom = document.getElementById('ed-from');
      const edSubj = document.getElementById('ed-subject');
      const edDate = document.getElementById('ed-date');
      const edBody = document.getElementById('ed-body');

      if (!modal || !edFrom || !edSubj || !edDate || !edBody) return;

      const safeFrom = from || '(nezn√°m√Ω odes√≠latel)';
      const safeSubject = subject || '(bez p≈ôedmƒõtu)';
      const safeDate = dateTxt || '';

      edFrom.textContent = safeFrom;
      edFrom.title = safeFrom;
      edSubj.textContent = safeSubject;
      edSubj.title = safeSubject;
      edDate.textContent = safeDate;
      edDate.title = safeDate;
      if (emailEntry && emailEntry._pending && emailEntry.originalBody) {
        edBody.textContent = emailEntry.originalBody;
      } else {
        edBody.textContent = 'Naƒç√≠t√°m obsah zpr√°vy‚Ä¶';
      }
      renderPendingPreview(emailEntry);
      syncProMeta();

      modal.classList.add('show');
      document.body.style.overflow = 'hidden';

      try {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const primaryEmail       = localStorage.getItem('primaryEmail');
        const isCustom = (src === 'custom') || /^\d+$/.test(String(id)); // UID = custom

        const shouldFetchBody = !(emailEntry && emailEntry._pending && emailEntry.originalBody);

        if (shouldFetchBody) {
          // Vol√°n√≠ lehk√©ho backend endpointu pro tƒõlo zpr√°vy (viz zmƒõny v serveru n√≠≈æe)
          let url;
          if (isCustom) {
            url = `${window.BACKEND}/api/custom-email/message-body?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(primaryEmail)}&uid=${encodeURIComponent(id)}`;
          } else {
            url = `${window.BACKEND}/api/gmail/message-body?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(primaryEmail)}&messageId=${encodeURIComponent(id)}`;
          }

          const r = await fetch(url);
          const j = await r.json();
          if (!r.ok || !j.success) throw new Error(j.message || 'Nepoda≈ôilo se naƒç√≠st obsah zpr√°vy.');
          edBody.textContent = j.body || '(tƒõlo zpr√°vy je pr√°zdn√©)';
        }
      } catch (e) {
        edBody.textContent = e.message || 'Chyba p≈ôi naƒç√≠t√°n√≠ obsahu zpr√°vy.';
      }
    }

        });
    }
    
    if (settingsForm) settingsForm.addEventListener('submit', saveSettings);
    if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
    if (analysisModal) analysisModal.addEventListener('click', (e) => { if (e.target === analysisModal) hideAnalysisModal(); });
    if (closeAnalysisModalBtn) closeAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
    if (googleBtn) googleBtn.addEventListener('click', connectGoogleAccount);
    if (statusFilter) statusFilter.addEventListener('change', fetchEmails);
    if (periodFilter) periodFilter.addEventListener('change', fetchEmails);
    if (searchBar) searchBar.addEventListener('search', fetchEmails);
    
    const modalFooter = document.querySelector('#analysisModal .modal-footer');
    if (modalFooter) {
        modalFooter.addEventListener('click', async (event) => {
            if (event.target.closest('#edit-reply-btn')) enterEditMode();
            if (event.target.closest('#save-edit-btn')) exitEditMode(true);
            if (event.target.closest('#cancel-edit-btn')) exitEditMode(false);
            if (event.target.closest('#send-now-btn') || event.target.closest('.btn-success')) {
  const sendButton = event.target.closest('button');
  const primaryEmail = localStorage.getItem('primaryEmail');

  const editor  = document.getElementById('response-editor');
  const display = document.getElementById('response-display');
  const replyBody = (editor && editor.style.display !== 'none'
    ? editor.value
    : (display?.innerText || '')
  ).trim();

  if (!primaryEmail || !currentMessageId || !replyBody) {
    showToast('Chyb√≠ data pro odesl√°n√≠.', 'error'); return;
  }
                
                if (!primaryEmail || !currentMessageId || !replyBody) {
                    showToast('Chyb√≠ data pro odesl√°n√≠.', 'error'); return;
                }
                sendButton.textContent = 'Odes√≠l√°m...'; sendButton.disabled = true;
                
                       
 try {
  // zdroj a √∫ƒçet z anal√Ωzy (nastaveno p≈ôi Analyze)
  const src     = window.__currentEmailSource || 'gmail';      // 'gmail' | 'custom'
  const account = window.__currentAccountAddress || primaryEmail;

  // metadata pro custom odesl√°n√≠
  const subj   = (window.CURRENT_EMAIL?.subject || '').trim();
  const fromRaw = (window.CURRENT_EMAIL?.from || '');
  const toAddr  = extractEmailAddress(fromRaw) || '';

  // p≈ôiprav endpoint + payload
  let urlPost = '', payload = {};
  if (src === 'custom') {
                    // Custom IMAP/SMTP
                    urlPost = `${window.BACKEND}/api/custom-email/send-reply`;
                    payload = {
                      dashboardUserEmail,
                      emailAddress: account,
                      to: toAddr,
                      subject: subj ? `Re: ${subj}` : 'Re:',
                      text: replyBody,
                      replyToUid: Number(currentMessageId),
                      // === P≈òIDAN√â ≈ò√ÅDKY PRO OPRAVU ===
                      origMessageId: window.CURRENT_EMAIL?.headers?.messageId || null,
                      origReferences: window.CURRENT_EMAIL?.headers?.references || null
                    };
                  } else {
    // Gmail
urlPost = `${window.BACKEND}/api/gmail/send-reply`;
payload = {
  dashboardUserEmail,
  email: account,
  messageId: currentMessageId,
  replyBody
};

  }



  // odeslat
  const response = await fetch(urlPost, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await response.json();

  if (data.success) {
    showToast(data.message, 'success');
    hideAnalysisModal();
    afterSuccessfulSend();
    await fetchEmails();// okam≈æit√Ω refresh seznamu email≈Ø po odesl√°n√≠
    const tplId = window.__lastUsedTemplateId;
if (tplId) {
  fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${tplId}/increment-use`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ dashboardUserEmail })
  }).finally(() => {
    window.__lastUsedTemplateId = null;
    loadTemplates();
  });
}

    // tv≈Øj existuj√≠c√≠ blok s increment-use (pokud ho m√°≈°) nechej beze zmƒõny pod t√≠mto
  } else {
    showToast(`Chyba: ${data.message}`, 'error');
  }


                        
                
                } catch (error) {
                    showToast('Nepoda≈ôilo se p≈ôipojit k serveru pro odesl√°n√≠.', 'error');
                } finally {
                    sendButton.textContent = 'Odeslat nyn√≠'; sendButton.disabled = false;
                }
            }
        });
    }

    document.getElementById('pick-template-btn')?.addEventListener('click', openTemplatePicker);
const tplPicker = document.getElementById('templatePicker');
tplPicker?.addEventListener('click', (e) => { if (e.target === tplPicker) closeTemplatePicker(); });
document.getElementById('closeTemplatePicker')?.addEventListener('click', closeTemplatePicker);
document.getElementById('cancelTplPicker')?.addEventListener('click', closeTemplatePicker);
document.getElementById('tplSearch')?.addEventListener('input', refreshPickerList);
document.getElementById('tplCategory')?.addEventListener('change', refreshPickerList);


    
// ===== FAQ (per √∫ƒçet) =====
async function loadFaqs() {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const account = (localStorage.getItem('primaryEmail') || '').trim();

  const infoEl = document.getElementById('faq-current-account');
  if (infoEl) infoEl.textContent = account || '(nen√≠ zvolen prim√°rn√≠ √∫ƒçet)';

  const listEl = document.getElementById('faq-list');
  if (!dashboardUserEmail || !account) {
    if (listEl) listEl.innerHTML = `<div class="banner error">Chyb√≠ p≈ôihl√°≈°en√Ω u≈æivatel nebo aktivn√≠ √∫ƒçet.</div>`;
    return;
  }

  // 1) zkus naƒç√≠st existuj√≠c√≠ FAQ
  let faqs = [];
  try {
    const r = await fetch(`${window.BACKEND}/api/faq?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(account)}`);
    const j = await r.json();
    if (j?.success) faqs = Array.isArray(j.faqs) ? j.faqs : (Array.isArray(j.items) ? j.items : []);
  } catch(e) {
    // nech√°me pokraƒçovat na autogeneraci
  }

  // 2) pokud nic nen√≠, automaticky vygeneruj z posledn√≠ch 200
  if (!faqs.length) {
    const ok = await autoGenerateFaq(200); // ‚Üì viz funkce n√≠≈æe
    if (ok) {
      try {
        const r2 = await fetch(`${window.BACKEND}/api/faq?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(account)}`);
        const j2 = await r2.json();
        if (j2?.success) faqs = Array.isArray(j2.faqs) ? j2.faqs : (Array.isArray(j2.items) ? j2.items : []);
      } catch(e){}
    }
  }

  renderFaqList(faqs); 
}

function renderFaqList(items=[]) {
  const listEl = document.getElementById('faq-list');
  if (!listEl) return;

  items = items.map(it => ({
    id: it.id, // Ujist√≠me se, ≈æe ID je p≈ô√≠tomno
    q: it.q || it.question || '',
    a: it.a || it.answer || ''
  }));

  if (!items.length) {
    listEl.innerHTML = `<div class="banner info">Zat√≠m ≈æ√°dn√© polo≈æky. Klikni na ‚ÄûP≈ôidat FAQ polo≈æku‚Äú nebo ‚ÄûNauƒçit se z historie‚Äú.</div>`;
    return;
  }

  listEl.innerHTML = items.map((it, idx) => `
    <div class="card" data-faq-index="${idx}" data-db-id="${it.id || ''}" style="padding:.75rem; border:1px solid #e5e7eb; border-radius:12px;">
      <div class="form-group">
        <label class="form-label">Ot√°zka</label>
        <input class="form-control faq-q" value="${escapeHtml(it.q)}" placeholder="Nap≈ô. Jak zmƒõnit fakturaƒçn√≠ √∫daje?">
      </div>
      <div class="form-group">
        <label class="form-label">Odpovƒõƒè</label>
        <textarea class="form-control faq-a" rows="3" placeholder="Struƒçn√°, jasn√° odpovƒõƒè‚Ä¶">${escapeHtml(it.a)}</textarea>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button type="button" class="btn btn-danger faq-del">üóëÔ∏è Smazat</button>
      </div>
    </div>
  `).join('');
}



function wireFaqButtons() {
  const faqList = document.getElementById('faq-list');
  
  // Delegov√°n√≠ ud√°lost√≠ pro maz√°n√≠ - bude fungovat pro v≈°echny polo≈æky
  faqList?.addEventListener('click', async (event) => {
    const deleteButton = event.target.closest('.faq-del');
    if (!deleteButton) return;

    const card = deleteButton.closest('[data-faq-index]');
    const dbId = card.dataset.dbId;

    // Pokud polo≈æka nem√° 'dbId', byla jen novƒõ p≈ôidan√° a neulo≈æen√°.
    // Staƒç√≠ ji smazat z DOMu.
    if (!dbId) {
      card.remove();
      return;
    }

    // Pokud ID m√°, mus√≠me zavolat API pro smaz√°n√≠ z datab√°ze.
    const dashboardUserEmail = localStorage.getItem('userEmail');
    const primaryEmail = localStorage.getItem('primaryEmail');

    

    try {
      const response = await fetch(`${window.BACKEND}/api/faq/${dbId}?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(primaryEmail)}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.success) {
        card.remove(); // Sma≈æeme z DOMu a≈æ po √∫spƒõ≈°n√©m smaz√°n√≠ z DB
        showToast('Polo≈æka byla smaz√°na.', 'success');
      } else {
        throw new Error(data.message || 'Nepoda≈ôilo se smazat polo≈æku.');
      }
    } catch (error) {
      showToast(error.message, 'error');
    }
  });

  // P≈ôid√°n√≠ nov√© FAQ polo≈æky
  document.getElementById('faq-add-btn')?.addEventListener('click', () => {
    const listEl = document.getElementById('faq-list');
    const newIndex = (listEl.querySelectorAll('[data-faq-index]').length > 0)
      ? Math.max(...Array.from(listEl.querySelectorAll('[data-faq-index]')).map(el => parseInt(el.dataset.faqIndex, 10))) + 1
      : 0;

    const div = document.createElement('div');
    div.className = 'card';
    div.dataset.faqIndex = newIndex;
    div.style.cssText = 'padding:.75rem; border:1px solid #e5e7eb; border-radius:12px;';
    div.innerHTML = `
      <div class="form-group">
        <label class="form-label">Ot√°zka</label>
        <input class="form-control faq-q" placeholder="Nap≈ô. Jak zmƒõnit fakturaƒçn√≠ √∫daje?">
      </div>
      <div class="form-group">
        <label class="form-label">Odpovƒõƒè</label>
        <textarea class="form-control faq-a" rows="3" placeholder="Struƒçn√°, jasn√° odpovƒõƒè‚Ä¶"></textarea>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button type="button" class="btn btn-danger faq-del">üóëÔ∏è Smazat</button>
      </div>`;
    listEl.appendChild(div);
  });

  // Tlaƒç√≠tka pro ulo≈æen√≠ 
  document.getElementById('faq-save-all-btn')?.addEventListener('click', saveFaqAll);
  
}

async function saveFaqAll() {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  const account = (localStorage.getItem('primaryEmail') || '').trim();
  if (!dashboardUserEmail || !account) return showToast('Chyb√≠ √∫ƒçet nebo u≈æivatel.', 'error');

  // seber data z formul√°≈ôe
  const items = Array.from(document.querySelectorAll('#faq-list [data-faq-index]')).map(card => ({
    q: card.querySelector('.faq-q')?.value?.trim() || '',
    a: card.querySelector('.faq-a')?.value?.trim() || ''
  })).filter(x => x.q || x.a);

  try {
    const r = await fetch(`${window.BACKEND}/api/faq/save`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email: account, items })
    });
    const data = await r.json();
    if (data?.success) {
      showToast('FAQ ulo≈æeno.', 'success');
      loadFaqs();
    } else {
      showToast(data?.message || 'Ulo≈æen√≠ selhalo.', 'error');
    }
  } catch(e) {
    showToast('Nepoda≈ôilo se ulo≈æit FAQ.', 'error');
  }
}

async function learnFaqFromHistory() {
    const dashboardUserEmail = localStorage.getItem('userEmail');
  const account = (localStorage.getItem('primaryEmail') || '').trim();
  if (!dashboardUserEmail || !account) {
    showToast('Chyb√≠ √∫ƒçet nebo u≈æivatel.', 'error');
    return;
  }

  // 1) napln√≠me style_examples (Gmail i Custom vƒõtev)
  const ok = await seedStyleExamples(dashboardUserEmail, account);
  if (!ok) {
    showToast('Nepoda≈ôilo se naƒç√≠st historii pro uƒçen√≠ (m√°lo dat nebo chyba).', 'warning');
    // i tak zkus√≠me pokraƒçovat (kdyby tam nƒõco mezit√≠m bylo)
  }

  // 2) z historie vygenerovat a ulo≈æit FAQ
  try {
    const r = await fetch(`${window.BACKEND}/api/faq/regenerate`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email: account, limit: 200 })
    });
    const data = await r.json();
    if (r.ok && data?.success) {
      if ((data.created|0) > 0) {
        showToast(`FAQ vygenerov√°no z ${data.created} polo≈æek.`, 'success');
      } else {
        showToast('Z historie se nepoda≈ôilo vytvo≈ôit ≈æ√°dn√© FAQ (m√°lo dat?).', 'info');
      }
      await loadFaqs(); // naƒçti a vykresli
    } else {
      showToast(data?.message || 'Uƒçen√≠/Regenerace FAQ selhala.', 'error');
    }
  } catch (e) {
    showToast('S√≠≈•ov√° chyba p≈ôi regeneraci FAQ.', 'error');
  }
}

// === Ulo≈æen√≠ vybran√©ho √∫ƒçtu do localStorage ===
document.querySelectorAll('.account-item').forEach(item => {
  item.addEventListener('click', () => {
    const email = item.dataset.email;
    const src = item.dataset.src || 'custom'; // 'gmail' nebo 'custom'
    if (email) {
      localStorage.setItem('primaryEmail', email);
      localStorage.setItem('primarySrc', src);
      console.log('Vybran√Ω √∫ƒçet nastaven:', email, src);
    }
  });
});



async function seedStyleExamples(dashboardUserEmail, accountEmail) {
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const isGmail = /@gmail\.com$/i.test(accountEmail);

  try {
    let items = [];

    if (isGmail) {
      // GMAIL: st√°hni p≈ô√≠klady z outboxu a inboxu a rovnou je ulo≈æ
      const [sent, inbox] = await Promise.all([
        window.fetchSentReplies(dashboardUserEmail, accountEmail, 200),
        window.fetchInboxExamples(dashboardUserEmail, accountEmail, 200),
      ]);
      items = [...sent, ...inbox];
    } else {
      // CUSTOM: fallback ‚Äì vyt√°hni p√°r e-mail≈Ø a nech backend zanalyzovat tƒõla
      const rList = await fetch(
        `${window.BACKEND}/api/custom-email/emails?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(accountEmail)}&limit=30`
      );
      const jList = await rList.json();
      const emails = Array.isArray(jList.emails) ? jList.emails : [];
      const picked = emails.slice(0, 20);

      for (const e of picked) {
        const uid = e.id || e.uid; if (!uid) continue;
        const rOne = await fetch(
          `${window.BACKEND}/api/custom-email/analyze-email?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(accountEmail)}&uid=${encodeURIComponent(uid)}`
        );
        const jOne = await rOne.json();
        const body = (jOne.emailBody || '').trim();
        if (body) {
          items.push({
            role: e.fromMe ? 'outgoing' : 'incoming',
            subject: String(e.subject || ''),
            body
          });
        }
        await sleep(200);
      }
    }

    if (!items.length) return false;

    // Ulo≈æ nasb√≠ran√© p≈ô√≠klady do DB
    const rIngest = await fetch(`${window.BACKEND}/api/style-examples/ingest`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email: accountEmail, items })
    });
    const jIngest = await rIngest.json();
    return rIngest.ok && jIngest?.success && (jIngest.saved | 0) > 0;
  } catch (err) {
    console.warn('seedStyleExamples error:', err);
    return false;
  }
  }





async function autoGenerateFaq(limit = 200) {
   const dashboardUserEmail = localStorage.getItem('userEmail');
  const account = (localStorage.getItem('primaryEmail') || '').trim();
  if (!dashboardUserEmail || !account) return false;

  const listEl = document.getElementById('faq-list');
  if (!listEl) return false;

  // --- KROK 1: Zobrazen√≠ poƒç√°teƒçn√≠ho stavu indik√°toru ---
  listEl.innerHTML = `
    <div class="faq-generator-status" id="faq-generation-status">
      <div class="faq-spinner"></div>
      <div class="faq-status-text" id="faq-status-text">Generuji FAQ z historie</div>
      <div class="faq-status-subtext" id="faq-status-subtext">Pros√≠m, vyƒçkejte...</div>
    </div>
  `;
  const statusTextEl = document.getElementById('faq-status-text');
  const statusSubtextEl = document.getElementById('faq-status-subtext');

  try {
    // --- F√ÅZE 1: Naƒç√≠t√°n√≠ historie ---
    statusTextEl.textContent = 'Krok 1/2: Naƒç√≠t√°m historii e-mail≈Ø';
    statusSubtextEl.textContent = 'Analyzuji odeslan√© a p≈ôijat√© zpr√°vy...';
    
    const seeded = await seedStyleExamples(dashboardUserEmail, account);
    if (!seeded) {
      console.warn('seedStyleExamples neulo≈æil ≈æ√°dn√° data, pokraƒçuji k regenerate‚Ä¶');
    }

    // --- F√ÅZE 2: AI Anal√Ωza ---
    statusTextEl.textContent = 'Krok 2/2: AI analyzuje data';
    statusSubtextEl.textContent = 'Tento krok m≈Ø≈æe trvat i nƒõkolik des√≠tek sekund.';

    const r = await fetch(`${window.BACKEND}/api/faq/regenerate`, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email: account, limit })
    });
    const j = await r.json();

    if (r.status === 429) {
      showToast(j?.message || 'Vyƒçerp√°n mƒõs√≠ƒçn√≠ limit AI akc√≠.', 'warning');
      return false;
    }
    if (!r.ok || !j?.success) {
      throw new Error(j?.message || 'Auto-generace FAQ selhala.');
    }

    if ((j.created|0) <= 0) {
      showToast('Z historie se nepoda≈ôilo vytvo≈ôit ≈æ√°dn√© FAQ (m√°lo dat?).', 'info');
      listEl.innerHTML = ''; // Vyƒçist√≠me indik√°tor
      return false;
    }

    showToast(`FAQ bylo √∫spƒõ≈°nƒõ vygenerov√°no.`, 'success');
    return true;

  } catch (e) {
    console.warn('Auto FAQ generation error:', e);
    showToast(e.message || 'Auto-generace FAQ selhala.', 'error');
    listEl.innerHTML = ''; // Vyƒçist√≠me indik√°tor i v p≈ô√≠padƒõ chyby
    return false;
  }
}




// pomocn√©
function escapeHtml(s='') {
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}




    checkMobile();
    window.addEventListener('resize', checkMobile);

    const initialActivePage = document.querySelector('.nav-link.active')?.getAttribute('data-page');
    if (initialActivePage === 'emails') {
        fetchEmails();
    }
     if (initialActivePage === 'settings') {
        loadSettings();
    }
    

    setInterval(() => {
        const emailsPage = document.getElementById('emails');
        if (emailsPage && emailsPage.classList.contains('active')) {
            console.log('üîÑ Automaticky obnovuji seznam email≈Ø...');
            fetchEmails();
        }
    }, 60000);
    const savePlanBtn = document.getElementById('save-plan-btn');
if (savePlanBtn) savePlanBtn.addEventListener('click', async () => {
  await savePlan();
  loadLimits(); // refresh usage po zmƒõnƒõ tarifu
});


});
    

function syncProMeta(){
  const from = document.getElementById('ed-from')?.textContent?.trim() || '';
  const subj = document.getElementById('ed-subject')?.textContent?.trim() || '';
  const date = document.getElementById('ed-date')?.textContent?.trim() || '';
  const v = (id, val) => {
    const el = document.getElementById(id);
    if (el) {
      const safe = val || '‚Äî';
      el.textContent = safe;
      el.title = safe;
    }
  };

  v('ed-from-meta', from);
  v('ed-subject-meta', subj);
  v('ed-date-meta', date);

  const av = document.getElementById('ed-avatar');
  if (av) {
    // vezmi inici√°ly z jm√©na / adresy
    let initials = '‚úâÔ∏è';
    const namePart = (from.split('<')[0] || '').trim();
    if (namePart) {
      const words = namePart.split(/\s+/).filter(Boolean);
      initials = words.slice(0,2).map(w => w[0]?.toUpperCase()).join('');
      if (!initials) initials = '‚úâÔ∏è';
    }
    av.textContent = initials;
  }

  const copyBtn = document.getElementById('ed-copy');
  const bodyEl  = document.getElementById('ed-body');
  if (copyBtn && bodyEl) {
    copyBtn.onclick = async () => {
      try { await navigator.clipboard.writeText(bodyEl.textContent || ''); }
      catch(e){ /* ignore */ }
    };
  }

  
  
}




// "Odpovƒõdƒõt" spust√≠ stejnou AI anal√Ωzu jako tlaƒç√≠tko "Analyzovat ü§ñ"
(function wireReplyToAI(){
  const triggerAiFromDetail = async () => {
    const ctx = window.__currentEmailCtx;
    if (!ctx || !ctx.id) {
      alert('Chyb√≠ kontext zpr√°vy ‚Äì otev≈ôi nejd≈ô√≠v detail e-mailu.');
      return;
    }

    // --- zav≈ôi otev≈ôen√Ω detailov√Ω modal, a≈• nep≈ôek√°≈æ√≠ ---
    const detailModal = document.getElementById('emailDetailModal');
    if (detailModal) {
      detailModal.classList.remove('show');
    }
    const readerModal = document.getElementById('emailReader');
    if (readerModal) {
      readerModal.classList.remove('show');
    }
    // vra≈• scrollov√°n√≠ body, pokud bylo zamknut√©
    document.body.style.overflow = '';

    // 1) Zkus naj√≠t p≈Øvodn√≠ ≈ô√°dek v seznamu a "kliknout" na jeho tlaƒç√≠tko .analyze-btn
    const row = document.querySelector(`.email-item[data-id="${ctx.id}"]`);
    const btn = row?.querySelector('.analyze-btn');
    if (btn) {
      btn.click();        // ‚Üí pou≈æije p≈ôesnƒõ tvoji existuj√≠c√≠ anal√Ωzu v UI
      return;
    }

    // 2) Fallback: zavolej p≈ô√≠mo backend anal√Ωzu (kdyby ≈ô√°dek nebyl v DOM)
    try {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const primaryEmail       = ctx.account || localStorage.getItem('primaryEmail');

      const url  = ctx.src === 'gmail'
        ? `${window.BACKEND}/api/gmail/analyze-email`
        : `${window.BACKEND}/api/custom-email/analyze-email`;

      const body = ctx.src === 'gmail'
        ? { dashboardUserEmail, email: primaryEmail, messageId: ctx.id }
        : { dashboardUserEmail, emailAddress: primaryEmail, uid: ctx.id };

      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      const j = await r.json();
      if (!r.ok || !j.success) throw new Error(j.message || 'AI anal√Ωza selhala.');

      // zobraz v√Ωsledek stejnƒõ jako to dƒõl√° tvoje AI UI (zachovej si vlastn√≠ funkci, n√°zev jen p≈ô√≠klad)
      if (typeof window.showAiAnalysisModal === 'function') {
        window.showAiAnalysisModal(j);  // pokud m√°≈° vlastn√≠ vykreslen√≠ AI modalu
      } else {
        alert('AI hotovo ‚Äì p≈ôipoj sem vol√°n√≠ sv√© funkce pro zobrazen√≠ v√Ωsledku.');
        console.log('AI analysis result:', j);
      }
    } catch (e) {
      alert(e.message || 'Nepoda≈ôilo se spustit AI anal√Ωzu.');
    }
  };

  // napoj obƒõ tlaƒç√≠tka v headeru/footru detailu
  const replyTop    = document.getElementById('ed-reply-open');
  const replyBottom = document.getElementById('ed-reply-bottom');
  replyTop    && (replyTop.onclick    = triggerAiFromDetail);
  replyBottom && (replyBottom.onclick = triggerAiFromDetail);
  const erReplyTop    = document.getElementById('er-reply');
  const erReplyBottom = document.getElementById('er-reply-bottom');
  erReplyTop    && (erReplyTop.onclick    = triggerAiFromDetail);
  erReplyBottom && (erReplyBottom.onclick = triggerAiFromDetail);
})();
  






// Glob√°ln√≠ promƒõnn√° pro ukl√°d√°n√≠ naƒçten√Ωch u≈æivatel≈Ø
let allAdminUsers = [];

// Funkce pro vykreslen√≠ tabulky na z√°kladƒõ dat
function renderAdminUsersTable(users) {
    const tableBody = document.getElementById('adminUsersTableBody');
  if (!tableBody) return;

  if (users.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:2rem;">Nenalezeni ≈æ√°dn√≠ u≈æivatel√©.</td></tr>';
    return;
  }

  tableBody.innerHTML = users.map(user => {
    const nameParts = (user.name || '').split(' ');
    const initials = (nameParts.length > 1
      ? nameParts[0][0] + nameParts[nameParts.length - 1][0]
      : (user.name || 'U').substring(0, 2)).toUpperCase();

    const aiMonth = Number(user.ai_actions_used ?? 0);
    const tokensMonth = Number(user.tokens_used ?? 0);

    return `
      <tr data-email="${escapeHtml(user.email)}">
        <td>
          <div class="user-info-cell">
            <div class="user-avatar-small">${initials}</div>
            <div class="user-details">
              <span class="user-name">${escapeHtml(user.name || '')}</span>
              <span class="user-email">${escapeHtml(user.email)}</span>
            </div>
          </div>
        </td>
        <td>${escapeHtml(user.plan || '')}</td>
        <td><span class="role-badge ${user.role === 'admin' ? 'role-admin' : 'role-user'}">${escapeHtml(user.role)}</span></td>
        <td>${new Date(user.created_at).toLocaleDateString('cs-CZ')}</td>
        <td style="text-align:right;">${aiMonth}</td>
        <td style="text-align:right;">${tokensMonth.toLocaleString('cs-CZ')}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-secondary btn-sm edit-user-btn">Upravit</button>
            <button class="btn btn-danger btn-sm delete-user-btn">Smazat</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// Hlavn√≠ funkce pro naƒçten√≠ a filtrov√°n√≠ dat
async function loadAdminUsers() {
    const tableBody = document.getElementById('adminUsersTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Naƒç√≠t√°m data...</td></tr>';
    
    const dashboardUserEmail = localStorage.getItem('userEmail');
    const searchTerm = document.getElementById('userSearch').value;
    const roleFilter = document.getElementById('roleFilter').value;

    try {
        const url = new URL(`${window.BACKEND}/api/admin/users`);
        url.searchParams.set('dashboardUserEmail', dashboardUserEmail);
        if (searchTerm) url.searchParams.set('search', searchTerm);
        if (roleFilter !== 'all') url.searchParams.set('role', roleFilter);

        const response = await fetch(url);
        const data = await response.json();
        if (!data.success) throw new Error(data.message);

        allAdminUsers = data.users || [];

        // Naplnƒõn√≠ statistik
        const stats = data.stats || {};
        document.getElementById('admin-total-users').textContent = stats.totalUsers || 0;
        document.getElementById('admin-paying-users').textContent = stats.payingUsers || 0;
        document.getElementById('admin-connected-emails').textContent = stats.connectedEmails || 0;
        document.getElementById('admin-ai-today').textContent = stats.aiActionsThisMonth || 0; // Zmƒõnƒõno na "tento mƒõs√≠c"
        
        renderAdminUsersTable(allAdminUsers);
    } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Chyba: ${error.message}</td></tr>`;
    }
}

// Funkce pro inicializaci v≈°ech posluchaƒç≈Ø ud√°lost√≠ v admin sekci
function initAdminEventListeners() {
    const userSearch = document.getElementById('userSearch');
    const roleFilter = document.getElementById('roleFilter');
    const tableBody = document.getElementById('adminUsersTableBody');
    const editModal = document.getElementById('editUserModal');

    // Filtry
    userSearch?.addEventListener('input', () => loadAdminUsers());
    roleFilter?.addEventListener('change', () => loadAdminUsers());

    // Kliknut√≠ na tlaƒç√≠tka v tabulce (Upravit / Smazat)
    tableBody?.addEventListener('click', async (e) => {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        
        // Smaz√°n√≠ u≈æivatele
        if (e.target.classList.contains('delete-user-btn')) {
            const row = e.target.closest('tr');
            const emailToDelete = row.dataset.email;
            
                try {
                    const res = await fetch(`${window.BACKEND}/api/admin/users/${emailToDelete}?dashboardUserEmail=${dashboardUserEmail}`, { method: 'DELETE' });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message);
                    showToast('U≈æivatel smaz√°n.', 'success');
                    row.remove();
                } catch (err) {
                    showToast(err.message, 'error');
                }
            
        }

        // √öprava u≈æivatele
        if (e.target.classList.contains('edit-user-btn')) {
            const row = e.target.closest('tr');
            const emailToEdit = row.dataset.email;
            const user = allAdminUsers.find(u => u.email === emailToEdit);
            if (user && editModal) {
                document.getElementById('editName').value = user.name;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editRole').value = user.role;
                editModal.classList.add('show');
            }
        }
    });

    // Ulo≈æen√≠ zmƒõn v mod√°ln√≠m oknƒõ
    document.getElementById('saveUserBtn')?.addEventListener('click', async () => {
      const dashboardUserEmail = localStorage.getItem('userEmail');
        const email = document.getElementById('editEmail').value;
        const name = document.getElementById('editName').value;
        const role = document.getElementById('editRole').value;

        try {
            // ZDE JE OPRAVA: P≈ôidali jsme dashboardUserEmail do URL jako query parametr
            const url = `${window.BACKEND}/api/admin/users/${email}?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`;
            
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, role }) // Z tƒõla po≈æadavku jsme ho odstranili
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            showToast('U≈æivatel upraven.', 'success');
            document.getElementById('editUserModal').classList.remove('show');
            loadAdminUsers(); // Znovu naƒçteme tabulku s aktu√°ln√≠mi daty
        } catch (err) {
            showToast(err.message, 'error');
        } 
    });

    // Zav√≠r√°n√≠ mod√°ln√≠ho okna
    editModal?.addEventListener('click', (e) => {
        if (e.target.hasAttribute('data-close-modal') || e.target === editModal) {
            editModal.classList.remove('show');
        }
    });
}



async function loadActivityLog() {
    const tableBody = document.getElementById('activityLogTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Naƒç√≠t√°m log...</td></tr>';
    
    const dashboardUserEmail = localStorage.getItem('userEmail');

    try {
        const response = await fetch(`${window.BACKEND}/api/admin/activity-log?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.message);

        if (data.log.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">≈Ω√°dn√° aktivita k zobrazen√≠.</td></tr>';
            return;
        }

        tableBody.innerHTML = data.log.map(entry => {
            const time = new Date(entry.timestamp).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            const statusClass = entry.status === 'error' ? 'role-admin' : 'role-user'; // Pou≈æijeme existuj√≠c√≠ t≈ô√≠dy pro barvy
            const statusText = entry.status === 'error' ? 'Chyba' : '√öspƒõch';
            const actionButton = entry.status === 'error' 
                ? '<button class="btn btn-secondary btn-sm">Zkontrolovat</button>' 
                : '<button class="btn btn-secondary btn-sm" style="opacity: 0.5; cursor: default;">Zobrazit</button>';

            return `
                <tr>
                    <td>${time}</td>
                    <td>${escapeHtml(entry.user_email)}</td>
                    <td>${escapeHtml(entry.action)}</td>
                    <td><span class="role-badge ${statusClass}">${statusText}</span></td>
                    <td>${actionButton}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Chyba: ${error.message}</td></tr>`;
    }
}

//  listener pro tlaƒç√≠tko Obnovit
document.getElementById('refresh-log-btn')?.addEventListener('click', loadActivityLog);


const adminTabLink = document.querySelector('.nav-link[data-page="admin"]');
if (adminTabLink) {
    adminTabLink.addEventListener('click', () => {
        loadAdminUsers();
        loadActivityLog(); 
    });
}


</script>


<!-- Email Reader Modal -->
<div class="modal-overlay" id="emailReader">
  <div class="modal modal-full-width" style="max-width: 980px;">
    <div class="modal-header">
      <div class="modal-title" id="er-subject">üìß Naƒç√≠t√°m‚Ä¶</div>
      <button class="modal-close" id="er-close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="analysis-section" style="margin-bottom:1rem;">
        <div class="section-header" style="justify-content:space-between;">
          <div style="display:flex; gap:.75rem; align-items:center;">
            <span class="section-icon">üë§</span>
            <div>
              <div class="section-title" id="er-from">‚Äî</div>
              <div class="section-content" id="er-date" style="font-size:.9rem; color:#64748b;">‚Äî</div>
            </div>
          </div>
          <div style="display:flex; gap:.5rem;">
            <button class="btn btn-secondary" id="er-copy">Kop√≠rovat text</button>
            <button class="btn btn-primary" id="er-reply">‚úâÔ∏è Odpovƒõdƒõt</button>
          </div>
        </div>
        <div id="er-tags" style="display:flex; gap:.5rem; flex-wrap:wrap;"></div>
      </div>

      <div class="response-section">
        <div class="response-header">
          <div class="response-title">Obsah zpr√°vy</div>
        </div>
        <div class="response-content" id="er-body" style="min-height:180px;">Naƒç√≠t√°m obsah‚Ä¶</div>
      </div>

      <div class="analysis-section" id="er-ai" style="display:none;">
        <div class="section-header">
          <span class="section-icon">ü§ñ</span>
          <div class="section-title">N√°vrh odpovƒõdi (AI)</div>
        </div>
        <div class="section-content" id="er-ai-reply" style="white-space:pre-wrap;"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="er-close-bottom">Zav≈ô√≠t</button>
      <button class="btn btn-primary" id="er-reply-bottom">‚úâÔ∏è Odpovƒõdƒõt</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>






