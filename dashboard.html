<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Emailov√Ω Agent</title>
    <style>

.toast .toast-action:hover { opacity: .9; }

          /* === STYLY PRO NOV√â MOD√ÅLN√ç OKNO === */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
    display: none; /* Skryt√© ve v√Ωchoz√≠m stavu */
    align-items: center; justify-content: center; z-index: 2000;
    opacity: 0; transition: opacity 0.3s ease;
}
.modal-overlay.show { opacity: 1; display: flex; }
.modal {
    background: white; border-radius: 20px; width: 90%; max-width: 900px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    transform: scale(0.95); transition: transform 0.3s ease;
    display: flex; flex-direction: column; max-height: 90vh;
}
.modal-overlay.show .modal { transform: scale(1); }
.modal-header {
    padding: 1.5rem 2rem; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid #e2e8f0; flex-shrink: 0;
}
.modal-title { font-size: 1.5rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.75rem; }
.modal-close { background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; transition: all 0.2s ease; }
.modal-close:hover { color: #1e293b; transform: rotate(90deg); }
.modal-body { padding: 2rem; overflow-y: auto; }
.modal-footer {
    padding: 1.5rem 2rem; display: flex; gap: 1rem; justify-content: flex-end;
    border-top: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0 0 20px 20px; flex-shrink: 0;
}
.analysis-section {
    background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 16px;
    padding: 1.5rem; margin-bottom: 1.5rem;
}
.section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
.section-icon { font-size: 1.5rem; }
.section-title { font-size: 1.2rem; font-weight: 600; color: #1e293b; }
.section-content { color: #374151; line-height: 1.6; font-size: 0.95rem; }
.response-section { padding: 1.5rem 0; }
.response-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
.response-title { display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem; font-weight: 700; color: #0c4a6e; }
.response-content {
    background: white; border: 1px solid #e2e8f0; border-radius: 12px;
    padding: 1.5rem; color: #374151; line-height: 1.7; font-size: 0.95rem;
    white-space: pre-wrap; /* Zachov√° form√°tov√°n√≠ odpovƒõdi od AI */
}
.btn-success { background: #22c55e; color: white; }
.loading {
    display: inline-block; width: 40px; height: 40px;
    border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
    border-radius: 50%; animation: spin 1s linear infinite;
}

.usage-panel { margin-top: 1rem; background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 1.25rem; }
.usage-title { margin: 0 0 1rem 0; color:#1e293b; font-weight: 600; }
.usage-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
.usage-card { border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem; transition: .2s ease; background:#f9fafb; }
.usage-card:hover { border-color:#667eea; box-shadow: 0 8px 25px rgba(102,126,234,.15); transform: translateY(-2px); }
.usage-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
.usage-name { font-weight:600; color:#1e293b; }
.usage-count { font-weight:700; color:#1e293b; }
.usage-bar { width:100%; height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
.usage-bar-fill { height:100%; background: linear-gradient(90deg,#667eea,#764ba2); width:0%; transition: width .4s ease; }
.usage-foot { margin-top:.5rem; color:#64748b; font-size:.9rem; }
.usage-period { margin-top: .75rem; color:#64748b; font-size:.9rem; }

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }




        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #94a3b8;
    height: 100%;
    /* P≈òID√ÅNO PRO VYCENTROV√ÅN√ç: */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 0 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: "ü§ñ";
            font-size: 1.8rem;
        }

        .collapse-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .collapse-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-menu {
            list-style: none;
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: white;
            border-radius: 2px;
        }

        .nav-icon {
            font-size: 1.2rem;
            min-width: 20px;
        }

        .nav-text {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
        }

        .sidebar.collapsed .logo span {
            display: none;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }

        .user-info {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
            background: #f1f5f9;
            border: none;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notifications:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Content Area */
        .content-area {
            padding: 2rem;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Overview */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-title {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .stat-icon {
            font-size: 1.5rem;
            padding: 8px;
            border-radius: 10px;
            background: #f1f5f9;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive {
            color: #16a34a;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        /* Email List */
        .email-list {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .email-list-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .email-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .email-item:hover {
            background: #f8fafc;
        }

        .email-item:last-child {
            border-bottom: none;
        }
        

        .email-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e2e8f0;
        }

        .email-status.unread {
            background: #3b82f6;
        }

        .email-status.processed {
            background: #16a34a;
        }

        .email-status.pending {
            background: #f59e0b;
        }

        .email-content {
            flex: 1;
        }

        .email-sender {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .email-subject {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .email-preview {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .email-meta {
            text-align: right;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .email-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .email-item:hover .email-actions {
            opacity: 1;
        }

        .action-btn {
            background: #f1f5f9;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        /* === PLAN ‚Äì STYLING === */
.plan-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1.25rem;
  margin-top: .75rem;
}
.plan-card {
  position: relative;
  background: white;
  border: 2px solid #e2e8f0;
  border-radius: 16px;
  padding: 1.25rem;
  transition: all .25s ease;
  cursor: pointer;
  display: block;
}
.plan-card:has(.plan-input:checked) {
  outline: none;                 /* zru≈°√≠ p≈Øvodn√≠ outline */
  border-color: #667eea;         /* jemn√© zv√Ωraznƒõn√≠ r√°meƒçku karty */
  box-shadow: 0 10px 25px rgba(102,126,234,.15);
}
.plan-card:hover { border-color: #667eea; box-shadow: 0 10px 25px rgba(102,126,234,.15); transform: translateY(-2px); }
.plan-card.popular { border-color: #764ba2; }
.plan-input { display: none; }

.plan-inner { display: flex; flex-direction: column; gap: .75rem; }
.plan-badge {
  align-self: flex-start;
  background: linear-gradient(45deg,#667eea,#764ba2);
  color: #fff; font-size: .7rem; font-weight: 700;
  padding: .25rem .5rem; border-radius: 999px; letter-spacing: .5px;
}
.plan-head { display: flex; align-items: baseline; justify-content: space-between; gap: .75rem; }
.plan-name { font-weight: 700; color: #1e293b; }
.plan-price { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
.plan-price span { color:#64748b; font-weight:600; font-size:.9rem; }
.plan-features { list-style: none; color:#374151; display:flex; flex-direction:column; gap:.35rem; margin: .25rem 0 0 0; padding:0; font-size:.92rem; }
.plan-actions { margin-top: 1rem; display:flex; align-items:center; gap:.75rem; }

        .action-btn:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .action-btn.approve {
            background: #dcfce7;
            color: #16a34a;
        }

        .action-btn.reject {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Forms */
        .form-section {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .form-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-control {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control select {
            cursor: pointer;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        /* Templates */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .template-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .template-name {
            font-weight: 600;
            color: #1e293b;
        }

        .template-actions {
            display: flex;
            gap: 0.5rem;
        }

        .template-preview {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .template-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Analytics */
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .chart-filters {
            display: flex;
            gap: 1rem;
        }

        .filter-btn {
            padding: 6px 16px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .chart-placeholder {
            height: 300px;
            background: #f8fafc;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 1.1rem;
        }

        /* Settings */
        .settings-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .settings-tab {
            padding: 1rem 0;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .settings-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
                background: #667eea;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-left: 4px solid #16a34a;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #dc2626;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        .page-container {
    width: 100%;
    max-width: 18000px; /* ZDE Mƒö≈áTE PO≈ΩADOVANOU ≈†√ç≈òKU */
    margin: 0 auto;    /* Toto vycentruje obsah na str√°nce */
}


.container {
    max-width: 900px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
}
.header {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    padding: 30px;
    text-align: center;
}
.header h1 {
    font-size: 28px;
    margin-bottom: 10px;
    font-weight: 600;
}
.header p {
    opacity: 0.9;
    font-size: 16px;
}
.content {
    padding: 30px;
}
.section-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.bulk-actions {
    display: flex;
    gap: 10px;
}
.bulk-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}
.bulk-btn.enable-all {
    background: #10b981;
    color: white;
}

.bulk-btn.disable-all {
    background: #ef4444;
    color: white;
}
.bulk-btn:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}
.email-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
}
.email-item {
    display: flex;
    align-items: center;
    padding: 20px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f9fafb;
}
.email-item:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}
.email-item.active {
    border-color: #10b981;
    background: linear-gradient(45deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
}
.checkbox-wrapper {
    position: relative;
    margin-right: 15px;
}
.checkbox-input {
    width: 20px;
    height: 20px;
    cursor: pointer;
    opacity: 0;
    position: absolute;
}
.checkbox-custom {
    width: 20px;
    height: 20px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
}
.checkbox-input:checked + .checkbox-custom {
    background: #10b981;
    border-color: #10b981;
}
.checkbox-custom::after {
    content: '‚úì';
    color: white;
    font-size: 12px;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.checkbox-input:checked + .checkbox-custom::after {
    opacity: 1;
}
.email-info {
    flex: 1;
}
.email-address {
    font-size: 16px;
    font-weight: 600;
    color: #111827;
    margin-bottom: 5px;
}
.email-provider {
    font-size: 14px;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 5px;
}
.provider-icon {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}



.modal.modal-full-width .response-section {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.modal.modal-full-width #response-editor {
    flex-grow: 1; /* Textov√© pole zabere v≈°echno voln√© m√≠sto */
    height: 100%;
}
.gmail-icon { background: #ea4335; }
.outlook-icon { background: #0078d4; }
.email-controls {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-left: 15px;
}
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    background: #f3f4f6;
    color: #6b7280;
}
.status-badge.active {
    background: #10b981;
    color: white;
}
.radio-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 6px;
    transition: all 0.3s ease;
}
.radio-wrapper:hover {
    background: rgba(102, 126, 234, 0.1);
}
.radio-wrapper.selected {
     background: transparent;   /* odstran√≠ ≈°ed√Ω obd√©ln√≠k uvnit≈ô */
    border: none;   
}
.radio-input {
    width: 16px;
    height: 16px;
    opacity: 0;
    position: absolute;
    cursor: pointer;
}
.radio-custom {
    width: 16px;
    height: 16px;
    border: 2px solid #d1d5db;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
}
.radio-input:checked + .radio-custom {
    border-color: #667eea;
    background: #667eea;
}
.radio-custom::after {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: white;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.radio-input:checked + .radio-custom::after {
    opacity: 1;
}
.radio-label {
    font-size: 12px;
    font-weight: 500;
    color: #6b7280;
    user-select: none;
}
.disconnect-btn {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 50%;
    background: #ef4444;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    margin-left: 8px;
    opacity: 0.7;
}
.disconnect-btn:hover {
    opacity: 1;
    background: #dc2626;
    transform: scale(1.1);
}
.disconnect-icon {
    font-size: 16px;
    font-weight: bold;
    line-height: 1;
}
.add-account {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    border: 2px dashed #d1d5db;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #6b7280;
    margin-top: 15px;
}
.add-account:hover {
    border-color: #667eea;
    color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

        
/* === MOD√ÅLN√ç OKNO === */
/* Overlay - p≈ôekryv cel√© obrazovky */
#modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    display: none; /* Skryt√© ve v√Ωchoz√≠m stavu */
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* Kontejner mod√°ln√≠ho okna */
#modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 480px;
    transform: scale(0.9);
    animation: modalAppear 0.3s ease forwards;
}

@keyframes modalAppear { to { transform: scale(1); } }

/* Hlaviƒçka mod√°ln√≠ho okna */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid #e9ecef;
}
.modal-title {
    font-size: 1.4em;
    font-weight: 600;
    color: #2c3e50;
}
.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6c757d;
    transition: all 0.3s ease;
}
.modal-close:hover {
    color: #495057;
    transform: rotate(90deg);
}

/* Tƒõlo mod√°ln√≠ho okna */
.modal-body {
    padding: 24px;
}
.provider-buttons {
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.provider-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 16px 24px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    background: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #495057;
}
.provider-btn:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}
.provider-icon {
    width: 24px;
    height: 24px;
}


/* Styly pro nov√Ω header s filtry */
.emails-header { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
 .form-control { padding-left: 45px; }
.search-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.search-box {
    flex: 1;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 12px 16px 12px 45px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: white;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 1.1rem;
}
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>AI Emailov√Ω Agent</span>
                </div>
                <button class="collapse-btn" id="collapseBtn">
                    <span>‚Üê</span>
                </button>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-page="dashboard">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="emails">
                            <span class="nav-icon">üìß</span>
                            <span class="nav-text">Emaily</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="templates">
                            <span class="nav-icon">üìù</span>
                            <span class="nav-text">≈†ablony</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="settings">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span class="nav-text">Nastaven√≠</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="analytics">
                            <span class="nav-icon">üìà</span>
                            <span class="nav-text">Analytika</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="integrations">
                            <span class="nav-icon">üîó</span>
                            <span class="nav-text">Integrace</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="user-info">
    <button class="notifications">
        <span>üîî</span>
        <span class="notification-badge">3</span>
    </button>
    <span id="user-name-display" style="font-weight: 500;"></span>
    <div class="user-avatar"></div>
    <button id="logout-button" style="border:none; background:#f1f5f9; padding:8px 12px; border-radius:8px; cursor:pointer;">Odhl√°sit se</button>
</div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Page -->
                <div class="page-content active" id="dashboard">
                    <div class="page-container"><div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">Zpracovan√© emaily</span>
                                <span class="stat-icon">üìß</span>
                            </div>
                            <div class="stat-value">1,247</div>
                            <div class="stat-change positive">
                                <span>‚Üó</span>
                                <span>+15% tento t√Ωden</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">U≈°et≈ôen√Ω ƒças</span>
                                <span class="stat-icon">‚è∞</span>
                            </div>
                            <div class="stat-value">24.5h</div>
                            <div class="stat-change positive">
                                <span>‚Üó</span>
                                <span>+8% tento mƒõs√≠c</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">√öspƒõ≈°nost AI</span>
                                <span class="stat-icon">üéØ</span>
                            </div>
                            <div class="stat-value">94.2%</div>
                            <div class="stat-change positive">
                                <span>‚Üó</span>
                                <span>+2.1% dnes</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <span class="stat-title">Aktivn√≠ ≈°ablony</span>
                                <span class="stat-icon">üìù</span>
                            </div>
                            <div class="stat-value">12</div>
                            <div class="stat-change">
                                <span>‚Üí</span>
                                <span>Beze zmƒõny</span>
                            </div>
                        </div>
                    </div>
                    </div>

                    <div class="email-list">
                        <div class="email-list-header">
                            <h3>Posledn√≠ emaily</h3>
                        </div>
                        
                        <div class="email-item">
                            <div class="email-status processed"></div>
                            <div class="email-content">
                                <div class="email-sender">Petr Svoboda</div>
                                <div class="email-subject">Re: Sch≈Øzka ohlednƒõ projektu</div>
                                <div class="email-preview">Dƒõkuji za rychlou odpovƒõƒè. Term√≠n mi vyhovuje...</div>
                            </div>
                            <div class="email-meta">
                                <div>15:42</div>
                                <div>Odpovƒõzeno AI</div>
                            </div>
                        </div>
                        
                        <div class="email-item">
                            <div class="email-status pending"></div>
                            <div class="email-content">
                                <div class="email-sender">Marie Nov√°kov√°</div>
                                <div class="email-subject">Dotaz na va≈°e slu≈æby</div>
                                <div class="email-preview">Dobr√Ω den, chtƒõla bych se zeptat na mo≈ænost...</div>
                            </div>
                            <div class="email-meta">
                                <div>14:28</div>
                                <div>ƒåek√° na schv√°len√≠</div>
                            </div>
                            <div class="email-actions">
                                <button class="action-btn approve">‚úì Schv√°lit</button>
                                <button class="action-btn reject">‚úó Zam√≠tnout</button>
                            </div>
                        </div>
                        
                        <div class="email-item">
                            <div class="email-status unread"></div>
                            <div class="email-content">
                                <div class="email-sender">Jan Proch√°zka</div>
                                <div class="email-subject">P≈ôipom√≠nky k n√°vrhu</div>
                                <div class="email-preview">Ahoj, m√°m nƒõkolik p≈ôipom√≠nek k tv√©mu n√°vrhu...</div>
                            </div>
                            <div class="email-meta">
                                <div>13:15</div>
                                <div>Nov√Ω</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emails Page -->



                <div class="page-content" id="emails">
                <div class="emails-header">
                    <h3>Spr√°va email≈Ø</h3>
                    <br>
    <div class="search-container">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="search" class="form-control" placeholder="Vyhledat emaily " id="search-bar">
        </div>
    </div>
    <div class="filter-row">
        <select class="form-control" id="status-filter">
            <option value="all">V≈°echny stavy</option>
                    <option value="unread">üìß Nep≈ôeƒçten√©</option>
                    <option value="processed">‚úÖ Zpracovan√©</option>
                    <option value="pending">‚è≥ ƒåekaj√≠c√≠</option>
                    <option value="spam">üö´ Spam</option>
        </select>
        <select class="form-control" id="period-filter">
            <option value="all">V≈°echna obdob√≠</option>
                    <option value="today">üìÖ Dnes</option>
                    <option value="week">üìÖ Tento t√Ωden</option>
                    <option value="month">üìÖ Tento mƒõs√≠c</option>
        </select>
       
    </div>
</div>


<div class="email-list">
    <div class="email-list-header">
        <h3 id="email-count-header">V≈°echny emaily</h3>
    </div>
    <div id="email-list-container">
        <div style="padding: 2rem; text-align: center; color: #94a3b8;">
            üìß Naƒç√≠t√°m emaily...
        </div>
    </div>
</div>
                    




                </div>

                <!-- Templates Page -->
                <div class="page-content" id="templates">
                    <div class="form-section">
                        <h3>Vytvo≈ôit novou ≈°ablonu</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">N√°zev ≈°ablony</label>
                                <input type="text" class="form-control" placeholder="nap≈ô. Odpovƒõƒè na dotaz">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kategorie</label>
                                <select class="form-control">
                                    <option>Obecn√©</option>
                                    <option>Obchodn√≠</option>
                                    <option>Podpora</option>
                                    <option>Sch≈Øzky</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Obsah ≈°ablony</label>
                            <textarea class="form-control" placeholder="Napi≈°te obsah va≈°√≠ ≈°ablony... M≈Ø≈æete pou≈æ√≠t promƒõnn√© jako {{jm√©no}}, {{datum}}, {{spoleƒçnost}}"></textarea>
                        </div>
                        <button class="btn btn-primary">
                            <span>üíæ</span>
                            Ulo≈æit ≈°ablonu
                        </button>
                    </div>

                    <div class="template-grid">
                        <div class="template-card">
                            <div class="template-header">
                                <div class="template-name">Odpovƒõƒè na dotaz</div>
                                <div class="template-actions">
                                    <button class="action-btn">‚úèÔ∏è</button>
                                    <button class="action-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="template-preview">
                                Dƒõkuji za v√°≈° dotaz. R√°d v√°m pomohu s {{p≈ôedmƒõt_dotazu}}. Podle va≈°ich po≈æadavk≈Ø...
                            </div>
                            <div class="template-stats">
                                <span>Pou≈æito: 47x</span>
                                <span>√öspƒõ≈°nost: 92%</span>
                            </div>
                        </div>

                        <div class="template-card">
                            <div class="template-header">
                                <div class="template-name">Pozv√°nka na sch≈Øzku</div>
                                <div class="template-actions">
                                    <button class="action-btn">‚úèÔ∏è</button>
                                    <button class="action-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="template-preview">
                                Dobr√Ω den {{jm√©no}}, r√°d bych v√°s pozval na sch≈Øzku ohlednƒõ {{t√©ma}}. Vyhovoval by v√°m term√≠n...
                            </div>
                            <div class="template-stats">
                                <span>Pou≈æito: 23x</span>
                                <span>√öspƒõ≈°nost: 89%</span>
                            </div>
                        </div>

                        <div class="template-card">
                            <div class="template-header">
                                <div class="template-name">Potvrzen√≠ objedn√°vky</div>
                                <div class="template-actions">
                                    <button class="action-btn">‚úèÔ∏è</button>
                                    <button class="action-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="template-preview">
                                Dƒõkujeme za va≈°i objedn√°vku ƒç√≠slo {{ƒç√≠slo_objedn√°vky}}. Va≈°e objedn√°vka byla p≈ôijata...
                            </div>
                            <div class="template-stats">
                                <span>Pou≈æito: 156x</span>
                                <span>√öspƒõ≈°nost: 96%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
   
<div class="page-content" id="settings">
    <div class="settings-tabs">
        <div class="settings-tab active" data-tab="ai">AI Nastaven√≠</div>
        <div class="settings-tab" data-tab="email">Email √∫ƒçty</div>
        <div class="settings-tab" data-tab="plan">Pl√°n</div>
        <div class="settings-tab" data-tab="notifications">Notifikace</div>
        <div class="settings-tab" data-tab="security">Zabezpeƒçen√≠</div>
    </div>

    <div class="settings-content" id="ai-settings">
    <form id="settings-form">
        <div class="form-section">
            <h3>Styl odpovƒõd√≠</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">T√≥n komunikace</label>
                    <select class="form-control" id="tone-select">
                        <option>Form√°ln√≠</option>
                        <option>Neform√°ln√≠</option>
                        <option>P≈ô√°telsk√Ω</option>
                        <option>Profesion√°ln√≠</option>
                        <option>Struƒçn√Ω</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">D√©lka odpovƒõd√≠</label>
                    <select class="form-control" id="length-select">
                        <option>Kr√°tk√° (1-2 vƒõty)</option>
                        <option>St≈ôedn√≠ (1 odstavec)</option>
                        <option>Dlouh√° (v√≠ce odstavc≈Ø)</option>
                        <option>Adaptivn√≠</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Osobn√≠ podpis</label>
                <textarea class="form-control" id="signature-textarea" placeholder="S pozdravem,&#10;Jan Nov√°k..."></textarea>
            </div>
        </div>

        <div class="form-section">
            <h3>Automatizace</h3>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Automatick√© odpovƒõdi</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Povol√≠ AI automaticky odpov√≠dat na rutinn√≠ emaily</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="auto-reply-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Schvalov√°n√≠ d≈Øle≈æit√Ωch email≈Ø</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Vy≈æaduje va≈°e schv√°len√≠ pro d≈Øle≈æit√© zpr√°vy</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="approval-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Spam filtr</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Automaticky filtruje nevy≈æ√°dan√© zpr√°vy</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="spam-filter-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">
            <span>üíæ</span>
            Ulo≈æit nastaven√≠
        </button>
    </form>





                    </div>

                    <!-- Email Accounts Tab -->
    <div class="settings-content" id="email-settings" style="display: none;">               
<div class="container" style="max-width: 100%; box-shadow: none; border-radius: 0;">
    <div class="header" style="padding: 20px; text-align: left; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
        
    </div>
    <div class="content" style="padding: 20px;">
        <div class="section-title">
    <span>P≈ôipojen√© √∫ƒçty</span>
    <div style="display: flex; align-items: center; gap: 20px;">
        <div style="font-size: 14px; color: #667eea; font-weight: 500;">
            üìù Nastavuji: <span id="currentConfigEmail"></span>
        </div>
        <div class="bulk-actions">
            <button class="bulk-btn enable-all" onclick="enableAllAccounts()">Aktivovat v≈°e</button>
            <button class="bulk-btn disable-all" onclick="disableAllAccounts()">Deaktivovat v≈°e</button>
        </div>
    </div>
</div>
<div class="email-list">
    </div>
<div class="add-account" onclick="addAccount()">
    <span>+ P≈ôidat dal≈°√≠ emailov√Ω √∫ƒçet</span>
</div>


    </div>
    </div> 
</div>

<!-- === PLAN SETTINGS === -->
<div class="settings-content" id="plan-settings" style="display: none;">
  <div class="form-section">
    <h3>Vyberte tarif</h3>

    <div class="plan-grid">
      <!-- Starter -->
      <label class="plan-card">
        <input type="radio" name="plan" value="Starter" class="plan-input">
        <div class="plan-inner">
          <div class="plan-head">
            <div class="plan-name">Starter</div>
            <div class="plan-price">Zdarma</div>
          </div>
          <ul class="plan-features">
            <li>‚úì A≈æ 50 email≈Ø mƒõs√≠ƒçnƒõ</li>
            <li>‚úì 1 emailov√Ω √∫ƒçet</li>
            <li>‚úì Z√°kladn√≠ ≈°ablony</li>
            <li>‚úì Email podpora</li>
          </ul>
        </div>
      </label>

      <!-- Professional -->
      <label class="plan-card popular">
        <input type="radio" name="plan" value="Professional" class="plan-input">
        <div class="plan-inner">
          <div class="plan-badge">NEJPOPUL√ÅRNƒöJ≈†√ç</div>
          <div class="plan-head">
            <div class="plan-name">Professional</div>
            <div class="plan-price">490 Kƒç <span>/ mƒõs√≠c</span></div>
          </div>
          <ul class="plan-features">
            <li>‚úì Neomezen√© emaily</li>
            <li>‚úì 5 emailov√Ωch √∫ƒçt≈Ø</li>
            <li>‚úì Vlastn√≠ ≈°ablony</li>
            <li>‚úì Kalend√°≈ôov√° integrace</li>
            <li>‚úì Pokroƒçil√© analytics</li>
            <li>‚úì Priority podpora</li>
          </ul>
        </div>
      </label>

      <!-- Enterprise -->
      <label class="plan-card">
        <input type="radio" name="plan" value="Enterprise" class="plan-input">
        <div class="plan-inner">
          <div class="plan-head">
            <div class="plan-name">Enterprise</div>
            <div class="plan-price">1 490 Kƒç <span>/ mƒõs√≠c</span></div>
          </div>
          <ul class="plan-features">
            <li>‚úì Neomezen√© emaily</li>
            <li>‚úì Neomezen√© √∫ƒçty</li>
            <li>‚úì Team management</li>
            <li>‚úì API p≈ô√≠stup</li>
            <li>‚úì White-label ≈ôe≈°en√≠</li>
            <li>‚úì Dedikovan√° podpora</li>
            <li>‚úì SLA garance</li>
          </ul>
        </div>
      </label>
    </div>

    <div class="plan-actions">
      <button id="save-plan-btn" class="btn btn-primary">üíæ Ulo≈æit pl√°n</button>
      <span id="current-plan-badge" class="status-badge" style="margin-left:10px;">Aktu√°ln√≠: ‚Äî</span>
    </div>
  </div>
  <div class="usage-panel" id="usage-panel" style="display:none;">
  <h4 class="usage-title">Vyu≈æit√≠ tohoto mƒõs√≠ce</h4>

  <div class="usage-grid">
    <!-- AI akce -->
    <div class="usage-card">
      <div class="usage-head">
        <div class="usage-name">AI akce</div>
        <div class="usage-count"><span id="ai-used">0</span>/<span id="ai-limit">0</span></div>
      </div>
      <div class="usage-bar"><div class="usage-bar-fill" id="ai-bar" style="width:0%"></div></div>
      <div class="usage-foot"><span id="ai-left">0</span> zb√Ωv√°</div>
    </div>

    <!-- P≈ôipojen√© √∫ƒçty -->
    <div class="usage-card">
      <div class="usage-head">
        <div class="usage-name">P≈ôipojen√© √∫ƒçty</div>
        <div class="usage-count"><span id="acc-count">0</span>/<span id="acc-limit">0</span></div>
      </div>
      <div class="usage-bar"><div class="usage-bar-fill" id="acc-bar" style="width:0%"></div></div>
      <div class="usage-foot">Limit pro aktu√°ln√≠ tarif</div>
    </div>
  </div>

  <div class="usage-period" id="usage-period"></div>
</div>
</div>








                    <!-- Notifications Tab -->
                    <div class="settings-content" id="notifications-settings" style="display: none;">
                        <div class="form-section">
                            <h3>Notifikace</h3>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Email notifikace</strong>
                                    <div style="color: #64748b; font-size: 0.9rem;">Dost√°vat upozornƒõn√≠ na email</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Push notifikace</strong>
                                    <div style="color: #64748b; font-size: 0.9rem;">Zobrazovat notifikace v prohl√≠≈æeƒçi</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="settings-content" id="security-settings" style="display: none;">
                        <div class="form-section">
                            <h3>Zabezpeƒçen√≠</h3>
                            <div class="form-group">
                                <label class="form-label">Zmƒõna hesla</label>
                                <input type="password" class="form-control" placeholder="Souƒçasn√© heslo">
                            </div>
                            <div class="form-group">
                                <input type="password" class="form-control" placeholder="Nov√© heslo">
                            </div>
                            <div class="form-group">
                                <input type="password" class="form-control" placeholder="Potvrzen√≠ nov√©ho hesla">
                            </div>
                            <button class="btn btn-primary">Zmƒõnit heslo</button>
                        </div>

                        <div class="form-section">
                            <h3>Dvoufaktorov√© ovƒõ≈ôen√≠</h3>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>2FA</strong>
                                    <div style="color: #64748b; font-size: 0.9rem;">Zv√Ω≈°te zabezpeƒçen√≠ sv√©ho √∫ƒçtu</div>
                                </div>
                                <button class="btn btn-primary">Povolit 2FA</button>
                            </div>
                        </div>
                    </div>
                </div>

                </div>





                






                <!-- Analytics Page -->
                <div class="page-content" id="analytics">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">Emailov√° aktivita</h3>
                            <div class="chart-filters">
                                <button class="filter-btn active">7 dn√≠</button>
                                <button class="filter-btn">30 dn√≠</button>
                                <button class="filter-btn">3 mƒõs√≠ce</button>
                            </div>
                        </div>
                        <div class="chart-placeholder">
                            üìä Graf emailov√© aktivity se zobraz√≠ zde
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">√öspƒõ≈°nost AI</h3>
                            </div>
                            <div class="chart-placeholder">
                                üéØ Graf √∫spƒõ≈°nosti AI
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-header">
                                <h3 class="chart-title">Kategorie email≈Ø</h3>
                            </div>
                            <div class="chart-placeholder">
                                ü•ß Kol√°ƒçov√Ω graf kategori√≠
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integrations Page -->
                <div class="page-content" id="integrations">
                    <div class="form-section">
                        <h3>Dostupn√© integrace</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div style="border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <span style="font-size: 2rem;">üìÖ</span>
                                    <div>
                                        <h4 style="margin: 0; color: #1e293b;">Google Calendar</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Automatick√© pl√°nov√°n√≠ sch≈Øzek</p>
                                    </div>
                                </div>
                                <button class="btn btn-primary" style="width: 100%;">P≈ôipojit</button>
                            </div>

                            <div style="border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <span style="font-size: 2rem;">üíº</span>
                                    <div>
                                        <h4 style="margin: 0; color: #1e293b;">Slack</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Notifikace o d≈Øle≈æit√Ωch emailech</p>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" style="width: 100%;">P≈ôipravuje se</button>
                            </div>

                            <div style="border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <span style="font-size: 2rem;">üìä</span>
                                    <div>
                                        <h4 style="margin: 0; color: #1e293b;">CRM syst√©my</h4>
                                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Synchronizace s va≈°√≠m CRM</p>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" style="width: 100%;">P≈ôipravuje se</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div id="toastMessage">Nastaven√≠ bylo √∫spƒõ≈°nƒõ ulo≈æeno!</div>
    </div>
    <div id="modal-overlay">
    <div id="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">P≈ôipojit nov√Ω emailov√Ω √∫ƒçet</h2>
            <button class="modal-close" id="modal-close-btn" aria-label="Zav≈ô√≠t">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="provider-buttons">
                <button class="provider-btn google" id="connect-google-btn">
                    <svg class="provider-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    P≈ôipojit p≈ôes Google
                </button>
                 <button class="provider-btn custom" id="connect-custom-btn">
                    <svg class="provider-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="#28a745" stroke-width="2" fill="none"/>
                        <polyline points="22,6 12,13 2,6" stroke="#28a745" stroke-width="2" fill="none"/>
                    </svg>
                    P≈ôipojit p≈ôes Custom Email
                </button>
            </div>
        </div>
    </div>
</div>





<div class="modal-overlay" id="analysisModal">
    <div class="modal">
        <div class="modal-header">
    <h2 class="modal-title"><span>ü§ñ</span> AI Anal√Ωza emailu</h2>
    <button class="modal-close" id="closeAnalysisModal">&times;</button>
</div>

<div class="modal-body" id="analysisModalBody">
    
    <div id="analysis-summary-section"></div>

    <div class="response-section">
        <div class="response-header">
            <div class="response-title">
                <span>‚ú®</span> Doporuƒçen√° odpovƒõƒè
            </div>
        </div>
        <div class="response-content" id="response-display"></div>
        <textarea class="form-control" id="response-editor" style="display: none; width: 100%; min-height: 150px; margin-top: 1rem;"></textarea>
    </div>

</div>

<div class="modal-footer">
    <div id="view-mode-buttons">
        <button class="btn btn-secondary" id="edit-reply-btn"><span>üìù</span> Upravit odpovƒõƒè</button>
        <button class="btn btn-success"><span>üì§</span> Odeslat nyn√≠</button>
    </div>
    <div id="edit-mode-buttons" style="display: none;">
        <button class="btn btn-secondary" id="cancel-edit-btn">Zru≈°it</button>
        <button class="btn btn-primary" id="save-edit-btn"><span>üíæ</span> Ulo≈æit zmƒõny</button>
    </div>
</div>
    </div>
</div>


    <script>
// ===================================================================================
// === 1. DEKLARACE GLOB√ÅLN√çCH PROMƒöNN√ùCH ===========================================
// ===================================================================================
const sidebar = document.getElementById('sidebar');
const collapseBtn = document.getElementById('collapseBtn');
const navLinks = document.querySelectorAll('.nav-link');
const pageContents = document.querySelectorAll('.page-content');
const pageTitle = document.getElementById('pageTitle');
const settingsTabs = document.querySelectorAll('.settings-tab');
const settingsContents = document.querySelectorAll('.settings-content');
const emailListContainer = document.getElementById('email-list-container');
const emailCountHeader = document.getElementById('email-count-header');
const modal = document.getElementById('modal-overlay');
const closeModalBtn = document.getElementById('modal-close-btn');
const googleBtn = document.getElementById('connect-google-btn');
const settingsForm = document.getElementById('settings-form');
const toneSelect = document.getElementById('tone-select');
const lengthSelect = document.getElementById('length-select');
const signatureTextarea = document.getElementById('signature-textarea');
const autoReplySwitch = document.getElementById('auto-reply-switch');
const approvalSwitch = document.getElementById('approval-switch');
const spamFilterSwitch = document.getElementById('spam-filter-switch');
const statusFilter = document.getElementById('status-filter');
const periodFilter = document.getElementById('period-filter');
const analysisModal = document.getElementById('analysisModal');
const closeAnalysisModalBtn = document.getElementById('closeAnalysisModal');
const searchBar = document.getElementById('search-bar');

let connectedAccounts = []; // [{ email: string, active: boolean }]
function getConnectedAccounts() { return connectedAccounts || []; }
function setConnectedAccounts(arr) { connectedAccounts = Array.isArray(arr) ? arr : []; }

let allEmails = [];
let currentMessageId = null;
const dashboardUserEmail = localStorage.getItem('userEmail'); // majitel dashboardu (p≈ôihl√°≈°en√Ω)
let primaryEmail = localStorage.getItem('primaryEmail') || '';
// =============== SYNC P≈òIPOJEN√ùCH √öƒåT≈Æ S BACKENDEM (P≈òIDEJ) ===============
async function fetchConnectedEmailsFromServer() {
  if (!dashboardUserEmail) return [];

  const urls = [
    `https://ai-email-server-stejdesign.onrender.com/api/accounts?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`,
    `https://ai-email-server-stejdesign.onrender.com/api/accounts/list?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`
  ];

  for (const u of urls) {
    try {
      const r = await fetch(u);
      const j = await r.json();
      if (j && j.success) {
        // podpora obou form√°t≈Ø: [{email,active}] i ["a@b.cz", ...]
        if (Array.isArray(j.accounts)) return j.accounts;
        if (Array.isArray(j.emails))   return j.emails.map(e => ({ email: e, active: true }));
      }
    } catch (_) {}
  }
  return [];
}

function getConnectedEmailsLS() {
  try { return JSON.parse(localStorage.getItem('connectedEmails')) || []; }
  catch { return []; }
}

function setConnectedEmailsLS(emails) {
  localStorage.setItem('connectedEmails', JSON.stringify(emails || []));
}

/**
 * St√°hne p≈ôipojen√© √∫ƒçty z backendu a ulo≈æ√≠ je do localStorage.
 * Vrac√≠ pole e-mail≈Ø. Pou≈æij v initializeDashboard().
 */
async function syncConnectedEmails() {
  const serverAccs = await fetchConnectedEmailsFromServer();
  setConnectedAccounts(serverAccs);
  return getConnectedAccounts();
}




function setPrimaryEmail(email) {
  primaryEmail = email;
  localStorage.setItem('primaryEmail', email);
}

// Po n√°vratu z OAuth: vezmeme new-email z URL a nastav√≠me jako primary
(function pickNewlyLinkedEmailFromUrl() {
  const params = new URLSearchParams(location.search);
  if (params.get('account-linked') === 'success' && params.get('new-email')) {
    setPrimaryEmail(decodeURIComponent(params.get('new-email')));
    // vyƒçisti URL
    const clean = new URL(location.href);
    clean.searchParams.delete('account-linked');
    clean.searchParams.delete('new-email');
    history.replaceState({}, '', clean.toString());
  }
})();


// ZMƒöNA: Odebrali jsme promƒõnn√© pro spr√°vu √∫ƒçt≈Ø odsud, budeme je spravovat v r√°mci funkc√≠ a localStorage.

// ===================================================================================
// === 2. Z√ÅKLADN√ç FUNKCE APLIKACE (Dashboard, Mod√°ly, Toast...) ====================
// ===================================================================================

function showToast(message, type = 'success', opts = {}) {
  const { duration = 3000, actionText = null, onAction = null } = opts;

  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  if (!toast || !toastMessage) return;

  // text + typ
  toastMessage.textContent = message;
  toast.className = `toast ${type} show`;

  // zru≈° p≈ô√≠padn√Ω p≈ôedchoz√≠ timer
  if (window.__toastTimer) {
    clearTimeout(window.__toastTimer);
    window.__toastTimer = null;
  }

  // vytvo≈ô / sprav akƒçn√≠ tlaƒç√≠tko (pokud je)
  let actionBtn = toast.querySelector('.toast-action-btn');
  if (actionText) {
    if (!actionBtn) {
      actionBtn = document.createElement('button');
      actionBtn.className = 'toast-action-btn';
      actionBtn.style.marginLeft = '12px';
      actionBtn.style.border = 'none';
      actionBtn.style.background = '#f1f5f9';
      actionBtn.style.color = '#334155';
      actionBtn.style.padding = '6px 10px';
      actionBtn.style.borderRadius = '6px';
      actionBtn.style.cursor = 'pointer';
      toast.appendChild(actionBtn);
    }
    actionBtn.textContent = actionText;
    actionBtn.onclick = () => { if (onAction) onAction(); };
    actionBtn.style.display = 'inline-block';
  } else if (actionBtn) {
    actionBtn.style.display = 'none';
    actionBtn.onclick = null;
  }

  // auto-hide
  window.__toastTimer = setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

function checkMobile() {
    if (sidebar && window.innerWidth <= 768) {
        sidebar.classList.add('collapsed');
    }
}

function openModal() {
    if (modal) modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    if (modal) modal.style.display = 'none';
    document.body.style.overflow = '';
}

function hideAnalysisModal() {
    if (analysisModal) analysisModal.classList.remove('show');
    document.body.style.overflow = '';
}

function connectGoogleAccount() {
    const GOOGLE_CLIENT_ID = "990614891314-kugic255rq68tt1m7uqg4rdp9jdig5lb.apps.googleusercontent.com";
    const REDIRECT_URI = "https://ai-email-server-stejdesign.onrender.com/api/oauth/google/callback";
    const oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

    // P≈ôid√°me email p≈ôihl√°≈°en√©ho u≈æivatele do state
    const loggedUserEmail = localStorage.getItem('userEmail');
    const params = {
        client_id: GOOGLE_CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: 'code',
        scope: 'openid email profile https://www.googleapis.com/auth/gmail.modify',
        access_type: 'offline',
        prompt: 'consent',
        include_granted_scopes: 'true',
        state: encodeURIComponent(loggedUserEmail || '')
    };
    window.location.href = `${oauth2Endpoint}?${new URLSearchParams(params)}`;
}

// ZMƒöNA: Funkce nyn√≠ naƒç√≠t√° emaily pro prim√°rn√≠ √∫ƒçet z localStorage
async function fetchEmails() {
    // NOV√â: Z√≠sk√°n√≠ prim√°rn√≠ho emailu z pamƒõti prohl√≠≈æeƒçe
    const primaryEmail = localStorage.getItem('primaryEmail');

    if (!primaryEmail) {
        if (emailListContainer) emailListContainer.innerHTML = `<div class="empty-state"><h3>Vyberte hlavn√≠ emailov√Ω √∫ƒçet</h3><p>V nastaven√≠ si zvolte, pro kter√Ω √∫ƒçet chcete emaily zobrazit.</p></div>`;
        if (emailCountHeader) emailCountHeader.textContent = 'Emaily (0)';
        return;
    }


    const accs = getConnectedAccounts().length ? getConnectedAccounts() : await syncConnectedEmails();
  const prim = accs.find(a => a.email === primaryEmail);
  if (!prim || !prim.active) {
    if (emailListContainer) {
      emailListContainer.innerHTML = `<div class="empty-state"><h3>Prim√°rn√≠ √∫ƒçet je neaktivn√≠</h3><p>Aktivujte ho v Nastaven√≠ ‚Üí Email √∫ƒçty.</p></div>`;
    }
    if (emailCountHeader) emailCountHeader.textContent = `Emaily pro: ${primaryEmail} (neaktivn√≠)`;
    return;
  }


    const status = statusFilter ? statusFilter.value : 'all';
    const period = periodFilter ? periodFilter.value : 'all';
    const searchQuery = searchBar ? searchBar.value : '';

    if (!emailListContainer) return;
    emailListContainer.innerHTML = `<div class="empty-state"><span>üìß</span><p>Naƒç√≠t√°m emaily pro ${primaryEmail}...</p></div>`;

    // NOV√â: Aktualizace nadpisu
    if (emailCountHeader) emailCountHeader.textContent = `Emaily pro: ${primaryEmail}`;

    try {
        // ZMƒöNA: Do API vol√°n√≠ se pos√≠l√° spr√°vn√Ω prim√°rn√≠ email
        const response = await fetch(
  `https://ai-email-server-stejdesign.onrender.com/api/gmail/emails` +
  `?email=${encodeURIComponent(primaryEmail)}` +
  `&dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}` +
  `&status=${encodeURIComponent(status)}` +
  `&period=${encodeURIComponent(period)}` +
  `&searchQuery=${encodeURIComponent(searchQuery)}`
);
        const data = await response.json();
        if (data.success) {
            allEmails = data.emails;
            // ZMƒöNA: Aktualizujeme nadpis i s celkov√Ωm poƒçtem email≈Ø
            if (emailCountHeader) emailCountHeader.textContent = `Emaily pro: ${primaryEmail} (${data.total || 0})`;
            renderEmailList(allEmails, data.total);
        } else {
            emailListContainer.innerHTML = `<div class="empty-state"><h3>Chyba: ${data.message}</h3><p>Zkontrolujte, zda je √∫ƒçet ${primaryEmail} st√°le aktivn√≠.</p></div>`;
        }
    } catch (error) {
        emailListContainer.innerHTML = `<div class="empty-state"><h3>Nepoda≈ôilo se p≈ôipojit k serveru.</h3></div>`;
    }
}

function renderEmailList(emails, total) {
    if (!emailListContainer) return;
    emailListContainer.innerHTML = '';
    
    if (emails.length === 0) {
        emailListContainer.innerHTML = `<div class="empty-state"><h3>Nebyly nalezeny ≈æ√°dn√© emaily</h3><p>Zkuste zmƒõnit filtry nebo vyhled√°v√°n√≠.</p></div>`;
        return;
    }
    emails.forEach(email => {
        const sender = email.sender.split('<')[0].trim().replace(/"/g, '');
        const emailHTML = `
            <div class="email-item" data-id="${email.id}">
                <div class="email-content" style="flex-grow: 1;">
                    <div class="email-sender">${sender}</div>
                    <div class="email-subject">${email.subject}</div>
                    <div class="email-preview">${email.snippet}</div>
                </div>
                <div class="email-meta" style="text-align: right; flex-shrink: 0;">
                    <div>${new Date(email.date).toLocaleDateString('cs-CZ')}</div>
                    <button class="btn btn-primary analyze-btn" data-message-id="${email.id}" style="margin-top: 5px;">
                        Analyzovat ü§ñ
                    </button>
                </div>
            </div>`;
        emailListContainer.insertAdjacentHTML('beforeend', emailHTML);
    });
}

// ZMƒöNA: Funkce nyn√≠ naƒç√≠t√° nastaven√≠ pro aktu√°lnƒõ vybran√Ω prim√°rn√≠ email
async function loadSettings() {
    const primaryEmail = localStorage.getItem('primaryEmail');
    if (!primaryEmail) {
        showToast('Nen√≠ vybr√°n ≈æ√°dn√Ω √∫ƒçet pro nastaven√≠.', 'warning');
        return;
    }

    console.log(`Naƒç√≠t√°m nastaven√≠ pro: ${primaryEmail}`);
    try {
        const response = await fetch(
  `https://ai-email-server-stejdesign.onrender.com/api/settings` +
  `?email=${encodeURIComponent(primaryEmail)}` +
  `&dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`
);
        const data = await response.json();
        if (data.success && data.settings) {
            const { tone, length, signature, auto_reply, approval_required, spam_filter } = data.settings;
            toneSelect.value = tone;
            lengthSelect.value = length;
            signatureTextarea.value = signature;
            autoReplySwitch.checked = auto_reply;
            approvalSwitch.checked = approval_required;
            spamFilterSwitch.checked = spam_filter;
            showToast(`Nastaven√≠ pro ${primaryEmail} bylo naƒçteno.`, 'success');
        } else {
             // Pokud pro dan√Ω email nastaven√≠ neexistuje, resetujeme formul√°≈ô do v√Ωchoz√≠ho stavu
            settingsForm.reset();
            showToast(`Pro ${primaryEmail} zat√≠m nebylo ulo≈æeno ≈æ√°dn√© nastaven√≠.`, 'info');
        }
    } catch (error) { showToast('Nepoda≈ôilo se naƒç√≠st nastaven√≠.', 'error'); }
}

// ZMƒöNA: Funkce ukl√°d√° nastaven√≠ pro aktu√°lnƒõ vybran√Ω prim√°rn√≠ email
async function saveSettings(event) {
    event.preventDefault();
    const primaryEmail = localStorage.getItem('primaryEmail');
    if (!primaryEmail) {
        showToast('Nen√≠ vybr√°n ≈æ√°dn√Ω √∫ƒçet, pro kter√Ω by se mƒõlo nastaven√≠ ulo≈æit.', 'error');
        return;
    }

    const settings = {
        dashboardUserEmail,                 
  email: primaryEmail,
  tone: toneSelect.value,
  length: lengthSelect.value,
  signature: signatureTextarea.value,
  auto_reply: autoReplySwitch.checked,
  approval_required: approvalSwitch.checked,
  spam_filter: spamFilterSwitch.checked
    };
    try {
        const response = await fetch('https://ai-email-server-stejdesign.onrender.com/api/settings', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(settings)
        });
        const data = await response.json();
        showToast(data.success ? data.message : `Chyba: ${data.message}`, data.success ? 'success' : 'error');
    } catch (error) { showToast('Nepoda≈ôilo se ulo≈æit nastaven√≠.', 'error'); }
}



async function loadPlan() {
  const userEmail = localStorage.getItem('userEmail');
  if (!userEmail) return;

  try {
    const res = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/user/plan?email=${encodeURIComponent(userEmail)}`);
    const data = await res.json();
    if (data.success && data.plan) {
      // za≈°krtnout spr√°vn√Ω radio
      const input = document.querySelector(`.plan-input[value="${data.plan}"]`);
      if (input) input.checked = true;
      // badge
      const badge = document.getElementById('current-plan-badge');
      if (badge) badge.textContent = `Aktu√°ln√≠: ${data.plan}`;
    }
  } catch (err) {
    console.error('Nepoda≈ôilo se naƒç√≠st pl√°n:', err);
  }
}

async function savePlan() {
  const userEmail = localStorage.getItem('userEmail');
  const selected = document.querySelector('.plan-input:checked');
  if (!userEmail || !selected) { showToast('Vyberte tarif.', 'warning'); return; }

  try {
    const res = await fetch('https://ai-email-server-stejdesign.onrender.com/api/user/plan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: userEmail, plan: selected.value })
    });
    const data = await res.json();
    showToast(data.message, data.success ? 'success' : 'error');
    if (data.success) {
      const badge = document.getElementById('current-plan-badge');
      if (badge) badge.textContent = `Aktu√°ln√≠: ${selected.value}`;
    }
  } catch (err) {
    showToast('Nepoda≈ôilo se ulo≈æit pl√°n.', 'error');
  }
}


async function loadLimits() {
  const dashboardUserEmail = localStorage.getItem('userEmail');
  if (!dashboardUserEmail) return;

  const panel = document.getElementById('usage-panel');
  try {
    const res = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/limits?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
    const data = await res.json();
    if (!data.success) throw new Error('Nepoda≈ôilo se naƒç√≠st limity');

    // AI akce
    const used = data.ai_actions_used ?? 0;
    const limit = data.monthly_ai_actions ?? 0;
    const left = Math.max(0, limit - used);
    const pctAI = limit > 0 ? Math.min(100, Math.round((used / limit) * 100)) : 0;

    document.getElementById('ai-used').textContent = used;
    document.getElementById('ai-limit').textContent = limit;
    document.getElementById('ai-left').textContent = left;
    document.getElementById('ai-bar').style.width = pctAI + '%';

    // P≈ôipojen√© √∫ƒçty
    const accLimit = data.max_accounts ?? 0;
    const accCount = await getConnectedAccountsCount(dashboardUserEmail);
    const pctAcc = accLimit > 0 ? Math.min(100, Math.round((accCount / accLimit) * 100)) : 0;

    document.getElementById('acc-count').textContent = accCount;
    document.getElementById('acc-limit').textContent = accLimit;
    document.getElementById('acc-bar').style.width = pctAcc + '%';

    // Obdob√≠
    document.getElementById('usage-period').textContent =
      `Obdob√≠: od ${data.period_start} (UTC) | Tarif: ${data.plan}`;

    panel.style.display = 'block';
  } catch (e) {
    console.error(e);
    if (panel) panel.style.display = 'none';
  }
}

async function getConnectedAccountsCount(dashboardUserEmail) {
  try {
    const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/accounts?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
    const j = await r.json();
    if (j.success) {
      const arr = Array.isArray(j.accounts) ? j.accounts : (j.emails || []).map(e => ({email:e, active:true}));
      return Array.isArray(arr) ? arr.length : 0;
    }
  } catch (_) {}
  return 0;
}



function enterEditMode() {
    const responseDisplay = document.getElementById('response-display');
    const responseEditor = document.getElementById('response-editor');
    const viewModeButtons = document.getElementById('view-mode-buttons');
    const editModeButtons = document.getElementById('edit-mode-buttons');
    
    // P≈òID√ÅNO: Z√≠sk√°n√≠ mod√°ln√≠ho okna a p≈ôid√°n√≠ t≈ô√≠dy pro roz≈°√≠≈ôen√≠
    const modal = document.querySelector('#analysisModal .modal');
    if (modal) {
        modal.classList.add('modal-full-width');
    }
    
    if (responseDisplay) responseDisplay.style.display = 'none';
    if (responseEditor) {
        responseEditor.style.display = 'block';
        responseEditor.value = responseDisplay.innerText;
        responseEditor.focus();
    }
    if (viewModeButtons) viewModeButtons.style.display = 'none';
    if (editModeButtons) editModeButtons.style.display = 'flex';
}

function exitEditMode(saveChanges) {
    const responseDisplay = document.getElementById('response-display');
    const responseEditor = document.getElementById('response-editor');
    const viewModeButtons = document.getElementById('view-mode-buttons');
    const editModeButtons = document.getElementById('edit-mode-buttons');
    
    // P≈òID√ÅNO: Odebr√°n√≠ t≈ô√≠dy pro roz≈°√≠≈ôen√≠ p≈ôi ukonƒçen√≠ editace
    const modal = document.querySelector('#analysisModal .modal');
    if (modal) {
        modal.classList.remove('modal-full-width');
    }
    
    if (saveChanges && responseDisplay && responseEditor) {
        responseDisplay.innerHTML = responseEditor.value.replace(/\n/g, '<br>');
        showToast('Odpovƒõƒè byla upravena.', 'success');
    }
    if (responseDisplay) responseDisplay.style.display = 'block';
    if (responseEditor) responseEditor.style.display = 'none';
    if (viewModeButtons) viewModeButtons.style.display = 'flex';
    if (editModeButtons) editModeButtons.style.display = 'none';
}


// ===================================================================================
// === 3. FUNKCE PRO SPR√ÅVU EMAILOV√ùCH √öƒåT≈Æ ==========================================
// ===================================================================================

// ZMƒöNA: Funkce nyn√≠ zv√Ωrazn√≠ prim√°rn√≠ √∫ƒçet podle localStorage
function renderConnectedAccounts() {
    const listEl = document.querySelector('#email-settings .email-list');
  if (!listEl) return;

  const accs = getConnectedAccounts(); // [{email, active}]
  const primary = localStorage.getItem('primaryEmail'); // primary klidnƒõ nech√°me v LS

  listEl.innerHTML = '';

  if (accs.length === 0) {
    listEl.innerHTML = '<p style="text-align:center;color:#6b7280;padding:2rem;">Zat√≠m nem√°te p≈ôipojen√Ω ≈æ√°dn√Ω emailov√Ω √∫ƒçet.</p>';
    const span = document.getElementById('currentConfigEmail');
    if (span) span.textContent = '≈Ω√°dn√Ω';
    return;
  }

  accs.forEach(({ email, active }) => {
    let providerName = 'Vlastn√≠', providerIconClass = 'gmail-icon';
    const e = email.toLowerCase();
    if (e.includes('gmail')) providerName = 'Gmail';
    else if (e.includes('outlook') || e.includes('hotmail')) { providerName = 'Outlook'; providerIconClass = 'outlook-icon'; }
    else if (e.includes('seznam')) providerName = 'Seznam';

    const isSelectedForConfig = (email === primary);

    const html = `
      <div class="email-item ${active ? 'active' : ''}" data-email="${email}">
        <div class="checkbox-wrapper" onclick="toggleAccount(this,'${email}',${!!active})">
          <input type="checkbox" class="checkbox-input" ${active ? 'checked' : ''}>
          <div class="checkbox-custom"></div>
        </div>
        <div class="email-info">
          <div class="email-address">${email}</div>
          <div class="email-provider">
            <div class="provider-icon ${providerIconClass}"></div>
            ${providerName} ‚Ä¢ P≈ôipojen
          </div>
        </div>
        <div class="email-controls">
          <div class="status-badge ${active ? 'active':''}">${active ? 'ü§ñ Aktivn√≠' : 'Neaktivn√≠'}</div>
          <div class="radio-wrapper ${isSelectedForConfig ? 'selected' : ''}" onclick="selectForConfig(this, '${email}')">
            <input type="radio" name="configEmail" value="${email}" class="radio-input" ${isSelectedForConfig ? 'checked' : ''}>
            <div class="radio-custom"></div>
            <span class="radio-label">Nastavit</span>
          </div>
          <button class="disconnect-btn" onclick="disconnectAccount('${email}')" title="Odpojit √∫ƒçet">
            <span class="disconnect-icon">√ó</span>
          </button>
        </div>
      </div>`;
    listEl.insertAdjacentHTML('beforeend', html);
  });

  const span = document.getElementById('currentConfigEmail');
  if (span) span.textContent = primary || '≈Ω√°dn√Ω';
}

// ZMƒöNA: Funkce nyn√≠ ulo≈æ√≠ v√Ωbƒõr a znovu naƒçte nastaven√≠
function selectForConfig(radioWrapper, email) {
    // Ulo≈æ√≠me nov√Ω prim√°rn√≠ email do localStorage
    localStorage.setItem('primaryEmail', email);

    // Vizu√°ln√≠ aktualizace
    document.querySelectorAll('#email-settings .radio-wrapper').forEach(wrapper => wrapper.classList.remove('selected'));
    radioWrapper.classList.add('selected');
    radioWrapper.querySelector('.radio-input').checked = true;
    document.getElementById('currentConfigEmail').textContent = email;
    
    // NOV√â: Okam≈æitƒõ naƒçteme nastaven√≠ pro novƒõ vybran√Ω √∫ƒçet
    loadSettings();
    fetchEmails();
}

async function toggleAccount(wrapper, email, currentActive) {
  const checkbox = wrapper.querySelector('.checkbox-input');
  // optimisticky otoƒç√≠me hodnotu
  const newActive = !currentActive;
  checkbox.checked = newActive;

  try {
    const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/accounts/set-active', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ dashboardUserEmail, email, active: newActive })
    });
    const j = await r.json();
    if (!j.success) throw new Error(j.message || 'Nepoda≈ôilo se ulo≈æit.');

    // refresh listu ze serveru (pravda je na serveru)
    const accs = await syncConnectedEmails();
    renderConnectedAccounts();

    // pokud jsi vypnul pr√°vƒõ prim√°rn√≠ √∫ƒçet ‚Üí zamez naƒç√≠t√°n√≠ email≈Ø
    const prim = localStorage.getItem('primaryEmail');
    const primObj = accs.find(a => a.email === prim);
    if (!primObj || !primObj.active) {
      if (emailListContainer) {
        emailListContainer.innerHTML = `<div class="empty-state"><h3>Prim√°rn√≠ √∫ƒçet je neaktivn√≠</h3><p>Pro naƒçten√≠ email≈Ø ho aktivujte v Nastaven√≠ ‚Üí Email √∫ƒçty.</p></div>`;
        if (emailCountHeader) emailCountHeader.textContent = 'Emaily (0)';
      }
    } else {
      // pokud je str√°nka ‚ÄûEmaily‚Äú otev≈ôen√°, naƒçti je znovu
      const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
      if (emailsPageActive) fetchEmails();
    }

    showToast(`Stav √∫ƒçtu ${email} byl zmƒõnƒõn.`, 'success');
  } catch (e) {
    // revert UI p≈ôi chybƒõ
    checkbox.checked = currentActive;
    showToast(`Chyba: ${e.message || e}`, 'error');
  }
}





async function addAccount() {
     const dashboardUserEmail = localStorage.getItem('userEmail');
  if (!dashboardUserEmail) {
    showToast('Nejste p≈ôihl√°≈°en.', 'error');
    return;
  }

  try {
    // naƒçti limity i aktu√°ln√≠ poƒçet √∫ƒçt≈Ø najednou
    const [limitsRes, accCount] = await Promise.all([
      fetch(`https://ai-email-server-stejdesign.onrender.com/api/limits?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`)
        .then(r => r.json()),
      getConnectedAccountsCount(dashboardUserEmail)
    ]);

    // kdy≈æ API na limity sel≈æe, rad≈°i modal otev≈ôi (fallback)
    if (!limitsRes?.success) {
      openModal();
      return;
    }

    const plan = limitsRes.plan;                   // nap≈ô. "Starter"
    const maxAccounts = limitsRes.max_accounts ?? 0;
    const hasReachedLimit = accCount >= maxAccounts;

    if (hasReachedLimit) {
      const msg = plan === 'Starter'
        ? 'Na tarifu Starter lze p≈ôipojit maxim√°lnƒõ 1 emailov√Ω √∫ƒçet. Pro p≈ôid√°n√≠ dal≈°√≠ho √∫ƒçtu p≈ôejdƒõte na vy≈°≈°√≠ tarif v Nastaven√≠ ‚Üí Pl√°n.'
        : `Dos√°hli jste limitu p≈ôipojen√Ωch √∫ƒçt≈Ø pro tarif ${plan} (max ${maxAccounts}). Pro p≈ôid√°n√≠ dal≈°√≠ho √∫ƒçtu p≈ôejdƒõte v Nastaven√≠ na vy≈°≈°√≠ tarif.`;

      // uk√°≈æeme dlouhou notifikaci a nab√≠dneme rovnou p≈ôepnut√≠ na Pl√°n
      showToast(msg, 'warning', {
        duration: 9000,
        actionText: 'P≈ôej√≠t na Pl√°n',
        onAction: () => {
          // otev≈ôi str√°nku Nastaven√≠ ‚Üí z√°lo≈æku Pl√°n
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          const settingsLink = document.querySelector('.nav-link[data-page="settings"]');
          if (settingsLink) settingsLink.classList.add('active');

          document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
          const settingsPage = document.getElementById('settings');
          if (settingsPage) settingsPage.classList.add('active');

          document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.settings-content').forEach(c => c.style.display = 'none');

          const planTab = document.querySelector('.settings-tab[data-tab="plan"]');
          if (planTab) planTab.classList.add('active');

          const planContent = document.getElementById('plan-settings');
          if (planContent) planContent.style.display = 'block';

          // v≈ædy naƒçti ƒçerstv√° data
          loadPlan();
          loadLimits();
        }
      });

      // D≈ÆLE≈ΩIT√â: tady skonƒçit ‚Äì neotev√≠rat modal
      return;
    }

    // limit nen√≠ vyƒçerp√°n ‚Üí otev≈ôi modal pro p≈ôipojen√≠
    openModal();

  } catch (e) {
    console.error(e);
    // p≈ôi chybƒõ radƒõji modal otev≈ôi, a≈• m√° u≈æivatel ≈°anci to zkusit
    openModal();
  }
}

// ZMƒöNA: Funkce zkontroluje, zda nebyl odpojen prim√°rn√≠ √∫ƒçet
async function disconnectAccount(email) {
    if (!confirm(`Opravdu chcete odpojit √∫ƒçet ${email}?`)) return;

  const dashboardUserEmail = localStorage.getItem('userEmail');
  if (!dashboardUserEmail) {
    showToast('Nejste p≈ôihl√°≈°en.', 'error');
    return;
  }

  try {
    // 1) odpojit na serveru + smazat v DB (a zneplatnit token u Google)
    const res = await fetch('https://ai-email-server-stejdesign.onrender.com/api/oauth/google/revoke', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, dashboardUserEmail })
    });
    const data = await res.json();
    if (!data.success) {
      showToast(data.message || 'Nepoda≈ôilo se odpojit √∫ƒçet.', 'error');
      return;
    }

    // 2) znovu st√°hnout aktu√°ln√≠ seznam √∫ƒçt≈Ø ze serveru (source of truth)
    const serverEmails = await fetchConnectedEmailsFromServer();
    setConnectedEmailsLS(serverEmails); // p≈ôepi≈° localStorage stavem z DB

    // 3) pokud jsme odpojili prim√°rn√≠, zvol nov√Ω (nebo sma≈æ nastaven√≠)
    const currentPrimary = localStorage.getItem('primaryEmail');
    if (currentPrimary === email) {
      const newPrimary = serverEmails[0] || null;
      if (newPrimary) localStorage.setItem('primaryEmail', newPrimary);
      else localStorage.removeItem('primaryEmail');
    }

    // 4) p≈ôekreslit UI + p≈ô√≠padnƒõ naƒç√≠st settings a emaily pro nov√Ω prim√°rn√≠
    renderConnectedAccounts();

    const newPrimaryAfter = localStorage.getItem('primaryEmail');
    if (newPrimaryAfter) {
      // jen kdy≈æ je nƒõco vybran√©
      await loadSettings();
      const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
      if (emailsPageActive) fetchEmails();
    } else {
      // kdy≈æ u≈æ nem√°≈° ≈æ√°dn√Ω √∫ƒçet
      if (emailListContainer)
        emailListContainer.innerHTML = `<div class="empty-state"><h3>Nem√°te p≈ôipojen√Ω ≈æ√°dn√Ω √∫ƒçet</h3><p>P≈ôidejte si √∫ƒçet v Nastaven√≠ ‚Üí Email √∫ƒçty.</p></div>`;
    }

    // 5) aktualizovat limity (progres bar) ‚Äì d≈Øle≈æit√© kv≈Øli p≈ôechodu na Starter
    await loadLimits();

    showToast('√öƒçet byl √∫spƒõ≈°nƒõ odpojen.', 'success');
  } catch (err) {
    console.error(err);
    showToast('Chyba p≈ôi odpojov√°n√≠ √∫ƒçtu.', 'error');
  }
}

// ZMƒöNA: Hlavn√≠ inicializaƒçn√≠ funkce, kter√° nastav√≠ v√Ωchoz√≠ prim√°rn√≠ √∫ƒçet
async function initializeDashboard() {
  // Kdy≈æ se vr√°time z OAuth, URL m≈Ø≈æe m√≠t ?account-linked=success...
  // Ne≈ôe≈° parametry ‚Äì stejnƒõ si v≈°e st√°hneme z DB a t√≠m je to nejspolehlivƒõj≈°√≠.
  if (new URLSearchParams(location.search).get('account-linked') === 'success') {
    showToast('√öƒçet byl √∫spƒõ≈°nƒõ propojen. Naƒç√≠t√°m √∫ƒçty...', 'success');
    // oƒçisti URL
    const clean = new URL(location.href);
    clean.searchParams.delete('account-linked');
    clean.searchParams.delete('new-email');
    history.replaceState({}, '', clean.toString());
  }

  // 1) st√°hni p≈ôipojen√© √∫ƒçty z backendu a ulo≈æ do localStorage
  const connectedEmails = await syncConnectedEmails();

  // 2) nastav/validuj prim√°rn√≠ √∫ƒçet
  let currentPrimary = localStorage.getItem('primaryEmail');
if (!currentPrimary || !connectedEmails.some(a => a.email === currentPrimary)) {
  currentPrimary = connectedEmails[0]?.email || null;
  if (currentPrimary) localStorage.setItem('primaryEmail', currentPrimary);
  else localStorage.removeItem('primaryEmail');
}

  // 3) vykresli seznam √∫ƒçt≈Ø + stav ‚ÄûNastavuji: ...‚Äú
  renderConnectedAccounts();

  // 4) Kdy≈æ je prim√°rn√≠, rovnou naƒçti AI nastaven√≠ a e-maily
  if (currentPrimary) {
    await loadSettings();
    // jestli u≈æivatel stoj√≠ na z√°lo≈æce ‚ÄûEmaily‚Äú, naƒçti je
    const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
    if (emailsPageActive) fetchEmails();
  }
}





// ===================================================================================
// === 4. HLAVN√ç BLOK - SPU≈†TƒöN√ç PO NAƒåTEN√ç STR√ÅNKY ==================================
// ===================================================================================


document.addEventListener('DOMContentLoaded', () => {
    console.log('AI Emailov√Ω Agent Dashboard loaded successfully');

    const planTab = document.querySelector('.settings-tab[data-tab="plan"]');
if (planTab) {
  planTab.addEventListener('click', () => {
    loadPlan();
    loadLimits(); // v≈ædy se naƒçtou ƒçerstv√° data p≈ôi kliknut√≠ na z√°lo≈æku "Pl√°n"
  });
}
    
    const userName = localStorage.getItem('userName');
    if (!userName) {
        alert("Nejste p≈ôihl√°≈°en.");
        window.location.href = 'login.html';
        return;
    }
    const avatarDiv = document.querySelector('.user-avatar');
    const userNameDisplay = document.getElementById('user-name-display');
    if (userNameDisplay) userNameDisplay.textContent = userName;
    if (avatarDiv) {
        const nameParts = userName.split(' ');
        let initials = nameParts.length > 1 ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : userName.substring(0, 2);
        avatarDiv.textContent = initials.toUpperCase();
    }
    const logoutButton = document.getElementById('logout-button');
    if (logoutButton) logoutButton.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'login.html';
    });
    
    initializeDashboard();

    if (collapseBtn) {
        collapseBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            collapseBtn.innerHTML = sidebar.classList.contains('collapsed') ? '<span>‚Üí</span>' : '<span>‚Üê</span>';
        });
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            pageContents.forEach(page => page.classList.remove('active'));
            const targetPageId = link.getAttribute('data-page');
            const targetElement = document.getElementById(targetPageId);
            if (targetElement) targetElement.classList.add('active');

            if (pageTitle) {
                const titles = { 'dashboard': 'Dashboard', 'emails': 'Spr√°va email≈Ø', 'templates': '≈†ablony', 'settings': 'Nastaven√≠', 'analytics': 'Analytika', 'integrations': 'Integrace' };
                pageTitle.textContent = titles[targetPageId] || 'Dashboard';
            }

            // ZMƒöNA: Funkce se volaj√≠ bez parametr≈Ø, vezmou si prim√°rn√≠ email z localStorage
            if (targetPageId === 'emails') fetchEmails();
            if (targetPageId === 'settings') loadSettings();
        });
    });

    if (settingsTabs) {
        settingsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            settingsTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Skryjeme v≈°echny obsahy z√°lo≈æek
            settingsContents.forEach(content => content.style.display = 'none');
            
            const targetContentId = tab.getAttribute('data-tab') + '-settings';
            const targetContent = document.getElementById(targetContentId);

            if (targetContent) {
                 targetContent.style.display = 'block';
                 if (tab.getAttribute('data-tab') === 'email') {
                     renderConnectedAccounts();
                 }
                 if (tab.getAttribute('data-tab') === 'ai') {
                     loadSettings(); // Naƒçteme nastaven√≠, kdy≈æ se vr√°t√≠me na AI z√°lo≈æku
                 }
                 if (tab.getAttribute('data-tab') === 'plan') {
          loadPlan();
          loadLimits();
        }
            }
        });
    });
    }

    if (emailListContainer) {
        emailListContainer.addEventListener('click', async (event) => {
            const analyzeButton = event.target.closest('.analyze-btn');
            if (analyzeButton) {
                currentMessageId = analyzeButton.dataset.messageId;
                const primaryEmail = localStorage.getItem('primaryEmail'); // ZMƒöNA
                if (!primaryEmail) {
                    showToast('≈Ω√°dn√Ω propojen√Ω email pro anal√Ωzu.', 'error'); return;
                }
                const modalBody = document.getElementById('analysisModalBody');
                if (analysisModal && modalBody) {
                    modalBody.innerHTML = '<div class="loading" style="margin: 4rem auto;"></div>';
                    analysisModal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
                try {
                    const response = await fetch('https://ai-email-server-stejdesign.onrender.com/api/gmail/analyze-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
  dashboardUserEmail,                 // ‚¨ÖÔ∏è P≈òID√ÅNO
  email: primaryEmail,
  messageId: currentMessageId
})
                    });
                    const data = await response.json();
                    if (data.success && modalBody) {
                        modalBody.innerHTML = `
                            <div class="analysis-section">
                                <div class="section-header"><div class="section-icon">üìä</div><div class="section-title">Shrnut√≠ a sentiment</div></div>
                                <div class="section-content"><strong>Shrnut√≠:</strong> ${data.analysis.summary}<br><strong>Sentiment:</strong> ${data.analysis.sentiment}</div>
                            </div>
                            <div class="response-section">
                                <div class="response-header"><div class="response-title"><span>‚ú®</span> Doporuƒçen√° odpovƒõƒè</div></div>
                                <div class="response-content" id="response-display">${data.analysis.suggested_reply.replace(/\n/g, '<br>')}</div>
                                <textarea class="form-control" id="response-editor" style="display: none;"></textarea>
                            </div>`;
                    } else if (modalBody) {
                        modalBody.innerHTML = `<p style="text-align: center; color: red;">Chyba anal√Ωzy: ${data.message}</p>`;
                    }
                } catch (error) {
                    if(modalBody) modalBody.innerHTML = `<p style="text-align: center; color: red;">Nepoda≈ôilo se p≈ôipojit k serveru pro anal√Ωzu.</p>`;
                }
            }
        });
    }
    
    if (settingsForm) settingsForm.addEventListener('submit', saveSettings);
    if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
    if (analysisModal) analysisModal.addEventListener('click', (e) => { if (e.target === analysisModal) hideAnalysisModal(); });
    if (closeAnalysisModalBtn) closeAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
    if (googleBtn) googleBtn.addEventListener('click', connectGoogleAccount);
    if (statusFilter) statusFilter.addEventListener('change', fetchEmails);
    if (periodFilter) periodFilter.addEventListener('change', fetchEmails);
    if (searchBar) searchBar.addEventListener('search', fetchEmails);
    
    const modalFooter = document.querySelector('#analysisModal .modal-footer');
    if (modalFooter) {
        modalFooter.addEventListener('click', async (event) => {
            if (event.target.closest('#edit-reply-btn')) enterEditMode();
            if (event.target.closest('#save-edit-btn')) exitEditMode(true);
            if (event.target.closest('#cancel-edit-btn')) exitEditMode(false);
            if (event.target.closest('.btn-success')) {
                const sendButton = event.target.closest('.btn-success');
                const primaryEmail = localStorage.getItem('primaryEmail'); // ZMƒöNA
                const replyBody = document.getElementById('response-editor').value;
                if (!primaryEmail || !currentMessageId || !replyBody) {
                    showToast('Chyb√≠ data pro odesl√°n√≠.', 'error'); return;
                }
                sendButton.textContent = 'Odes√≠l√°m...'; sendButton.disabled = true;
                try {
                    const response = await fetch('https://ai-email-server-stejdesign.onrender.com/api/gmail/send-reply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
  dashboardUserEmail,                 // ‚¨ÖÔ∏è P≈òID√ÅNO
  email: primaryEmail,
  messageId: currentMessageId,
  replyBody
})
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast(data.message, 'success'); hideAnalysisModal();
                    } else { showToast(`Chyba: ${data.message}`, 'error'); }
                } catch (error) {
                    showToast('Nepoda≈ôilo se p≈ôipojit k serveru pro odesl√°n√≠.', 'error');
                } finally {
                    sendButton.textContent = 'Odeslat nyn√≠'; sendButton.disabled = false;
                }
            }
        });
    }

    checkMobile();
    window.addEventListener('resize', checkMobile);

    const initialActivePage = document.querySelector('.nav-link.active')?.getAttribute('data-page');
    if (initialActivePage === 'emails') {
        fetchEmails();
    }
     if (initialActivePage === 'settings') {
        loadSettings();
    }
    

    setInterval(() => {
        const emailsPage = document.getElementById('emails');
        if (emailsPage && emailsPage.classList.contains('active')) {
            console.log('üîÑ Automaticky obnovuji seznam email≈Ø...');
            fetchEmails();
        }
    }, 60000);
    const savePlanBtn = document.getElementById('save-plan-btn');
if (savePlanBtn) savePlanBtn.addEventListener('click', async () => {
  await savePlan();
  loadLimits(); // refresh usage po zmƒõnƒõ tarifu
});
});
    
    
</script>
</body>
</html>