<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AI Emailový Agent</title>
  <style>
    /* === PRO EMAIL MODAL === */
    /* === PRO EMAIL MODAL === */
    .pro-modal {
      padding: 12px;
      overflow: hidden;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .25);
      max-height: min(920px, 90vh);
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: linear-gradient(160deg, rgba(14, 165, 233, 0.18) 0%, rgba(59, 130, 246, 0.14) 48%, rgba(99, 102, 241, 0.12) 100%);
    }

    .pro-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .85rem;
      padding: 12px 16px;
      background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 60%, #6366f1 100%);
      color: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(14, 116, 233, 0.28);
    }

    .pro-modal__id {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .pro-headings {
      min-width: 0;
    }

    .pro-title {
      font-weight: 700;
      font-size: 1.1rem;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pro-subtitle {
      opacity: .95;
      font-size: .9rem;
      display: flex;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
      row-gap: .25rem;
    }

    .pro-subtitle span {
      min-width: 0;
      overflow-wrap: anywhere;
    }

    .pro-dot {
      opacity: .75;
      flex-shrink: 0;
    }

    .pro-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: rgba(255, 255, 255, .2);
      border: 1px solid rgba(255, 255, 255, .35);
      font-weight: 700;
      backdrop-filter: blur(6px);
    }

    .pro-actions {
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .pro-chip {
      background: rgba(255, 255, 255, .18);
      border-color: rgba(255, 255, 255, .35);
      color: #fff;
    }

    .pro-chip:hover {
      background: rgba(255, 255, 255, .28);
    }

    .pro-close {
      margin-left: .25rem;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .15);
      border: 1px solid rgba(255, 255, 255, .35);
      color: #fff;
      cursor: pointer;
    }

    .pro-close:hover {
      background: rgba(255, 255, 255, .28);
    }

    .pro-modal__body {
      padding: 16px 18px 18px;
      display: grid;
      grid-template-columns: minmax(220px, 280px) minmax(0, 1fr);
      gap: 18px;
      flex: 1;
      min-height: 0;
      align-items: stretch;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      overflow: hidden;
    }

    .pro-modal__body>* {
      min-width: 0;
    }

    @media (max-width: 1080px) {
      .pro-modal__body {
        grid-template-columns: minmax(200px, 240px) minmax(0, 1fr);
      }
    }

    @media (max-width: 860px) {
      .pro-modal__body {
        grid-template-columns: 1fr;
        gap: 16px;
        overflow-y: auto;
      }
    }

    .pro-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 16px;
      padding: 14px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .pro-sidebar .pro-meta {
      border: none;
      background: transparent;
      padding: 0;
      box-shadow: none;
    }

    .pro-content {
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-gutter: stable both-edges;
    }

    .pro-content::-webkit-scrollbar {
      width: 10px;
    }

    .pro-content::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.45);
      border-radius: 8px;
    }

    .pro-content::-webkit-scrollbar-track {
      background: rgba(241, 245, 249, 0.8);
      border-radius: 8px;
    }

    .pro-body-card--email {
      flex: 1 1 auto;
      min-height: 0;
    }

    .pro-body-card--ai {
      flex: 0 0 auto;
    }

    .ai-inline-card {
      position: sticky;
      bottom: 0;
      z-index: 5;
      box-shadow: 0 -16px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .ai-inline-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #ffffff 40%);
      pointer-events: none;
      border-radius: inherit;
      opacity: 0.92;
    }

    .ai-inline-card .pro-body-card__content {
      position: relative;
      z-index: 1;
    }

    @media (max-width: 860px) {
      .pro-sidebar {
        background: transparent;
        border: none;
        padding: 0;
        box-shadow: none;
      }

      .pro-content {
        overflow: visible;
        padding-right: 0;
      }

      .ai-inline-card {
        position: static;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      }

      .ai-inline-card::before {
        display: none;
      }
    }


    .pro-meta {
      background: #f8fafc;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .pro-meta__row {
      display: grid;
      grid-template-columns: 108px 1fr;
      gap: 10px;
      padding: 10px 6px;
      align-items: start;
    }

    .pro-meta__label {
      font-size: .8rem;
      color: #64748b;
    }

    .pro-meta__value {
      font-size: .95rem;
      color: #0f172a;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .pro-body-card {
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }

    .pro-body-card__title {
      padding: 12px 16px;
      font-weight: 600;
      color: #0f172a;
      background: #f8fafc;
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    }

    .pro-body-card__content {
      padding: 18px 16px;
      white-space: pre-wrap;
      line-height: 1.55;
      color: #111827;
      min-height: 0;
    }

    #ed-body {
      overflow-y: auto;
      max-height: clamp(360px, calc(74vh - 220px), 620px);
      min-height: clamp(280px, 38vh, 520px);
      padding-right: 6px;
      scrollbar-gutter: stable both-edges;
    }

    @media (max-width: 860px) {
      #ed-body {
        max-height: none;
      }
    }

    .pro-modal__footer {
      padding: 12px 18px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid #e5e7eb;
      background: #fff;
    }

    /* drobnosti */
    #emailDetailModal .btn {
      border-radius: 10px;
      padding: 8px 12px;
    }

    #emailDetailModal.show .modal {
      transform: translateY(0);
      opacity: 1;
      transition: .28s ease;
    }

    #emailDetailModal .modal {
      transform: translateY(8px);
      opacity: 0;
    }








    .toast .toast-action:hover {
      opacity: .9;
    }

    /* === STYLY PRO NOVÉ MODÁLNÍ OKNO === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      /* Skryté ve výchozím stavu */
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .email-item {
      cursor: pointer;
    }

    .email-item .analyze-btn {
      cursor: default;
    }

    #emailDetailModal {
      z-index: 2050;
    }

    #emailDetailModal .modal-body {
      max-height: calc(90vh - 160px);
      overflow: auto;
    }

    #analysisModal {
      z-index: 2000;
    }

    #templatePicker {
      z-index: 2100;
    }

    .modal-overlay.show {
      opacity: 1;
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 20px;
      width: 94%;
      max-width: 1040px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      transform: scale(0.95);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e2e8f0;
      flex-shrink: 0;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      color: #1e293b;
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 2rem;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 1.5rem 2rem;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      border-top: 1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 0 0 20px 20px;
      flex-shrink: 0;
    }

    .list-action-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .list-action-group .btn {
      width: 190px;
    }

    .quick-ai-btn {
      background: #f1f5f9;
      color: #0f172a;
      border: 1px solid #e2e8f0;
    }

    .quick-ai-btn:hover {
      background: #e2e8f0;
      color: #0f172a;
    }

    .ai-composer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2300;
      transition: opacity .25s ease;
      opacity: 0;
      padding: 1.5rem;
    }

    .ai-composer-overlay.show {
      display: flex;
      opacity: 1;
    }

    .ai-composer-panel {
      width: min(960px, 96vw);
      background: #ffffff;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(15, 23, 42, 0.22);
      overflow: hidden;
      transform: translateY(12px);
      transition: transform .25s ease;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .ai-composer-overlay.show .ai-composer-panel {
      transform: translateY(0);
    }

    .ai-composer-header {
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    }

    .ai-composer-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1e1b4b;
      display: flex;
      align-items: center;
      gap: .65rem;
    }

    .ai-composer-title span {
      font-size: 1.6rem;
    }

    .ai-composer-context {
      color: #4338ca;
      font-weight: 500;
      font-size: .95rem;
    }

    .ai-composer-close {
      border: none;
      background: rgba(255, 255, 255, 0.65);
      color: #4338ca;
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      font-size: 1.4rem;
      cursor: pointer;
      transition: .2s ease;
    }

    .ai-composer-close:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: rotate(90deg);
    }

    .ai-composer-body {
      padding: 1.75rem 2rem;
      overflow: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
    }

    .ai-composer-note {
      padding: 1rem 1.25rem;
      background: #e2e8f0;
      border-radius: 16px;
      color: #334155;
      font-size: .95rem;
      line-height: 1.5;
    }

    .ai-composer-field label {
      display: block;
      font-weight: 600;
      margin-bottom: .5rem;
      color: #0f172a;
    }

    .ai-composer-field textarea {
      width: 100%;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 1rem 1.1rem;
      font-size: 1rem;
      line-height: 1.6;
      resize: vertical;
      min-height: 120px;
      background: #f8fafc;
    }

    .ai-composer-field textarea:focus {
      outline: none;
      border-color: #818cf8;
      box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
      background: #fff;
    }

    .ai-composer-select {
      width: 100%;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: .75rem;
      font-size: .95rem;
      background: #fff;
      color: #0f172a;
    }

    .ai-composer-tag {
      font-size: .85rem;
      color: #475569;
      background: #e2e8f0;
      padding: .4rem .7rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .ai-composer-profile {
      color: #64748b;
      font-size: .9rem;
    }

    .ai-composer-status {
      font-size: .9rem;
      color: #334155;
    }

    .ai-composer-loader {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 4px solid #e2e8f0;
      border-top-color: #6366f1;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
    }

    .ai-composer-result {
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      background: #f8fafc;
      padding: 1rem;
      display: none;
      flex-direction: column;
      gap: .75rem;
    }

    .ai-composer-result.show {
      display: flex;
    }

    .ai-composer-result textarea {
      width: 100%;
      border: none;
      background: transparent;
      resize: vertical;
      min-height: 220px;
      line-height: 1.6;
      font-size: .97rem;
      color: #0f172a;
    }

    .ai-composer-result textarea:focus {
      outline: none;
    }

    .ai-composer-result-actions {
      display: flex;
      justify-content: flex-end;
      gap: .75rem;
    }

    .ai-composer-footer {
      padding: 1.25rem 2rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .ai-composer-footer .btn-primary {
      min-width: 180px;
    }

    .ai-inline-card {
      grid-column: 1 / -1;
      position: relative;
      width: 100%;
      max-width: none;
      align-self: stretch;
      min-height: clamp(300px, 44vh, 500px);
      display: flex;
      flex-direction: column;
    }

    .ai-inline-card .pro-body-card__title {
      display: flex;
      align-items: center;
      gap: .75rem;
    }

    .ai-inline-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      font-size: 1.15rem;
    }

    .ai-inline-content {
      display: flex;
      gap: 1.25rem;
      align-items: stretch;
      flex: 1;
      min-height: 0;
      flex-wrap: wrap;
    }

    .ai-inline-main {
      display: flex;
      flex-direction: column;
      gap: .75rem;
      min-width: 260px;
      min-height: 0;
      flex: 1 1 340px;
    }

    .ai-inline-lead {
      font-size: .95rem;
      color: #475569;
      line-height: 1.55;
    }

    .ai-inline-input {
      min-height: clamp(160px, 28vh, 360px);
      resize: vertical;
      background: #f8fafc;
      border: 1px solid #dbe3f3;
      border-radius: 14px;
      padding: 1rem 1.1rem;
      line-height: 1.6;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transition: border-color .2s ease, box-shadow .2s ease;
      flex: 1;
      min-width: 0;
    }

    .ai-inline-input:focus {
      outline: none;
      border-color: #818cf8;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.18);
      background: #fff;
    }

    .ai-inline-side {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 1.1rem 1.25rem;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      min-width: 260px;
      align-self: stretch;
      flex: 1 1 260px;
    }

    .ai-inline-hint {
      background: rgba(99, 102, 241, 0.08);
      border: 1px solid rgba(99, 102, 241, 0.18);
      border-radius: 12px;
      padding: 1rem 1.15rem;
      color: #312e81;
      line-height: 1.5;
    }

    .ai-inline-hint-title {
      display: block;
      font-weight: 600;
      margin-bottom: .55rem;
      font-size: .92rem;
      color: #1e1b4b;
    }

    .ai-inline-list {
      margin: 0;
      padding-left: 1.1rem;
      display: flex;
      flex-direction: column;
      gap: .45rem;
      font-size: .9rem;
      color: #4338ca;
    }

    .ai-inline-button {
      width: 100%;
      display: inline-flex;
      justify-content: center;
      gap: .5rem;
      font-weight: 600;
      box-shadow: 0 12px 25px rgba(99, 102, 241, 0.18);
      align-self: flex-start;
    }

    .ai-inline-note {
      font-size: .85rem;
      color: #475569;
      text-align: center;
    }

    @media (min-width: 720px) {
      .ai-inline-content {
        flex-wrap: nowrap;
        min-height: clamp(360px, 48vh, 560px);
      }
    }

    @media (max-width: 719px) {
      .ai-inline-side {
        padding: 1rem;
      }

      .ai-inline-button {
        width: auto;
        align-self: flex-start;
      }

      .ai-inline-note {
        text-align: left;
      }
    }

    .analysis-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .section-icon {
      font-size: 1.5rem;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #ffffff;
    }

    .section-content {
      color: #cbd5e1;
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .response-section {
      padding: 1.5rem 0;
    }

    .response-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .response-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.3rem;
      font-weight: 700;
      color: #ffffff;
    }

    .response-content {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      color: #ecf0f1;
      line-height: 1.7;
      font-size: 0.95rem;
      white-space: pre-wrap;
    }

    .btn-success {
      background: #22c55e;
      color: white;
    }

    .loading {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .usage-panel {
      margin-top: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.25rem;
    }

    .usage-title {
      margin: 0 0 1rem 0;
      color: #ffffff;
      font-weight: 600;
    }

    .usage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }

    .usage-card {
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1rem;
      transition: .2s ease;
      background: rgba(255, 255, 255, 0.03);
    }

    .usage-card:hover {
      border-color: #667eea;
      box-shadow: 0 8px 25px rgba(102, 126, 234, .15);
      transform: translateY(-2px);
    }

    .usage-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: .5rem;
    }

    .usage-name {
      font-weight: 600;
      color: #ffffff;
    }

    .usage-count {
      font-weight: 700;
      color: #ffffff;
    }

    .usage-bar {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .usage-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width .4s ease;
    }

    .usage-foot {
      margin-top: .5rem;
      color: #94a3b8;
      /* Lighter */
      font-size: .9rem;
    }

    .usage-period {
      margin-top: .75rem;
      color: #94a3b8;
      /* Lighter */
      font-size: .9rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }




    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #ecf0f1;
      overflow-x: hidden;
      /* Prevent horizontal scroll on body */
      width: 100%;
      min-height: 100vh;
    }


    /* FIX: Global Input Styling for Readability in Dark Mode */
    input,
    select,
    textarea {
      background-color: rgba(0, 0, 0, 0.3) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    /* FIX: Placeholder styling for better contrast */
    ::placeholder {
      color: #94a3b8 !important;
      opacity: 1;
    }

    /* FIX: Reset margins for first children to remove gaps */
    .page-content>*:first-child {
      margin-top: 0 !important;
    }

    /* FIX: Connect negative margins to specific sections to reduce gap */
    #admin,
    #analytics,
    #integrations {
      margin-top: 0 !important;
      padding-top: 1rem !important;
    }

    #admin>*:first-child,
    #analytics>*:first-child,
    #integrations>*:first-child {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    .dashboard-container {
      display: flex;
      min-height: 100vh;
    }

    .tpl-help {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: var(--section-gap);
    }

    .tpl-help h3 {
      margin: 0 0 .75rem 0;
      font-size: 1.15rem;
      color: #ffffff;
    }

    .tpl-help .muted {
      color: #cbd5e1;
      /* Much lighter */
      font-size: .92rem;
    }

    .tpl-help .chip-grid {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin: .75rem 0 1rem 0;
    }

    .tpl-help .chip {
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
      padding: .35rem .65rem;
      font-size: .85rem;
      cursor: pointer;
      color: #e2e8f0;
    }

    .tpl-help .chip:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .tpl-help .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: .75rem;
      font-size: .9rem;
      color: #e2e8f0;
    }

    .tpl-help .row {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 1rem;
    }

    @media (max-width: 900px) {
      .tpl-help .row {
        grid-template-columns: 1fr;
      }
    }

    .tpl-help .warn {
      margin-top: .6rem;
      color: #fbbf24;
      /* Warn yellow/orange for dark mode */
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.3);
      padding: .6rem .75rem;
      border-radius: 8px;
      font-size: .9rem;
    }

    .tpl-help .ok {
      margin-top: .6rem;
      color: #065f46;
      background: #ecfdf5;
      border: 1px solid #10b98133;
      padding: .6rem .75rem;
      border-radius: 8px;
      font-size: .9rem;
    }

    .tpl-help .btn-mini {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      border: none;
      border-radius: 8px;
      padding: .5rem .7rem;
      background: #f1f5f9;
      cursor: pointer;
    }

    .tpl-help .btn-mini:hover {
      background: #e2e8f0;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #94a3b8;
      height: 100%;
      /* PŘIDÁNO PRO VYCENTROVÁNÍ: */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      padding: 2rem 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      transition: all 0.3s ease;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }

    .sidebar.collapsed {
      width: 80px;
    }

    .sidebar-header {
      padding: 0 2rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }



    .collapse-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: auto;
    }

    .collapse-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .nav-menu {
      list-style: none;
      padding: 0 1rem;
    }

    .nav-item {
      margin-bottom: 0.5rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-radius: 12px;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-link:hover,
    .nav-link.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(5px);
    }

    .nav-link.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60%;
      background: white;
      border-radius: 2px;
    }

    .nav-icon {
      font-size: 1.2rem;
      min-width: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-icon svg {
      width: 20px;
      height: 20px;
      opacity: 0.8;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    .nav-text {
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .nav-text {
      opacity: 0;
    }

    .sidebar.collapsed .logo span {
      display: none;
    }



    /* --- Oddělení bloků a hlavička seznamu šablon --- */


    .section-divider::before,
    .section-divider::after {
      content: "";
      height: 1px;
      background: #e5e7eb;
      flex: 1;
    }

    :root {
      --section-gap: 1.5rem;
    }



    /* „karta“ kolem seznamu šablon, aby byl vizuálně samostatně */
    .templates-section {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1rem 1rem 1.25rem;
      margin-top: 0;
    }

    .templates-title {
      margin: 0 0 .75rem 0;
      font-weight: 700;
      color: #ffffff;
    }

    .templates-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: .75rem;
      margin-bottom: .75rem;
    }

    .templates-header .left {
      font-weight: 700;
      color: #ffffff;
    }

    .templates-header .left .sub {
      margin-left: .6rem;
      font-weight: 500;
      color: #94a3b8;
      font-size: .95rem;
    }

    .templates-header .meta {
      color: #6b7280;
      font-size: .92rem;
    }



    .faq-generator-status {
      text-align: center;
      padding: 3rem 1.5rem;
      border: 2px dashed #e5e7eb;
      border-radius: 16px;
      background-color: #f9fafb;
      color: #4b5563;
    }

    .faq-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #d1d5db;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    .faq-status-text {
      font-weight: 500;
      font-size: 1.1rem;
    }

    .faq-status-subtext {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #6b7280;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }


    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed+.main-content {
      margin-left: 80px;
    }

    .user-info {
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 20px;
      /* Remove full width background to match preview "floating" look */
      background: transparent;
      box-shadow: none;
      border-bottom: none;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #ffffff;
    }

    /* Component Styles from Index.html Preview */
    .notification-bell {
      position: relative;
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f59e0b;
      /* Orange/Gold icon */
      cursor: pointer;
      transition: transform 0.2s;
      border: none;
    }

    .notification-bell:hover {
      transform: scale(1.05);
    }

    .notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      background: #ef4444;
      color: white;
      font-size: 0.7rem;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #232436;
      /* Match dark bg for cut-out effect */
    }

    /* Redefine user-profile to match preview pill style */
    .user-profile-pill {
      background: #393a5b;
      /* Lighter purple block */
      border-radius: 30px;
      padding: 6px 6px 6px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: default;
    }

    .user-avatar-pill {
      width: 36px;
      height: 36px;
      background: #6366f1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
    }

    .logout-btn-styled {
      background: white;
      color: #1e1e2d;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 0.2s;
    }

    .logout-btn-styled:hover {
      transform: scale(1.05);
    }

    .notifications {
      position: relative;
      background: #f1f5f9;
      border: none;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .notifications:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ef4444;
      color: white;
      font-size: 0.75rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    .content-area {
      padding: 1rem;
      min-height: 100vh;
      overflow-y: auto;
    }

    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    #er-tags .tag {
      padding: .25rem .5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.1);
      font-size: .8rem;
      color: #e2e8f0;
      /* Lighter text for tags */
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Dashboard Overview */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .stat-title {
      font-size: 0.9rem;
      color: #cbd5e1;
      /* Lighter */
      font-weight: 500;
    }

    .stat-icon {
      font-size: 1.5rem;
      padding: 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      /* Transparent bg */
      color: white;
      /* Ensure icon is visible */
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }

    .stat-change {
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-change.positive {
      color: #16a34a;
    }

    .stat-change.negative {
      color: #dc2626;
    }

    /* Emails Header */
    .emails-header {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .emails-header h3 {
      color: #ffffff;
      margin-bottom: 1rem;
    }

    /* Email List */
    .email-list {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    .email-list-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .email-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .email-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .email-item:last-child {
      border-bottom: none;
    }

    .email-item.unread .email-sender,
    .email-item.unread .email-subject {
      font-weight: 600;
      color: #ffffff;
    }

    .pagination-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
      padding: 1rem 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: transparent;
    }

    .pagination-info {
      font-size: 0.875rem;
      color: #94a3b8;
    }

    .pagination-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .pagination-button {
      min-width: 38px;
      padding: 0.4rem 0.65rem;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #f1f5f9;
      color: #1e293b;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .pagination-button:hover:not(.active):not(:disabled) {
      background: #e2e8f0;
    }

    .pagination-button.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #fff;
    }

    .pagination-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }


    .email-status {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e2e8f0;
    }

    .email-status.unread {
      background: #3b82f6;
    }

    .email-status.processed {
      background: #16a34a;
    }

    .email-status.pending {
      background: #f59e0b;
    }

    .email-content {
      flex: 1;
      min-width: 0;
    }

    .email-sender {
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.25rem;
      overflow-wrap: anywhere;
    }

    .email-subject {
      color: #cbd5e1;
      /* Lighter */
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      overflow-wrap: anywhere;
    }

    .email-preview {
      color: #94a3b8;
      /* Lighter */
      font-size: 0.8rem;
      overflow-wrap: anywhere;
    }

    .email-meta {
      text-align: right;
      font-size: 0.8rem;
      color: #94a3b8;
      /* Lighter */
    }

    .email-actions {
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .email-item:hover .email-actions {
      opacity: 1;
    }

    .action-btn {
      background: #f1f5f9;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }

    /* === PLAN – STYLING === */
    .plan-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.25rem;
      margin-top: .75rem;
    }

    .plan-card {
      position: relative;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.25rem;
      transition: all .25s ease;
      cursor: pointer;
      display: block;
    }

    .plan-card:has(.plan-input:checked) {
      outline: none;
      /* zruší původní outline */
      border-color: #667eea;
      /* jemné zvýraznění rámečku karty */
      box-shadow: 0 10px 25px rgba(102, 126, 234, .15);
    }

    .plan-card:hover {
      border-color: #667eea;
      box-shadow: 0 10px 25px rgba(102, 126, 234, .15);
      transform: translateY(-2px);
    }

    .plan-card.popular {
      border-color: #764ba2;
    }

    .plan-input {
      display: none;
    }

    .plan-inner {
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    .plan-badge {
      align-self: flex-start;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: #fff;
      font-size: .7rem;
      font-weight: 700;
      padding: .25rem .5rem;
      border-radius: 999px;
      letter-spacing: .5px;
    }

    .plan-head {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: .75rem;
    }

    .plan-name {
      font-weight: 700;
      color: #ffffff;
    }

    .plan-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: #ffffff;
    }

    .plan-price span {
      color: #64748b;
      font-weight: 600;
      font-size: .9rem;
    }

    .plan-features {
      list-style: none;
      color: #cbd5e1;
      display: flex;
      flex-direction: column;
      gap: .35rem;
      margin: .25rem 0 0 0;
      padding: 0;
      font-size: .92rem;
    }

    .plan-actions {
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: .75rem;
    }

    .action-btn:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    .action-btn.approve {
      background: #dcfce7;
      color: #16a34a;
    }

    .action-btn.reject {
      background: #fef2f2;
      color: #dc2626;
    }

    /* Forms */
    .form-section {
      background: rgba(255, 255, 255, 0.05);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
    }

    .form-section h3 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 1.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-label {
      font-weight: 500;
      color: #cbd5e1;
      font-size: 0.9rem;
    }

    .form-control {
      padding: 12px 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.3);
      color: white;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-control select {
      cursor: pointer;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #cbd5e1;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    /* Templates */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .template-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .template-card:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .template-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .template-name {
      font-weight: 600;
      color: #ffffff;
    }

    .template-actions {
      display: flex;
      gap: 0.5rem;
    }

    .template-preview {
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 1rem;
    }

    .template-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #94a3b8;
    }

    /* Analytics */
    .chart-container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #ffffff;
    }

    .chart-filters {
      display: flex;
      gap: 1rem;
    }

    .filter-btn {
      padding: 6px 16px;
      background: #f1f5f9;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }

    .filter-btn.active {
      background: #667eea;
      color: white;
    }

    .chart-placeholder {
      height: 300px;
      background: #f8fafc;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1.1rem;
    }

    /* Settings */
    .settings-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .settings-tab {
      padding: 1rem 0;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #64748b;
      transition: all 0.3s ease;
    }

    .settings-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e2e8f0;
      transition: 0.3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #667eea;
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 280px !important;
        /* Force width ignoring .collapsed */
      }

      /* Hide collapse button on mobile */
      .collapse-btn {
        display: none !important;
      }

      /* Force text visibility on mobile */
      .sidebar .nav-text {
        opacity: 1 !important;
        display: inline-block !important;
      }

      /* Hide logo text if needed or ensure it is visible */
      .sidebar .logo span {
        display: inline-block !important;
      }

      .sidebar.open {
        transform: translateX(0);
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
      }

      .main-content {
        margin-left: 0;
      }

      .user-info {
        padding: 1rem;
        justify-content: space-between;
        /* Allow button on left, user info on right */
      }

      .mobile-menu-btn {
        display: flex !important;
        /* Force show on mobile */
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
        margin-right: auto;
        /* Push to the left */
        z-index: 1001;
        /* Ensure on top */
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .template-grid {
        grid-template-columns: 1fr;
      }

      /* Ensure modal is responsive */
      .pro-modal {
        width: 95%;
        height: 90vh;
      }

      /* Adjust padding for content */
      .content-area {
        padding: 1rem 0.5rem;
      }

      .page-container {
        width: 100%;
      }

      /* FIX: Stack custom grids on mobile */
      .admin-stats,
      .chart-container .chart-wrapper,
      /* if wrapper exists */
      div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
      }

      /* FIX: Ensure charts fit screen */
      .chart-placeholder,
      canvas {
        width: 100% !important;
        max-width: 100%;
      }

      /* FIX: Table responsiveness */
      .users-section {
        overflow-x: auto;
      }

      .users-table {
        min-width: 600px;
        /* Force min width to trigger scroll */
      }

      /* FIX: Settings tabs scrolling */
      .settings-tabs {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 0.5rem;
      }

      .settings-tab {
        flex: 0 0 auto;
        /* Prevent shrinking */
      }

      /* GLOBAL MOBILE RESET */
      html,
      body {
        overflow-x: hidden !important;
        width: 100%;
      }

      .main-content {
        width: 100vw;
        max-width: 100vw;
        overflow-x: hidden;
        padding-right: 0;
      }

      /* Ensure containers don't push width */
      .page-container,
      .content-area {
        max-width: 100%;
        box-sizing: border-box;
      }

      /* Admin Specifics */
      .users-section {
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Settings Specifics */
      .settings-tabs {
        width: 100%;
        max-width: 100%;
        padding-right: 1rem;
        /* Space for scroll */
      }
    }

    /* Overlay for mobile sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      z-index: 999;
      /* Below sidebar (1000) */
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .mobile-menu-btn {
      display: none;
      /* Hidden by default */
    }

    /* Loading Animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      color: #1e293b !important;
      border-left: 4px solid #16a34a;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .toast * {
      color: #1e293b !important;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.error {
      border-left-color: #dc2626;
    }

    .toast.warning {
      border-left-color: #f59e0b;
    }

    .page-container {
      width: 100%;
      max-width: 1500px;
      /* ZDE MĚŇTE POŽADOVANOU ŠÍŘKU */
      margin: 0 auto;
      /* Toto vycentruje obsah na stránce */
    }


    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .content {
      padding: 30px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .bulk-actions {
      display: flex;
      gap: 10px;
    }

    .bulk-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .bulk-btn.enable-all {
      background: #10b981;
      color: white;
    }

    .bulk-btn.disable-all {
      background: #ef4444;
      color: white;
    }

    .bulk-btn:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }

    .email-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
    }

    .email-item {
      display: flex;
      align-items: center;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
    }

    .email-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .email-item.active {
      border-color: #10b981;
      background: linear-gradient(45deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.2);
    }

    .checkbox-wrapper {
      position: relative;
      margin-right: 15px;
    }

    .checkbox-input {
      width: 20px;
      height: 20px;
      cursor: pointer;
      opacity: 0;
      position: absolute;
    }

    .checkbox-custom {
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
    }

    .checkbox-input:checked+.checkbox-custom {
      background: #10b981;
      border-color: #10b981;
    }

    .checkbox-custom::after {
      content: '✓';
      color: white;
      font-size: 12px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .checkbox-input:checked+.checkbox-custom::after {
      opacity: 1;
    }

    .email-info {
      flex: 1;
      min-width: 0;
    }

    .email-address {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 5px;
      overflow-wrap: anywhere;
    }

    .email-provider {
      font-size: 14px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap;
    }

    .provider-icon {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }



    .modal.modal-full-width .response-section {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .modal.modal-full-width #response-editor {
      flex-grow: 1;
      /* Textové pole zabere všechno volné místo */
      height: 100%;
    }

    .gmail-icon {
      background: #ea4335;
    }

    .outlook-icon {
      background: #0078d4;
    }

    .email-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-left: 15px;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: #f3f4f6;
      color: #6b7280;
    }

    .status-badge.active {
      background: #10b981;
      color: white;
    }

    .radio-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .radio-wrapper:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .radio-wrapper.selected {
      background: transparent;
      /* odstraní šedý obdélník uvnitř */
      border: none;
    }

    .radio-input {
      width: 16px;
      height: 16px;
      opacity: 0;
      position: absolute;
      cursor: pointer;
    }

    .radio-custom {
      width: 16px;
      height: 16px;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
    }

    .radio-input:checked+.radio-custom {
      border-color: #667eea;
      background: #667eea;
    }

    .radio-custom::after {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: white;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .radio-input:checked+.radio-custom::after {
      opacity: 1;
    }

    .radio-label {
      font-size: 12px;
      font-weight: 500;
      color: #6b7280;
      user-select: none;
    }

    .disconnect-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      background: #ef4444;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      margin-left: 8px;
      opacity: 0.7;
    }

    .disconnect-btn:hover {
      opacity: 1;
      background: #dc2626;
      transform: scale(1.1);
    }

    .disconnect-icon {
      font-size: 16px;
      font-weight: bold;
      line-height: 1;
    }

    .add-account {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #94a3b8;
      margin-top: 15px;
    }

    .add-account:hover {
      border-color: #667eea;
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }


    /* === MODÁLNÍ OKNO === */
    /* Overlay - překryv celé obrazovky */
    #modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      display: none;
      /* Skryté ve výchozím stavu */
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Kontejner modálního okna */
    #modal-content {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 480px;
      transform: scale(0.9);
      animation: modalAppear 0.3s ease forwards;
    }

    @keyframes modalAppear {
      to {
        transform: scale(1);
      }
    }

    /* Add class .modal style for consistency with #modal-content */
    .modal {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      width: 90%;
      max-width: 480px;
      margin: auto;
      transform: scale(0.9);
      animation: modalAppear 0.3s ease forwards;
    }

    /* Hlavička modálního okna */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-title {
      font-size: 1.4em;
      font-weight: 600;
      color: #ffffff;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #94a3b8;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      color: #ffffff;
      transform: rotate(90deg);
    }

    /* Tělo modálního okna */
    .modal-body {
      padding: 24px;
    }

    .provider-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .provider-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #ffffff;
    }

    .provider-btn:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .provider-icon {
      width: 24px;
      height: 24px;
    }


    /* Styly pro nový header s filtry */
    .emails-header {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      background: rgba(0, 0, 0, 0.3);
      color: #ffffff;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .search-box {
      flex: 1;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 45px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: white;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      font-size: 1.1rem;
    }

    /* Hint pro význam proměnných */
    .tpl-var-hint {
      display: none;
      margin-top: .5rem;
      font-size: .9rem;
      color: #334155;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      padding: .5rem .75rem;
      border-radius: 10px;
    }

    .tpl-var-hint strong {
      color: #1f2937;
    }

    /* schovej text „Vaše šablony“ v headeru karty */
    .templates-header .left {
      display: none;
    }

    /* ať zůstane jen pravá část s počtem */
    .templates-header {
      justify-content: flex-end;
    }



    /* Styly pro Admin Dashboard */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .admin-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .stat-title {
      font-size: 0.9rem;
      color: #94a3b8;
      font-weight: 500;
    }

    .stat-icon {
      font-size: 1.5rem;
      padding: 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #ffffff;
    }

    .users-section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    .section-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #ffffff;
    }

    .search-filters {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box {
      position: relative;
    }

    .search-input {
      padding: 8px 12px 8px 35px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      width: 250px;
      background: rgba(0, 0, 0, 0.3);
      color: #ffffff;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      background: rgba(0, 0, 0, 0.3);
      color: #ffffff;
      cursor: pointer;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
    }

    .users-table th,
    .users-table td {
      padding: 1rem 1.5rem;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #cbd5e1;
    }

    .users-table th {
      background: rgba(255, 255, 255, 0.05);
      font-weight: 600;
      color: #e2e8f0;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .users-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .activity-action {
      font-weight: 600;
      color: #ffffff;
    }

    .activity-detail {
      margin-top: 0.25rem;
      color: #94a3b8;
      font-size: 0.85rem;
      white-space: pre-line;
    }

    .user-info-cell {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-avatar-small {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .user-details {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 600;
      color: #ffffff;
    }

    .user-email {
      font-size: 0.875rem;
      color: #94a3b8;
    }

    .role-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }

    .role-admin {
      background: rgba(254, 243, 199, 0.1);
      color: #fcd34d;
      border: 1px solid rgba(252, 211, 77, 0.3);
    }

    .role-user {
      background: rgba(219, 234, 254, 0.1);
      color: #93c5fd;
      border: 1px solid rgba(147, 197, 253, 0.3);
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    /* Header BG Animation */
    .header-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      opacity: 0.4;
      background-image:
        linear-gradient(rgba(102, 126, 234, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(102, 126, 234, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: gridMove 20s linear infinite;
      pointer-events: none;
    }

    @keyframes gridMove {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(50px);
      }
    }

    /* === PRO MODAL REDESIGN (Dark Theme - Refined) === */
    .pro-modal {
      background: #0f172a;
      /* Solid dark color to prevent transparency issues */
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
      width: 90%;
      max-width: 1100px;
      margin: auto;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 85vh;
      /* Fixed height for consistency */
      overflow: hidden;
      animation: modalAppear 0.3s ease forwards;
    }

    .pro-modal__header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 23, 42, 0.95);
      flex-shrink: 0;
    }

    .pro-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    .pro-modal__id {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .pro-modal__body {
      padding: 0;
      display: flex;
      flex-direction: column;
      flex: 1;
      /* Take remaining height */
      overflow-y: auto;
      background: #0f172a;
    }

    /* Hide sidebar as requested */
    .pro-sidebar {
      display: none !important;
    }

    /* Hide top buttons as requested */
    .pro-actions #ed-copy,
    .pro-actions #ed-reply-open {
      display: none !important;
    }

    .pro-content {
      width: 100%;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      height: 100%;
    }

    .pro-headings .pro-title {
      color: white;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .pro-headings .pro-subtitle {
      color: #94a3b8;
      font-size: 0.95rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .pro-dot {
      color: rgba(255, 255, 255, 0.2);
    }

    .pro-body-card {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 0;
      /* Remove padding from container to let header span full width if needed, or manage internally */
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .pro-body-card--email {
      flex: 1;
      /* Expand to fill space */
      min-height: 300px;
    }

    .pro-body-card__title {
      background: rgba(255, 255, 255, 0.03);
      padding: 1rem 1.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .pro-body-card__content {
      padding: 1.75rem;
      color: #e2e8f0;
      line-height: 1.8;
      font-size: 1.05rem;
    }

    /* AI Inline Card - Quick Reply Design Fix */
    .ai-inline-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(102, 126, 234, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .ai-inline-card .pro-body-card__title {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.1), transparent);
      color: #a5b4fc;
      border-bottom: 1px solid rgba(102, 126, 234, 0.15);
    }

    .ai-inline-card .pro-body-card__content {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      /* Adjusted ratio */
      gap: 2rem;
      padding: 1.5rem 1.75rem;
    }

    @media (max-width: 768px) {
      .ai-inline-card .pro-body-card__content {
        grid-template-columns: 1fr;
      }
    }

    .ai-inline-main {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .ai-inline-lead {
      font-size: 0.9rem;
      color: #cbd5e1;
      margin: 0;
    }

    .ai-inline-side {
      background: rgba(30, 41, 59, 0.4);
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .ai-inline-hint-title {
      color: #fff;
      font-weight: 600;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 0.5rem;
    }

    .ai-inline-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .ai-inline-list li {
      position: relative;
      padding-left: 1.5rem;
      font-size: 0.85rem;
      color: #94a3b8;
      line-height: 1.4;
    }

    .ai-inline-list li::before {
      content: "✨";
      font-size: 0.8rem;
      position: absolute;
      left: 0;
      top: 2px;
    }

    .ai-inline-input {
      background: rgba(15, 23, 42, 0.8);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 1rem;
      min-height: 120px;
      font-size: 0.95rem;
      resize: none;
      transition: all 0.2s;
      width: 100%;
    }

    .ai-inline-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      outline: none;
      background: rgba(15, 23, 42, 1);
    }

    .ai-inline-input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .ai-inline-button {
      width: 100%;
      justify-content: center;
      padding: 0.9rem;
      font-weight: 600;
      margin-top: auto;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      border: none;
      color: white;
    }

    .ai-inline-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .ai-inline-note {
      font-size: 0.75rem;
      color: #64748b;
      text-align: center;
      margin: 0.5rem 0 0 0;
    }

    .pro-modal__footer {
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      background: rgba(15, 23, 42, 0.95);
      flex-shrink: 0;
    }

    .pro-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      padding: 0.5rem;
      transition: color 0.2s;
      font-size: 1.5rem;
      line-height: 1;
    }

    .pro-close:hover {
      color: white;
    }

    /* === AI COMPOSER DARK THEME === */
    .ai-composer-panel {
      background: #0f172a !important;
      /* Extremely darker blue/slate */
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      color: white;
    }

    .ai-composer-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
      background: rgba(15, 23, 42, 0.95);
    }

    .ai-composer-title {
      color: white !important;
    }

    .ai-composer-context {
      color: #94a3b8 !important;
    }

    .ai-composer-close {
      color: #94a3b8 !important;
    }

    .ai-composer-close:hover {
      color: white !important;
      background: rgba(255, 255, 255, 0.1) !important;
    }

    .ai-composer-body {
      background: #0f172a !important;
    }

    .ai-composer-select,
    .ai-composer-field textarea,
    .ai-composer-result textarea {
      background: rgba(30, 41, 59, 0.6) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      color: white !important;
      border-radius: 10px;
    }

    .ai-composer-select:focus,
    .ai-composer-field textarea:focus {
      border-color: #667eea !important;
      outline: none;
      background: rgba(30, 41, 59, 1) !important;
    }

    .ai-composer-note {
      color: #64748b !important;
    }

    .ai-composer-footer {
      border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
      background: rgba(0, 0, 0, 0.2) !important;
    }

    .ai-composer-tag {
      background: #667eea !important;
      color: white !important;
    }
  </style>
</head>

<body>
  <div class="header-bg"></div>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div
            style="background: rgba(255, 255, 255, 0.95); padding: 8px; border-radius: 50px; display: flex; align-items: center; justify-content: center; width: 90px; height: 90px; box-shadow: 0 0 20px rgba(255,255,255,0.4);">
            <img src="logo-Agent.png" alt="Logo" style="width: 100%; height: auto;">
          </div>
        </div>
        <button class="collapse-btn" id="collapseBtn">
          <span>←</span>
        </button>
      </div>

      <nav>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="#" class="nav-link active" data-page="dashboard">
              <span class="nav-icon">
                <svg viewBox="0 0 24 24">
                  <rect x="3" y="3" width="7" height="7"></rect>
                  <rect x="14" y="3" width="7" height="7"></rect>
                  <rect x="14" y="14" width="7" height="7"></rect>
                  <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
              </span>
              <span class="nav-text">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-page="emails">
              <span class="nav-icon">
                <svg viewBox="0 0 24 24">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
              </span>
              <span class="nav-text">Emaily</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-page="templates">
              <span class="nav-icon">
                <svg viewBox="0 0 24 24">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </span>
              <span class="nav-text">Šablony</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-page="settings">
              <span class="nav-icon">
                <svg viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="3"></circle>
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                  </path>
                </svg>
              </span>
              <span class="nav-text">Nastavení</span>
            </a>
          </li>
          <li class="nav-item" id="admin-menu-item" style="display: none;">
            <a href="#" class="nav-link" data-page="admin">
              <span class="nav-icon">
                <svg viewBox="0 0 24 24">
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                  </polygon>
                </svg>
              </span>
              <span class="nav-text">Admin</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-page="analytics">
              <span class="nav-icon">
                <svg viewBox="0 0 24 24">
                  <line x1="18" y1="20" x2="18" y2="10"></line>
                  <line x1="12" y1="20" x2="12" y2="4"></line>
                  <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
              </span>
              <span class="nav-text">Analytika</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" data-page="integrations">
              <span class="nav-icon">
                <svg viewBox="0 0 24 24">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
              </span>
              <span class="nav-text">Integrace</span>
            </a>
          </li>

        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <!-- Top Bar -->
      <!-- Top Bar -->
      <div class="user-info">
        <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Menu">☰</button>

        <button class="notification-bell">
          <svg viewBox="0 0 24 24" fill="currentColor" stroke="none" style="width:20px;height:20px;">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <div class="notification-badge">3</div>
        </button>

        <div class="user-profile-pill">
          <span id="user-name-display">Načítám...</span>
          <div class="user-avatar-pill" id="user-avatar-display"></div>
        </div>

        <button id="logout-button" class="logout-btn-styled">Odhlásit se</button>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Dashboard Page -->
        <div class="page-content active" id="dashboard">
          <div class="page-container">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-header">
                  <span class="stat-title">Zpracované emaily</span>
                  <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                      stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                      <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                  </span>
                </div>
                <div class="stat-value" id="stat-processed">...</div>
                <div class="stat-change positive">
                  <span>↗</span>
                  <span>+15% tento týden</span>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-header">
                  <span class="stat-title">Ušetřený čas</span>
                  <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                      stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                  </span>
                </div>
                <div class="stat-value" id="stat-saved-time">...</div>
                <div class="stat-change positive">
                  <span>↗</span>
                  <span>+8% tento měsíc</span>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-header">
                  <span class="stat-title">Úspěšnost AI</span>
                  <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                      stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="10"></circle>
                      <circle cx="12" cy="12" r="6"></circle>
                      <circle cx="12" cy="12" r="2"></circle>
                    </svg>
                  </span>
                </div>
                <div class="stat-value" id="stat-ai-success">...</div>
                <div class="stat-change positive">
                  <span>↗</span>
                  <span>+2.1% dnes</span>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-header">
                  <span class="stat-title">Aktivní šablony</span>
                  <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                      stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                      <polyline points="14 2 14 8 20 8"></polyline>
                      <line x1="16" y1="13" x2="8" y2="13"></line>
                      <line x1="16" y1="17" x2="8" y2="17"></line>
                      <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                  </span>
                </div>
                <div class="stat-value" id="stat-active-templates">...</div>
                <div class="stat-change">
                  <span>→</span>
                  <span>Beze změny</span>
                </div>
              </div>
            </div>
          </div>

          <div class="email-list" id="dashboard-recent-emails">
            <div class="email-list-header">
              <h3>Poslední emaily</h3>
            </div>
            <div style="padding:1rem; text-align:center; color:#94a3b8;">Načítám...</div>
          </div>
        </div>

        <!-- Emails Page -->



        <div class="page-content" id="emails">
          <div class="emails-header"
            style="background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; border-radius: 16px !important; color: white !important;">
            <h3>Správa emailů</h3>
            <br>
            <div class="search-container">
              <div class="search-box">
                <span class="search-icon">🔍</span>
                <input type="search" class="form-control" placeholder="Vyhledat emaily " id="search-bar">
              </div>
            </div>
            <div class="filter-row">
              <select class="form-control" id="status-filter">
                <option value="all">📥 Doručená pošta</option>
                <option value="unread">📧 Nepřečtené</option>
                <option value="approval">⏳ Čekající</option>
              </select>
              <select class="form-control" id="period-filter">
                <option value="all">Všechna období</option>
                <option value="today">📅 Dnes</option>
                <option value="week">📅 Tento týden</option>
                <option value="month">📅 Tento měsíc</option>
              </select>
            </div>
          </div>

          <div class="email-list">
            <div class="email-list-header">
              <h3 id="email-count-header">Všechny emaily</h3>
            </div>
            <div id="email-list-container">
              <div style="padding: 2rem; text-align: center; color: #94a3b8;">
                📧 Načítám emaily...
              </div>
            </div>
            <div id="email-pagination" class="pagination-container" style="display:none;"></div>
          </div>
        </div>

        <!-- Template Picker Modal -->
        <div class="modal-overlay" id="templatePicker">
          <div class="modal">
            <div class="modal-header">
              <h2 class="modal-title">📚 Vyberte šablonu</h2>
              <button class="modal-close" id="closeTemplatePicker">&times;</button>
            </div>

            <div class="modal-body">
              <div class="form-grid" style="margin-bottom:1rem;">
                <div class="form-group">
                  <label class="form-label">Hledat</label>
                  <input id="tplSearch" class="form-control" placeholder="Název nebo text šablony...">
                </div>
                <div class="form-group">
                  <label class="form-label">Kategorie</label>
                  <select id="tplCategory" class="form-control">
                    <option>Vše</option>
                    <option>Obecné</option>
                    <option>Obchodní</option>
                    <option>Podpora</option>
                    <option>Schůzky</option>
                  </select>
                </div>
              </div>

              <div id="tplPickerList" class="template-grid">
                <!-- sem se renderují šablony (refreshPickerList) -->
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn btn-secondary" id="cancelTplPicker">Zavřít</button>
            </div>
          </div>
        </div>

        <!-- AI Composer Panel -->
        <div class="ai-composer-overlay" id="aiComposer">
          <div class="ai-composer-panel" role="dialog" aria-modal="true" aria-labelledby="aiComposerTitle">
            <div class="ai-composer-header">
              <div>
                <div class="ai-composer-title" id="aiComposerTitle"><span>✨</span>AI odpověď</div>
                <div class="ai-composer-context" id="aiComposerContext">Vyberte e-mail, ke kterému chcete připravit
                  odpověď.</div>
              </div>
              <button class="ai-composer-close" id="aiComposerClose" type="button" aria-label="Zavřít">×</button>
            </div>
            <div class="ai-composer-body">
              <div class="ai-composer-field">
                <label for="aiComposerEmailSelect">Pracovní e-mail</label>
                <select id="aiComposerEmailSelect" class="ai-composer-select">
                  <option value="">Vyberte e-mail ze seznamu…</option>
                </select>
                <div class="ai-composer-profile" id="aiComposerProfile">Styl profilu se načítá…</div>
              </div>
              <div class="ai-composer-field">
                <label for="aiComposerInstructions">Vložte svůj návrh odpovědi ke stylistické úpravě</label>
                <textarea id="aiComposerInstructions"
                  placeholder="Napište nebo vložte svůj text odpovědi. AI ho jen uhladí a nic nového nepřidá…"></textarea>
              </div>
              <div class="ai-composer-note">
                Tón, délka i podpis se automaticky přebírají z nastavení připojeného e-mailového účtu.
              </div>
              <div class="ai-composer-status" id="aiComposerStatus"></div>
              <div class="ai-composer-loader" id="aiComposerLoader" style="display:none;"></div>
              <div class="ai-composer-result" id="aiComposerResultWrap">
                <div class="ai-composer-tag">Návrh odpovědi</div>
                <textarea id="aiComposerResult" readonly></textarea>
                <div class="ai-composer-result-actions">
                  <button class="btn btn-primary" id="aiComposerSend" type="button">📤 Odeslat</button>
                </div </div>
              </div>
              <div class="ai-composer-footer">
                <div class="ai-composer-status" id="aiComposerFooterStatus"></div>
                <div style="display:flex; gap:.75rem; flex-wrap:wrap; justify-content:flex-end;">
                  <button class="btn btn-secondary" id="aiComposerCancel" type="button">Zavřít</button>
                  <button class="btn btn-primary" id="aiComposerGenerate" type="button">✨ Upravit odpověď</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Email Detail Modal -->
          <div class="modal-overlay" id="emailDetailModal">
            <div class="modal pro-modal">
              <!-- Header -->
              <div class="pro-modal__header">
                <div class="pro-modal__id">
                  <div class="pro-avatar" id="ed-avatar" aria-hidden="true">✉️</div>
                  <div class="pro-headings">
                    <div class="pro-title" id="ed-subject">Bez předmětu</div>
                    <div class="pro-subtitle">
                      <span id="ed-from">—</span>
                      <span class="pro-dot">•</span>
                      <span id="ed-date">—</span>
                    </div>
                  </div>
                </div>
                <div class="pro-actions">
                  <button class="btn btn-secondary pro-chip" id="ed-copy">
                    <span>Copy</span>
                  </button>
                  <button class="btn btn-primary" id="ed-reply-open">Odpovědět</button>
                  <button class="pro-close" id="closeEmailDetail" aria-label="Zavřít">✕</button>
                </div>
              </div>




              <!-- Body -->
              <div class="pro-modal__body">
                <!-- Sidebar Removed as requested -->

                <div class="pro-content">
                  <div class="pro-body-card pro-body-card--email">
                    <div class="pro-body-card__title">
                      <span>📄</span> Obsah zprávy
                    </div>
                    <div class="pro-body-card__content" id="ed-body">Načítám…</div>
                  </div>

                  <div class="pro-body-card pro-body-card--ai" id="ed-ai-card" style="display: none;">
                    <div class="pro-body-card__title">
                      <span>🤖</span> Návrh odpovědi (AI)
                    </div>
                    <div class="pro-body-card__content">
                      <div
                        style="color:#e2e8f0; margin-bottom:12px; line-height:1.6; background:rgba(0,0,0,0.2); padding:1rem; border-radius:8px;">
                        <div><strong>Shrnutí:</strong> <span id="ed-ai-summary">—</span></div>
                        <div><strong>Sentiment:</strong> <span id="ed-ai-sentiment">—</span></div>
                      </div>
                      <div id="ed-ai-reply" style="white-space: pre-wrap; line-height:1.55; color:#f1f5f9;"></div>
                    </div>
                  </div>

                  <!-- Quick AI Reply Removed as requested -->
                </div>
              </div>



              <!-- Footer -->
              <div class="pro-modal__footer">
                <button class="btn btn-secondary" id="closeEmailDetailBottom">Zavřít</button>
                <button class="btn btn-primary" id="ed-reply-bottom">Odpovědět</button>
              </div>
            </div>
          </div>




        </div>

        <!-- Templates Page -->
        <div class="page-content" id="templates">
          <div class="form-section">
            <h3>Vytvořit novou šablonu</h3>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Název šablony</label>
                <input type="text" id="tpl-name" class="form-control" placeholder="např. Odpověď na dotaz">
              </div>
              <div class="form-group">
                <label class="form-label">Kategorie</label>
                <select id="tpl-category" class="form-control">
                  <option>Obecné</option>
                  <option>Obchodní</option>
                  <option>Podpora</option>
                  <option>Schůzky</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Obsah šablony</label>
              <textarea id="tpl-content" class="form-control" placeholder="Text šablony…"></textarea>
            </div>
            <button id="tpl-save-btn" class="btn btn-primary"><span>💾</span> Uložit šablonu</button>
          </div>


          <div class="tpl-help" id="tpl-help">
            <h3>🧩 Nápověda k šablonám</h3>
            <div class="muted">
              Do textu vkládej proměnné ve tvaru <code>{{nazev}}</code>. Při vložení do emailu se pokusíme chybějící
              údaje doplnit z analyzovaného emailu.
            </div>

            <div class="row" style="margin-top:.75rem;">
              <div>
                <div class="muted">Dostupné proměnné (kliknutím vložíš na kurzor do pole „Obsah šablony“):</div>
                <div class="chip-grid" id="tpl-chip-grid"></div>

                <div class="muted" style="margin-top:.75rem;">AI slot (generativní úsek v hranatých závorkách):</div>
                <div class="code">[[AI: Napiš stručný odstavec shrnující důvod reklamace a další postup.]]</div>
                <div style="margin-top:.5rem;">
                  <button class="btn-mini" id="btn-insert-ai">➕ Vložit AI slot</button>
                  <button class="btn-mini" id="btn-insert-example">📋 Vložit ukázkovou šablonu</button>
                </div>
              </div>

              <div>
                <div class="muted">Kontrola šablony</div>
                <div id="tpl-validator" class="ok">Žádné neznámé proměnné.</div>
                <div class="muted" style="margin-top:.75rem;">
                  Tipy:
                  <ul style="margin:.35rem 0 0 1rem;">
                    <li>Použij <b>{{recipientName}}</b> pro zdvořilé oslovení („paní Nováková“ / „pane Dvořáku“).</li>
                    <li>Neznámé hodnoty necháváme prázdné; můžeš je dopsat ručně.</li>
                    <li>AI sloty piš česky a konkrétně, bez „vyplň si sám“ instrukcí.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>



          <div class="templates-section">
            <h3 class="templates-title">📁 Vaše šablony</h3>
            <div class="template-grid" id="tpl-list"></div>
          </div>



        </div>

        <!-- Settings Page -->

        <div class="page-content" id="settings">
          <div class="settings-tabs">
            <div class="settings-tab active" data-tab="ai">AI Nastavení</div>
            <div class="settings-tab" data-tab="email">Email účty</div>
            <div class="settings-tab" data-tab="plan">Plán</div>
            <div class="settings-tab" data-tab="notifications">Notifikace</div>
            <div class="settings-tab" data-tab="security">Zabezpečení</div>
            <div class="settings-tab" data-tab="faq">FAQ</div>
          </div>

          <div class="settings-content" id="ai-settings">
            <form id="settings-form">
              <div class="form-section">
                <h3>Styl odpovědí</h3>

                <div class="form-group" style="display:flex;gap:.75rem;align-items:center;">
                  <span id="learn-style-status" class="muted" style="color:#64748b;"></span>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Tón komunikace</label>
                    <select class="form-control" id="tone-select">
                      <option>Formální</option>
                      <option>Neformální</option>
                      <option>Přátelský</option>
                      <option>Profesionální</option>
                      <option>Stručný</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Délka odpovědí</label>
                    <select class="form-control" id="length-select">
                      <option>Krátká (1-2 věty)</option>
                      <option>Střední (1 odstavec)</option>
                      <option>Dlouhá (více odstavců)</option>
                      <option>Adaptivní</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Osobní podpis</label>
                  <textarea class="form-control" id="signature-textarea"
                    placeholder="S pozdravem,&#10;Jan Novák..."></textarea>
                </div>
              </div>

              <div class="form-section">
                <h3>Automatizace</h3>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>Automatické odpovědi</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Povolí AI automaticky odpovídat na rutinní emaily
                    </div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="auto-reply-switch" checked>
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>Schvalování důležitých emailů</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Vyžaduje vaše schválení pro důležité zprávy</div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="approval-switch" checked>
                    <span class="slider"></span>
                  </label>
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>Spam filtr</strong>
                    <div style="color: #64748b; font-size: 0.9rem;">Automaticky filtruje nevyžádané zprávy</div>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="spam-filter-switch" checked>
                    <span class="slider"></span>
                  </label>
                </div>
              </div>

              <button type="submit" class="btn btn-primary">
                <span>💾</span>
                Uložit nastavení
              </button>
            </form>





          </div>

          <!-- Email Accounts Tab -->
          <div class="settings-content" id="email-settings" style="display: none;">
            <div class="container"
              style="max-width: 100%; box-shadow: none; border-radius: 0; background: transparent;">
              <div class="header"
                style="padding: 20px; text-align: left; background: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: white;">

              </div>
              <div class="content" style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 16px;">
                <div class="section-title" style="color: white;">
                  <span>Připojené účty</span>
                  <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="font-size: 14px; color: #a5b4fc; font-weight: 500;">
                      📝 Nastavuji: <span id="currentConfigEmail"></span>
                    </div>
                    <div class="bulk-actions">
                      <button class="bulk-btn enable-all" onclick="enableAllAccounts()"
                        style="background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3);">Aktivovat
                        vše</button>
                      <button class="bulk-btn disable-all" onclick="disableAllAccounts()"
                        style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);">Deaktivovat
                        vše</button>
                    </div>
                  </div>
                </div>
                <div class="email-list">
                </div>
                <div class="add-account" onclick="addAccount()">
                  <span>+ Přidat další emailový účet</span>
                </div>


              </div>
            </div>
          </div>

          <!-- === PLAN SETTINGS === -->
          <div class="settings-content" id="plan-settings" style="display: none;">
            <div class="form-section">
              <h3>Vyberte tarif</h3>

              <div class="plan-grid">
                <!-- Starter -->
                <label class="plan-card">
                  <input type="radio" name="plan" value="Starter" class="plan-input">
                  <div class="plan-inner">
                    <div class="plan-head">
                      <div class="plan-name">Starter</div>
                      <div class="plan-price">Zdarma</div>
                    </div>
                    <ul class="plan-features">
                      <li>✓ Až 50 emailů měsíčně</li>
                      <li>✓ 1 emailový účet</li>
                      <li>✓ Základní šablony</li>
                      <li>✓ Email podpora</li>
                    </ul>
                  </div>
                </label>

                <!-- Professional -->
                <label class="plan-card popular">
                  <input type="radio" name="plan" value="Professional" class="plan-input">
                  <div class="plan-inner">
                    <div class="plan-badge">NEJPOPULÁRNĚJŠÍ</div>
                    <div class="plan-head">
                      <div class="plan-name">Professional</div>
                      <div class="plan-price">490 Kč <span>/ měsíc</span></div>
                    </div>
                    <ul class="plan-features">
                      <li>✓ Neomezené emaily</li>
                      <li>✓ 5 emailových účtů</li>
                      <li>✓ Vlastní šablony</li>
                      <li>✓ Kalendářová integrace</li>
                      <li>✓ Pokročilé analytics</li>
                      <li>✓ Priority podpora</li>
                    </ul>
                  </div>
                </label>

                <!-- Enterprise -->
                <label class="plan-card">
                  <input type="radio" name="plan" value="Enterprise" class="plan-input">
                  <div class="plan-inner">
                    <div class="plan-head">
                      <div class="plan-name">Enterprise</div>
                      <div class="plan-price">1 490 Kč <span>/ měsíc</span></div>
                    </div>
                    <ul class="plan-features">
                      <li>✓ Neomezené emaily</li>
                      <li>✓ Neomezené účty</li>
                      <li>✓ Team management</li>
                      <li>✓ API přístup</li>
                      <li>✓ White-label řešení</li>
                      <li>✓ Dedikovaná podpora</li>
                      <li>✓ SLA garance</li>
                    </ul>
                  </div>
                </label>
              </div>

              <div class="plan-actions">
                <button id="save-plan-btn" class="btn btn-primary">💾 Uložit plán</button>
                <span id="current-plan-badge" class="status-badge" style="margin-left:10px;">Aktuální: —</span>
              </div>
            </div>
            <div class="usage-panel" id="usage-panel" style="display:none;">
              <h4 class="usage-title">Využití tohoto měsíce</h4>

              <div class="usage-grid">
                <!-- AI akce -->
                <div class="usage-card">
                  <div class="usage-head">
                    <div class="usage-name">AI akce</div>
                    <div class="usage-count"><span id="ai-used">0</span>/<span id="ai-limit">0</span></div>
                  </div>
                  <div class="usage-bar">
                    <div class="usage-bar-fill" id="ai-bar" style="width:0%"></div>
                  </div>
                  <div class="usage-foot"><span id="ai-left">0</span> zbývá</div>
                </div>

                <!-- Připojené účty -->
                <div class="usage-card">
                  <div class="usage-head">
                    <div class="usage-name">Připojené účty</div>
                    <div class="usage-count"><span id="acc-count">0</span>/<span id="acc-limit">0</span></div>
                  </div>
                  <div class="usage-bar">
                    <div class="usage-bar-fill" id="acc-bar" style="width:0%"></div>
                  </div>
                  <div class="usage-foot">Limit pro aktuální tarif</div>
                </div>
              </div>

              <div class="usage-period" id="usage-period"></div>
            </div>
          </div>








          <!-- Notifications Tab -->
          <div class="settings-content" id="notifications-settings" style="display: none;">
            <div class="form-section">
              <h3>Notifikace</h3>
              <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>Email notifikace</strong>
                  <div style="color: #64748b; font-size: 0.9rem;">Dostávat upozornění na email</div>
                </div>
                <label class="switch">
                  <input type="checkbox" checked>
                  <span class="slider"></span>
                </label>
              </div>
              <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>Push notifikace</strong>
                  <div style="color: #64748b; font-size: 0.9rem;">Zobrazovat notifikace v prohlížeči</div>
                </div>
                <label class="switch">
                  <input type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- Security Tab -->
          <div class="settings-content" id="security-settings" style="display: none;">
            <div class="form-section">
              <h3>Zabezpečení</h3>
              <div class="form-group">
                <label class="form-label">Změna hesla</label>
                <input type="password" id="cur-pass" class="form-control" placeholder="Současné heslo">
              </div>
              <div class="form-group">
                <input type="password" id="new-pass" class="form-control" placeholder="Nové heslo">
              </div>
              <div class="form-group">
                <input type="password" id="new-pass2" class="form-control" placeholder="Potvrzení nového hesla">
              </div>
              <button class="btn btn-primary" id="btn-change-pass">Změnit heslo</button>
            </div>

            <div class="form-section">
              <h3>Dvoufaktorové ověření</h3>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>2FA</strong>
                  <div style="color: #64748b; font-size: 0.9rem;">Zvýšte zabezpečení svého účtu</div>
                </div>
                <button class="btn btn-primary">Povolit 2FA</button>
              </div>
            </div>
          </div>

          <!-- FAQ Tab -->
          <div class="settings-content" id="faq-settings" style="display:none;">
            <div class="form-section">
              <h3>FAQ pro účet</h3>

              <div class="form-group">
                <label class="form-label">Aktivní účet</label>
                <!-- ukáže aktuální primaryEmail jen pro informaci -->
                <div id="faq-current-account" class="muted"
                  style="padding:.35rem .5rem;background:rgba(255, 255, 255, 0.1);border-radius:.5rem; color: #e2e8f0;">
                </div>
              </div>

              <div class="form-group" style="display:flex; gap:.5rem; flex-wrap:wrap;">
                <button id="faq-add-btn" class="btn btn-primary"><span>➕</span> Přidat FAQ položku</button>
                <button id="faq-save-all-btn" class="btn"><span>💾</span> Uložit změny</button>
              </div>

              <div id="faq-list" style="display:grid; gap:.5rem;">
                <!-- dynamicky se sem vykreslí jednotlivé položky FAQ -->
              </div>

              <div class="muted" style="margin-top:.75rem;">
                Tip: FAQ se ukládá **per účet**. Přepni primární účet vpravo nahoře (pokud to u tebe máš), nebo dle
                toho, jak dnes vybíráš aktivní schránku.
              </div>
            </div>
          </div>


        </div>

      </div>












      <!-- Analytics Page -->
      <div class="page-content" id="analytics" style="margin-top: 0 !important; padding-top: 0 !important;">
        <div
          style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; margin-top: 0 !important;">
          <div class="chart-container">
            <div class="chart-header">
              <h3 class="chart-title">Průměrná doba odpovědi</h3>
            </div>
            <div class="chart-placeholder">
              <canvas id="responseTimeChart" style="height:300px"></canvas>
            </div>
          </div>

          <div class="chart-container">
            <div class="chart-header">
              <h3 class="chart-title">Kvalita odpovědí AI</h3>
            </div>
            <div class="chart-placeholder">
              <canvas id="aiQualityChart" style="height:300px"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Nejčastěji používané šablony</h3>
            <div class="chart-filters">
              <button class="filter-btn active" data-days="7">7 dní</button>
              <button class="filter-btn" data-days="30">30 dní</button>
              <button class="filter-btn" data-days="90">3 měsíce</button>
            </div>
          </div>
          <div class="chart-placeholder">
            <canvas id="templateUsageChart" style="height:300px"></canvas>
          </div>
        </div>
      </div>

      <!-- Integrations Page -->
      <div class="page-content" id="integrations" style="margin-top: 0 !important; padding-top: 0 !important;">
        <div class="form-section" style="margin-top: 0 !important;">
          <h3>Dostupné integrace</h3>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div
              style="border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
              <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <span style="font-size: 2rem;">📅</span>
                <div>
                  <h4 style="margin: 0; color: #ffffff;">Google Calendar</h4>
                  <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">Automatické plánování schůzek</p>
                </div>
              </div>
              <button class="btn btn-primary" style="width: 100%;">Připojit</button>
            </div>

            <div
              style="border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
              <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <span style="font-size: 2rem;">💼</span>
                <div>
                  <h4 style="margin: 0; color: #ffffff;">Slack</h4>
                  <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">Notifikace o důležitých emailech</p>
                </div>
              </div>
              <button class="btn btn-secondary" style="width: 100%;">Připravuje se</button>
            </div>

            <div
              style="border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.05); border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease;">
              <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <span style="font-size: 2rem;">📊</span>
                <div>
                  <h4 style="margin: 0; color: #ffffff;">CRM systémy</h4>
                  <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">Synchronizace s vaším CRM</p>
                </div>
              </div>
              <button class="btn btn-secondary" style="width: 100%;">Připravuje se</button>
            </div>
          </div>
        </div>

      </div>
      <!-- Admin Page -->
      <div class="page-content" id="admin" style="margin-top: 0 !important; padding-top: 0 !important;">
        <div class="admin-stats" style="margin-top: 0 !important;">
          <div class="stat-card">
            <div class="stat-header"><span class="stat-title">Celkem uživatelů</span>
              <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </span>
            </div>
            <div class="stat-value" id="admin-total-users">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-header"><span class="stat-title">Platící zákazníci</span>
              <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                  </polygon>
                </svg>
              </span>
            </div>
            <div class="stat-value" id="admin-paying-users">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-header"><span class="stat-title">Připojené emaily</span>
              <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
              </span>
            </div>
            <div class="stat-value" id="admin-connected-emails">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-header"><span class="stat-title">AI akce dnes</span>
              <span class="stat-icon" style="display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
              </span>
            </div>
            <div class="stat-value" id="admin-ai-today">-</div>
          </div>
        </div>
        <div class="users-section">
          <div class="section-header">
            <h2 class="section-title">Správa uživatelů</h2>
            <div class="search-filters">
              <div class="search-box"><span class="search-icon">🔍</span><input type="search" class="search-input"
                  placeholder="Hledat uživatele..." id="userSearch"></div>
              <select class="filter-select" id="roleFilter">
                <option value="all">Všechny role</option>
                <option value="admin">Admin</option>
                <option value="user">Uživatel</option>
              </select>
            </div>
          </div>
          <table class="users-table">
            <thead>
              <tr>
                <th>Uživatel</th>
                <th>Plán</th>
                <th>Role</th>
                <th>Datum registrace</th>
                <th>AI akce (m)</th>
                <th>Tokeny (m)</th>
                <th>Akce</th>
              </tr>
            </thead>
            <tbody id="adminUsersTableBody"></tbody>
          </table>
        </div>
        <div class="users-section" style="margin-top: 2rem;">
          <div class="section-header">
            <h2 class="section-title">Poslední aktivita</h2>
            <button class="btn btn-primary btn-sm" id="refresh-log-btn">🔄 Obnovit</button>
          </div>
          <table class="users-table">
            <thead>
              <tr>
                <th>Čas</th>
                <th>Uživatel</th>
                <th>Akce</th>
                <th>Status</th>
                <th>Detaily</th>
              </tr>
            </thead>
            <tbody id="activityLogTableBody">
            </tbody>
          </table>
          <div id="activity-pagination" class="pagination-container" style="display:none;"></div>
        </div>
      </div>

  </div>








  </main>


  <div class="modal-overlay" id="editUserModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title"><span>✏️</span> Upravit uživatele</h2>
        <button class="modal-close" data-close-modal>&times;</button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <div class="form-group">
            <label class="form-label">Jméno</label>
            <input type="text" class="form-control" id="editName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email (pouze pro čtení)</label>
            <input type="email" class="form-control" id="editEmail" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select class="form-control" id="editRole">
              <option value="user">Uživatel</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-close-modal>Zrušit</button>
        <button class="btn btn-primary" id="saveUserBtn">💾 Uložit změny</button>
      </div>
    </div>
  </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <div id="toastMessage">Nastavení bylo úspěšně uloženo!</div>
  </div>
  <div id="modal-overlay">
    <div id="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Připojit nový emailový účet</h2>
        <button class="modal-close" id="modal-close-btn" aria-label="Zavřít">✕</button>
      </div>
      <div class="modal-body">
        <div class="provider-buttons">
          <button class="provider-btn google" id="connect-google-btn">
            <svg class="provider-icon" viewBox="0 0 24 24">
              <path fill="#4285F4"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
              <path fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
              <path fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
              <path fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
            </svg>
            Připojit přes Google
          </button>
          <button class="provider-btn custom" id="connect-custom-btn">
            <svg class="provider-icon" viewBox="0 0 24 24" fill="none">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="#28a745"
                stroke-width="2" fill="none" />
              <polyline points="22,6 12,13 2,6" stroke="#28a745" stroke-width="2" fill="none" />
            </svg>
            Připojit přes Custom Email
          </button>
        </div>
      </div>
    </div>
  </div>





  <div class="modal-overlay" id="analysisModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">AI Analýza emailu</h2>
        <button class="modal-close" id="closeAnalysisModal">&times;</button>
      </div>

      <div class="modal-body" id="analysisModalBody">

        <div id="analysis-summary-section"></div>

        <div class="response-section">
          <div class="response-header">
            <div class="response-title">
              <span>✨</span> Doporučená odpověď
            </div>
          </div>
          <div class="response-content" id="response-display"></div>
          <textarea class="form-control" id="response-editor"
            style="display: none; width: 100%; min-height: 150px; margin-top: 1rem;"></textarea>
        </div>

      </div>

      <div class="modal-footer" id="analysis-footer">
        <button class="btn btn-secondary" id="edit-reply-btn"><span>📝</span> Upravit odpověď</button>
        <button class="btn btn-primary" id="save-edit-btn" style="display:none;"><span>💾</span> Uložit změny</button>
        <button class="btn btn-link" id="cancel-edit-btn" style="display:none;">Zrušit úpravy</button>

        <button class="btn btn-success" id="send-now-btn"><span>📤</span> Odeslat nyní</button>
        <button class="btn btn-secondary" id="pick-template-btn">📚 Vybrat šablonu</button>
      </div>
    </div>
  </div>




  <script>
    // ===================================================================================
    // === 1. DEKLARACE GLOBÁLNÍCH PROMĚNNÝCH ===========================================
    // ===================================================================================
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');

    // Create and append overlay
    const sidebarOverlay = document.createElement('div');
    sidebarOverlay.className = 'sidebar-overlay';
    document.body.appendChild(sidebarOverlay);

    const collapseBtn = document.getElementById('collapseBtn');
    const navLinks = document.querySelectorAll('.nav-link');
    const pageContents = document.querySelectorAll('.page-content');
    const pageTitle = document.getElementById('pageTitle');
    const contentArea = document.querySelector('.content-area');
    const settingsTabs = document.querySelectorAll('.settings-tab');
    const settingsContents = document.querySelectorAll('.settings-content');
    const emailListContainer = document.getElementById('email-list-container');
    const emailCountHeader = document.getElementById('email-count-header');
    const modal = document.getElementById('modal-overlay');
    const closeModalBtn = document.getElementById('modal-close-btn');
    const googleBtn = document.getElementById('connect-google-btn');
    const settingsForm = document.getElementById('settings-form');
    const toneSelect = document.getElementById('tone-select');
    const lengthSelect = document.getElementById('length-select');
    const signatureTextarea = document.getElementById('signature-textarea');
    const autoReplySwitch = document.getElementById('auto-reply-switch');
    const approvalSwitch = document.getElementById('approval-switch');
    const spamFilterSwitch = document.getElementById('spam-filter-switch');
    const statusFilter = document.getElementById('status-filter');
    const periodFilter = document.getElementById('period-filter');
    const analysisModal = document.getElementById('analysisModal');
    const closeAnalysisModalBtn = document.getElementById('closeAnalysisModal');
    const searchBar = document.getElementById('search-bar');
    const paginationContainer = document.getElementById('email-pagination');

    const EMAILS_PER_PAGE = 10;
    let currentEmailPage = 1;
    let lastEmailTotal = 0;

    function showEmailDetailModal(modal) {
      if (!modal) return;

      if (modal.parentElement !== document.body) {
        document.body.appendChild(modal);
      }

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      requestAnimationFrame(() => modal.classList.add('show'));
    }

    function hideEmailDetailModal(modal) {
      if (!modal) return;

      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');

      const finalize = () => {
        if (!modal.classList.contains('show')) {
          modal.style.display = 'none';
        }
      };

      modal.addEventListener('transitionend', finalize, { once: true });
      setTimeout(finalize, 300);
    }


    // === Modal helpers: uložit výchozí obsah a možnost ho vrátit ===
    const modalBodyEl = document.querySelector('#modal-content .modal-body');
    const DEFAULT_PROVIDER_HTML = modalBodyEl ? modalBodyEl.innerHTML : '';

    function restoreProviderChooser() {
      if (!modalBodyEl || !DEFAULT_PROVIDER_HTML) return;
      modalBodyEl.innerHTML = DEFAULT_PROVIDER_HTML;

      // znovu navázat kliky na tlačítka v chooseru
      document.getElementById('connect-google-btn')?.addEventListener('click', connectGoogleAccount);
      document.getElementById('connect-custom-btn')?.addEventListener('click', openCustomConnect);
    }


    let connectedAccounts = []; // [{ email: string, active: boolean }]
    function getConnectedAccounts() { return connectedAccounts || []; }
    function setConnectedAccounts(arr) { connectedAccounts = Array.isArray(arr) ? arr : []; }

    let allEmails = [];
    let currentMessageId = null;


    function findEmailEntryById(id, pendingId = '') {
      if (!Array.isArray(allEmails) || (!id && !pendingId)) return null;
      const pendingKey = pendingId ? String(pendingId) : '';
      const idKey = id ? String(id) : '';
      return allEmails.find(entry => {
        if (pendingKey) return String(entry?.pendingId ?? '') === pendingKey;
        return String(entry?.id ?? '') === idKey;
      }) || null;
    }

    function buildEmailContextFromRow(row) {
      if (!row) return null;
      const id = row.dataset.id || row.dataset.messageId || '';
      const pendingId = row.dataset.pendingId || '';
      const srcRaw = (row.dataset.src || '').toLowerCase();
      const replyTo = row.dataset.replyTo || '';
      const originalFrom = row.dataset.fromOriginal || '';
      const accountEmail = row.dataset.account || localStorage.getItem('primaryEmail') || '';
      const subject = row.querySelector('.email-subject')?.textContent?.trim()
        || row.dataset.subject
        || '';
      const from = row.dataset.from || '';
      const dateTxt = row.querySelector('.email-meta > div')?.textContent?.trim() || '';

      const entry = findEmailEntryById(id, pendingId);
      const context = {
        id: id || entry?.id || '',
        pendingId,
        src: srcRaw || entry?._src || entry?.source || 'gmail',
        account: accountEmail || entry?.account || '',
        from: from || entry?.sender || entry?.from || '',
        subject: subject || entry?.subject || '',
        date: dateTxt || entry?.date || '',
        replyTo: replyTo || entry?.replyTo || entry?.sender || '',
        originalFrom: originalFrom || entry?.originalFrom || ''
      };

      if (!context.id && entry?.pendingId) {
        context.id = String(entry.pendingId);
      }

      if (context.src !== 'custom' && /^\d+$/.test(String(context.id))) {
        context.src = 'custom';
      }

      return context;
    }



    window.__lastUsedTemplateId = null;




    const dashboardUserEmail = localStorage.getItem('userEmail'); // majitel dashboardu (přihlášený)
    let primaryEmail = localStorage.getItem('primaryEmail') || '';
    // =============== SYNC PŘIPOJENÝCH ÚČTŮ S BACKENDEM (PŘIDEJ) ===============
    async function fetchConnectedEmailsFromServer() {
      if (!dashboardUserEmail) return [];

      const urls = [
        `https://ai-email-server-stejdesign.onrender.com/api/accounts?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`,
        `https://ai-email-server-stejdesign.onrender.com/api/accounts/list?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`
      ];

      for (const u of urls) {
        try {
          const r = await fetch(u, { cache: 'no-store' });  // <<< důležité
          const j = await r.json();
          if (j && j.success) {
            if (Array.isArray(j.accounts)) return j.accounts;                         // [{email, active}]
            if (Array.isArray(j.emails)) return j.emails.map(e => ({ email: e, active: true }));
          }
        } catch (_) { }
      }
      return [];
    }

    function getConnectedEmailsLS() {
      try { return JSON.parse(localStorage.getItem('connectedEmails')) || []; }
      catch { return []; }
    }

    function setConnectedEmailsLS(emails) {
      localStorage.setItem('connectedEmails', JSON.stringify(emails || []));
    }


    // ==== LEARNING FROM HISTORY (front-end) =====================================

    // změň, pokud máš jinou base URL backendu
    // === BACKEND BASE (změň pokud máš jinou URL) ===

    // === BACKEND BASE ===
    window.BACKEND = 'https://ai-email-server-stejdesign.onrender.com';

    // === Helpery na window ===
    window.fetchSentReplies = async function (dashboardUserEmail, email, limit = 200) {
      const url = `${window.BACKEND}/api/gmail/sent-replies?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(email)}&limit=${limit}`;
      const r = await fetch(url, { cache: 'no-store' });
      const j = await r.json();
      if (!j.success) throw new Error(j.message || 'fetchSentReplies: backend vrátil chybu');
      return Array.isArray(j.items) ? j.items : [];
    };

    window.fetchInboxExamples = async function (dashboardUserEmail, email, limit = 200) {
      const url = `${window.BACKEND}/api/gmail/inbox-examples?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(email)}&limit=${limit}`;
      const r = await fetch(url, { cache: 'no-store' });
      const j = await r.json();
      if (!j.success) throw new Error(j.message || 'fetchInboxExamples: backend vrátil chybu');
      return Array.isArray(j.items) ? j.items : [];
    };

    window.saveStyleExamples = async function (dashboardUserEmail, email, items) {
      // 1) lehký limit na délku těla (kvůli velikosti JSONu)
      const MAX_BODY = 4000; // znaků
      const cleaned = (items || []).map(it => ({
        ...it,
        body: String(it.body || '').slice(0, MAX_BODY)
      }));

      // 2) pošli to na server po menších dávkách
      const BATCH = 80;
      let savedTotal = 0;

      for (let i = 0; i < cleaned.length; i += BATCH) {
        const batch = cleaned.slice(i, i + BATCH);
        const r = await fetch(`${window.BACKEND}/api/style-examples/ingest`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dashboardUserEmail, email, items: batch })
        });
        const j = await r.json();
        if (!r.ok || !j?.success) {
          throw new Error(j?.message || 'saveStyleExamples: backend vrátil chybu');
        }
        savedTotal += j.saved || 0;

        // krátká pauza, ať netrápíme server
        await new Promise(res => setTimeout(res, 150));
      }

      return { saved: savedTotal };
    };

    window.fetchStyleProfile = async function (dashboardUserEmail, email) {
      const url = `${window.BACKEND}/api/style-profile?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(email)}`;
      const r = await fetch(url, { cache: 'no-store' });
      return await r.json();
    };



    // ===== ANALYTICS =====
    let __activityChart, __aiChart, __catChart;

    async function loadAnalytics(days = 7) {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const account = (localStorage.getItem('primaryEmail') || '').trim();
      if (!dashboardUserEmail || !account) return;

      // Zničíme staré instance grafů, aby se mohly překreslit
      if (window.__responseTimeChart) window.__responseTimeChart.destroy();
      if (window.__aiQualityChart) window.__aiQualityChart.destroy();
      if (window.__templateUsageChart) window.__templateUsageChart.destroy();

      // === 1. Graf: Průměrná doba odpovědi (zatím statická ukázka) ===
      const ctx1 = document.getElementById('responseTimeChart')?.getContext('2d');
      if (ctx1) {
        window.__responseTimeChart = new Chart(ctx1, {
          type: 'bar',
          data: {
            labels: ['Vy (manuálně)', 'AI Asistent'],
            datasets: [{
              label: 'Průměrná doba v hodinách',
              data: [2.5, 0.1], // Statická ukázková data
              backgroundColor: ['#9ca3af', '#6366f1'],
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
        });
      }

      // === 2. Graf: Kvalita odpovědí AI (zatím statická ukázka) ===
      const ctx2 = document.getElementById('aiQualityChart')?.getContext('2d');
      if (ctx2) {
        window.__aiQualityChart = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Odesláno bez úprav', 'Upraveno a odesláno', 'Zahozeno'],
            datasets: [{
              data: [75, 20, 5], // Statická ukázková data
              backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      }

      // === 3. Graf: Využití šablon (data z API) ===
      try {
        const tplRes = await fetch(`${window.BACKEND}/api/analytics/templates?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
        const tplData = await tplRes.json();
        const topTemplates = (tplData.top || []).slice(0, 8);

        const ctx3 = document.getElementById('templateUsageChart')?.getContext('2d');
        if (ctx3) {
          window.__templateUsageChart = new Chart(ctx3, {
            type: 'bar',
            data: {
              labels: topTemplates.map(t => t.name),
              datasets: [{
                label: 'Počet použití',
                data: topTemplates.map(t => t.uses),
                backgroundColor: '#3b82f6',
              }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }
      } catch (e) {
        console.error("Chyba při načítání dat o šablonách:", e);
        showToast("Nepodařilo se načíst data o šablonách.", "error");
      }

      // Zajistíme funkčnost tlačítek pro změnu časového období
      document.querySelectorAll('#analytics .filter-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#analytics .filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const days = parseInt(btn.dataset.days, 10);
          // Zde by v budoucnu volalo loadAnalytics(days), ale pro statická data to není nutné
          // Prozatím jen vizuálně přepínáme
        };
      });
    }







    // === Klik handler ===
    window.learnFromHistory = async function () {
      const dashboardUserEmail = localStorage.getItem('userEmail') || 'tomas.lipuvka@gmail.com';
      const email = localStorage.getItem('primaryEmail') || 'tomas.lipuvka@gmail.com';

      const btn = document.getElementById('btn-learn-style');
      const old = btn?.textContent;
      try {
        if (btn) { btn.disabled = true; btn.textContent = 'Učím se z historie…'; }

        const sent = await window.fetchSentReplies(dashboardUserEmail, email, 200);
        const inbox = await window.fetchInboxExamples(dashboardUserEmail, email, 200);
        const saved = await window.saveStyleExamples(dashboardUserEmail, email, [...sent, ...inbox]);

        (window.showToast || alert)(`Hotovo: uloženo ${saved.saved} příkladů.`);
        const prof = await window.fetchStyleProfile(dashboardUserEmail, email);
        console.log('STYLE PROFILE', prof);
      } catch (e) {
        console.error(e);
        (window.showToast || alert)(e.message || 'Učení z historie selhalo.');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = old || 'Naučit se z historie'; }
      }
    };

    // připojit listener po načtení DOM
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-learn-style')
        ?.addEventListener('click', window.learnFromHistory);
    });





    /**
     * Stáhne připojené účty z backendu a uloží je do localStorage.
     * Vrací pole e-mailů. Použij v initializeDashboard().
     */
    async function syncConnectedEmails() {
      const serverAccs = await fetchConnectedEmailsFromServer();
      setConnectedAccounts(serverAccs);
      return getConnectedAccounts();
    }




    function setPrimaryEmail(email) {
      primaryEmail = email;
      localStorage.setItem('primaryEmail', email);
    }



    window.CURRENT_EMAIL = { id: '', subject: '', from: '', date: '', bodyText: '', analysis: {}, account: '' };
    window.CURRENT_SETTINGS = null;

    const aiComposer = (() => {
      const overlay = document.getElementById('aiComposer');
      if (!overlay) return null;

      const instructionsEl = document.getElementById('aiComposerInstructions');
      const emailSelectEl = document.getElementById('aiComposerEmailSelect');
      const contextLabel = document.getElementById('aiComposerContext');
      const profileLabel = document.getElementById('aiComposerProfile');
      const statusLabel = document.getElementById('aiComposerStatus');
      const footerStatusLabel = document.getElementById('aiComposerFooterStatus');
      const loaderEl = document.getElementById('aiComposerLoader');
      const resultWrap = document.getElementById('aiComposerResultWrap');
      const resultTextarea = document.getElementById('aiComposerResult');
      const sendBtn = document.getElementById('aiComposerSend');
      const generateBtn = document.getElementById('aiComposerGenerate');
      const cancelBtn = document.getElementById('aiComposerCancel');
      const closeBtn = document.getElementById('aiComposerClose');
      const launcherBtn = document.getElementById('openAiComposerGlobal');
      const inlineTrigger = document.getElementById('ed-open-composer');

      let currentContext = null;
      let isGenerating = false;
      let previousOverflow = '';
      let lastGeneratedContext = null;
      let lastGeneratedReply = '';

      function updateSendButtonAvailability() {
        if (!sendBtn) return;
        if (sendBtn.dataset.loading === '1') {
          sendBtn.disabled = true;
          return;
        }
        const ready = Boolean(lastGeneratedReply) && lastGeneratedContext && lastGeneratedContext.id;
        sendBtn.disabled = isGenerating || !ready;
      }

      function setSendButtonLoading(isLoading) {
        if (!sendBtn) return;
        sendBtn.dataset.loading = isLoading ? '1' : '0';
        sendBtn.textContent = isLoading ? 'Odesílám…' : '📤 Odeslat';
        if (isLoading) {
          sendBtn.disabled = true;
        } else {
          updateSendButtonAvailability();
        }
      }

      function resetGeneratedData() {
        lastGeneratedContext = null;
        lastGeneratedReply = '';
        if (sendBtn) {
          sendBtn.dataset.loading = '0';
          sendBtn.textContent = '📤 Odeslat';
        }
        updateSendButtonAvailability();
      }

      resetGeneratedData();

      function toggleResult(show, text = null) {
        if (!resultWrap || !resultTextarea) return;
        if (show) {
          resultWrap.classList.add('show');
          if (typeof text === 'string') resultTextarea.value = text;
        } else {
          resultWrap.classList.remove('show');
          if (text === null) resultTextarea.value = '';
          resetGeneratedData();
        }
        updateSendButtonAvailability();
      }

      function toggleLoader(show) {
        if (!loaderEl || !generateBtn) return;
        isGenerating = show;
        loaderEl.style.display = show ? 'block' : 'none';
        generateBtn.disabled = show;
        generateBtn.textContent = show ? 'Upravuji…' : '✨ Upravit odpověď';
        updateSendButtonAvailability();
      }

      function updateProfileHint() {
        if (!profileLabel) return;
        const settings = window.CURRENT_SETTINGS;
        if (!settings) {
          profileLabel.textContent = 'Styl profilu se načítá…';
          return;
        }
        const tone = settings.tone || 'neuvedeno';
        const length = settings.length || 'neuvedeno';
        const hasSignature = (settings.signature || '').trim().length > 0;
        profileLabel.textContent = `Profil účtu: ${tone} • ${length} • ${hasSignature ? 'podpis se připojí' : 'bez podpisu'}`;
      }

      function updateContextLabel() {
        if (!contextLabel) return;
        if (!currentContext || !currentContext.id) {
          contextLabel.textContent = 'Vyberte e-mail, ke kterému chcete připravit odpověď.';
          return;
        }
        const subj = currentContext.subject || '(bez předmětu)';
        const sender = currentContext.from || currentContext.replyTo || 'neznámý odesílatel';
        contextLabel.textContent = `${subj} • ${sender}`;
      }

      function guessContext() {
        if (window.__currentEmailCtx && window.__currentEmailCtx.id) {
          return { ...window.__currentEmailCtx };
        }
        if (Array.isArray(allEmails) && allEmails.length > 0) {
          const email = allEmails[0];
          return {
            id: email.id || email.pendingId || '',
            src: (email._src || email.source || 'gmail').toLowerCase(),
            account: email.account || localStorage.getItem('primaryEmail') || '',
            from: email.sender || email.from || '',
            subject: email.subject || '',
            date: email.date || '',
            replyTo: email.replyTo || email.sender || '',
            originalFrom: email.originalFrom || ''
          };
        }
        return null;
      }

      function populateEmailOptions(activeCtx) {
        if (!emailSelectEl) return;
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Vyberte e-mail ze seznamu…';
        const fragment = document.createDocumentFragment();
        fragment.appendChild(placeholder);

        const seen = new Set();
        (Array.isArray(allEmails) ? allEmails : []).forEach(email => {
          if (!email || (!email.id && !email.pendingId)) return;
          const id = String(email.id || email.pendingId);
          if (seen.has(id)) return;
          seen.add(id);
          const option = document.createElement('option');
          option.value = id;
          option.textContent = `${email.subject || '(bez předmětu)'} — ${(email.sender || email.from || '').trim()}`.slice(0, 120);
          option.dataset.src = (email._src || email.source || 'gmail').toLowerCase();
          option.dataset.account = email.account || localStorage.getItem('primaryEmail') || '';
          option.dataset.from = email.sender || email.from || '';
          option.dataset.subject = email.subject || '';
          option.dataset.date = email.date || '';
          if (activeCtx && String(activeCtx.id) === id) option.selected = true;
          fragment.appendChild(option);
        });

        if (activeCtx && activeCtx.id && !seen.has(String(activeCtx.id))) {
          const extra = document.createElement('option');
          extra.value = String(activeCtx.id);
          extra.textContent = `${activeCtx.subject || '(bez předmětu)'} — ${(activeCtx.from || '').trim()}`.slice(0, 120);
          extra.dataset.src = (activeCtx.src || 'gmail').toLowerCase();
          extra.dataset.account = activeCtx.account || localStorage.getItem('primaryEmail') || '';
          extra.dataset.from = activeCtx.from || '';
          extra.dataset.subject = activeCtx.subject || '';
          extra.dataset.date = activeCtx.date || '';
          extra.selected = true;
          fragment.appendChild(extra);
        }

        emailSelectEl.innerHTML = '';
        emailSelectEl.appendChild(fragment);
      }

      function applyOverrides(opts = {}) {
        if (instructionsEl && typeof opts.instructions === 'string') {
          instructionsEl.value = opts.instructions;
        }
        if (opts.resultText) {
          toggleResult(true, opts.resultText);
        } else {
          toggleResult(false, null);
        }
      }

      function openComposer(ctx = null, opts = {}) {
        currentContext = ctx ? { ...ctx } : guessContext();
        populateEmailOptions(currentContext);
        updateContextLabel();
        resetGeneratedData();
        applyOverrides(opts);
        updateProfileHint();
        if (typeof ensureSettingsLoaded === 'function') {
          ensureSettingsLoaded().then(updateProfileHint).catch(() => { });
        }
        previousOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
        overlay.classList.add('show');
        statusLabel && (statusLabel.textContent = '');
        footerStatusLabel && (footerStatusLabel.textContent = '');
        toggleLoader(false);
        setTimeout(() => {
          if (instructionsEl && (opts.focusInstructions ?? true)) {
            instructionsEl.focus({ preventScroll: false });
          }
        }, 50);
      }

      function closeComposer() {
        overlay.classList.remove('show');
        document.body.style.overflow = previousOverflow || '';
        toggleLoader(false);
        footerStatusLabel && (footerStatusLabel.textContent = '');
        resetGeneratedData();
      }

      async function generateReply() {
        if (isGenerating) return;
        if (!currentContext || !currentContext.id) {
          if (statusLabel) statusLabel.textContent = 'Vyberte prosím e-mail, pro který mám připravit odpověď.';
          emailSelectEl?.focus();
          toggleResult(false);
          return;
        }

        const dashboardUserEmail = localStorage.getItem('userEmail');
        const accountEmail = currentContext.account || localStorage.getItem('primaryEmail');
        if (!dashboardUserEmail || !accountEmail) {
          if (statusLabel) statusLabel.textContent = 'Chybí přihlášený uživatel nebo vybraný e-mailový účet.';
          return;
        }

        const instructions = instructionsEl?.value?.trim() || '';
        if (!instructions) {
          toggleResult(false);
          if (statusLabel) statusLabel.textContent = 'Vložte text odpovědi, který mám upravit.';
          instructionsEl?.focus({ preventScroll: false });
          return;
        }
        const toneOverride = (CURRENT_SETTINGS?.tone || '').trim();
        const lengthOverride = (CURRENT_SETTINGS?.length || '').trim();
        const includeSignature = Boolean(CURRENT_SETTINGS?.signature?.trim());

        const payload = {
          dashboardUserEmail,
          instructions,
          toneOverride,
          lengthOverride,
          includeSignature
        };

        let endpoint = '';
        let body;
        const src = (currentContext.src || '').toLowerCase();
        if (src === 'custom') {
          endpoint = `${window.BACKEND}/api/custom-email/analyze-email`;
          body = { ...payload, emailAddress: accountEmail, uid: currentContext.id };
        } else {
          endpoint = `${window.BACKEND}/api/gmail/analyze-email`;
          body = { ...payload, email: accountEmail, messageId: currentContext.id };
        }

        toggleLoader(true);
        if (statusLabel) statusLabel.textContent = '';
        if (footerStatusLabel) footerStatusLabel.textContent = '';

        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (!res.ok || !data.success) {
            throw new Error(data?.message || 'Generování odpovědi selhalo.');
          }
          const replyBody = String(data?.analysis?.suggested_reply || '').trim();
          if (!replyBody) {
            throw new Error('AI neposlala návrh odpovědi.');
          }
          toggleResult(true, replyBody);
          lastGeneratedReply = replyBody;
          lastGeneratedContext = {
            id: currentContext.id,
            pendingId: currentContext.pendingId || null,
            src: (currentContext.src || 'gmail').toLowerCase(),
            account: currentContext.account || localStorage.getItem('primaryEmail') || '',
            replyTo: currentContext.replyTo || '',
            from: currentContext.from || '',
            subject: currentContext.subject || '',
            headers: data?.headers || null
          };
          updateSendButtonAvailability();
          if (footerStatusLabel) footerStatusLabel.textContent = 'Návrh připraven. Odešlete ho tlačítkem „Odeslat“.';
          if (typeof showToast === 'function') {
            showToast('AI návrh je připraven.', 'success');
          }
        } catch (err) {
          if (statusLabel) statusLabel.textContent = err.message || 'Nepodařilo se připravit návrh odpovědi.';
          toggleResult(false, null);
        } finally {
          toggleLoader(false);
        }
      }

      async function onSend() {
        if (!sendBtn || sendBtn.dataset.loading === '1') return;
        const replyBody = (resultTextarea?.value || '').trim();
        if (!replyBody) {
          if (typeof showToast === 'function') {
            showToast('Není připraven žádný text k odeslání.', 'warning');
          }
          return;
        }

        if (!lastGeneratedContext || !lastGeneratedContext.id || !currentContext || currentContext.id !== lastGeneratedContext.id) {
          if (typeof showToast === 'function') {
            showToast('Nejprve upravte odpověď pro vybraný e-mail.', 'warning');
          }
          return;
        }

        const dashboardUserEmail = localStorage.getItem('userEmail');
        const accountEmail = lastGeneratedContext.account || currentContext.account || localStorage.getItem('primaryEmail');
        if (!dashboardUserEmail || !accountEmail) {
          const msg = 'Chybí přihlášený uživatel nebo e-mailový účet.';
          if (footerStatusLabel) footerStatusLabel.textContent = msg;
          if (typeof showToast === 'function') {
            showToast(msg, 'error');
          }
          return;
        }

        setSendButtonLoading(true);
        if (statusLabel) statusLabel.textContent = '';
        if (footerStatusLabel) footerStatusLabel.textContent = 'Odesílám odpověď…';

        try {
          const src = (lastGeneratedContext.src || '').toLowerCase();
          let url = '';
          let payload = null;

          if (src === 'custom') {
            const headers = lastGeneratedContext.headers || {};
            const origMessageId = headers?.messageId || headers?.MessageId || null;
            const origReferences = headers?.references || headers?.References || null;
            const replyTargetRaw = lastGeneratedContext.replyTo || lastGeneratedContext.from || '';
            const toAddress = extractEmailAddress(replyTargetRaw || '');
            const subject = (lastGeneratedContext.subject || '').trim();
            const replyToUid = Number(lastGeneratedContext.pendingId || lastGeneratedContext.id);

            if (!replyTargetRaw || !toAddress) {
              throw new Error('Nepodařilo se určit adresáta odpovědi.');
            }
            if (!origMessageId) {
              throw new Error('Chybí identifikátor původní zprávy.');
            }
            if (!Number.isFinite(replyToUid) || replyToUid <= 0) {
              throw new Error('Chybí UID původní zprávy.');
            }

            url = `${window.BACKEND}/api/custom-email/send-reply`;
            payload = {
              dashboardUserEmail,
              emailAddress: accountEmail,
              to: toAddress,
              replyTo: replyTargetRaw,
              subject: subject ? `Re: ${subject}` : 'Re:',
              text: replyBody,
              replyToUid,
              origMessageId,
              origReferences: origReferences || null
            };
          } else {
            url = `${window.BACKEND}/api/gmail/send-reply`;
            payload = {
              dashboardUserEmail,
              email: accountEmail,
              messageId: lastGeneratedContext.id,
              replyBody
            };
          }

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await response.json();

          if (!response.ok || !data?.success) {
            throw new Error(data?.message || 'Odeslání odpovědi selhalo.');
          }

          if (typeof showToast === 'function') {
            showToast(data?.message || 'Odpověď byla odeslána.', 'success');
          }
          if (footerStatusLabel) footerStatusLabel.textContent = 'Odpověď byla odeslána.';

          resetGeneratedData();
          closeComposer();

          if (typeof afterSuccessfulSend === 'function') {
            try { await afterSuccessfulSend(); } catch (e) { console.warn(e); }
          }
          if (typeof fetchEmails === 'function') {
            try { await fetchEmails(); } catch (e) { console.warn(e); }
          }
        } catch (err) {
          const message = err?.message || 'Odeslání odpovědi selhalo.';
          if (footerStatusLabel) footerStatusLabel.textContent = message;
          if (typeof showToast === 'function') {
            showToast(message, 'error');
          }
        } finally {
          setSendButtonLoading(false);
        }
      }

      function onEmailSelectChange() {
        const option = emailSelectEl?.selectedOptions?.[0];
        if (!option || !option.value) {
          currentContext = null;
          updateContextLabel();
          return;
        }
        currentContext = {
          id: option.value,
          src: (option.dataset.src || '').toLowerCase() || 'gmail',
          account: option.dataset.account || localStorage.getItem('primaryEmail') || '',
          from: option.dataset.from || '',
          subject: option.dataset.subject || '',
          date: option.dataset.date || '',
          replyTo: option.dataset.from || ''
        };
        toggleResult(false, null);
        window.__currentEmailCtx = { ...currentContext };
        updateContextLabel();
      }

      emailSelectEl?.addEventListener('change', onEmailSelectChange);
      generateBtn?.addEventListener('click', generateReply);
      cancelBtn?.addEventListener('click', closeComposer);
      closeBtn?.addEventListener('click', closeComposer);
      sendBtn?.addEventListener('click', onSend);
      overlay.addEventListener('click', (evt) => {
        if (evt.target === overlay) closeComposer();
      });
      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape' && overlay.classList.contains('show')) {
          closeComposer();
        }
      });

      launcherBtn?.addEventListener('click', () => {
        openComposer(guessContext());
      });

      inlineTrigger?.addEventListener('click', () => {
        const inlineCtx = window.__currentEmailCtx
          || buildEmailContextFromRow(document.querySelector(`.email-item[data-id="${window.__currentEmailCtx?.id || ''}"]`));
        const instructions = document.getElementById('ed-ai-instructions')?.value || '';
        openComposer(inlineCtx, { instructions, focusInstructions: !instructions });
      });

      return { open: openComposer, close: closeComposer };
    })();

    if (aiComposer) {
      window.aiComposer = aiComposer;
    }

    // Pomocná funkce: aktuálně vybraný připojený účet (přepiš, pokud už něco máš)
    function getSelectedAccountEmail() {
      // zkus element select/input; pokud nemáš, ulož si při výběru účtu do localStorage
      return document.querySelector('#accountSelect')?.value
        || localStorage.getItem('connectedEmail')
        || CURRENT_EMAIL.account
        || '';
    }

    // Načti (jednou) nastavení pro daný účet
    async function ensureSettingsLoaded() {
      if (CURRENT_SETTINGS && CURRENT_SETTINGS.connected_email === getSelectedAccountEmail()) return;
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const connectedEmail = getSelectedAccountEmail();
      if (!dashboardUserEmail || !connectedEmail) return;

      const r = await fetch(`${API_BASE}/api/settings?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(connectedEmail)}`).then(x => x.json());
      if (r.success) {
        CURRENT_SETTINGS = r.settings;
      }
    }



    // Po návratu z OAuth: vezmeme new-email z URL a nastavíme jako primary
    (function pickNewlyLinkedEmailFromUrl() {
      const params = new URLSearchParams(location.search);
      if (params.get('account-linked') === 'success' && params.get('new-email')) {
        setPrimaryEmail(decodeURIComponent(params.get('new-email')));
        // vyčisti URL
        const clean = new URL(location.href);
        clean.searchParams.delete('account-linked');
        clean.searchParams.delete('new-email');
        history.replaceState({}, '', clean.toString());
      }
    })();


    // === Nápověda k šablonám ===
    const TPL_VARS = [
      'recipientName', 'product', 'price', 'deliveryTime', 'senderName',
      'ourNextStep', 'ourDeadline', 'theirNextStep', 'theirDeadline', 'meetingDate',
      'orderNumber', 'issue', 'solutionOptionA', 'solutionOptionB', 'company',
      'painPoint', 'kpi', 'kpiValue', 'timeframe', 'slot1', 'slot2',
      'step1', 'step2', 'step3', 'deadline'
    ];

    const TPL_DESCRIPTIONS = {
      recipientName: 'Jméno příjemce (např. „paní Nováková“).',
      product: 'Produkt/služba, kterých se email týká.',
      price: 'Cena (ideálně včetně měny).',
      deliveryTime: 'Termín dodání / doručení.',
      senderName: 'Jméno a příjmení odesílatele emailu (osoby, která vám psala).',
      ourNextStep: 'Náš další krok (co uděláme my).',
      ourDeadline: 'Náš termín/uzávěrka.',
      theirNextStep: 'Další krok protistrany (co má udělat příjemce).',
      theirDeadline: 'Termín/uzávěrka pro příjemce.',
      meetingDate: 'Datum/čas schůzky.',
      orderNumber: 'Číslo objednávky.',
      issue: 'Stručný popis problému/požadavku.',
      solutionOptionA: 'Varianta řešení A.',
      solutionOptionB: 'Varianta řešení B.',
      company: 'Název firmy příjemce.',
      painPoint: 'Hlavní „bolest“/problém zákazníka.',
      kpi: 'Cíl/KPI, který sledujete.',
      kpiValue: 'Aktuální hodnota KPI.',
      timeframe: 'Horizont/dobu plnění (např. „Q3 2025“).',
      slot1: 'Navržený časový slot č. 1 na call/schůzku.',
      slot2: 'Navržený časový slot č. 2 na call/schůzku.',
      step1: 'Krok postupu č. 1.',
      step2: 'Krok postupu č. 2.',
      step3: 'Krok postupu č. 3.',
      deadline: 'Konečný termín/uzávěrka.'
    };

    function insertAtCursor(textarea, text) {
      const el = typeof textarea === 'string' ? document.getElementById(textarea) : textarea;
      if (!el) return;
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      const before = el.value.slice(0, start);
      const after = el.value.slice(end);
      el.value = before + text + after;
      const cursor = start + text.length;
      el.focus();
      el.setSelectionRange(cursor, cursor);
      // po každém vložení rovnou validuj
      validateTemplateVariables();
    }

    async function learnStyleFromHistory() {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const primaryEmail = localStorage.getItem('primaryEmail');
      if (!dashboardUserEmail || !primaryEmail) {
        showToast('Vyber prosím primární účet v Nastavení → Email účty.', 'warning');
        return;
      }
      const statusEl = document.getElementById('learn-style-status');
      statusEl.textContent = 'Analyzuji odpovědi… může to chvíli trvat.';
      try {
        const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/style/learn', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dashboardUserEmail, email: primaryEmail, limit: 200 })
        });
        const j = await r.json();
        if (!j.success) throw new Error(j.message || 'Učení stylu selhalo.');
        // ulož styl do paměti klientu, ať ho máme hned k dispozici
        window.CURRENT_SETTINGS = { ...(window.CURRENT_SETTINGS || {}), style_profile: j.style_profile };
        showToast('Styl naučen. Budu ho používat ve všech odpovědích.', 'success');
        statusEl.textContent = 'Hotovo.';
      } catch (e) {
        showToast(e.message || 'Nepodařilo se naučit styl.', 'error');
        statusEl.textContent = '';
      }
    }

    document.getElementById('learn-style-btn')?.addEventListener('click', learnStyleFromHistory);



    function renderTplHelp() {
      const grid = document.getElementById('tpl-chip-grid');
      if (!grid) return;
      grid.innerHTML = '';

      // Hint box (vytvoříme jednou)
      let hintBox = document.getElementById('tpl-var-hint');
      if (!hintBox) {
        hintBox = document.createElement('div');
        hintBox.id = 'tpl-var-hint';
        hintBox.className = 'tpl-var-hint';
        // vlož hned pod grid s chipy
        grid.parentElement.insertBefore(hintBox, grid.nextSibling);
      }

      const showVarHint = (name) => {
        const desc = TPL_DESCRIPTIONS[name];
        if (!desc) { hintBox.style.display = 'none'; return; }
        hintBox.innerHTML = `<strong>{{${name}}}</strong> — ${desc}`;
        hintBox.style.display = 'block';
      };
      const hideVarHint = () => { hintBox.style.display = 'none'; };

      // CHIPS s tooltippy
      TPL_VARS.forEach(v => {
        const btn = document.createElement('button');
        btn.className = 'chip';
        btn.type = 'button';
        btn.textContent = `{{${v}}}`;
        btn.title = TPL_DESCRIPTIONS[v] || ''; // nativní tooltip
        btn.setAttribute('aria-label', TPL_DESCRIPTIONS[v] || `{{${v}}}`);

        btn.addEventListener('click', () => insertAtCursor('tpl-content', `{{${v}}}`));
        btn.addEventListener('mouseenter', () => showVarHint(v));
        btn.addEventListener('focus', () => showVarHint(v));
        btn.addEventListener('mouseleave', hideVarHint);
        btn.addEventListener('blur', hideVarHint);

        grid.appendChild(btn);
      });

      // AI slot tlačítka
      document.getElementById('btn-insert-ai')?.addEventListener('click', () => {
        insertAtCursor('tpl-content', '[[AI: Napiš dvě věty empatického uznání problému a navrhni další konkrétní krok.]]');
      });
      document.getElementById('btn-insert-example')?.addEventListener('click', (e) => {
        e.preventDefault();
        const nameEl = document.getElementById('tpl-name');
        const catEl = document.getElementById('tpl-category');
        const contentEl = document.getElementById('tpl-content');
        if (!contentEl) return;

        if (nameEl) nameEl.value = 'Odpověď na reklamaci — potvrzení přijetí';
        if (catEl) catEl.value = 'Podpora';

        const example =
          `Dobrý den {{recipientName}},

děkujeme za zprávu ohledně objednávky {{orderId}}. Mrzí nás vzniklé potíže.

[[AI: Stručně a empaticky shrň důvod reklamace podle emailu a přidej 1–2 věty s ujištěním.]]

Pro rychlé vyřízení prosím pošlete fotografie poškození a číslo účtu pro případné vrácení peněz.
Číslo reklamace: {{caseId}}

Děkujeme a brzy se ozveme s dalším postupem.
S pozdravem
{{senderName}}
{{senderSignature}}`;

        if ((contentEl.value || '').trim().length) {
          contentEl.value = contentEl.value.replace(/\s*$/, '') + '\n\n---\n' + example;
        } else {
          contentEl.value = example;
        }

        contentEl.focus();
        const pos = contentEl.value.length;
        contentEl.setSelectionRange(pos, pos);
        validateTemplateVariables?.();
        showToast?.('Ukázková šablona vložena. Uprav ji a ulož.', 'success');
      });

      // === Hint podle kurzoru v textarea ===
      const ta = document.getElementById('tpl-content');
      const checkCaretVar = () => {
        if (!ta) return hideVarHint();
        const i = ta.selectionStart ?? 0;
        const text = ta.value || '';
        const re = /{{\s*([a-zA-Z0-9_]+)\s*}}/g;
        let m, found = null;
        while ((m = re.exec(text))) {
          const start = m.index;
          const end = re.lastIndex;
          if (i >= start && i <= end) { found = m[1]; break; }
        }
        if (found && TPL_DESCRIPTIONS[found]) showVarHint(found);
        else hideVarHint();
      };
      ta?.addEventListener('keyup', checkCaretVar);
      ta?.addEventListener('click', checkCaretVar);
      ta?.addEventListener('focus', checkCaretVar);

      // validuj průběžně
      document.getElementById('tpl-content')?.addEventListener('input', validateTemplateVariables);
      validateTemplateVariables();
    }




    function validateTemplateVariables() {
      const ta = document.getElementById('tpl-content');
      const box = document.getElementById('tpl-validator');
      if (!ta || !box) return;

      const txt = ta.value || '';
      const used = Array.from(txt.matchAll(/{{\s*([a-zA-Z0-9_]+)\s*}}/g)).map(m => m[1]);
      const aiSlots = Array.from(txt.matchAll(/\[\[\s*AI\s*:(.*?)\]\]/gs)).length;

      const unknown = [...new Set(used.filter(k => !TPL_VARS.includes(k)))];
      if (unknown.length) {
        box.className = 'warn';
        box.innerHTML = `Neznámé proměnné: <b>${unknown.join(', ')}</b>.<br>
      Použij některou z dostupných výše nebo oprav překlep.`;
      } else {
        box.className = 'ok';
        box.innerHTML = `Žádné neznámé proměnné. AI slotů: <b>${aiSlots}</b>.`;
      }
    }

    // po načtení stránky/otevření záložky Šablony
    document.addEventListener('DOMContentLoaded', renderTplHelp);


    // ZMĚNA: Odebrali jsme proměnné pro správu účtů odsud, budeme je spravovat v rámci funkcí a localStorage.

    // ===================================================================================
    // === 2. ZÁKLADNÍ FUNKCE APLIKACE (Dashboard, Modály, Toast...) ====================
    // ===================================================================================

    function showToast(message, type = 'success', opts = {}) {
      const { duration = 3000, actionText = null, onAction = null } = opts;

      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      if (!toast || !toastMessage) return;

      // text + typ
      toastMessage.textContent = message;
      toast.className = `toast ${type} show`;

      // zruš případný předchozí timer
      if (window.__toastTimer) {
        clearTimeout(window.__toastTimer);
        window.__toastTimer = null;
      }

      // vytvoř / sprav akční tlačítko (pokud je)
      let actionBtn = toast.querySelector('.toast-action-btn');
      if (actionText) {
        if (!actionBtn) {
          actionBtn = document.createElement('button');
          actionBtn.className = 'toast-action-btn';
          actionBtn.style.marginLeft = '12px';
          actionBtn.style.border = 'none';
          actionBtn.style.background = '#f1f5f9';
          actionBtn.style.color = '#334155';
          actionBtn.style.padding = '6px 10px';
          actionBtn.style.borderRadius = '6px';
          actionBtn.style.cursor = 'pointer';
          toast.appendChild(actionBtn);
        }
        actionBtn.textContent = actionText;
        actionBtn.onclick = () => { if (onAction) onAction(); };
        actionBtn.style.display = 'inline-block';
      } else if (actionBtn) {
        actionBtn.style.display = 'none';
        actionBtn.onclick = null;
      }

      // auto-hide
      window.__toastTimer = setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    function checkMobile() {
      // On mobile, we want the sidebar NOT to be collapsed (mini), because we hide/show the whole thing.
      // So we ensure 'collapsed' class is REMOVED so texts are visible when opened.
      if (sidebar && window.innerWidth <= 768) {
        sidebar.classList.remove('collapsed');
      }
    }

    function openModal() {
      // pokaždé začni výběrem poskytovatele
      restoreProviderChooser();
      if (modal) modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      if (modal) modal.style.display = 'none';
      document.body.style.overflow = '';
      // po zavření resetuj, aby příště nebyl ponechaný formulář
      restoreProviderChooser();
    }

    function hideAnalysisModal() {
      if (analysisModal) analysisModal.classList.remove('show');
      document.body.style.overflow = '';
    }

    function connectGoogleAccount() {
      const GOOGLE_CLIENT_ID = "990614891314-kugic255rq68tt1m7uqg4rdp9jdig5lb.apps.googleusercontent.com";
      const REDIRECT_URI = "https://ai-email-server-stejdesign.onrender.com/api/oauth/google/callback";
      const oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

      // Přidáme email přihlášeného uživatele do state
      const loggedUserEmail = localStorage.getItem('userEmail');
      const params = {
        client_id: GOOGLE_CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: 'code',
        scope: 'openid email profile https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.send',
        access_type: 'offline',
        prompt: 'consent',
        include_granted_scopes: 'true',
        state: encodeURIComponent(loggedUserEmail || '')
      };
      window.location.href = `${oauth2Endpoint}?${new URLSearchParams(params)}`;
    }

    // === CUSTOM EMAIL: otevřít modal s formulářem a zavolat /api/custom-email/connect ===
    function openCustomConnect() {
      const overlay = document.getElementById('modal-overlay');
      const box = document.getElementById('modal-content');
      const body = box?.querySelector('.modal-body');
      if (!overlay || !body) return;

      // ⚙️ Základ: jen e-mail + heslo. Ostatní je schované v "Pokročilé nastavení".
      body.innerHTML = `
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Email adresa</label>
        <input id="ce-emailAddress" class="form-control" type="email" placeholder="jan@firma.cz" required>
      </div>
      <div class="form-group">
        <label class="form-label">Heslo</label>
        <input id="ce-password" class="form-control" type="password" placeholder="••••••••" required>
      </div>
    </div>

    <button type="button" id="toggle-advanced" class="bulk-btn" style="margin:.75rem 0 0;">
      Pokročilé nastavení
    </button>

    <div class="advanced-settings" style="display:none; margin-top: .75rem;">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Uživatelské jméno</label>
          <input id="ce-username" class="form-control" type="text" placeholder="(většinou stejný jako email)">
        </div>
      </div>

      <div class="form-grid" style="margin-top:1rem;">
        <div class="form-group">
          <label class="form-label">IMAP host</label>
          <input id="ce-imapHost" class="form-control" placeholder="imap.firma.cz">
        </div>
        <div class="form-group">
          <label class="form-label">IMAP port</label>
          <input id="ce-imapPort" class="form-control" type="number" value="993">
        </div>
        <div class="form-group">
          <label class="form-label">IMAP zabezpečení</label>
          <select id="ce-imapSecure" class="form-control">
            <option value="1" selected>SSL/TLS</option>
            <option value="0">Nezabezpečené</option>
          </select>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">SMTP host</label>
          <input id="ce-smtpHost" class="form-control" placeholder="smtp.firma.cz">
        </div>
        <div class="form-group">
          <label class="form-label">SMTP port</label>
          <input id="ce-smtpPort" class="form-control" type="number" value="465">
        </div>
        <div class="form-group">
          <label class="form-label">SMTP zabezpečení</label>
          <select id="ce-smtpSecure" class="form-control">
            <option value="1" selected>SSL/TLS</option>
            <option value="0">Nezabezpečené</option>
          </select>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:.5rem; margin-top:1rem;">
      <button id="ce-connect-btn" class="btn btn-primary">Ověřit & uložit</button>
      <button id="ce-cancel-btn" class="btn btn-secondary">Zrušit</button>
    </div>
    <div id="ce-connect-msg" style="margin-top:.5rem; color:#64748b;"></div>
  `;

      overlay.style.display = 'flex';

      // Toggle "Pokročilé nastavení"
      document.getElementById('toggle-advanced')?.addEventListener('click', () => {
        const adv = document.querySelector('.advanced-settings');
        if (!adv) return;
        adv.style.display = adv.style.display === 'none' ? 'block' : 'none';
      });

      document.getElementById('ce-cancel-btn')?.addEventListener('click', () => { closeModal(); });

      // Ověřit & uložit
      document.getElementById('ce-connect-btn')?.addEventListener('click', async () => {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const emailAddress = document.getElementById('ce-emailAddress').value.trim();
        const password = document.getElementById('ce-password').value;

        const msgEl = document.getElementById('ce-connect-msg');
        const advVisible = document.querySelector('.advanced-settings')?.style.display !== 'none';
        const val = (id) => {
          const el = document.getElementById(id);
          return el && el.value ? el.value : undefined;
        };

        // 📦 Minimální payload (email+heslo). Pokud je otevřené Pokročilé a něco vyplněné, přidáme to.
        const payload = {
          dashboardUserEmail,
          emailAddress,
          password
        };
        if (advVisible) {
          payload.username = val('ce-username') || emailAddress;
          payload.imapHost = val('ce-imapHost');
          const ip = val('ce-imapPort'); if (ip) payload.imapPort = Number(ip);
          const isec = val('ce-imapSecure'); if (isec != null) payload.imapSecure = isec === '1';

          payload.smtpHost = val('ce-smtpHost');
          const sp = val('ce-smtpPort'); if (sp) payload.smtpPort = Number(sp);
          const ssec = val('ce-smtpSecure'); if (ssec != null) payload.smtpSecure = ssec === '1';
        }

        msgEl.textContent = 'Ověřuji přihlášení…';
        try {
          const resp = await fetch(`${window.BACKEND}/api/custom-email/connect`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const j = await resp.json();
          if (!resp.ok || !j.success) throw new Error(j.message || 'Připojení selhalo.');
          msgEl.textContent = '✅ Účet připojen. Načítám…';

          // výchozí AI nastavení pro tento účet
          await fetch(`${window.BACKEND}/api/settings`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              dashboardUserEmail, email: emailAddress,
              tone: 'Formální', length: 'Střední (1 odstavec)', signature: 'Společnost Senzoor',
              auto_reply: false, approval_required: true, spam_filter: true
            })
          });

          await syncConnectedEmails();
          localStorage.setItem('primaryEmail', emailAddress);
          renderConnectedAccounts();
          await loadSettings();
          overlay.style.display = 'none';
          showToast('Účet přidán a připraven.', 'success');
        } catch (e) {
          msgEl.textContent = '❌ ' + (e.message || e);
        }
      });
    }

    // zapni tlačítko v modalu „Připojit přes Custom Email“
    document.getElementById('connect-custom-btn')?.addEventListener('click', openCustomConnect);

    function parseSenderName(s = '') {
      const m = String(s).match(/<([^>]+)>/);
      const raw = m ? m[1] : String(s);
      return raw.trim().replace(/^mailto:/i, '');
    }


    async function tryGmailEmails(primaryEmail, status, period, searchQuery, page = 1, limit = EMAILS_PER_PAGE) {
      if (!primaryEmail) return null;

      const normalizedStatus = String(status || 'all').toLowerCase();

      if (normalizedStatus === 'approval') {
        try {
          const pendingUrl = new URL(`${window.BACKEND}/api/gmail/pending-replies`);
          pendingUrl.searchParams.set('dashboardUserEmail', dashboardUserEmail);
          pendingUrl.searchParams.set('email', primaryEmail);

          const r = await fetch(pendingUrl.toString(), { cache: 'no-store' });
          let j = null;
          try {
            j = await r.json();
          } catch (_) {
            j = null;
          }
          if (!r.ok || !j || !j.success) {
            return { src: 'gmail', total: Array.isArray(j?.pending) ? j.pending.length : 0, emails: [] };
          }

          const normalized = (j.pending || []).map((item) => {
            const createdAt = item.created_at || item.last_generated_at || item.sent_at;
            let meta = {};
            if (item.metadata) {
              try {
                meta = typeof item.metadata === 'object' ? item.metadata : JSON.parse(item.metadata);
              } catch (_) {
                meta = {};
              }
            }
            const replyTo = meta.replyToHeader || meta.replyTo || item.sender || '';
            const originalFrom = meta.fromHeader || meta.sender || item.sender || '';
            const displaySender = replyTo || originalFrom || item.sender || '';
            return {
              id: item.message_id,
              messageId: item.message_id,
              pendingId: item.id,
              sender: displaySender,
              replyTo: replyTo || displaySender,
              originalFrom,
              subject: item.subject || 'Bez předmětu',
              snippet: item.summary || item.snippet || '',
              date: createdAt || new Date().toISOString(),
              _src: 'gmail',
              _pending: true,
              account: primaryEmail,
              replyBody: item.reply_body || '',
              originalBody: item.original_body || '',
              summary: item.summary || '',
              sentiment: item.sentiment || '',
              threadId: item.thread_id || '',
              status: item.status || 'pending'
            };
          });


          return { src: 'gmail', total: normalized.length, emails: normalized };
        } catch (error) {
          console.error('Nepodařilo se načíst čekající odpovědi:', error);
          return { src: 'gmail', total: 0, emails: [] };
        }
      }

      const url = `${window.BACKEND}/api/gmail/emails?email=${encodeURIComponent(primaryEmail)}&dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&status=${encodeURIComponent(status)}&period=${encodeURIComponent(period)}&searchQuery=${encodeURIComponent(searchQuery)}&page=${page}&limit=${limit}`;
      const r = await fetch(url, { cache: 'no-store' });
      let j = null;
      try {
        j = await r.json();
      } catch (_) {
        j = null;
      }
      if (!r.ok || !j || !j.success) return null;
      const normalized = (j.emails || []).map(e => {
        const replyTo = e.replyTo || '';
        const originalFrom = e.from || '';
        const fallbackSender = e.sender || originalFrom || '';
        const displaySender = replyTo || fallbackSender;
        return {
          id: e.id,                       // Gmail messageId
          uid: null,
          sender: displaySender,
          replyTo: replyTo || displaySender,
          originalFrom,
          subject: e.subject,
          snippet: e.snippet || '',
          date: e.date,
          _src: 'gmail',
          _pending: false,
          account: primaryEmail,
          unread: e.unread === true,
          status: normalizedStatus === 'spam' ? 'spam' : (e.status || e.folder || '')
        };
      });
      return { src: 'gmail', total: j.total || normalized.length, emails: normalized };
    }

    async function tryCustomPendingEmails(primaryEmail) {
      if (!primaryEmail) return null;
      const url = `${window.BACKEND}/api/custom-email/pending-replies?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(primaryEmail)}`;
      const r = await fetch(url, { cache: 'no-store' });
      let j = null;
      try {
        j = await r.json();
      } catch (_) {
        j = null;
      }
      if (!r.ok || !j || !j.success) {
        return { src: 'custom', total: Array.isArray(j?.pending) ? j.pending.length : 0, emails: [] };
      }

      const normalized = (j.pending || []).map((item) => {
        const createdAt = item.created_at || item.last_generated_at || item.sent_at;
        let meta = {};
        if (item.metadata) {
          try {
            meta = typeof item.metadata === 'object' ? item.metadata : JSON.parse(item.metadata);
          } catch (_) {
            meta = {};
          }
        }
        const replyTo = meta.replyToHeader || meta.replyTo || item.sender || '';
        const originalFrom = meta.fromHeader || meta.sender || item.sender || '';
        const displaySender = replyTo || originalFrom || item.sender || '';
        return {
          id: item.message_id || String(item.id),
          messageId: item.message_id || String(item.id),
          pendingId: item.id,
          sender: displaySender,
          replyTo: replyTo || displaySender,
          originalFrom,
          subject: item.subject || 'Bez předmětu',
          snippet: item.summary || item.snippet || '',
          date: createdAt || new Date().toISOString(),
          _src: 'custom',
          _pending: true,
          account: primaryEmail,
          replyBody: item.reply_body || '',
          originalBody: item.original_body || '',
          summary: item.summary || '',
          sentiment: item.sentiment || '',
          status: item.status || 'pending'
        };
      });

      return { src: 'custom', total: normalized.length, emails: normalized };
    }





    async function tryCustomEmails(primaryEmail, status = 'all', period = 'all', searchQuery = '', page = 1, limit = EMAILS_PER_PAGE) {
      const numericPage = Number(page);
      const numericLimit = Number(limit);
      const safePage = Number.isFinite(numericPage) && numericPage > 0 ? numericPage : 1;
      const safeLimit = Number.isFinite(numericLimit) && numericLimit > 0 ? numericLimit : EMAILS_PER_PAGE;
      // ZMĚNA: Používáme sjednocený endpoint /api/gmail/emails, který umí i custom účty
      // Důležité: parametr se jmenuje 'email', nikoliv 'emailAddress'
      const url = `${window.BACKEND}/api/gmail/emails?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(primaryEmail)}&limit=${safeLimit}&page=${safePage}&status=${encodeURIComponent(status)}&period=${encodeURIComponent(period)}&searchQuery=${encodeURIComponent(searchQuery)}`;
      const r = await fetch(url, { cache: 'no-store' });
      let j = null;
      try {
        j = await r.json();
      } catch (_) {
        j = null;
      }
      if (!r.ok || !j || !j.success) return null;
      const normalized = (j.emails || []).map(e => {
        // backend vrací { id: "...", sender: "...", subject, date, ... }
        const uid = e.uid ?? e.id; // podpora obou variant
        const replyTo = e.replyTo || '';
        const originalFrom = e.from || '';
        const fallbackSender = e.sender || originalFrom || '';
        const displaySender = replyTo || fallbackSender;
        return {
          id: String(uid),
          uid: Number(uid),
          sender: displaySender,
          replyTo: replyTo || displaySender,
          originalFrom,
          subject: e.subject || '',
          snippet: e.snippet || '',
          date: e.date || e.internalDate || Date.now(),
          _src: 'custom',
          _pending: false,
          account: primaryEmail,
          unread: e.unread === true
        };
      });
      return { src: 'custom', total: j.total ?? normalized.length, emails: normalized };
    }



    // ZMĚNA: Funkce nyní načítá emaily pro primární účet z localStorage
    async function fetchEmails(options = {}) {
      const { resetPage = false, targetPage = null } = options || {};
      const primaryEmail = localStorage.getItem('primaryEmail');
      if (!primaryEmail) {
        if (emailListContainer) emailListContainer.innerHTML = `<div class="empty-state"><h3>Vyberte hlavní emailový účet</h3></div>`;
        if (emailCountHeader) emailCountHeader.textContent = 'Emaily';
        return;
      }

      const accs = getConnectedAccounts().length ? getConnectedAccounts() : await syncConnectedEmails();
      const prim = accs.find(a => a.email === primaryEmail);
      if (!prim || !prim.active) {
        if (emailListContainer) emailListContainer.innerHTML = `<div class="empty-state"><h3>Primární účet je neaktivní</h3></div>`;
        if (emailCountHeader) emailCountHeader.textContent = `Emaily pro: ${primaryEmail} (neaktivní)`;
        return;
      }

      const status = statusFilter ? statusFilter.value : 'all';
      const period = periodFilter ? periodFilter.value : 'all';
      const searchQuery = searchBar ? searchBar.value : '';
      if (resetPage) {
        currentEmailPage = 1;
      } else if (targetPage !== null) {
        const numericTarget = Number(targetPage);
        if (Number.isFinite(numericTarget) && numericTarget > 0) {
          currentEmailPage = Math.floor(numericTarget);
        }
      }

      if (!Number.isFinite(currentEmailPage) || currentEmailPage < 1) {
        currentEmailPage = 1;
      }

      const pageToRequest = currentEmailPage;

      emailListContainer.innerHTML = `<div class="empty-state"><span>📧</span><p>Načítám emaily pro ${primaryEmail}…</p></div>`;

      try {
        const accountType = (prim?.type || '').toLowerCase();
        const looksLikeGmail = /@(gmail|googlemail)\.com$/i.test(primaryEmail || '');

        let isGmailAccount = accountType === 'gmail';
        let isCustomAccount = accountType === 'custom';

        if (!accountType) {
          // Fallback heuristika: pokud není typ definován, rozliš podle domény
          isGmailAccount = looksLikeGmail;
          isCustomAccount = !looksLikeGmail;
        }

        // Bezpečný default: když nepoznáme typ, preferuj custom (neblokuje IMAP účty)
        if (!isGmailAccount && !isCustomAccount) {
          isCustomAccount = true;
        }
        let res = null;

        if (status === 'approval') {
          const [gmailPending, customPending] = await Promise.all([
            isGmailAccount ? tryGmailEmails(primaryEmail, status, period, searchQuery, pageToRequest, EMAILS_PER_PAGE) : null,
            isCustomAccount ? tryCustomPendingEmails(primaryEmail) : null
          ]);

          const sources = [gmailPending, customPending].filter(src => src && Array.isArray(src.emails));
          const combinedEmails = sources.flatMap(src => src.emails);
          combinedEmails.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
          const totalCount = sources.reduce((sum, src) => sum + (src?.total ?? (src?.emails?.length || 0)), 0);
          res = { src: 'approval', total: totalCount || combinedEmails.length, emails: combinedEmails };
        } else {
          const [gmailResult, customResult] = await Promise.all([
            isGmailAccount ? tryGmailEmails(primaryEmail, status, period, searchQuery, pageToRequest, EMAILS_PER_PAGE) : null,
            isCustomAccount ? tryCustomEmails(primaryEmail, status, period, searchQuery, pageToRequest, EMAILS_PER_PAGE) : null
          ]);

          if (gmailResult && Array.isArray(gmailResult.emails)) {
            res = gmailResult;
          }

          if ((!res || !Array.isArray(res.emails) || res.emails.length === 0) && customResult && Array.isArray(customResult.emails)) {
            res = customResult;
          }
        }

        if (!res || !Array.isArray(res.emails)) {
          throw new Error('Nepodařilo se načíst emaily.');
        }

        const normalizedStatus = String(status || 'all').toLowerCase();
        const rawEmails = Array.isArray(res.emails) ? res.emails : [];

        const mappedEmails = rawEmails.map(email => {
          if (normalizedStatus === 'spam' && !isSpamEmail(email)) {
            return { ...email, status: 'spam' };
          }
          if (normalizedStatus !== 'spam' && isSpamEmail(email)) {
            // spam zprávy rovnou považuj za přečtené, aby se nepletly v nepřečtených filtrech
            return { ...email, unread: false };
          }
          return email;
        });

        let filteredEmails = mappedEmails;
        if (normalizedStatus !== 'spam') {
          filteredEmails = filteredEmails.filter(email => !isSpamEmail(email));
        }

        if (normalizedStatus === 'unread') {
          filteredEmails = filteredEmails.filter(email => email.unread === true);
        } else if (normalizedStatus === 'processed') {
          filteredEmails = filteredEmails.filter(email => email.unread === false);
        }

        allEmails = filteredEmails.map(email => ({
          ...email,
          account: email.account || primaryEmail
        }));

        lastEmailTotal = Number(res.total ?? filteredEmails.length ?? 0);

        if (!Number.isFinite(lastEmailTotal) || lastEmailTotal < allEmails.length) {
          lastEmailTotal = allEmails.length;
        }

        currentEmailPage = Math.max(1, pageToRequest);

        if (emailCountHeader) {
          const total = lastEmailTotal;
          const countStr = total > 0 ? ` (${total})` : '';
          if (status === 'approval') {
            emailCountHeader.textContent = `Čekající odpovědi pro: ${primaryEmail}${countStr}`;
          } else {
            emailCountHeader.textContent = `Emaily pro: ${primaryEmail}${countStr}`;
          }
        }

        const totalPages = Math.max(1, Math.ceil(lastEmailTotal / EMAILS_PER_PAGE));
        if (currentEmailPage > totalPages) {
          currentEmailPage = totalPages;
          if (currentEmailPage !== pageToRequest) {
            return fetchEmails({ targetPage: currentEmailPage });
          }
        }

        renderEmailList(allEmails, lastEmailTotal);
      } catch (e) {
        emailListContainer.innerHTML = `<div class="empty-state"><h3>${e.message || 'Chyba načítání'}</h3></div>`;
      }
    }





    async function hydrateSecurityTab() {
      const email = localStorage.getItem('userEmail');
      if (!email) return;

      // Zjistí, jestli má uživatel heslo
      try {
        const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/auth/has-password?email=${encodeURIComponent(email)}`);
        const j = await r.json();
        const hasPass = !!j?.hasPassword;

        const curEl = document.getElementById('cur-pass');
        if (curEl) {
          // Pokud heslo nemá (Google-only), pole pro současné heslo skryj
          curEl.parentElement.style.display = hasPass ? '' : 'none';
        }
      } catch (e) {
        // Když se check nepovede, nic hrozného – nech vše viditelné
      }
    }



    async function loadTemplates() {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const list = document.getElementById('tpl-list');
      if (!list || !dashboardUserEmail) return;

      list.innerHTML = '<div style="color:#94a3b8;text-align:center;">Načítám šablony…</div>';

      try {
        const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
        const j = await r.json();
        if (!j.success) throw new Error(j.message || 'Chyba načítání');
        renderTemplateList(j.templates || []);
      } catch (e) {
        list.innerHTML = `<div style="color:#dc2626;text-align:center;">${e.message || 'Nepodařilo se načíst šablony.'}</div>`;
      }
    }





    function renderTemplateList(templates = []) {
      const countEl = document.getElementById('tpl-count');
      if (countEl) countEl.textContent = templates.length;
      const list = document.getElementById('tpl-list');
      if (!list) return;

      if (!templates.length) {
        list.innerHTML = '<div style="color:#94a3b8; text-align:center; padding: 2rem;">Zatím nemáte vytvořené žádné šablony.</div>';
        return;
      }

      list.innerHTML = ''; // Vyčistíme starý obsah
      templates.forEach(tpl => {
        const uses = Number(tpl.uses ?? 0);
        const success = Number(tpl.success_rate ?? 0);
        const content = String(tpl.content ?? '');

        const card = document.createElement('div');
        card.className = 'template-card';
        card.innerHTML = `
            <div class="template-header">
                <div class="template-name">${escapeHtml(tpl.name || 'Bez názvu')}</div>
                <div class="template-actions">
                    <button class="action-btn" data-act="edit">✏️ Upravit</button>
                    <button class="action-btn reject" data-act="delete" style="background: #fef2f2; color: #dc2626;">🗑️ Smazat</button>
                </div>
            </div>
            <div class="template-preview">${escapeHtml(content).slice(0, 150)}${content.length > 150 ? '…' : ''}</div>
            <div class="template-stats">
                <span>Použito: ${uses}×</span>
                <span>Úspěšnost: ${success.toFixed(0)}%</span>
            </div>
        `;
        // Přidáme listener na celou kartu, který bude delegovat kliknutí na tlačítka
        card.addEventListener('click', (evt) => onTemplateCardClick(evt, tpl));
        list.appendChild(card);
      });
    }

    function extractEmailAddress(s = '') {
      // 1) odescapuj případné &lt; a &gt; apod.
      const txt = document.createElement('textarea');
      txt.innerHTML = String(s);
      const unescaped = txt.value;

      // 2) pokus o <email> tvar
      const m = unescaped.match(/<\s*([^>]+)\s*>/);
      if (m) return m[1].trim();

      // 3) fallback: najdi první výskyt něco@něco.tld ve stringu
      const m2 = unescaped.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
      if (m2) return m2[0].trim();

      // 4) poslední možnost – vrať ořezaný text
      return unescaped.trim();
    }




    function escapeHtml(s = '') { return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

    let __analysisWasOpen = false;


    // --- Template Picker modal (ponechat jen jednu verzi) ---
    function openTemplatePicker() {
      const el = document.getElementById('templatePicker');
      if (!el) return;

      const a = document.getElementById('analysisModal');
      __analysisWasOpen = a?.classList.contains('show');
      if (__analysisWasOpen) a.classList.remove('show');  // dočasně schovej analýzu

      el.classList.add('show');
      document.body.style.overflow = 'hidden';
      refreshPickerList();
    }

    function closeTemplatePicker() {
      const el = document.getElementById('templatePicker');
      if (!el) return;

      el.classList.remove('show');
      document.body.style.overflow = '';

      if (__analysisWasOpen) {
        document.getElementById('analysisModal')?.classList.add('show'); // vrať analýzu
        __analysisWasOpen = false;
      }
    }

    async function refreshPickerList() {
      const list = document.getElementById('tplPickerList');
      const q = (document.getElementById('tplSearch')?.value || '').trim().toLowerCase();
      const cat = document.getElementById('tplCategory')?.value || 'Vše';
      list.innerHTML = 'Načítám…';

      try {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const url = new URL('https://ai-email-server-stejdesign.onrender.com/api/templates');
        url.searchParams.set('dashboardUserEmail', dashboardUserEmail);

        const r = await fetch(url.toString());
        const j = await r.json();
        if (!j.success) throw new Error(j.message || 'Chyba při načítání.');

        let items = j.templates || [];
        if (cat && cat !== 'Vše') items = items.filter(t => (t.category || 'Obecné') === cat);
        if (q) items = items.filter(t =>
          String(t.name || '').toLowerCase().includes(q) ||
          String(t.content || '').toLowerCase().includes(q)
        );

        if (!items.length) { list.innerHTML = '<div style="color:#94a3b8;">Žádné šablony</div>'; return; }

        list.innerHTML = '';
        for (const t of items) {
          const uses = Number(t.uses ?? 0);
          const success = Number(t.success_rate ?? 0);
          const content = String(t.content ?? '');
          const card = document.createElement('div');
          card.className = 'template-card';
          card.innerHTML = `
        <div class="template-header">
          <div class="template-name">${escapeHtml(String(t.name ?? 'Bez názvu'))}</div>
          <div class="template-actions">
            <button class="action-btn" data-use="${t.id}">📋 Použít</button>
          </div>
        </div>
        <div class="template-preview">${escapeHtml(content).slice(0, 220)}${content.length > 220 ? '…' : ''}</div>
        <div class="template-stats">
          <span>Použito: ${Number.isFinite(uses) ? uses : 0}×</span>
          <span>Úspěšnost: ${Number.isFinite(success) ? success.toFixed(0) : '0'}%</span>
        </div>`;
          card.addEventListener('click', (e) => {
            if (e.target.closest('[data-use]')) { useTemplate(t); closeTemplatePicker(); }
          });
          list.appendChild(card);
        }
      } catch (e) {
        list.innerHTML = `<div style="color:#dc2626;">${e.message || 'Nepodařilo se načíst šablony.'}</div>`;
      }
    }







    function onTemplateCardClick(evt, tpl) {

      const btn = evt.target.closest('[data-act]');
      if (!btn) return;
      const act = btn.dataset.act;

      if (act === 'delete') return deleteTemplate(tpl.id);
      if (act === 'edit') return startEditTemplate(tpl);
      if (act === 'use') return useTemplate(tpl);
    }

    async function createTemplate() {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const name = document.getElementById('tpl-name').value.trim();
      const category = document.getElementById('tpl-category').value.trim();
      const content = document.getElementById('tpl-content').value.trim();
      if (!name || !content) { showToast('Vyplň jméno a obsah šablony.', 'warning'); return; }

      try {
        const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/templates', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dashboardUserEmail, name, category, content })
        });
        const j = await r.json();
        if (!j.success) throw new Error(j.message || 'Nepodařilo se uložit');
        showToast('Šablona uložena.', 'success');
        document.getElementById('tpl-name').value = '';
        document.getElementById('tpl-content').value = '';
        loadTemplates();
      } catch (e) { showToast(e.message || 'Chyba při ukládání', 'error'); }
    }

    function startEditTemplate(tpl) {
      document.getElementById('tpl-name').value = tpl.name;
      document.getElementById('tpl-category').value = tpl.category || 'Obecné';
      document.getElementById('tpl-content').value = tpl.content;

      const btn = document.getElementById('tpl-save-btn');
      btn.textContent = '💾 Uložit změny';
      btn.dataset.editingId = tpl.id;
    }

    async function saveEditedTemplate(id) {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const name = document.getElementById('tpl-name').value.trim();
      const category = document.getElementById('tpl-category').value.trim();
      const content = document.getElementById('tpl-content').value.trim();
      if (!name || !content) { showToast('Vyplň jméno a obsah šablony.', 'warning'); return; }

      try {
        const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${id}`, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dashboardUserEmail, name, category, content })
        });
        const j = await r.json();
        if (!j.success) throw new Error(j.message || 'Nepodařilo se upravit');
        showToast('Šablona upravena.', 'success');
        const btn = document.getElementById('tpl-save-btn');
        btn.textContent = '💾 Uložit šablonu';
        delete btn.dataset.editingId;
        document.getElementById('tpl-name').value = '';
        document.getElementById('tpl-content').value = '';
        loadTemplates();
      } catch (e) { showToast(e.message || 'Chyba při úpravě', 'error'); }
    }

    async function deleteTemplate(id) {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      if (!confirm('Opravdu smazat šablonu?')) return;
      try {
        const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${id}?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`, { method: 'DELETE' });
        const j = await r.json();
        if (!j.success) throw new Error(j.message || 'Nepodařilo se smazat');
        showToast('Šablona smazána.', 'success');
        loadTemplates();
      } catch (e) { showToast(e.message || 'Chyba při mazání', 'error'); }
    }




    async function changePasswordSubmit() {
      const email = localStorage.getItem('userEmail');
      if (!email) { showToast('Nejste přihlášen.', 'error'); return; }

      const curPass = document.getElementById('cur-pass')?.value || '';
      const newPass = document.getElementById('new-pass')?.value || '';
      const newPass2 = document.getElementById('new-pass2')?.value || '';

      if (!newPass || !newPass2) {
        showToast('Vyplňte nové heslo a potvrzení.', 'warning');
        return;
      }
      if (newPass !== newPass2) {
        showToast('Nová hesla se neshodují.', 'error');
        return;
      }

      try {
        const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            currentPassword: curPass,         // u Google-only bude prázdný – backend to zvládá
            newPassword: newPass,
            newPasswordConfirm: newPass2
          })
        });
        const j = await r.json();
        if (!j.success) {
          showToast(j.message || 'Změna hesla selhala.', 'error');
          return;
        }
        showToast(j.message || 'Heslo změněno. Přihlaste se znovu.', 'success');
        // pro jistotu odhlásit a nechat znovu přihlásit
        setTimeout(() => {
          localStorage.clear();
          window.location.href = 'login.html';
        }, 1200);
      } catch (e) {
        showToast('Nepodařilo se komunikovat se serverem.', 'error');
      }
    }




    // --- Helpers pro šablony ----
    function escapeHtml(s = '') { return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }



    // --- Grid šablon na stránce /Templates (pokud ho používáš) ---

    function onTemplateCardClick(evt, tpl) {
      const btn = evt.target.closest('[data-act]');
      if (!btn) return;
      const act = btn.dataset.act;
      if (act === 'delete') return deleteTemplate(tpl.id);
      if (act === 'edit') return startEditTemplate(tpl);
      if (act === 'use') return useTemplate(tpl);
    }





    // napojení handlerů (v tvém DOMContentLoaded):
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btn-change-pass');
      if (btn) btn.addEventListener('click', changePasswordSubmit);

      // Když uživatel otevře záložku „Zabezpečení“, načti stav:
      const securityTab = document.querySelector('.settings-tab[data-tab="security"]');
      if (securityTab) {
        securityTab.addEventListener('click', () => {
          setTimeout(hydrateSecurityTab, 0);
        });
      }
      // Nebo rovnou při loadu:
      hydrateSecurityTab();

      const pickTplBtn = document.getElementById('pick-template-btn');
      if (pickTplBtn) pickTplBtn.addEventListener('click', openTemplatePicker);

      const tplPicker = document.getElementById('templatePicker');
      tplPicker?.addEventListener('click', (e) => {
        if (e.target === tplPicker) closeTemplatePicker();
      });
      document.getElementById('closeTemplatePicker')?.addEventListener('click', closeTemplatePicker);
      document.getElementById('cancelTplPicker')?.addEventListener('click', closeTemplatePicker);
      document.getElementById('tplSearch')?.addEventListener('input', refreshPickerList);
      document.getElementById('tplCategory')?.addEventListener('change', refreshPickerList);
    });





    function isSpamEmail(email = {}) {
      const status = String(email.status || '').toLowerCase();
      const folder = String(email.folder || email.label || email._folder || '').toLowerCase();
      const labels = Array.isArray(email.labels) ? email.labels : Array.isArray(email.labelIds) ? email.labelIds : [];
      const labelsContainSpam = labels.some(l => String(l).toLowerCase().includes('spam'));
      return status === 'spam' || folder === 'spam' || email.isSpam === true || labelsContainSpam;
    }




    function renderEmailList(emails, total) {







      if (!emailListContainer) return;
      const safeEmails = Array.isArray(emails) ? emails : [];
      const currentStatusFilter = document.getElementById('status-filter')?.value;
      const isApprovalView = currentStatusFilter === 'approval';

      const numericTotal = Number(total);
      const totalCount = Number.isFinite(numericTotal)
        ? Math.max(numericTotal, safeEmails.length)
        : safeEmails.length;

      if (!safeEmails.length) {
        emailListContainer.innerHTML = `<div class="empty-state"><h3>Nebyly nalezeny žádné emaily</h3><p>Zkuste změnit filtry nebo vyhledávání.</p></div>`;
        if (paginationContainer) {
          paginationContainer.innerHTML = '';
          paginationContainer.style.display = 'none';
        }
        return;
      }

      const totalPages = Math.max(1, Math.ceil(totalCount / EMAILS_PER_PAGE));
      if (currentEmailPage > totalPages) currentEmailPage = totalPages;

      let pageEmails = safeEmails;
      let startIndex = (currentEmailPage - 1) * EMAILS_PER_PAGE + 1;
      if (isApprovalView) {
        const sliceStart = (currentEmailPage - 1) * EMAILS_PER_PAGE;
        pageEmails = safeEmails.slice(sliceStart, sliceStart + EMAILS_PER_PAGE);
        startIndex = sliceStart + 1;
      }
      const endIndex = Math.min(startIndex + (pageEmails.length ? pageEmails.length - 1 : 0), totalCount);

      emailListContainer.innerHTML = '';

      pageEmails.forEach(email => {
        const sender = (email.sender || '').split('<')[0].trim().replace(/"/g, '') || email.sender;
        const pendingIdValue = email.pendingId ?? null;
        const pendingIdAttr = pendingIdValue !== null && pendingIdValue !== undefined ? escapeHtml(String(pendingIdValue)) : '';
        const srcAttr = escapeHtml(email._src || 'gmail');

        // Dynamické přidání schvalovacích tlačítek
        const actionButtons = isApprovalView
          ? `<div class="approval-actions" style="margin-top: 8px; display: flex; gap: 8px;">
                <button class="btn btn-success btn-sm approve-btn" data-pending-id="${pendingIdAttr}" data-src="${srcAttr}">✅ Schválit</button>
                <button class="btn btn-danger btn-sm reject-btn" data-pending-id="${pendingIdAttr}" data-src="${srcAttr}">❌ Zamítnout</button>
              </div>`
          : `<div class="list-action-group">
             <button class="btn btn-primary analyze-btn" data-message-id="${email.id}" type="button">Analyzovat 🤖</button>
             <button class="btn quick-ai-btn" data-message-id="${email.id}" type="button">AI odpověď ✨</button>
           </div>`;
        const replyPreviewRaw = (email.replyBody || '').trim();
        const replyPreview = replyPreviewRaw ? replyPreviewRaw.slice(0, 180) + (replyPreviewRaw.length > 180 ? '…' : '') : '';
        const summaryText = (email.summary || email.snippet || '').trim();
        const badge = email._pending
          ? `<div class="status-badge" style="display:inline-flex; align-items:center; gap:6px; background:#fef3c7; color:#92400e; font-weight:600; padding:2px 8px; border-radius:999px; margin-bottom:6px; font-size:0.8rem;">⏳ Čeká na schválení</div>`
          : '';

        const preview = isApprovalView
          ? `
            <div class="email-preview">${escapeHtml(summaryText || '(bez shrnutí)')}</div>
            <div class="email-preview" style="margin-top:4px; color:#475569;">AI odpověď: ${escapeHtml(replyPreview || '(bez návrhu)')}</div>
          `
          : `<div class="email-preview">${escapeHtml(email.snippet || '')}</div>`;

        const datasetParts = [
          `data-id="${escapeHtml(email.id || '')}"`,
          `data-src="${srcAttr}"`,
          `data-from="${escapeHtml(email.sender || '')}"`
        ];
        if (email.replyTo) datasetParts.push(`data-reply-to="${escapeHtml(email.replyTo)}"`);
        if (email.originalFrom) datasetParts.push(`data-from-original="${escapeHtml(email.originalFrom)}"`);
        const accountValue = email.account || localStorage.getItem('primaryEmail') || '';
        if (accountValue) datasetParts.push(`data-account="${escapeHtml(accountValue)}"`);
        if (pendingIdValue !== null && pendingIdValue !== undefined) datasetParts.push(`data-pending-id="${pendingIdAttr}"`);
        if (email.messageId) datasetParts.push(`data-message-id="${escapeHtml(email.messageId)}"`);
        if (email._pending) datasetParts.push('data-pending="1"');
        const isUnread = email.unread === true && !email._pending;
        if (isUnread) datasetParts.push('data-unread="1"');

        const emailHTML = `
              <div class="email-item ${isUnread ? 'unread' : ''}" ${datasetParts.join(' ')}>
                  <div class="email-content" style="flex-grow: 1;">
                      ${badge}
                      <div class="email-sender">${escapeHtml(sender)}</div>
                      <div class="email-subject">${escapeHtml(email.subject || '(bez předmětu)')}</div>
                      ${preview}
                  </div>
                  <div class="email-meta" style="text-align: right; flex-shrink: 0;">
                      <div>${new Date(email.date).toLocaleDateString('cs-CZ')}</div>
                      ${actionButtons}
                  </div>
              </div>`;
        emailListContainer.insertAdjacentHTML('beforeend', emailHTML);
      });

      renderPagination(totalPages, startIndex, endIndex, totalCount);
    }

    function renderPagination(totalPages, startIndex, endIndex, totalRecords) {
      if (!paginationContainer) return;

      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        paginationContainer.style.display = 'none';
        return;
      }

      const safeTotal = Math.max(totalRecords || 0, endIndex);
      const infoText = `Zobrazeno ${startIndex}-${endIndex} z ${safeTotal} emailů`;
      const prevPage = currentEmailPage > 1 ? currentEmailPage - 1 : 1;
      const nextPage = currentEmailPage < totalPages ? currentEmailPage + 1 : totalPages;

      let buttons = `
    <button class="pagination-button${currentEmailPage === 1 ? ' disabled' : ''}" data-page="${prevPage}" ${currentEmailPage === 1 ? 'disabled' : ''}>‹</button>
  `;

      for (let i = 1; i <= totalPages; i++) {
        buttons += `<button class="pagination-button${i === currentEmailPage ? ' active' : ''}" data-page="${i}">${i}</button>`;
      }

      buttons += `
    <button class="pagination-button${currentEmailPage === totalPages ? ' disabled' : ''}" data-page="${nextPage}" ${currentEmailPage === totalPages ? 'disabled' : ''}>›</button>
  `;

      paginationContainer.innerHTML = `
    <div class="pagination-info">${infoText}</div>
    <div class="pagination-buttons">${buttons}</div>
  `;
      paginationContainer.style.display = '';
    }

    paginationContainer?.addEventListener('click', (event) => {
      const btn = event.target.closest('.pagination-button');
      if (!btn || btn.disabled) return;

      const requested = Number(btn.dataset.page);
      if (!Number.isFinite(requested) || requested < 1) return;

      const totalPages = Math.max(1, Math.ceil(Math.max(lastEmailTotal, allEmails?.length || 0) / EMAILS_PER_PAGE));
      const nextPage = Math.min(Math.max(requested, 1), totalPages);
      if (nextPage === currentEmailPage) return;

      fetchEmails({ targetPage: nextPage }).catch(err => console.error('Pagination fetch error:', err));

      try {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (_) {
        window.scrollTo(0, 0);
      }
    });

    function renderPendingPreview(entry) {
      const card = document.getElementById('ed-ai-card');
      const summaryEl = document.getElementById('ed-ai-summary');
      const sentimentEl = document.getElementById('ed-ai-sentiment');
      const replyEl = document.getElementById('ed-ai-reply');

      if (!card || !summaryEl || !sentimentEl || !replyEl) return;

      if (!entry || !entry._pending) {
        card.style.display = 'none';
        summaryEl.textContent = '—';
        sentimentEl.textContent = '—';
        replyEl.textContent = '';
        return;
      }

      card.style.display = '';
      summaryEl.textContent = entry.summary || '(bez shrnutí)';
      sentimentEl.textContent = entry.sentiment || '(neuvedeno)';
      replyEl.textContent = entry.replyBody || '';
    }




    // --- Akce schválení/odmítnutí pro maily v režimu "Čekající" ---
    document.getElementById('email-list-container')?.addEventListener('click', async (e) => {
      const approveBtn = e.target.closest('.approve-btn');
      const rejectBtn = e.target.closest('.reject-btn');
      if (!approveBtn && !rejectBtn) return;

      const row = e.target.closest('.email-item');
      const pendingIdRaw = approveBtn?.dataset.pendingId
        || rejectBtn?.dataset.pendingId
        || row?.dataset.pendingId;
      let pendingId = pendingIdRaw !== undefined && pendingIdRaw !== null
        ? String(pendingIdRaw).trim()
        : '';

      if (!pendingId && row) {
        const rowId = row.dataset.id || row.dataset.messageId || '';
        const fallbackEntry = findEmailEntryById(rowId || '', '');
        if (fallbackEntry?.pendingId) {
          pendingId = String(fallbackEntry.pendingId).trim();
        }
      }
      const src = approveBtn?.dataset.src
        || rejectBtn?.dataset.src
        || row?.dataset.src
        || 'gmail';

      const dashboardUserEmail = localStorage.getItem('userEmail');
      const accountEmail = localStorage.getItem('primaryEmail');

      const triggerBtn = approveBtn || rejectBtn;

      try {
        if (!pendingId) throw new Error('Chybí ID návrhu.');
        if (!dashboardUserEmail || !accountEmail) throw new Error('Chybí kontext účtu.');
        if (!['gmail', 'custom'].includes(src)) throw new Error('Nepodporovaný typ účtu.');

        if (triggerBtn) triggerBtn.disabled = true;

        const endpoint = approveBtn ? 'approve' : 'reject';
        const url = src === 'custom'
          ? `${window.BACKEND}/api/custom-email/pending-replies/${encodeURIComponent(pendingId)}/${endpoint}`
          : `${window.BACKEND}/api/gmail/pending-replies/${encodeURIComponent(pendingId)}/${endpoint}`;

        const payload = src === 'custom'
          ? { dashboardUserEmail, emailAddress: accountEmail }
          : { dashboardUserEmail, email: accountEmail };

        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok || !j.success) throw new Error(j.message || 'Akce selhala.');

        showToast(j.message || (approveBtn ? 'Odpověď byla odeslána.' : 'Návrh byl zamítnut.'), 'success');
        await fetchEmails();
      } catch (err) {
        showToast(err.message || 'Chyba akce.', 'error');
      } finally {
        if (triggerBtn) triggerBtn.disabled = false;
      }
    });












    // ZMĚNA: Funkce nyní načítá nastavení pro aktuálně vybraný primární email
    async function loadSettings() {
      const primaryEmail = localStorage.getItem('primaryEmail');
      if (!primaryEmail) {
        showToast('Není vybrán žádný účet pro nastavení.', 'warning');
        return;
      }

      console.log(`Načítám nastavení pro: ${primaryEmail}`);
      try {
        const response = await fetch(
          `https://ai-email-server-stejdesign.onrender.com/api/settings` +
          `?email=${encodeURIComponent(primaryEmail)}` +
          `&dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`
        );
        const data = await response.json();
        if (data.success && data.settings) {
          const { tone, length, signature, auto_reply, approval_required, spam_filter } = data.settings;
          toneSelect.value = tone;
          lengthSelect.value = length;
          signatureTextarea.value = signature;
          autoReplySwitch.checked = auto_reply;
          approvalSwitch.checked = approval_required;
          spamFilterSwitch.checked = spam_filter;
          showToast(`Nastavení pro ${primaryEmail} bylo načteno.`, 'success');
          window.CURRENT_SETTINGS = data.settings;
        } else {
          // Pokud pro daný email nastavení neexistuje, resetujeme formulář do výchozího stavu
          settingsForm.reset();
          showToast(`Pro ${primaryEmail} zatím nebylo uloženo žádné nastavení.`, 'info');
        }
      } catch (error) { showToast('Nepodařilo se načíst nastavení.', 'error'); }
    }

    // ZMĚNA: Funkce ukládá nastavení pro aktuálně vybraný primární email
    async function saveSettings(event) {
      event.preventDefault();
      const primaryEmail = localStorage.getItem('primaryEmail');
      if (!primaryEmail) {
        showToast('Není vybrán žádný účet, pro který by se mělo nastavení uložit.', 'error');
        return;
      }

      const settings = {
        dashboardUserEmail,
        email: primaryEmail,
        tone: toneSelect.value,
        length: lengthSelect.value,
        signature: signatureTextarea.value,
        auto_reply: autoReplySwitch.checked,
        approval_required: approvalSwitch.checked,
        spam_filter: spamFilterSwitch.checked
      };
      try {
        const response = await fetch('https://ai-email-server-stejdesign.onrender.com/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        const data = await response.json();
        showToast(data.success ? data.message : `Chyba: ${data.message}`, data.success ? 'success' : 'error');
      } catch (error) { showToast('Nepodařilo se uložit nastavení.', 'error'); }
    }



    async function loadPlan() {
      const userEmail = localStorage.getItem('userEmail');
      if (!userEmail) return;

      try {
        const res = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/user/plan?email=${encodeURIComponent(userEmail)}`);
        const data = await res.json();
        if (data.success && data.plan) {
          // zaškrtnout správný radio
          const input = document.querySelector(`.plan-input[value="${data.plan}"]`);
          if (input) input.checked = true;
          // badge
          const badge = document.getElementById('current-plan-badge');
          if (badge) badge.textContent = `Aktuální: ${data.plan}`;
        }
      } catch (err) {
        console.error('Nepodařilo se načíst plán:', err);
      }
    }

    async function savePlan() {
      const userEmail = localStorage.getItem('userEmail');
      const selected = document.querySelector('.plan-input:checked');
      if (!userEmail || !selected) { showToast('Vyberte tarif.', 'warning'); return; }

      try {
        const res = await fetch('https://ai-email-server-stejdesign.onrender.com/api/user/plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: userEmail, plan: selected.value })
        });
        const data = await res.json();
        showToast(data.message, data.success ? 'success' : 'error');
        if (data.success) {
          const badge = document.getElementById('current-plan-badge');
          if (badge) badge.textContent = `Aktuální: ${selected.value}`;
        }
      } catch (err) {
        showToast('Nepodařilo se uložit plán.', 'error');
      }
    }


    async function loadLimits() {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      if (!dashboardUserEmail) return;

      const panel = document.getElementById('usage-panel');
      try {
        const res = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/limits?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
        const data = await res.json();
        if (!data.success) throw new Error('Nepodařilo se načíst limity');

        // AI akce
        const used = data.ai_actions_used ?? 0;
        const limit = data.monthly_ai_actions ?? 0;
        const left = Math.max(0, limit - used);
        const pctAI = limit > 0 ? Math.min(100, Math.round((used / limit) * 100)) : 0;

        document.getElementById('ai-used').textContent = used;
        document.getElementById('ai-limit').textContent = limit;
        document.getElementById('ai-left').textContent = left;
        document.getElementById('ai-bar').style.width = pctAI + '%';

        // Připojené účty
        const accLimit = data.max_accounts ?? 0;
        const accCount = await getConnectedAccountsCount(dashboardUserEmail);
        const pctAcc = accLimit > 0 ? Math.min(100, Math.round((accCount / accLimit) * 100)) : 0;

        document.getElementById('acc-count').textContent = accCount;
        document.getElementById('acc-limit').textContent = accLimit;
        document.getElementById('acc-bar').style.width = pctAcc + '%';

        // Období
        document.getElementById('usage-period').textContent =
          `Období: od ${data.period_start} (UTC) | Tarif: ${data.plan}`;

        panel.style.display = 'block';
      } catch (e) {
        console.error(e);
        if (panel) panel.style.display = 'none';
      }
    }

    async function getConnectedAccountsCount(dashboardUserEmail) {
      try {
        const r = await fetch(`https://ai-email-server-stejdesign.onrender.com/api/accounts?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
        const j = await r.json();
        if (j.success) {
          const arr = Array.isArray(j.accounts) ? j.accounts : (j.emails || []).map(e => ({ email: e, active: true }));
          return Array.isArray(arr) ? arr.length : 0;
        }
      } catch (_) { }
      return 0;
    }



    function enterEditMode() {
      const view = document.getElementById('response-display');
      const edit = document.getElementById('response-editor');
      if (view && edit) {
        edit.value = (view.innerText || '').trim();
        view.style.display = 'none';
        edit.style.display = 'block';
        edit.focus();
      }
      document.getElementById('edit-reply-btn')?.style.setProperty('display', 'none');
      document.getElementById('save-edit-btn')?.style.setProperty('display', 'inline-flex');
      document.getElementById('cancel-edit-btn')?.style.setProperty('display', 'inline-flex');
    }

    function exitEditMode(saveChanges) {
      const view = document.getElementById('response-display');
      const edit = document.getElementById('response-editor');
      if (saveChanges && view && edit) {
        view.innerText = edit.value;
        showToast('Odpověď byla upravena.', 'success');
      }
      if (view && edit) {
        view.style.display = 'block';
        edit.style.display = 'none';
      }
      document.getElementById('edit-reply-btn')?.style.setProperty('display', 'inline-flex');
      document.getElementById('save-edit-btn')?.style.setProperty('display', 'none');
      document.getElementById('cancel-edit-btn')?.style.setProperty('display', 'none');
    }


    // ===================================================================================
    // === 3. FUNKCE PRO SPRÁVU EMAILOVÝCH ÚČTŮ ==========================================
    // ===================================================================================

    // ZMĚNA: Funkce nyní zvýrazní primární účet podle localStorage
    function renderConnectedAccounts() {
      const listEl = document.querySelector('#email-settings .email-list');
      if (!listEl) return;

      const accs = getConnectedAccounts(); // [{email, active}]
      const primary = localStorage.getItem('primaryEmail'); // primary klidně necháme v LS

      listEl.innerHTML = '';

      if (accs.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#6b7280;padding:2rem;">Zatím nemáte připojený žádný emailový účet.</p>';
        const span = document.getElementById('currentConfigEmail');
        if (span) span.textContent = 'Žádný';
        return;
      }

      accs.forEach(({ email, active, type }) => {
        let providerName = 'Vlastní', providerIconClass = 'gmail-icon';
        const e = email.toLowerCase();
        if (e.includes('gmail')) providerName = 'Gmail';
        else if (e.includes('outlook') || e.includes('hotmail')) { providerName = 'Outlook'; providerIconClass = 'outlook-icon'; }
        else if (e.includes('seznam')) providerName = 'Seznam';

        const isSelectedForConfig = (email === primary);

        const html = `
      <div class="email-item ${active ? 'active' : ''}" data-email="${email}" data-type="${type || ''}">
        <div class="checkbox-wrapper" onclick="toggleAccount(this,'${email}',${!!active})">
          <input type="checkbox" class="checkbox-input" ${active ? 'checked' : ''}>
          <div class="checkbox-custom"></div>
        </div>
        <div class="email-info">
          <div class="email-address">${email}</div>
          <div class="email-provider">
            <div class="provider-icon ${providerIconClass}"></div>
            ${providerName} • Připojen
          </div>
        </div>
        <div class="email-controls">
          <div class="status-badge ${active ? 'active' : ''}">${active ? '🤖 Aktivní' : 'Neaktivní'}</div>
          <div class="radio-wrapper ${isSelectedForConfig ? 'selected' : ''}" onclick="selectForConfig(this, '${email}')">
            <input type="radio" name="configEmail" value="${email}" class="radio-input" ${isSelectedForConfig ? 'checked' : ''}>
            <div class="radio-custom"></div>
            <span class="radio-label">Nastavit</span>
          </div>
          <button class="disconnect-btn" onclick="disconnectAccount('${email}', '${type || ''}' )" title="Odpojit účet">
            <span class="disconnect-icon">×</span>
          </button>
        </div>
      </div>`;
        listEl.insertAdjacentHTML('beforeend', html);
      });

      const span = document.getElementById('currentConfigEmail');
      if (span) span.textContent = primary || 'Žádný';
    }

    async function setAllAccountsActive(targetState) {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      if (!dashboardUserEmail) {
        showToast('Nejste přihlášen.', 'error');
        return;
      }

      const accounts = getConnectedAccounts();
      if (!accounts.length) {
        showToast('Nemáte připojené žádné emailové účty.', 'info');
        return;
      }

      const buttons = document.querySelectorAll('#email-settings .bulk-btn');
      buttons.forEach(btn => btn.setAttribute('disabled', 'disabled'));

      const failed = [];

      try {
        for (const { email } of accounts) {
          try {
            const response = await fetch('https://ai-email-server-stejdesign.onrender.com/api/accounts/set-active', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ dashboardUserEmail, email, active: targetState })
            });
            const result = await response.json();
            if (!result.success) {
              failed.push(email);
            }
          } catch (_) {
            failed.push(email);
          }
        }

        const accs = await syncConnectedEmails();
        renderConnectedAccounts();

        const prim = localStorage.getItem('primaryEmail');
        const primObj = accs.find(a => a.email === prim);

        if (!primObj || !primObj.active) {
          if (emailListContainer) {
            emailListContainer.innerHTML = `<div class="empty-state"><h3>Primární účet je neaktivní</h3><p>Pro načtení emailů ho aktivujte v Nastavení → Email účty.</p></div>`;
            if (emailCountHeader) emailCountHeader.textContent = 'Emaily';
          }
        } else {
          const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
          if (emailsPageActive) fetchEmails();
        }

        if (failed.length) {
          showToast(`Některé účty se nepodařilo aktualizovat: ${failed.join(', ')}`, 'error');
        } else {
          showToast(targetState ? 'Všechny účty byly aktivovány.' : 'Všechny účty byly deaktivovány.', 'success');
        }
      } catch (error) {
        showToast('Nepodařilo se změnit stav účtů.', 'error');
      } finally {
        buttons.forEach(btn => btn.removeAttribute('disabled'));
      }
    }

    async function enableAllAccounts() {
      await setAllAccountsActive(true);
    }

    async function disableAllAccounts() {
      await setAllAccountsActive(false);
    }

    // ZMĚNA: Funkce nyní uloží výběr a znovu načte nastavení
    function selectForConfig(radioWrapper, email) {
      // Uložíme nový primární email do localStorage
      localStorage.setItem('primaryEmail', email);

      // Vizuální aktualizace
      document.querySelectorAll('#email-settings .radio-wrapper').forEach(wrapper => wrapper.classList.remove('selected'));
      radioWrapper.classList.add('selected');
      radioWrapper.querySelector('.radio-input').checked = true;
      document.getElementById('currentConfigEmail').textContent = email;

      // NOVÉ: Okamžitě načteme nastavení pro nově vybraný účet
      loadSettings();
      fetchEmails();
    }

    async function toggleAccount(wrapper, email, currentActive) {
      const checkbox = wrapper.querySelector('.checkbox-input');
      // optimisticky otočíme hodnotu
      const newActive = !currentActive;
      checkbox.checked = newActive;

      try {
        const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/accounts/set-active', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dashboardUserEmail, email, active: newActive })
        });
        const j = await r.json();
        if (!j.success) throw new Error(j.message || 'Nepodařilo se uložit.');

        // refresh listu ze serveru (pravda je na serveru)
        const accs = await syncConnectedEmails();
        renderConnectedAccounts();

        // pokud jsi vypnul právě primární účet → zamez načítání emailů
        const prim = localStorage.getItem('primaryEmail');
        const primObj = accs.find(a => a.email === prim);
        if (!primObj || !primObj.active) {
          if (emailListContainer) {
            emailListContainer.innerHTML = `<div class="empty-state"><h3>Primární účet je neaktivní</h3><p>Pro načtení emailů ho aktivujte v Nastavení → Email účty.</p></div>`;
            if (emailCountHeader) emailCountHeader.textContent = 'Emaily';
          }
        } else {
          // pokud je stránka „Emaily“ otevřená, načti je znovu
          const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
          if (emailsPageActive) fetchEmails();
        }

        showToast(`Stav účtu ${email} byl změněn.`, 'success');
      } catch (e) {
        // revert UI při chybě
        checkbox.checked = currentActive;
        showToast(`Chyba: ${e.message || e}`, 'error');
      }
    }





    async function addAccount() {
      const dashboardUserEmail = localStorage.getItem('userEmail');
      if (!dashboardUserEmail) {
        showToast('Nejste přihlášen.', 'error');
        return;
      }

      try {
        // načti limity i aktuální počet účtů najednou
        const [limitsRes, accCount] = await Promise.all([
          fetch(`https://ai-email-server-stejdesign.onrender.com/api/limits?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`)
            .then(r => r.json()),
          getConnectedAccountsCount(dashboardUserEmail)
        ]);

        // když API na limity selže, radši modal otevři (fallback)
        if (!limitsRes?.success) {
          openModal();
          return;
        }

        const plan = limitsRes.plan;                   // např. "Starter"
        const maxAccounts = limitsRes.max_accounts ?? 0;
        const hasReachedLimit = accCount >= maxAccounts;

        if (hasReachedLimit) {
          const msg = plan === 'Starter'
            ? 'Na tarifu Starter lze připojit maximálně 1 emailový účet. Pro přidání dalšího účtu přejděte na vyšší tarif v Nastavení → Plán.'
            : `Dosáhli jste limitu připojených účtů pro tarif ${plan} (max ${maxAccounts}). Pro přidání dalšího účtu přejděte v Nastavení na vyšší tarif.`;

          // ukážeme dlouhou notifikaci a nabídneme rovnou přepnutí na Plán
          showToast(msg, 'warning', {
            duration: 9000,
            actionText: 'Přejít na Plán',
            onAction: () => {
              // otevři stránku Nastavení → záložku Plán
              document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
              const settingsLink = document.querySelector('.nav-link[data-page="settings"]');
              if (settingsLink) settingsLink.classList.add('active');

              document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
              const settingsPage = document.getElementById('settings');
              if (settingsPage) settingsPage.classList.add('active');

              document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.settings-content').forEach(c => c.style.display = 'none');

              const planTab = document.querySelector('.settings-tab[data-tab="plan"]');
              if (planTab) planTab.classList.add('active');

              const planContent = document.getElementById('plan-settings');
              if (planContent) planContent.style.display = 'block';

              // vždy načti čerstvá data
              loadPlan();
              loadLimits();
            }
          });

          // DŮLEŽITÉ: tady skončit – neotevírat modal
          return;
        }

        // limit není vyčerpán → otevři modal pro připojení
        openModal();

      } catch (e) {
        console.error(e);
        // při chybě raději modal otevři, ať má uživatel šanci to zkusit
        openModal();
      }
    }

    // ZMĚNA: Funkce zkontroluje, zda nebyl odpojen primární účet
    async function disconnectAccount(email, accType) {
      if (!confirm(`Opravdu chcete odpojit účet ${email}?`)) return;

      const dashboardUserEmail = localStorage.getItem('userEmail');
      if (!dashboardUserEmail) { showToast('Nejste přihlášen.', 'error'); return; }

      // 1) vyber endpoint podle typu
      //    - pokud accType není k dispozici, zkusíme nejdřív custom, pak gmail (fallback)
      const tries = accType === 'custom' ? [
        { url: `${window.BACKEND}/api/custom-email/disconnect`, body: { dashboardUserEmail, emailAddress: email } }
      ] : accType === 'gmail' ? [
        { url: `${window.BACKEND}/api/oauth/google/revoke`, body: { dashboardUserEmail, email } }
      ] : [
        // neznámý typ -> zkus oba
        { url: `${window.BACKEND}/api/custom-email/disconnect`, body: { dashboardUserEmail, emailAddress: email } },
        { url: `${window.BACKEND}/api/oauth/google/revoke`, body: { dashboardUserEmail, email } }
      ];

      let ok = false, lastMsg = 'Nepodařilo se odpojit účet.';
      for (const t of tries) {
        try {
          const res = await fetch(t.url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(t.body)
          });
          const j = await res.json();
          if (j?.success) { ok = true; lastMsg = j.message || 'Účet odpojen.'; break; }
          lastMsg = j?.message || lastMsg;
        } catch (e) {
          lastMsg = e?.message || lastMsg;
        }
      }
      if (!ok) { showToast(lastMsg, 'error'); return; }

      // 2) refresh účtů a UI
      const serverAccs = await fetchConnectedEmailsFromServer();
      setConnectedAccounts(serverAccs);

      // pokud jsme odpojili primární, nahraď ho jiným / smaž
      const currentPrimary = localStorage.getItem('primaryEmail');
      if (currentPrimary === email) {
        const firstEmail = serverAccs[0]?.email;
        if (firstEmail) localStorage.setItem('primaryEmail', firstEmail);
        else localStorage.removeItem('primaryEmail');
      }

      renderConnectedAccounts();

      const newPrimaryAfter = localStorage.getItem('primaryEmail');
      if (newPrimaryAfter) {
        await loadSettings();
        const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
        if (emailsPageActive) fetchEmails();
      } else {
        if (emailListContainer)
          emailListContainer.innerHTML = `<div class="empty-state"><h3>Nemáte připojený žádný účet</h3><p>Přidejte si účet v Nastavení → Email účty.</p></div>`;
      }

      await loadLimits();
      showToast(lastMsg || 'Účet byl úspěšně odpojen.', 'success');
    }



    // Pomocné regexy
    const VAR_RE = /{{\s*([a-zA-Z0-9_.-]+)\s*}}/g;
    const AI_RE = /\[\[\s*AI\s*:(.*?)\]\]/gs;

    window.__lastUsedTemplateId = null;


    async function useTemplate(tpl) {
      const modalEl = document.getElementById('analysisModal');
      const responseDisplay = document.getElementById('response-display');
      const responseEditor = document.getElementById('response-editor');

      if (!modalEl) { showToast('Nelze otevřít editor odpovědi.', 'error'); return; }

      // otevři modal + přepni do editačního režimu
      modalEl.classList.add('show');
      document.body.style.overflow = 'hidden';
      if (responseDisplay) responseDisplay.style.display = 'none';
      if (responseEditor) {
        responseEditor.style.display = 'block';
        responseEditor.value = 'Načítám šablonu…';
      }
      document.getElementById('view-mode-buttons')?.style.setProperty('display', 'none');
      document.getElementById('edit-mode-buttons')?.style.setProperty('display', 'flex');

      window.__lastUsedTemplateId = tpl.id;

      try {
        const dashboardUserEmail = localStorage.getItem('userEmail');

        // volitelně: načti nastavení, pokud máte utilitu
        if (typeof ensureSettingsLoaded === 'function') {
          try { await ensureSettingsLoaded(); } catch (_) { }
        }

        // poskládej context
        const context = {
          emailBody: (window.CURRENT_EMAIL?.bodyText) || '',
          analysis: (window.CURRENT_EMAIL?.analysis) || {},
          settings: (window.CURRENT_SETTINGS) || {},
          meta: {
            subject: window.CURRENT_EMAIL?.subject || '',
            from: window.CURRENT_EMAIL?.from || '',
            date: window.CURRENT_EMAIL?.date || ''
          }
        };

        // POZOR: žádné API_BASE, použijeme přímo URL serveru
        const r = await fetch('https://ai-email-server-stejdesign.onrender.com/api/templates/render', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dashboardUserEmail, templateId: tpl.id, context })
        });
        const j = await r.json();

        if (j?.success && j?.rendered) {
          responseEditor.value = j.rendered;
          responseEditor.focus();
          showToast(`Šablona „${tpl.name}“ vložena do odpovědi.`, 'success');
        } else {
          responseEditor.value = String(tpl.content || '');
          responseEditor.focus();
          showToast(j?.message || 'Render selhal, vložen původní obsah.', 'warning');
        }

        if (typeof closeTemplatePicker === 'function') closeTemplatePicker();
      } catch (e) {
        console.error(e);
        responseEditor.value = String(tpl.content || '');
        responseEditor.focus();
        showToast('Nepodařilo se vyrenderovat šablonu – vložen původní obsah.', 'error');
      }
    }

    // inkrementace uses po úspěšném odeslání (máš event handler; jen dovnitř přidej)
    async function afterSuccessfulSend() {
      const tplId = window.__lastUsedTemplateId;
      const dashboardUserEmail = localStorage.getItem('userEmail');
      if (tplId) {
        fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${tplId}/increment-use`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dashboardUserEmail })
        }).finally(() => {
          window.__lastUsedTemplateId = null;
          loadTemplates(); // aby se hned propsal počet „Použito“
        });
      }
    }














    // ZMĚNA: Hlavní inicializační funkce, která nastaví výchozí primární účet
    async function initializeDashboard() {
      // Když se vrátime z OAuth, URL může mít ?account-linked=success...
      // Neřeš parametry – stejně si vše stáhneme z DB a tím je to nejspolehlivější.
      if (new URLSearchParams(location.search).get('account-linked') === 'success') {
        showToast('Účet byl úspěšně propojen. Načítám účty...', 'success');
        // očisti URL
        const clean = new URL(location.href);
        clean.searchParams.delete('account-linked');
        clean.searchParams.delete('new-email');
        history.replaceState({}, '', clean.toString());
      }

      // 1) stáhni připojené účty z backendu a ulož do localStorage
      let currentPrimary = localStorage.getItem('primaryEmail');
      const connectedEmails = await syncConnectedEmails();

      if (!currentPrimary || !connectedEmails.some(a => a.email === currentPrimary)) {
        const firstEmail = connectedEmails[0]?.email || null;
        if (firstEmail) localStorage.setItem('primaryEmail', firstEmail);
        else localStorage.removeItem('primaryEmail');
        currentPrimary = firstEmail;
      }

      // 3) vykresli seznam účtů + stav „Nastavuji: ...“
      renderConnectedAccounts();

      // 4) Když je primární, rovnou načti AI nastavení a e-maily
      if (currentPrimary) {
        await loadSettings();
        // jestli uživatel stojí na záložce „Emaily“, načti je
        const emailsPageActive = document.getElementById('emails')?.classList.contains('active');
        if (emailsPageActive) fetchEmails();
      }
    }

    (function () {
      const modal = document.getElementById('emailDetailModal');
      const closeBtns = [
        document.getElementById('closeEmailDetail'),
        document.getElementById('closeEmailDetailBottom')
      ].filter(Boolean);

      closeBtns.forEach(btn => btn.addEventListener('click', () => {
        hideEmailDetailModal(modal);
        document.body.style.overflow = '';
      }));

      modal?.addEventListener('click', (e) => {
        if (e.target === modal) {
          hideEmailDetailModal(modal);
          document.body.style.overflow = '';
        }
      });
    })();



    // ===================================================================================
    // === 4. HLAVNÍ BLOK - SPUŠTĚNÍ PO NAČTENÍ STRÁNKY ==================================
    // ===================================================================================


    document.addEventListener('DOMContentLoaded', () => {
      wireFaqButtons();
      console.log('AI Emailový Agent Dashboard loaded successfully');
      initAdminEventListeners();

      const userRole = localStorage.getItem('userRole');
      if (userRole === 'admin') {
        const adminMenuItem = document.getElementById('admin-menu-item');
        if (adminMenuItem) {
          adminMenuItem.style.display = 'block';
        }
      }

      const adminTabLink = document.querySelector('.nav-link[data-page="admin"]');
      if (adminTabLink) {
        adminTabLink.addEventListener('click', loadAdminUsers);
      }



      const planTab = document.querySelector('.settings-tab[data-tab="plan"]');
      if (planTab) {
        planTab.addEventListener('click', () => {
          loadPlan();
          loadLimits(); // vždy se načtou čerstvá data při kliknutí na záložku "Plán"
        });
      }

      const userName = localStorage.getItem('userName');
      if (!userName) {
        alert("Nejste přihlášen.");
        window.location.href = 'login.html';
        return;
      }
      const avatarDiv = document.getElementById('user-avatar-display');
      const userNameDisplay = document.getElementById('user-name-display');
      if (userNameDisplay) userNameDisplay.textContent = userName;
      if (avatarDiv) {
        const nameParts = userName.split(' ');
        let initials = nameParts.length > 1 ? nameParts[0][0] + nameParts[nameParts.length - 1][0] : userName.substring(0, 2);
        avatarDiv.textContent = initials.toUpperCase();
      }
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton) logoutButton.addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'login.html';
      });

      initializeDashboard();

      if (collapseBtn) {
        collapseBtn.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          collapseBtn.innerHTML = sidebar.classList.contains('collapsed') ? '<span>→</span>' : '<span>←</span>';
        });
      }

      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();

          navLinks.forEach(l => l.classList.remove('active'));
          link.classList.add('active');


          pageContents.forEach(page => page.classList.remove('active'));

          const targetPageId = link.getAttribute('data-page');
          const targetElement = document.getElementById(targetPageId);
          if (targetElement) {
            targetElement.classList.add('active');
          }
          if (contentArea) {
            contentArea.scrollTop = 0;
          }

          if (pageTitle) {
            const titles = { 'dashboard': 'Dashboard', 'emails': 'Správa emailů', 'templates': 'Šablony', 'settings': 'Nastavení', 'analytics': 'Analytika', 'integrations': 'Integrace', 'admin': 'Admin' };
            pageTitle.textContent = titles[targetPageId] || 'Dashboard';
          }

          // FIX: Hide content-area for pages outside it (admin, analytics, integrations)
          const pagesOutsideContentArea = ['admin', 'analytics', 'integrations'];
          if (contentArea) {
            if (pagesOutsideContentArea.includes(targetPageId)) {
              contentArea.style.display = 'none';
            } else {
              contentArea.style.display = '';
            }
          }

          // Načtení dat pro příslušnou stránku
          if (targetPageId === 'emails') fetchEmails();
          if (targetPageId === 'settings') loadSettings();
          if (targetPageId === 'analytics') loadAnalytics(7);
          if (targetPageId === 'admin') {
            loadAdminUsers();
            loadActivityLog();
          }
        });
      });



      // Šablony – načti, když uživatel otevře záložku „Šablony“
      const templatesTabLink = document.querySelector('.nav-link[data-page="templates"]');
      if (templatesTabLink) {
        templatesTabLink.addEventListener('click', () => loadTemplates());
      }

      // V AI/Nastavení tab panelu – pokud chceš načítat i při kliku na „Šablony“ přes postranní menu
      document.getElementById('tpl-save-btn')?.addEventListener('click', (e) => {
        const editingId = e.currentTarget.dataset.editingId;
        if (editingId) return saveEditedTemplate(editingId);
        return createTemplate();
      });


      if (settingsTabs) {
        settingsTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            settingsTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            // Skryjeme všechny obsahy záložek
            settingsContents.forEach(content => content.style.display = 'none');

            const targetContentId = tab.getAttribute('data-tab') + '-settings';
            const targetContent = document.getElementById(targetContentId);

            if (targetContent) {
              targetContent.style.display = 'block';

              // pokud je to FAQ tab, načti FAQ
              if (tab.getAttribute('data-tab') === 'faq') {
                loadFaqs();
                // wireFaqButtons() se nyní volá jen jednou v DOMContentLoaded, takže ho odsud odebereme
              }

              if (tab.getAttribute('data-tab') === 'email') {
                renderConnectedAccounts();
              }
              if (tab.getAttribute('data-tab') === 'ai') {
                loadSettings(); // Načteme nastavení, když se vrátíme na AI záložku
              }
              if (tab.getAttribute('data-tab') === 'plan') {
                loadPlan();
                loadLimits();
              }
            }
          });
        });
      }

      if (emailListContainer) {
        emailListContainer.addEventListener('click', async (event) => {
          const quickAiButton = event.target.closest('.quick-ai-btn');
          if (quickAiButton) {
            event.preventDefault();
            event.stopPropagation();
            const row = quickAiButton.closest('.email-item');
            const ctx = buildEmailContextFromRow(row);
            if (!ctx || !ctx.id) {
              showToast('Nepodařilo se připravit kontext e-mailu.', 'error');
              return;
            }
            window.__currentEmailCtx = ctx;
            window.aiComposer?.open(ctx, { focusInstructions: true });
            return;
          }

          const analyzeButton = event.target.closest('.analyze-btn');
          if (analyzeButton) {
            currentMessageId = analyzeButton.dataset.messageId;
            const primaryEmail = localStorage.getItem('primaryEmail'); // ZMĚNA
            if (!primaryEmail) {
              showToast('Žádný propojený email pro analýzu.', 'error'); return;
            }
            const modalBody = document.getElementById('analysisModalBody');
            if (analysisModal && modalBody) {
              modalBody.innerHTML = '<div class="loading" style="margin: 4rem auto;"></div>';
              analysisModal.classList.add('show');
              document.body.style.overflow = 'hidden';
            }
            try {

              const modalEl = modalBody.closest('.modal');
              modalEl?.classList.add('analysis-modal');

              modalBody.innerHTML = `
  <div class="analysis-loading">
    <div class="analysis-spinner"></div>
  </div>
`;

              // jednorázově injektuj CSS pro loader
              (function injectAnalysisLoaderStyles() {
                if (document.getElementById('analysis-loading-styles')) return;
                const style = document.createElement('style');
                style.id = 'analysis-loading-styles';
                style.textContent = `
    .analysis-modal .analysis-loading{
      min-height: 320px;
      display: grid;
      place-items: center;
    }
    .analysis-modal .analysis-spinner{
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 4px solid #e5e7eb;
      border-top-color: #667eea;
      animation: analysis-spin 1s linear infinite;
    }
    @keyframes analysis-spin { to { transform: rotate(360deg); } }
  `;
                document.head.appendChild(style);
              })();


              // z karty zprávy si vezmeme zdroj (gmail/custom)
              const item = analyzeButton.closest('.email-item');
              const analyzeCtx = buildEmailContextFromRow(item);
              window.__currentEmailCtx = analyzeCtx || window.__currentEmailCtx;
              let src = (analyzeCtx?.src || item?.dataset?.src || '').toLowerCase();
              // 1) pokud je název listu/hlavička "Custom IMAP", ber to jako custom
              const hdr = document.getElementById('email-count');
              const headerText = hdr?.textContent || '';
              if (/Custom IMAP/i.test(headerText)) src = 'custom';
              // 2) pokud máme čistě číselné ID (UID), je to custom
              if (src !== 'custom' && /^\d+$/.test(String(currentMessageId))) src = 'custom';
              // 3) poslední pojistka – když máme payload pro custom (viz bodyCustom) a prázdný messageId,
              //    tak určitě použij custom endpoint
              // (tuhle podmínku můžeš vynechat, pokud messageId vždy máš)

              // připrav payloady pro oba případy
              const bodyGmail = {
                dashboardUserEmail,
                email: primaryEmail,
                messageId: currentMessageId,
                styleProfile: (window.CURRENT_SETTINGS && window.CURRENT_SETTINGS.style_profile) || null
              };
              const bodyCustom = {
                dashboardUserEmail,
                emailAddress: primaryEmail,
                uid: Number(currentMessageId) // u customu posíláme UID jako číslo
              };

              // zvol správný endpoint
              const analyzeUrl = src === 'custom'
                ? `${window.BACKEND}/api/custom-email/analyze-email`
                : `${window.BACKEND}/api/gmail/analyze-email`;

              // zavolej analýzu
              const response = await fetch(analyzeUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(src === 'custom' ? bodyCustom : bodyGmail)
              });
              const data = await response.json();
              if (!response.ok || !data.success) throw new Error(data.message || 'Analýza selhala.');

              // zapamatuj si zdroj, ať odesílání ví, kam se má poslat reply
              window.__currentEmailSource = src;          // 'gmail' | 'custom'
              window.__currentAccountAddress = primaryEmail;

              if (data.success && modalBody) {
                modalBody.innerHTML = `
    <div class="analysis-section">
      <div class="section-header">
        <div class="section-icon">📊</div>
        <div class="section-title">Shrnutí a sentiment</div>
      </div>
      <div class="section-content">
        <strong>Shrnutí:</strong> ${data.analysis.summary}<br>
        <strong>Sentiment:</strong> ${data.analysis.sentiment}
      </div>
    </div>
    <div class="response-section">
      <div class="response-header">
        <div class="response-title"><span>✨</span> Doporučená odpověď</div>
      </div>
      <div class="response-content" id="response-display">${data.analysis.suggested_reply.replace(/\n/g, '<br>')}</div>
      <textarea class="form-control" id="response-editor" style="display: none;"></textarea>
    </div>`;

                const datasetReplyTo = analyzeCtx?.replyTo || item?.dataset?.replyTo || '';
                const datasetFrom = analyzeCtx?.from || item?.dataset?.from || '';
                const datasetOriginalFrom = analyzeCtx?.originalFrom || item?.dataset?.fromOriginal || datasetFrom;
                window.CURRENT_EMAIL = {
                  id: currentMessageId,
                  subject: analyzeCtx?.subject || item?.querySelector('.email-subject')?.textContent?.trim() || '',
                  from: datasetReplyTo || datasetFrom || '',
                  replyTo: datasetReplyTo || '',
                  originalFrom: datasetOriginalFrom || '',
                  date: item?.querySelector('.email-meta > div')?.textContent?.trim() || '',
                  bodyText: data.emailBody || '',
                  analysis: data.analysis || {},
                  account: primaryEmail,
                  headers: data.headers || {}
                };

                const headerReplyTo = data?.headers?.replyTo || '';
                if (headerReplyTo && !window.CURRENT_EMAIL.replyTo) {
                  window.CURRENT_EMAIL.replyTo = headerReplyTo;
                  if (!window.CURRENT_EMAIL.from) {
                    window.CURRENT_EMAIL.from = headerReplyTo;
                  }
                }
                if (!window.CURRENT_EMAIL.originalFrom && data?.headers?.from) {
                  window.CURRENT_EMAIL.originalFrom = data.headers.from;
                }


                // 1) Rozšířit modal + přidat scope class
                const modalEl = modalBody.closest('.modal');
                modalEl?.classList.add('analysis-modal');
                const modalEl2 = modalBody.closest('.modal');
                modalEl2?.classList.add('analysis-modal');
                // Pokud bys někdy měl .modal-dialog, tak bezpečně:
                const dlg = modalEl2?.querySelector?.('.modal-dialog');
                if (dlg) dlg.classList.add('modal-xl');

                // 2) Přiinjektovat CSS (jednou)
                (function injectAnalysisStyles() {
                  if (document.getElementById('analysis-modal-styles')) return;
                  const css = `
    .analysis-modal .modal-body{ display:block; }
    .analysis-modal .response-section{ width:100%; }

    /* Zobrazená odpověď (read-only) */
    .analysis-modal .response-content{
      display:block;
      width:100% !important;
      max-width:none !important;
      min-height:300px;
      padding:12px 14px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      overflow:auto;
      white-space:pre-wrap;       /* zachová odřádkování */
      word-break:break-word;
    }

    /* Editor */
    .analysis-modal #response-editor{
      display:none;
      width:100% !important;
      max-width:none !important;
      min-height:300px;
      padding:12px 14px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      resize:vertical;
      line-height:1.5;
    }
  `;
                  const style = document.createElement('style');
                  style.id = 'analysis-modal-styles';
                  style.textContent = css;
                  document.head.appendChild(style);
                })();

                // TENTO ŘÁDEK ZAJIŠŤUJE, ŽE NOVÉ TLAČÍTKO BUDE FUNGOVAT
                document.getElementById('pick-template-btn')?.addEventListener('click', openTemplatePicker);

              } else if (modalBody) {
                modalBody.innerHTML = `<p style="text-align: center; color: red;">Chyba analýzy: ${data.message}</p>`;
              }




            } catch (error) {
              if (modalBody) modalBody.innerHTML = `<p style="text-align: center; color: red;">Nepodařilo se připojit k serveru pro analýzu.</p>`;
            }
          }

          const item = event.target.closest('.email-item');
          if (item && !event.target.closest('.analyze-btn') && !event.target.closest('.approve-btn') && !event.target.closest('.reject-btn')) {
            const ctx = buildEmailContextFromRow(item);
            window.__currentEmailCtx = ctx;
            const id = ctx?.id || item.dataset.id;
            const src = (ctx?.src || item.dataset.src || 'gmail').toLowerCase();
            const from = ctx?.from || item.dataset.from || '';
            const subject = ctx?.subject || item.querySelector('.email-subject')?.textContent?.trim() || '';
            const dateTxt = ctx?.date || item.querySelector('.email-meta > div')?.textContent?.trim() || '';
            const pendingId = ctx?.pendingId || item.dataset.pendingId || '';

            const emailEntry = findEmailEntryById(id, pendingId);

            // otevři modal + loading
            const modal = document.getElementById('emailDetailModal');
            const edFrom = document.getElementById('ed-from');
            const edSubj = document.getElementById('ed-subject');
            const edDate = document.getElementById('ed-date');
            const edBody = document.getElementById('ed-body');

            if (!modal || !edFrom || !edSubj || !edDate || !edBody) return;

            const safeFrom = from || '(neznámý odesílatel)';
            const originalFrom = window.CURRENT_EMAIL?.originalFrom || emailEntry?.originalFrom || '';
            const safeSubject = subject || '(bez předmětu)';
            const safeDate = dateTxt || '';

            edFrom.textContent = safeFrom;
            edFrom.title = (originalFrom && originalFrom !== safeFrom)
              ? `${safeFrom}\nPůvodní From: ${originalFrom}`
              : safeFrom;
            edSubj.textContent = safeSubject;
            edSubj.title = safeSubject;
            edDate.textContent = safeDate;
            edDate.title = safeDate;
            if (emailEntry && emailEntry._pending && emailEntry.originalBody) {
              edBody.textContent = emailEntry.originalBody;
            } else {
              edBody.textContent = 'Načítám obsah zprávy…';
            }
            renderPendingPreview(emailEntry);
            syncProMeta();

            showEmailDetailModal(modal);
            document.body.style.overflow = 'hidden';

            try {
              const dashboardUserEmail = localStorage.getItem('userEmail');
              const primaryEmail = localStorage.getItem('primaryEmail');
              const isCustom = (src === 'custom');

              const requestId = ctx?.id || id;

              const shouldFetchBody = !(emailEntry && emailEntry._pending && emailEntry.originalBody);

              if (shouldFetchBody) {
                // Volání lehkého backend endpointu pro tělo zprávy (viz změny v serveru níže)
                let url;
                if (isCustom) {
                  url = `${window.BACKEND}/api/custom-email/message-body?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(primaryEmail)}&uid=${encodeURIComponent(requestId)}`;
                } else {
                  url = `${window.BACKEND}/api/gmail/message-body?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(primaryEmail)}&messageId=${encodeURIComponent(requestId)}`;
                }

                const r = await fetch(url);
                const j = await r.json();
                if (!r.ok || !j.success) throw new Error(j.message || 'Nepodařilo se načíst obsah zprávy.');
                edBody.textContent = j.body || '(tělo zprávy je prázdné)';
              }
            } catch (e) {
              edBody.textContent = e.message || 'Chyba při načítání obsahu zprávy.';
            }
          }

        });
      }

      if (settingsForm) settingsForm.addEventListener('submit', saveSettings);
      if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
      if (analysisModal) analysisModal.addEventListener('click', (e) => { if (e.target === analysisModal) hideAnalysisModal(); });
      if (closeAnalysisModalBtn) closeAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
      if (googleBtn) googleBtn.addEventListener('click', connectGoogleAccount);
      if (statusFilter) statusFilter.addEventListener('change', () => fetchEmails({ resetPage: true }));
      if (periodFilter) periodFilter.addEventListener('change', () => fetchEmails({ resetPage: true }));
      if (searchBar) {
        searchBar.addEventListener('search', () => fetchEmails({ resetPage: true }));
        searchBar.addEventListener('input', (event) => {
          if (event.target.value === '') {
            fetchEmails({ resetPage: true });
          }
        });
      }

      const modalFooter = document.querySelector('#analysisModal .modal-footer');
      if (modalFooter) {
        modalFooter.addEventListener('click', async (event) => {
          if (event.target.closest('#edit-reply-btn')) enterEditMode();
          if (event.target.closest('#save-edit-btn')) exitEditMode(true);
          if (event.target.closest('#cancel-edit-btn')) exitEditMode(false);
          if (event.target.closest('#send-now-btn') || event.target.closest('.btn-success')) {
            const sendButton = event.target.closest('button');
            const primaryEmail = localStorage.getItem('primaryEmail');

            const editor = document.getElementById('response-editor');
            const display = document.getElementById('response-display');
            const replyBody = (editor && editor.style.display !== 'none'
              ? editor.value
              : (display?.innerText || '')
            ).trim();

            if (!primaryEmail || !currentMessageId || !replyBody) {
              showToast('Chybí data pro odeslání.', 'error'); return;
            }

            if (!primaryEmail || !currentMessageId || !replyBody) {
              showToast('Chybí data pro odeslání.', 'error'); return;
            }
            sendButton.textContent = 'Odesílám...'; sendButton.disabled = true;


            try {
              // zdroj a účet z analýzy (nastaveno při Analyze)
              const src = window.__currentEmailSource || 'gmail';      // 'gmail' | 'custom'
              const account = window.__currentAccountAddress || primaryEmail;

              // metadata pro custom odeslání
              const subj = (window.CURRENT_EMAIL?.subject || '').trim();
              const replyTargetRaw = window.CURRENT_EMAIL?.replyTo || window.CURRENT_EMAIL?.from || '';
              const toAddr = extractEmailAddress(replyTargetRaw) || '';
              if (!replyTargetRaw || !toAddr) {
                showToast('Nepodařilo se zjistit adresu pro odpověď.', 'error');
                sendButton.textContent = 'Odeslat nyní';
                sendButton.disabled = false;
                return;
              }

              // připrav endpoint + payload
              let urlPost = '', payload = {};
              if (src === 'custom') {
                // Custom IMAP/SMTP
                urlPost = `${window.BACKEND}/api/custom-email/send-reply`;
                payload = {
                  dashboardUserEmail,
                  emailAddress: account,
                  to: toAddr,
                  replyTo: replyTargetRaw,
                  subject: subj ? `Re: ${subj}` : 'Re:',
                  text: replyBody,
                  replyToUid: Number(currentMessageId),
                  origMessageId: window.CURRENT_EMAIL?.headers?.messageId || null,
                  origReferences: window.CURRENT_EMAIL?.headers?.references || null
                };
              } else {
                // Gmail
                urlPost = `${window.BACKEND}/api/gmail/send-reply`;
                payload = {
                  dashboardUserEmail,
                  email: account,
                  messageId: currentMessageId,
                  replyBody
                };

              }



              // odeslat
              const response = await fetch(urlPost, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const data = await response.json();

              if (data.success) {
                showToast(data.message, 'success');
                hideAnalysisModal();
                afterSuccessfulSend();
                await fetchEmails();// okamžitý refresh seznamu emailů po odeslání
                const tplId = window.__lastUsedTemplateId;
                if (tplId) {
                  fetch(`https://ai-email-server-stejdesign.onrender.com/api/templates/${tplId}/increment-use`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dashboardUserEmail })
                  }).finally(() => {
                    window.__lastUsedTemplateId = null;
                    loadTemplates();
                  });
                }

                // tvůj existující blok s increment-use (pokud ho máš) nechej beze změny pod tímto
              } else {
                showToast(`Chyba: ${data.message}`, 'error');
              }




            } catch (error) {
              showToast('Nepodařilo se připojit k serveru pro odeslání.', 'error');
            } finally {
              sendButton.textContent = 'Odeslat nyní'; sendButton.disabled = false;
            }
          }
        });
      }

      document.getElementById('pick-template-btn')?.addEventListener('click', openTemplatePicker);
      const tplPicker = document.getElementById('templatePicker');
      tplPicker?.addEventListener('click', (e) => { if (e.target === tplPicker) closeTemplatePicker(); });
      document.getElementById('closeTemplatePicker')?.addEventListener('click', closeTemplatePicker);
      document.getElementById('cancelTplPicker')?.addEventListener('click', closeTemplatePicker);
      document.getElementById('tplSearch')?.addEventListener('input', refreshPickerList);
      document.getElementById('tplCategory')?.addEventListener('change', refreshPickerList);



      // ===== FAQ (per účet) =====
      async function loadFaqs() {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const account = (localStorage.getItem('primaryEmail') || '').trim();

        const infoEl = document.getElementById('faq-current-account');
        if (infoEl) infoEl.textContent = account || '(není zvolen primární účet)';

        const listEl = document.getElementById('faq-list');
        if (!dashboardUserEmail || !account) {
          if (listEl) listEl.innerHTML = `<div class="banner error">Chybí přihlášený uživatel nebo aktivní účet.</div>`;
          return;
        }

        // 1) zkus načíst existující FAQ
        let faqs = [];
        try {
          const r = await fetch(`${window.BACKEND}/api/faq?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(account)}`);
          const j = await r.json();
          if (j?.success) faqs = Array.isArray(j.faqs) ? j.faqs : (Array.isArray(j.items) ? j.items : []);
        } catch (e) {
          // necháme pokračovat na autogeneraci
        }

        // 2) pokud nic není, automaticky vygeneruj z posledních 200
        if (!faqs.length) {
          const ok = await autoGenerateFaq(200); // ↓ viz funkce níže
          if (ok) {
            try {
              const r2 = await fetch(`${window.BACKEND}/api/faq?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(account)}`);
              const j2 = await r2.json();
              if (j2?.success) faqs = Array.isArray(j2.faqs) ? j2.faqs : (Array.isArray(j2.items) ? j2.items : []);
            } catch (e) { }
          }
        }

        renderFaqList(faqs);
      }

      function renderFaqList(items = []) {
        const listEl = document.getElementById('faq-list');
        if (!listEl) return;

        items = items.map(it => ({
          id: it.id, // Ujistíme se, že ID je přítomno
          q: it.q || it.question || '',
          a: it.a || it.answer || ''
        }));

        if (!items.length) {
          listEl.innerHTML = `<div class="banner info">Zatím žádné položky. Klikni na „Přidat FAQ položku“ nebo „Naučit se z historie“.</div>`;
          return;
        }

        listEl.innerHTML = items.map((it, idx) => `
    <div class="card" data-faq-index="${idx}" data-db-id="${it.id || ''}" style="padding:.75rem; border:1px solid #e5e7eb; border-radius:12px;">
      <div class="form-group">
        <label class="form-label">Otázka</label>
        <input class="form-control faq-q" value="${escapeHtml(it.q)}" placeholder="Např. Jak změnit fakturační údaje?">
      </div>
      <div class="form-group">
        <label class="form-label">Odpověď</label>
        <textarea class="form-control faq-a" rows="3" placeholder="Stručná, jasná odpověď…">${escapeHtml(it.a)}</textarea>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button type="button" class="btn btn-danger faq-del">🗑️ Smazat</button>
      </div>
    </div>
  `).join('');
      }



      function wireFaqButtons() {
        const faqList = document.getElementById('faq-list');

        // Delegování událostí pro mazání - bude fungovat pro všechny položky
        faqList?.addEventListener('click', async (event) => {
          const deleteButton = event.target.closest('.faq-del');
          if (!deleteButton) return;

          const card = deleteButton.closest('[data-faq-index]');
          const dbId = card.dataset.dbId;

          // Pokud položka nemá 'dbId', byla jen nově přidaná a neuložená.
          // Stačí ji smazat z DOMu.
          if (!dbId) {
            card.remove();
            return;
          }

          // Pokud ID má, musíme zavolat API pro smazání z databáze.
          const dashboardUserEmail = localStorage.getItem('userEmail');
          const primaryEmail = localStorage.getItem('primaryEmail');



          try {
            const response = await fetch(`${window.BACKEND}/api/faq/${dbId}?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&email=${encodeURIComponent(primaryEmail)}`, {
              method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
              card.remove(); // Smažeme z DOMu až po úspěšném smazání z DB
              showToast('Položka byla smazána.', 'success');
            } else {
              throw new Error(data.message || 'Nepodařilo se smazat položku.');
            }
          } catch (error) {
            showToast(error.message, 'error');
          }
        });

        // Přidání nové FAQ položky
        document.getElementById('faq-add-btn')?.addEventListener('click', () => {
          const listEl = document.getElementById('faq-list');
          const newIndex = (listEl.querySelectorAll('[data-faq-index]').length > 0)
            ? Math.max(...Array.from(listEl.querySelectorAll('[data-faq-index]')).map(el => parseInt(el.dataset.faqIndex, 10))) + 1
            : 0;

          const div = document.createElement('div');
          div.className = 'card';
          div.dataset.faqIndex = newIndex;
          div.style.cssText = 'padding:.75rem; border:1px solid #e5e7eb; border-radius:12px;';
          div.innerHTML = `
      <div class="form-group">
        <label class="form-label">Otázka</label>
        <input class="form-control faq-q" placeholder="Např. Jak změnit fakturační údaje?">
      </div>
      <div class="form-group">
        <label class="form-label">Odpověď</label>
        <textarea class="form-control faq-a" rows="3" placeholder="Stručná, jasná odpověď…"></textarea>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end;">
        <button type="button" class="btn btn-danger faq-del">🗑️ Smazat</button>
      </div>`;
          listEl.appendChild(div);
        });

        // Tlačítka pro uložení 
        document.getElementById('faq-save-all-btn')?.addEventListener('click', saveFaqAll);

      }

      async function saveFaqAll() {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const account = (localStorage.getItem('primaryEmail') || '').trim();
        if (!dashboardUserEmail || !account) return showToast('Chybí účet nebo uživatel.', 'error');

        // seber data z formuláře
        const items = Array.from(document.querySelectorAll('#faq-list [data-faq-index]')).map(card => ({
          q: card.querySelector('.faq-q')?.value?.trim() || '',
          a: card.querySelector('.faq-a')?.value?.trim() || ''
        })).filter(x => x.q || x.a);

        try {
          const r = await fetch(`${window.BACKEND}/api/faq/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dashboardUserEmail, email: account, items })
          });
          const data = await r.json();
          if (data?.success) {
            showToast('FAQ uloženo.', 'success');
            loadFaqs();
          } else {
            showToast(data?.message || 'Uložení selhalo.', 'error');
          }
        } catch (e) {
          showToast('Nepodařilo se uložit FAQ.', 'error');
        }
      }

      async function learnFaqFromHistory() {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const account = (localStorage.getItem('primaryEmail') || '').trim();
        if (!dashboardUserEmail || !account) {
          showToast('Chybí účet nebo uživatel.', 'error');
          return;
        }

        // 1) naplníme style_examples (Gmail i Custom větev)
        const ok = await seedStyleExamples(dashboardUserEmail, account);
        if (!ok) {
          showToast('Nepodařilo se načíst historii pro učení (málo dat nebo chyba).', 'warning');
          // i tak zkusíme pokračovat (kdyby tam něco mezitím bylo)
        }

        // 2) z historie vygenerovat a uložit FAQ
        try {
          const r = await fetch(`${window.BACKEND}/api/faq/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dashboardUserEmail, email: account, limit: 200 })
          });
          const data = await r.json();
          if (r.ok && data?.success) {
            if ((data.created | 0) > 0) {
              showToast(`FAQ vygenerováno z ${data.created} položek.`, 'success');
            } else {
              showToast('Z historie se nepodařilo vytvořit žádné FAQ (málo dat?).', 'info');
            }
            await loadFaqs(); // načti a vykresli
          } else {
            showToast(data?.message || 'Učení/Regenerace FAQ selhala.', 'error');
          }
        } catch (e) {
          showToast('Síťová chyba při regeneraci FAQ.', 'error');
        }
      }

      // === Uložení vybraného účtu do localStorage ===
      document.querySelectorAll('.account-item').forEach(item => {
        item.addEventListener('click', () => {
          const email = item.dataset.email;
          const src = item.dataset.src || 'custom'; // 'gmail' nebo 'custom'
          if (email) {
            localStorage.setItem('primaryEmail', email);
            localStorage.setItem('primarySrc', src);
            console.log('Vybraný účet nastaven:', email, src);
          }
        });
      });



      async function seedStyleExamples(dashboardUserEmail, accountEmail) {
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));
        const isGmail = /@gmail\.com$/i.test(accountEmail);

        try {
          let items = [];

          if (isGmail) {
            // GMAIL: stáhni příklady z outboxu a inboxu a rovnou je ulož
            const [sent, inbox] = await Promise.all([
              window.fetchSentReplies(dashboardUserEmail, accountEmail, 200),
              window.fetchInboxExamples(dashboardUserEmail, accountEmail, 200),
            ]);
            items = [...sent, ...inbox];
          } else {
            // CUSTOM: fallback – vytáhni pár e-mailů a nech backend zanalyzovat těla
            const rList = await fetch(
              `${window.BACKEND}/api/custom-email/emails?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(accountEmail)}&limit=30`
            );
            const jList = await rList.json();
            const emails = Array.isArray(jList.emails) ? jList.emails : [];
            const picked = emails.slice(0, 20);

            for (const e of picked) {
              const uid = e.id || e.uid; if (!uid) continue;
              const rOne = await fetch(
                `${window.BACKEND}/api/custom-email/analyze-email?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}&emailAddress=${encodeURIComponent(accountEmail)}&uid=${encodeURIComponent(uid)}`
              );
              const jOne = await rOne.json();
              const body = (jOne.emailBody || '').trim();
              if (body) {
                items.push({
                  role: e.fromMe ? 'outgoing' : 'incoming',
                  subject: String(e.subject || ''),
                  body
                });
              }
              await sleep(200);
            }
          }

          if (!items.length) return false;

          // Ulož nasbírané příklady do DB
          const rIngest = await fetch(`${window.BACKEND}/api/style-examples/ingest`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dashboardUserEmail, email: accountEmail, items })
          });
          const jIngest = await rIngest.json();
          return rIngest.ok && jIngest?.success && (jIngest.saved | 0) > 0;
        } catch (err) {
          console.warn('seedStyleExamples error:', err);
          return false;
        }
      }





      async function autoGenerateFaq(limit = 200) {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const account = (localStorage.getItem('primaryEmail') || '').trim();
        if (!dashboardUserEmail || !account) return false;

        const listEl = document.getElementById('faq-list');
        if (!listEl) return false;

        // --- KROK 1: Zobrazení počátečního stavu indikátoru ---
        listEl.innerHTML = `
    <div class="faq-generator-status" id="faq-generation-status">
      <div class="faq-spinner"></div>
      <div class="faq-status-text" id="faq-status-text">Generuji FAQ z historie</div>
      <div class="faq-status-subtext" id="faq-status-subtext">Prosím, vyčkejte...</div>
    </div>
  `;
        const statusTextEl = document.getElementById('faq-status-text');
        const statusSubtextEl = document.getElementById('faq-status-subtext');

        try {
          // --- FÁZE 1: Načítání historie ---
          statusTextEl.textContent = 'Krok 1/2: Načítám historii e-mailů';
          statusSubtextEl.textContent = 'Analyzuji odeslané a přijaté zprávy...';

          const seeded = await seedStyleExamples(dashboardUserEmail, account);
          if (!seeded) {
            console.warn('seedStyleExamples neuložil žádná data, pokračuji k regenerate…');
          }

          // --- FÁZE 2: AI Analýza ---
          statusTextEl.textContent = 'Krok 2/2: AI analyzuje data';
          statusSubtextEl.textContent = 'Tento krok může trvat i několik desítek sekund.';

          const r = await fetch(`${window.BACKEND}/api/faq/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dashboardUserEmail, email: account, limit })
          });
          const j = await r.json();

          if (r.status === 429) {
            showToast(j?.message || 'Vyčerpán měsíční limit AI akcí.', 'warning');
            return false;
          }
          if (!r.ok || !j?.success) {
            throw new Error(j?.message || 'Auto-generace FAQ selhala.');
          }

          if ((j.created | 0) <= 0) {
            showToast('Z historie se nepodařilo vytvořit žádné FAQ (málo dat?).', 'info');
            listEl.innerHTML = ''; // Vyčistíme indikátor
            return false;
          }

          showToast(`FAQ bylo úspěšně vygenerováno.`, 'success');
          return true;

        } catch (e) {
          console.warn('Auto FAQ generation error:', e);
          showToast(e.message || 'Auto-generace FAQ selhala.', 'error');
          listEl.innerHTML = ''; // Vyčistíme indikátor i v případě chyby
          return false;
        }
      }




      // pomocné
      function escapeHtml(s = '') {
        return String(s)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }




      checkMobile();
      checkMobile();
      window.addEventListener('resize', checkMobile);

      // Mobile Menu Logic
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
          sidebar.classList.toggle('open');
          sidebarOverlay.classList.toggle('show');
        });
      }

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', () => {
          sidebar.classList.remove('open');
          sidebarOverlay.classList.remove('show');
        });
      }

      // Close sidebar when clicking a nav link on mobile
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('show');
          }
        });
      });


      const initialActivePage = document.querySelector('.nav-link.active')?.getAttribute('data-page');
      if (initialActivePage === 'emails') {
        fetchEmails();
      }
      if (initialActivePage === 'settings') {
        loadSettings();
      }


      setInterval(() => {
        const emailsPage = document.getElementById('emails');
        if (emailsPage && emailsPage.classList.contains('active')) {
          console.log('🔄 Automaticky obnovuji seznam emailů...');
          fetchEmails();
        }
      }, 60000);
      const savePlanBtn = document.getElementById('save-plan-btn');
      if (savePlanBtn) savePlanBtn.addEventListener('click', async () => {
        await savePlan();
        loadLimits(); // refresh usage po změně tarifu
      });


    });


    function syncProMeta() {
      const from = document.getElementById('ed-from')?.textContent?.trim() || '';
      const subj = document.getElementById('ed-subject')?.textContent?.trim() || '';
      const date = document.getElementById('ed-date')?.textContent?.trim() || '';
      const v = (id, val) => {
        const el = document.getElementById(id);
        if (el) {
          const safe = val || '—';
          el.textContent = safe;
          el.title = safe;
        }
      };

      v('ed-from-meta', from);
      v('ed-subject-meta', subj);
      v('ed-date-meta', date);

      const av = document.getElementById('ed-avatar');
      if (av) {
        // vezmi iniciály z jména / adresy
        let initials = '✉️';
        const namePart = (from.split('<')[0] || '').trim();
        if (namePart) {
          const words = namePart.split(/\s+/).filter(Boolean);
          initials = words.slice(0, 2).map(w => w[0]?.toUpperCase()).join('');
          if (!initials) initials = '✉️';
        }
        av.textContent = initials;
      }

      const copyBtn = document.getElementById('ed-copy');
      const bodyEl = document.getElementById('ed-body');
      if (copyBtn && bodyEl) {
        copyBtn.onclick = async () => {
          try { await navigator.clipboard.writeText(bodyEl.textContent || ''); }
          catch (e) { /* ignore */ }
        };
      }



    }




    // "Odpovědět" spustí stejnou AI analýzu jako tlačítko "Analyzovat 🤖"
    (function wireReplyToAI() {
      const triggerAiFromDetail = () => {
        const ctx = window.__currentEmailCtx;
        if (!ctx || !ctx.id) {
          if (typeof showToast === 'function') {
            showToast('Nejprve otevřete detail konkrétního e-mailu.', 'warning');
          } else {
            alert('Chybí kontext zprávy – otevři nejdřív detail e-mailu.');
          }
          return;
        }

        const detailModal = document.getElementById('emailDetailModal');
        if (detailModal) {
          hideEmailDetailModal(detailModal);
        }
        document.body.style.overflow = '';

        const inlineInstructions = document.getElementById('ed-ai-instructions')?.value || '';
        window.aiComposer?.open(ctx, {
          instructions: inlineInstructions,
          focusInstructions: !inlineInstructions
        });
      };

      // napoj obě tlačítka v headeru/footru detailu
      const replyTop = document.getElementById('ed-reply-open');
      const replyBottom = document.getElementById('ed-reply-bottom');
      replyTop && (replyTop.onclick = triggerAiFromDetail);
      replyBottom && (replyBottom.onclick = triggerAiFromDetail);
      const erReplyTop = document.getElementById('er-reply');
      const erReplyBottom = document.getElementById('er-reply-bottom');
      erReplyTop && (erReplyTop.onclick = triggerAiFromDetail);
      erReplyBottom && (erReplyBottom.onclick = triggerAiFromDetail);
    })();







    // Globální proměnná pro ukládání načtených uživatelů
    let allAdminUsers = [];

    const ACTIVITY_LOG_LIMIT = 500;
    const ACTIVITY_LOGS_PER_PAGE = 10;
    let activityLogEntries = [];
    let currentActivityPage = 1;
    const activityPaginationContainer = document.getElementById('activity-pagination');

    // Funkce pro vykreslení tabulky na základě dat
    function renderAdminUsersTable(users) {
      const tableBody = document.getElementById('adminUsersTableBody');
      if (!tableBody) return;

      if (users.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:2rem;">Nenalezeni žádní uživatelé.</td></tr>';
        return;
      }

      tableBody.innerHTML = users.map(user => {
        const nameParts = (user.name || '').split(' ');
        const initials = (nameParts.length > 1
          ? nameParts[0][0] + nameParts[nameParts.length - 1][0]
          : (user.name || 'U').substring(0, 2)).toUpperCase();

        const aiMonth = Number(user.ai_actions_used ?? 0);
        const tokensMonth = Number(user.tokens_used ?? 0);

        return `
      <tr data-email="${escapeHtml(user.email)}">
        <td>
          <div class="user-info-cell">
            <div class="user-avatar-small">${initials}</div>
            <div class="user-details">
              <span class="user-name">${escapeHtml(user.name || '')}</span>
              <span class="user-email">${escapeHtml(user.email)}</span>
            </div>
          </div>
        </td>
        <td>${escapeHtml(user.plan || '')}</td>
        <td><span class="role-badge ${user.role === 'admin' ? 'role-admin' : 'role-user'}">${escapeHtml(user.role)}</span></td>
        <td>${new Date(user.created_at).toLocaleDateString('cs-CZ')}</td>
        <td style="text-align:right;">${aiMonth}</td>
        <td style="text-align:right;">${tokensMonth.toLocaleString('cs-CZ')}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-secondary btn-sm edit-user-btn">Upravit</button>
            <button class="btn btn-danger btn-sm delete-user-btn">Smazat</button>
          </div>
        </td>
      </tr>
    `;
      }).join('');
    }

    // Hlavní funkce pro načtení a filtrování dat
    async function loadAdminUsers() {
      const tableBody = document.getElementById('adminUsersTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Načítám data...</td></tr>';

      const dashboardUserEmail = localStorage.getItem('userEmail');
      const searchTerm = document.getElementById('userSearch').value;
      const roleFilter = document.getElementById('roleFilter').value;

      try {
        const url = new URL(`${window.BACKEND}/api/admin/users`);
        url.searchParams.set('dashboardUserEmail', dashboardUserEmail);
        if (searchTerm) url.searchParams.set('search', searchTerm);
        if (roleFilter !== 'all') url.searchParams.set('role', roleFilter);

        const response = await fetch(url);
        const data = await response.json();
        if (!data.success) throw new Error(data.message);

        allAdminUsers = data.users || [];

        // Naplnění statistik
        const stats = data.stats || {};
        document.getElementById('admin-total-users').textContent = stats.totalUsers || 0;
        document.getElementById('admin-paying-users').textContent = stats.payingUsers || 0;
        document.getElementById('admin-connected-emails').textContent = stats.connectedEmails || 0;
        document.getElementById('admin-ai-today').textContent = stats.aiActionsThisMonth || 0; // Změněno na "tento měsíc"

        renderAdminUsersTable(allAdminUsers);
      } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Chyba: ${error.message}</td></tr>`;
      }
    }

    // Funkce pro inicializaci všech posluchačů událostí v admin sekci
    function initAdminEventListeners() {
      const userSearch = document.getElementById('userSearch');
      const roleFilter = document.getElementById('roleFilter');
      const tableBody = document.getElementById('adminUsersTableBody');
      const editModal = document.getElementById('editUserModal');

      // Filtry
      userSearch?.addEventListener('input', () => loadAdminUsers());
      roleFilter?.addEventListener('change', () => loadAdminUsers());

      // Kliknutí na tlačítka v tabulce (Upravit / Smazat)
      tableBody?.addEventListener('click', async (e) => {
        const dashboardUserEmail = localStorage.getItem('userEmail');

        // Smazání uživatele
        if (e.target.classList.contains('delete-user-btn')) {
          const row = e.target.closest('tr');
          const emailToDelete = row.dataset.email;

          try {
            const res = await fetch(`${window.BACKEND}/api/admin/users/${emailToDelete}?dashboardUserEmail=${dashboardUserEmail}`, { method: 'DELETE' });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            showToast('Uživatel smazán.', 'success');
            row.remove();
          } catch (err) {
            showToast(err.message, 'error');
          }

        }

        // Úprava uživatele
        if (e.target.classList.contains('edit-user-btn')) {
          const row = e.target.closest('tr');
          const emailToEdit = row.dataset.email;
          const user = allAdminUsers.find(u => u.email === emailToEdit);
          if (user && editModal) {
            document.getElementById('editName').value = user.name;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role;
            editModal.classList.add('show');
          }
        }
      });

      // Uložení změn v modálním okně
      document.getElementById('saveUserBtn')?.addEventListener('click', async () => {
        const dashboardUserEmail = localStorage.getItem('userEmail');
        const email = document.getElementById('editEmail').value;
        const name = document.getElementById('editName').value;
        const role = document.getElementById('editRole').value;

        try {
          // ZDE JE OPRAVA: Přidali jsme dashboardUserEmail do URL jako query parametr
          const url = `${window.BACKEND}/api/admin/users/${email}?dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`;

          const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, role }) // Z těla požadavku jsme ho odstranili
          });
          const data = await res.json();
          if (!data.success) throw new Error(data.message);
          showToast('Uživatel upraven.', 'success');
          document.getElementById('editUserModal').classList.remove('show');
          loadAdminUsers(); // Znovu načteme tabulku s aktuálními daty
        } catch (err) {
          showToast(err.message, 'error');
        }
      });

      // Zavírání modálního okna
      editModal?.addEventListener('click', (e) => {
        if (e.target.hasAttribute('data-close-modal') || e.target === editModal) {
          editModal.classList.remove('show');
        }
      });
    }



    async function loadActivityLog() {
      const tableBody = document.getElementById('activityLogTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Načítám log...</td></tr>';

      const dashboardUserEmail = localStorage.getItem('userEmail');

      try {
        const response = await fetch(`${window.BACKEND}/api/admin/activity-log?limit=${ACTIVITY_LOG_LIMIT}&dashboardUserEmail=${encodeURIComponent(dashboardUserEmail)}`);
        const contentType = response.headers.get('content-type') || '';

        if (!contentType.includes('application/json')) {
          const rawText = await response.text().catch(() => '');
          const hasBody = typeof rawText === 'string' && rawText.trim().length > 0;
          throw new Error(hasBody ? 'Server vrátil neočekávanou odpověď.' : 'Server vrátil prázdnou odpověď.');
        }

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data?.message || `Chyba serveru (${response.status})`);
        }

        if (!data?.success) {
          throw new Error(data?.message || 'Načtení logu selhalo.');
        }

        activityLogEntries = Array.isArray(data.log) ? data.log : [];
        currentActivityPage = 1;

        if (!activityLogEntries.length) {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Žádná aktivita k zobrazení.</td></tr>';
          hideActivityPagination();
          return;
        }

        renderActivityLogPage(currentActivityPage);
      } catch (error) {
        activityLogEntries = [];
        currentActivityPage = 1;
        hideActivityPagination();
        tableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Chyba: ${escapeHtml(error.message || 'Neznámá chyba')}</td></tr>`;
      }
    }

    function hideActivityPagination() {
      if (!activityPaginationContainer) return;
      activityPaginationContainer.innerHTML = '';
      activityPaginationContainer.style.display = 'none';
    }

    function formatActivityDetails(details) {
      if (!details) return '';
      if (typeof details === 'string') return details;
      if (typeof details === 'object') {
        if (details.reason) return details.reason;
        const parts = Object.entries(details)
          .filter(([key, value]) => value !== undefined && value !== null && value !== '')
          .map(([key, value]) => `${key}: ${value}`);
        if (parts.length) return parts.join(', ');
      }
      try {
        return JSON.stringify(details);
      } catch (error) {
        return '';
      }
    }

    function renderActivityLogPage(page = 1) {
      const tableBody = document.getElementById('activityLogTableBody');
      if (!tableBody) return;

      if (!Array.isArray(activityLogEntries) || activityLogEntries.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Žádná aktivita k zobrazení.</td></tr>';
        hideActivityPagination();
        return;
      }

      const totalEntries = activityLogEntries.length;
      const totalPages = Math.max(1, Math.ceil(totalEntries / ACTIVITY_LOGS_PER_PAGE));
      const safePage = Math.min(Math.max(page, 1), totalPages);

      currentActivityPage = safePage;

      const sliceStart = (safePage - 1) * ACTIVITY_LOGS_PER_PAGE;
      const pageEntries = activityLogEntries.slice(sliceStart, sliceStart + ACTIVITY_LOGS_PER_PAGE);

      const rows = pageEntries.map(entry => {
        const timestamp = entry?.timestamp ? new Date(entry.timestamp) : null;
        const time = timestamp && !isNaN(timestamp)
          ? `${timestamp.toLocaleDateString('cs-CZ')} ${timestamp.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}`
          : '—';
        const isError = entry?.status === 'error';
        const statusClass = isError ? 'role-admin' : 'role-user';
        const statusText = isError ? 'Chyba' : 'Úspěch';
        const actionButton = isError
          ? '<button class="btn btn-secondary btn-sm">Zkontrolovat</button>'
          : '<button class="btn btn-secondary btn-sm" style="opacity: 0.5; cursor: default;">Zobrazit</button>';
        const detailText = formatActivityDetails(entry?.details);

        return `
                <tr>
                    <td>${escapeHtml(time)}</td>
                    <td>${escapeHtml(entry?.user_email || '—')}</td>
                    <td>
                        <div class="activity-action">${escapeHtml(entry?.action || '—')}</div>
                        ${detailText ? `<div class="activity-detail">${escapeHtml(detailText)}</div>` : ''}
                    </td>
                    <td><span class="role-badge ${statusClass}">${statusText}</span></td>
                    <td>${actionButton}</td>
                </tr>
            `;
      }).join('');

      tableBody.innerHTML = rows;

      const startIndex = sliceStart + 1;
      const endIndex = sliceStart + pageEntries.length;
      renderActivityPagination(totalPages, startIndex, endIndex, totalEntries);
    }

    function renderActivityPagination(totalPages, startIndex, endIndex, totalRecords) {
      if (!activityPaginationContainer) return;

      if (totalPages <= 1) {
        hideActivityPagination();
        return;
      }

      const safeEnd = Math.min(endIndex, totalRecords);
      const infoText = `Zobrazeno ${startIndex}-${safeEnd} z ${totalRecords} aktivit`;
      const prevPage = currentActivityPage > 1 ? currentActivityPage - 1 : 1;
      const nextPage = currentActivityPage < totalPages ? currentActivityPage + 1 : totalPages;

      let buttons = `
    <button class="pagination-button${currentActivityPage === 1 ? ' disabled' : ''}" data-page="${prevPage}" ${currentActivityPage === 1 ? 'disabled' : ''}>‹</button>
  `;

      for (let i = 1; i <= totalPages; i++) {
        buttons += `<button class="pagination-button${i === currentActivityPage ? ' active' : ''}" data-page="${i}">${i}</button>`;
      }

      buttons += `
    <button class="pagination-button${currentActivityPage === totalPages ? ' disabled' : ''}" data-page="${nextPage}" ${currentActivityPage === totalPages ? 'disabled' : ''}>›</button>
  `;

      activityPaginationContainer.innerHTML = `
    <div class="pagination-info">${infoText}</div>
    <div class="pagination-buttons">${buttons}</div>
  `;
      activityPaginationContainer.style.display = '';
    }

    //  listener pro tlačítko Obnovit
    document.getElementById('refresh-log-btn')?.addEventListener('click', loadActivityLog);

    activityPaginationContainer?.addEventListener('click', (event) => {
      const button = event.target.closest('.pagination-button');
      if (!button || button.disabled) return;

      const requestedPage = Number(button.dataset.page);
      if (!Number.isFinite(requestedPage) || requestedPage < 1) return;

      renderActivityLogPage(requestedPage);
    });


    const adminTabLink = document.querySelector('.nav-link[data-page="admin"]');
    if (adminTabLink) {
      adminTabLink.addEventListener('click', () => {
        loadAdminUsers();
        loadActivityLog();
      });
    }


    // === DASHBOARD LOGIC (RESTORED) ===
    async function loadDashboardStats() {
      console.log('Called loadDashboardStats');
      const dashboardUserEmail = localStorage.getItem('userEmail');
      const account = localStorage.getItem('primaryEmail');
      console.log('Dashboard stats params:', { dashboardUserEmail, account });

      if (!dashboardUserEmail) {
        console.warn('Missing dashboardUserEmail, cannot load stats');
        return;
      }

      try {
        const url = new URL(`${window.BACKEND}/api/dashboard/stats`);
        url.searchParams.set('dashboardUserEmail', dashboardUserEmail);
        if (account) url.searchParams.set('email', account);

        const r = await fetch(url);
        const j = await r.json();
        if (j.success && j.stats) {
          const s = j.stats;
          const setTxt = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.textContent = val;
          };
          setTxt('stat-processed', s.processedEmails || 0);
          setTxt('stat-saved-time', (s.savedHours || 0) + 'h');
          setTxt('stat-ai-success', (s.successRate || 0) + '%');
          setTxt('stat-active-templates', s.activeTemplates || 0);
        }
      } catch (e) {
        console.error('Failed to load dashboard stats:', e);
      }
    }

    async function loadDashboardRecentEmails() {
      const list = document.getElementById('dashboard-recent-emails');
      if (!list) return;

      const dashboardUserEmail = localStorage.getItem('userEmail');
      const account = localStorage.getItem('primaryEmail');
      if (!dashboardUserEmail || !account) {
        list.innerHTML = '<div style="padding:1rem; text-align:center; color:#94a3b8;">Vyberte účet pro zobrazení emailů.</div>';
        return;
      }

      list.innerHTML = '<div style="padding:1rem; text-align:center; color:#94a3b8;">Načítám poslední emaily...</div>';

      try {
        const url = new URL(`${window.BACKEND}/api/dashboard/recent-emails`);
        url.searchParams.set('dashboardUserEmail', dashboardUserEmail);
        url.searchParams.set('email', account);

        const r = await fetch(url);
        const j = await r.json();

        if (j.success && j.emails) {
          const emails = j.emails;
          if (!emails.length) {
            list.innerHTML = '<div style="padding:1rem; text-align:center; color:#94a3b8;">Žádné nedávné emaily.</div>';
            return;
          }


          // Filter out emails sent by me (assuming 'from' contains my email)
          const filteredEmails = emails.filter(e => {
            if (!account) return true;
            return !e.from.toLowerCase().includes(account.toLowerCase());
          });

          if (!filteredEmails.length) {
            list.innerHTML = '<div style="padding:1rem; text-align:center; color:#94a3b8;">Žádné příchozí emaily.</div>';
            return;
          }

          const rows = filteredEmails.slice(0, 3).map(e => {
            const time = new Date(e.date).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            let statusClass = 'processed';
            let statusText = 'Zpracováno';
            if (e.isRead === false) { statusClass = 'unread'; statusText = 'Nový'; }

            return `
              <div class="email-item" style="cursor: default;">
                <div class="email-status ${statusClass}"></div>
                <div class="email-content">
                  <div class="email-sender">${escapeHtml(e.from)}</div>
                  <div class="email-subject">${escapeHtml(e.subject)}</div>
                  <div class="email-preview">${escapeHtml(e.snippet || '')}</div>
                </div>
                <div class="email-meta">
                  <div>${time}</div>
                  <div>${statusText}</div>
                </div>
              </div>
            `;
          }).join('');

          list.innerHTML = `
            <div class="email-list-header">
              <h3>Poslední emaily</h3>
            </div>
            ${rows}
          `;

        } else {
          list.innerHTML = '<div style="padding:1rem; text-align:center; color:#ef4444;">Chyba načítání.</div>';
        }
      } catch (e) {
        console.error(e);
        list.innerHTML = '<div style="padding:1rem; text-align:center; color:#dc2626;">Chyba načítání emailů.</div>';
      }
    }

    // Auto load hooks
    const dashboardTabLink = document.querySelector('.nav-link[data-page="dashboard"]');
    if (dashboardTabLink) {
      dashboardTabLink.addEventListener('click', () => {
        loadDashboardStats();
        loadDashboardRecentEmails();
      });
    }
    if (document.querySelector('#dashboard.active')) {
      loadDashboardStats();
      loadDashboardRecentEmails();
    }
  </script>


  <!-- Email Reader Modal -->
  <div class="modal-overlay" id="emailReader">
    <div class="modal modal-full-width" style="max-width: 980px;">
      <div class="modal-header">
        <div class="modal-title" id="er-subject">📧 Načítám…</div>
        <button class="modal-close" id="er-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="analysis-section" style="margin-bottom:1rem;">
          <div class="section-header" style="justify-content:space-between;">
            <div style="display:flex; gap:.75rem; align-items:center;">
              <span class="section-icon">👤</span>
              <div>
                <div class="section-title" id="er-from">—</div>
                <div class="section-content" id="er-date" style="font-size:.9rem; color:#64748b;">—</div>
              </div>
            </div>
            <div style="display:flex; gap:.5rem;">
              <button class="btn btn-secondary" id="er-copy">Kopírovat text</button>
              <button class="btn btn-primary" id="er-reply">✉️ Odpovědět</button>
            </div>
          </div>
          <div id="er-tags" style="display:flex; gap:.5rem; flex-wrap:wrap;"></div>
        </div>

        <div class="response-section">
          <div class="response-header">
            <div class="response-title">Obsah zprávy</div>
          </div>
          <div class="response-content" id="er-body" style="min-height:180px;">Načítám obsah…</div>
        </div>

        <div class="analysis-section" id="er-ai" style="display:none;">
          <div class="section-header">
            <span class="section-icon">🤖</span>
            <div class="section-title">Návrh odpovědi (AI)</div>
          </div>
          <div class="section-content" id="er-ai-reply" style="white-space:pre-wrap;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="er-close-bottom">Zavřít</button>
        <button class="btn btn-primary" id="er-reply-bottom">✉️ Odpovědět</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>

</html>
